<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Nutrition & Allergen API - Interactive Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0EA5A4;
      --primary-dark: #0B7F7E;
      --secondary: #0EA5A4;
      --accent: #0EA5A4;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --text-primary: #0F172A;
      --text-secondary: #475569;
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8FAFC;
      --bg-tertiary: #EDF2F7;
      --border: #E2E8F0;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
      --radius: 12px;
      --radius-lg: 16px;
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      background: white;
      border-radius: var(--radius);
      padding: 16px 20px;
      box-shadow: var(--shadow-xl);
      border-left: 4px solid var(--danger);
      min-width: 320px;
      max-width: 400px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      pointer-events: auto;
      animation: slideInRight 0.3s ease-out;
      position: relative;
      overflow: hidden;
    }

    .toast.success {
      border-left-color: var(--success);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    .toast-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .toast-close {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: color 0.2s;
    }

    .toast-close:hover {
      color: var(--text-primary);
    }

    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: var(--danger);
      animation: toastProgress 5s linear forwards;
    }

    .toast.success .toast-progress {
      background: var(--success);
    }

    .toast.warning .toast-progress {
      background: var(--warning);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Child 4-8 Fruit Portion Warning Banner */
    .child-fruit-warning {
      padding: 12px 16px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: var(--radius);
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .child-fruit-warning-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .child-fruit-warning-content {
      flex: 1;
    }

    .child-fruit-warning-title {
      font-weight: 700;
      font-size: 0.9rem;
      color: #92400e;
      margin-bottom: 4px;
    }

    .child-fruit-warning-message {
      font-size: 0.85rem;
      color: #78350f;
      line-height: 1.5;
    }

    @keyframes toastProgress {
      from {
        width: 100%;
      }
      to {
        width: 0%;
      }
    }

    .toast.hiding {
      animation: slideOutRight 0.3s ease-out forwards;
    }

    /* Quantity Control Styles */
    .quantity-control {
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      background: white;
    }

    .quantity-input {
      border: none;
      outline: none;
      width: 60px;
      padding: 4px 6px;
      text-align: center;
      font-size: 0.85rem;
      background: transparent;
    }

    /* Hide number input spinners */
    .quantity-input::-webkit-inner-spin-button,
    .quantity-input::-webkit-outer-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }

    .quantity-input[type=number] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .quantity-btn {
      background: var(--bg-tertiary);
      border: none;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      transition: background 0.2s;
      user-select: none;
    }

    .quantity-btn:hover {
      background: var(--primary);
      color: white;
    }

    .quantity-btn:active {
      background: var(--primary-dark);
    }

    .quantity-btn.decrement {
      border-right: 1px solid var(--border);
    }

    .quantity-btn.increment {
      border-left: 1px solid var(--border);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #0EA5A4 0%, #0B7F7E 50%, #0EA5A4 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      position: relative;
    }

    /* Premium subtle noise overlay (keeps gradient colors unchanged) */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      opacity: 0.035; /* subtle grain */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.6'/%3E%3C/svg%3E");
      background-repeat: repeat;
    }

    /* Make sure all visible content stays above the overlay */
    body > * {
      position: relative;
      z-index: 1;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Main Tabs Container */
    .main-tabs-container {
      margin-bottom: 30px;
      display: flex;
      justify-content: center;
    }

    .main-tabs {
      display: flex;
      gap: 10px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 8px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .main-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0.8;
    }

    .main-tab:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.1);
    }

    .main-tab.active {
      background: white;
      color: var(--primary);
      opacity: 1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .main-tab-content {
      display: none;
    }

    .main-tab-content.active {
      display: block;
    }

    
    /* Header */
    .header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .header .subtitle {
      font-size: 1.1rem;
      opacity: 0.95;
      margin-bottom: 15px;
    }

    .header .badge {
      display: inline-block;
      padding: 8px 20px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 50px;
      font-size: 0.9rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Main Layout - Removed, using centered search and 3-column browse */
    .main-layout {
      display: block;
      margin-bottom: 25px;
    }
    
    /* Search Area Container - Centered */
    .search-area-container {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    .search-area-container .search-container {
      max-width: 800px;
      width: 100%;
      display: flex;
      flex-direction: column;
      padding: 15px 20px; /* Reduced from 25px */
    }
    
    .search-area-container .search-container .card-header {
      flex-shrink: 0;
      margin-bottom: 12px; /* Reduced from 20px */
      padding-bottom: 8px; /* Reduced from 15px */
    }

    .search-area-container .search-container .card-title {
      font-size: 1.1rem; /* Reduced from 1.3rem */
    }

    .search-area-container .search-container .card-subtitle {
      font-size: 0.85rem; /* Reduced from 0.9rem */
      margin-top: 3px; /* Reduced from 5px */
    }
    
    .search-area-container .search-container .search-section {
      flex-shrink: 0;
    }
    
    .search-area-container .search-container .ingredients-textarea-section {
      margin-top: 8px; /* Reduced from 15px */
      margin-bottom: 10px; /* Added to control spacing */
    }

    .search-area-container .search-container .ingredients-textarea-section {
      margin-top: 8px; /* Reduced from 15px */
      margin-bottom: 8px; /* Added to control spacing */
    }

    .search-area-container .search-container .textarea-label {
      margin-bottom: 5px; /* Reduced from 8px */
      font-size: 0.9rem; /* Slightly smaller */
    }

    .search-area-container .search-container .ingredients-textarea {
      min-height: 60px !important; /* Constrain height - reduced from 100px */
      padding: 10px 15px !important; /* Reduced padding from 15px */
      font-size: 0.95rem; /* Slightly smaller font */
    }
    
    .search-area-container .search-container #analyze-btn {
      margin-top: 12px; /* Reduced spacing */
      flex-shrink: 0;
      padding: 12px 24px; /* Reduced from default */
    }

    /* Browse & Results Grid — mobile-first (NO fixed widths) */
    .browse-results-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-bottom: 30px;
      align-items: stretch;
    }

    .browse-results-grid > .card.results-container,
    .browse-results-grid > :nth-child(2) {
      width: auto !important;
      max-width: 100% !important;
      min-width: 0 !important;
    }

    /* Desktop only: keep EXACT 725px behavior */
    @media (min-width: 1025px) {
      .browse-results-grid {
        grid-template-columns: minmax(0, 1fr) 725px;
        gap: 25px;
      }

      .browse-results-grid > .card.results-container {
        display: flex;
        flex-direction: column;
        width: 725px !important;
        max-width: 725px !important;
        min-width: 725px !important;
        box-sizing: border-box;
      }

      .browse-results-grid > :nth-child(2) {
        width: 725px !important;
        max-width: 725px !important;
        min-width: 725px !important;
      }
    }
    
    .results-container .results-header {
      flex-shrink: 0;
    }
    
    .results-container .tabs {
      flex-shrink: 0;
    }
    
    /* Browse Ingredients Grid */
    /* New Goal-Driven Browse Ingredients Layout */
    .browse-ingredients-layout {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Sticky Selected Summary */
    .selected-summary {
      position: relative;
      top: 10px;
      z-index: auto;
      background: linear-gradient(135deg, rgba(14, 165, 164, 0.12) 0%, rgba(14, 165, 164, 0.08) 100%);
      border: 2px solid var(--primary);
      border-radius: var(--radius);
      padding: 12px 16px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
    }

    .selected-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .selected-label {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .selected-value {
      font-weight: 700;
      color: var(--primary);
      padding: 4px 10px;
      background: white;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    /* Goals Section - Horizontal Chips */
    .goals-section {
      margin-bottom: 0;
    }

    .section-header-compact {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .section-title-compact {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .search-input-compact {
      flex: 1;
      min-width: 200px;
      max-width: 300px;
      padding: 8px 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
    }

    .search-input-compact:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.15);
    }

    .goals-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 50px;
      max-height: none;
      overflow: visible;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .goal-chip {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
    }

    .goal-chip:hover {
      border-color: var(--primary);
      background: rgba(14, 165, 164, 0.05);
      transform: translateY(-1px);
    }

    .goal-chip.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
    }

    /* Goal search and browse toggle */
    .pf-goal-browse-toggle {
      margin-top: 8px;
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pf-goal-browse-toggle:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(14, 165, 164, 0.05);
    }

    .pf-goal-empty {
      padding: 12px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Subcategories Section - Chip Grid */
    .subcategories-section {
      margin-bottom: 0;
    }

    .toggle-show-all {
      padding: 6px 14px;
      background: white;
      border: 2px solid var(--primary);
      border-radius: var(--radius);
      color: var(--primary);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .toggle-show-all:hover {
      background: var(--primary);
      color: white;
    }

    .subcategories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
      max-height: 180px;
      overflow: hidden;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      transition: max-height 0.3s ease;
    }

    .subcategories-grid.expanded {
      max-height: none;
      overflow: visible;
    }

    .subcategory-chip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: white;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .subcategory-chip:hover {
      border-color: var(--primary);
      background: rgba(14, 165, 164, 0.05);
      transform: translateY(-1px);
    }

    .subcategory-chip.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
    }

    .subcategory-chip .count {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-left: 8px;
    }

    .subcategory-chip.active .count {
      opacity: 0.9;
    }

    /* Ingredients Section */
    .ingredients-section {
      margin-bottom: 0;
    }

    .subsection-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .recommended-ingredients {
      margin-bottom: 24px;
    }

    .ingredients-grid-compact {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      max-height: none;
      overflow: visible;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .ingredient-item-compact {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: white;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .ingredient-item-compact:hover {
      border-color: var(--primary);
      background: rgba(14, 165, 164, 0.05);
      transform: translateY(-1px);
    }

    .ingredient-item-compact .add-btn {
      padding: 4px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ingredient-item-compact .add-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .ingredient-item-compact .add-btn.added {
      background: #e5e7eb;
      color: #334155;
      border-color: #cbd5e1;
      cursor: default;
    }

    .ingredient-item-compact .add-btn.added:hover {
      transform: none;
      box-shadow: none;
    }

    /* Legacy styles for backward compatibility */
    .browse-ingredients-grid {
      display: none; /* Hide old layout */
    }

    /* Main Content Grid: Search & Results Side by Side (for Smoothie tab) */
    .main-content-grid {
      display: grid;
      grid-template-columns: 1fr 1.5fr;
      gap: 25px;
      margin-bottom: 30px;
      align-items: stretch;
    }

    /* Cards */
    .card {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      padding: 25px;
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--bg-tertiary);
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* Search & Ingredients Section */
    .search-section {
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
    }

    select.search-input {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 12px;
      padding-right: 40px;
      cursor: pointer;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.35);
      background: white;
      transition: all 0.3s ease;
    }

    .ingredients-textarea-section {
      margin-top: 15px;
    }
    
    .error-message {
      margin-top: 10px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 2px solid #ef4444;
      border-radius: var(--radius);
      color: #991b1b;
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideDown 0.3s ease-out;
    }
    
    .error-message::before {
      content: "⚠️";
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .textarea-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .ingredients-textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      background: white;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .ingredients-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(14, 165, 164, 0.35);
      background: white;
    }

    .ingredient-suggestions {
      position: relative;
      margin-top: 5px;
    }

    .suggestions-dropdown {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 5px;
    }

    .suggestion-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid var(--bg-tertiary);
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover {
      background: var(--bg-secondary);
      border-left: 3px solid var(--primary);
    }

    .suggestion-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .suggestion-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .selected-ingredients {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
    }

    .ingredient-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: linear-gradient(135deg, rgba(14, 165, 164, 0.10) 0%, rgba(14, 165, 164, 0.10) 100%);
      border: 2px solid var(--primary);
      border-radius: var(--radius);
      font-size: 0.9rem;
      color: var(--primary);
      font-weight: 600;
    }

    .ingredient-chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.25) !important;
    }

    .ingredient-chip .remove-btn {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      font-size: 1.3rem;
      padding: 0;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
      font-weight: bold;
    }

    .ingredient-chip .remove-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      transform: scale(1.1);
    }
    
    .ingredient-chip .quantity-btn:hover {
      background: #fde68a !important;
      transform: scale(1.05);
    }
    
    .ingredient-chip .unit-select:hover {
      border-color: #d97706 !important;
    }

    .btn-primary {
      width: 100%;
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: 2px solid transparent;
      border-radius: var(--radius);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
      margin-top: 15px;
      height: 54px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Clear Button Style */
    #smoothie-clear-btn {
      flex: 0 0 auto;
      padding: 16px 20px;
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 2px solid #ef4444;
      border-radius: var(--radius);
      color: #dc2626;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1);
      height: 54px;
      box-sizing: border-box;
      line-height: 1;
    }

    #smoothie-clear-btn:hover {
      background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
      border-color: #dc2626;
    }

    #smoothie-clear-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.15);
    }

    /* Explorer Panels */
    .explorer-panel {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 2px solid var(--border);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 500px;
    }

    .panel-header {
      padding: 15px 20px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      font-weight: 600;
      font-size: 1rem;
    }

    .panel-body {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }

    .panel-item {
      padding: 12px 15px;
      margin: 5px;
      background: white;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-item:hover {
      background: linear-gradient(135deg, rgba(14, 165, 164, 0.10) 0%, rgba(14, 165, 164, 0.10) 100%);
      border-color: var(--primary);
      transform: translateX(5px);
    }

    .panel-item.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .panel-item .count {
      font-size: 0.85rem;
      opacity: 0.8;
      font-weight: 500;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    /* Results Section */
    .results-section {
      grid-column: 1 / -1;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--bg-tertiary);
    }
    
    .results-container .results-header {
      margin-bottom: 0;
      padding-bottom: 15px;
    }
    
    .results-container .tabs {
      margin-top: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--bg-tertiary);
      padding-bottom: 0;
    }
    
    .results-container .tab-pane {
      flex: 1;
      min-height: 0;
      display: none;
      overflow: hidden;
    }
    
    .results-container .tab-pane.active {
      display: block;
    }
    
    .results-container .results-body {
      height: 100%;
      overflow-y: auto;
      
    }
    
    .search-container .card-body,
    .search-container > *:not(.card-header) {
      flex-shrink: 0;
    }
    
    .search-container .selected-ingredients {
      flex-shrink: 0;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      font-size: 0.9rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    .status-dot.error {
      background: var(--danger);
    }

    .tabs {
      display: flex;
      gap: 5px;
      background: var(--bg-secondary);
      padding: 5px;
      border-radius: var(--radius);
    }

    .tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .tab.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .tab:hover:not(.active) {
      background: rgba(14, 165, 164, 0.10);
    }

    .tab-pane {
      display: none;
      height: 100%;
      overflow: hidden;
    }
    
    .tab-pane.active {
      display: block;
    }
    
    .results-body {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 25px;
      min-height: 300px;
      max-height: 600px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.8;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 2px solid var(--border);
      height: 100%;
    }

    /* Smoothie tab: stop giant results container */
    #smoothie-tab-content .results-container .results-body,
    #smoothie-tab-content .results-body {
      height: auto !important;
      min-height: 0 !important;
      max-height: none !important;
      overflow: visible !important;

      /* Smoothie results should look like normal UI, not terminal output */
      font-family: inherit !important;
      white-space: normal !important;
      line-height: 1.5 !important;
      padding: 16px !important;
    }

    /* Smoothie tab: make results look like a modern card (not a log panel) */
    #smoothie-tab-content .results-body {
      background: transparent !important;
      border: none !important;
      border-radius: 0 !important;
      font-size: 0.95rem !important;
    }

    /* Smoothie Nutrition: clean tabs (scoped) */
    #smoothie-tab-content .sn-tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      margin-top: 8px;
    }

    #smoothie-tab-content .sn-tab {
      padding: 10px 14px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-secondary);
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      transition: color 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }

    #smoothie-tab-content .sn-tab:hover {
      color: var(--text-primary);
      background: rgba(0,0,0,0.03);
      border-radius: 10px 10px 0 0;
    }

    #smoothie-tab-content .sn-tab.active {
      border-bottom-color: var(--primary);
      color: var(--primary);
    }

    /* Smoothie Nutrition: clean header + badge */
    #smoothie-tab-content .sn-nutrition-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin: 8px 0 10px;
    }

    #smoothie-tab-content .sn-nutrition-title{
      display:flex;
      align-items:center;
      gap:10px;
    }

    #smoothie-tab-content .sn-emoji{ font-size: 1.2rem; }

    #smoothie-tab-content .sn-title{
      color: var(--primary);
      font-size: 1.05rem;
      font-weight: 800;
      line-height: 1.2;
    }

    #smoothie-tab-content .sn-subtitle{
      color: var(--text-secondary);
      font-size: 0.82rem;
      margin-top: 2px;
    }

    #smoothie-tab-content .sn-usda-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #6ee7b7;
      background: #ecfdf5;
      font-size: 0.75rem;
      color: #047857;
    }

    /* Smoothie Nutrition: servings control */
    #smoothie-tab-content .sn-controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }

    #smoothie-tab-content .sn-qty{
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      display:flex;
      align-items:center;
    }

    #smoothie-tab-content .sn-qty-btn{
      border: none;
      background: transparent;
      padding: 8px 12px;
      font-weight: 900;
      cursor: pointer;
      color: var(--text-primary);
    }

    #smoothie-tab-content .sn-qty-btn:hover{
      background: rgba(0,0,0,0.04);
    }

    #smoothie-tab-content .sn-qty-btn.decrement{
      border-right: 1px solid var(--border);
    }

    #smoothie-tab-content .sn-qty-btn.increment{
      border-left: 1px solid var(--border);
    }

    #smoothie-tab-content .sn-qty-input{
      width: 64px;
      padding: 6px;
      border: none;
      outline: none;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 800;
    }

    /* Vegan Milk Recommendation: compact collapsible card */
    #smoothie-tab-content .vmr-card{
      padding: 10px 12px;
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border: 2px solid #ef4444;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
    }

    #smoothie-tab-content .vmr-summary-row{
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #7f1d1d;
      line-height: 1.4;
    }

    #smoothie-tab-content .vmr-summary-row::-webkit-details-marker{
      display: none;
    }

    #smoothie-tab-content .vmr-summary-row::before{
      content: '▶';
      font-size: 0.7rem;
      transition: transform 0.2s ease;
      display: inline-block;
      flex-shrink: 0;
    }

    #smoothie-tab-content .vmr-card[open] .vmr-summary-row::before{
      transform: rotate(90deg);
    }

    #smoothie-tab-content .vmr-title{
      font-size: 0.75rem;
      color: #991b1b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 700;
    }

    #smoothie-tab-content .vmr-table-wrapper{
      max-height: 220px;
      overflow-y: auto;
      margin-top: 10px;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #smoothie-tab-content .vmr-table-wrapper table{
      width: 100%;
      border-collapse: collapse;
    }

    #smoothie-tab-content .vmr-table-wrapper thead tr{
      background: rgba(0, 0, 0, 0.2);
    }

    #smoothie-tab-content .vmr-table-wrapper th{
      padding: 10px 12px;
      font-size: 0.75rem;
      color: white;
      text-align: left;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    #smoothie-tab-content .vmr-table-wrapper th:last-child{
      text-align: center;
    }

    #smoothie-tab-content .vmr-table-wrapper tbody tr{
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    #smoothie-tab-content .vmr-table-wrapper tbody tr:last-child{
      border-bottom: none;
    }

    #smoothie-tab-content .vmr-table-wrapper td{
      padding: 8px 12px;
      font-size: 0.85rem;
      color: white;
    }

    #smoothie-tab-content .vmr-table-wrapper td:last-child{
      text-align: center;
      font-weight: 600;
    }

    /* Nutrition Display - Compact Tile Grid With Icons */
    .nutrition-grid {
      display: flex;
      flex-direction: column;
      flex-wrap: nowrap;
      gap: 8px;
      margin: 0;
      padding: 0;
      overflow-y: auto;
      overflow-x: hidden;
      width: 100%;
      padding-bottom: 4px;
    }
    
    .nutrition-grid::-webkit-scrollbar {
      height: 6px;
    }
    
    .nutrition-grid::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }
    
    .nutrition-grid::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    
    .nutrition-grid::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-row:last-child {
      border-bottom: none;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-row:hover {
      background: rgba(14, 165, 164, 0.05);
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-main {
      flex: 1;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-name {
      font-weight: 700;
      font-size: 0.9rem;
      color: #0f172a;
      white-space: nowrap;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-badges {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 3px;
      white-space: nowrap;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-portion {
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-control {
      display: flex;
      align-items: center;
      border: 1.5px solid #f59e0b;
      border-radius: 6px;
      overflow: hidden;
      background: white;
      box-shadow: 0 1px 3px rgba(245, 158, 11, 0.2);
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-btn {
      border: none;
      background: #fef3c7;
      color: #92400e;
      width: 28px;
      height: 28px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-btn:hover:not(:disabled) {
      background: #fde68a;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-input {
      width: 50px;
      padding: 4px;
      border: none;
      outline: none;
      text-align: center;
      font-size: 0.85rem;
      font-weight: 700;
      color: #78350f;
      background: white;
    }

    /* Hide native number input spinners for Smoothie quantity inputs (both class systems) */
    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-input::-webkit-inner-spin-button,
    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-input::-webkit-outer-spin-button,
    #smoothie-tab-content #smoothie-selected-ingredients .ss-qty-input::-webkit-inner-spin-button,
    #smoothie-tab-content #smoothie-selected-ingredients .ss-qty-input::-webkit-outer-spin-button {
      -webkit-appearance: none !important;
      appearance: none !important;
      margin: 0;
    }

    /* Firefox */
    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-input[type="number"],
    #smoothie-tab-content #smoothie-selected-ingredients .ss-qty-input[type="number"] {
      -moz-appearance: textfield !important;
      appearance: textfield !important;
    }

    /* Hide native number input spinners for Smoothie quantity inputs (both class systems) */
    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-input::-webkit-inner-spin-button,
    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-input::-webkit-outer-spin-button,
    #smoothie-tab-content #smoothie-selected-ingredients .ss-qty-input::-webkit-inner-spin-button,
    #smoothie-tab-content #smoothie-selected-ingredients .ss-qty-input::-webkit-outer-spin-button {
      -webkit-appearance: none !important;
      appearance: none !important;
      margin: 0;
    }

    /* Firefox */
    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-quantity-input[type="number"],
    #smoothie-tab-content #smoothie-selected-ingredients .ss-qty-input[type="number"] {
      -moz-appearance: textfield !important;
      appearance: textfield !important;
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-remove-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
    }

    #smoothie-tab-content #smoothie-selected-ingredients .smoothie-remove-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    /* Mobile: stack controls below name on narrow screens */
    @media (max-width: 640px) {
      #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-row {
        flex-wrap: wrap;
        align-items: flex-start;
      }

      #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-main {
        width: 100%;
      }

      #smoothie-tab-content #smoothie-selected-ingredients .smoothie-ingredient-controls {
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* Smoothie Selected Ingredients: Compact Panel (ss-*) */
    #smoothie-tab-content .ss-panel{
      background: white;
      border: 1px solid rgba(15, 23, 42, 0.1);
      border-radius: 12px;
      padding: 0;
      margin-top: 15px;
      overflow: hidden;
    }

    #smoothie-tab-content .ss-panel summary{
      cursor: pointer;
      list-style: none;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      user-select: none;
    }

    #smoothie-tab-content .ss-panel summary::-webkit-details-marker{
      display: none;
    }

    #smoothie-tab-content .ss-panel summary::before{
      content: '▶';
      font-size: 0.7rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    #smoothie-tab-content .ss-panel[open] summary::before{
      transform: rotate(90deg);
    }

    #smoothie-tab-content .ss-header{
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    #smoothie-tab-content .ss-title{
      font-weight: 700;
      font-size: 0.9rem;
      color: #0f172a;
      white-space: nowrap;
    }

    #smoothie-tab-content .ss-meta{
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    #smoothie-tab-content .ss-meta-item{
      display: flex;
      align-items: center;
      gap: 4px;
    }

    #smoothie-tab-content .ss-yield{
      font-weight: 600;
      color: var(--primary);
      font-size: 0.85rem;
    }

    #smoothie-tab-content .ss-chipstrip{
      display: flex;
      align-items: center;
      gap: 6px;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 4px 0;
      flex: 1;
      min-width: 0;
      scrollbar-width: thin;
      scrollbar-color: rgba(15, 23, 42, 0.2) transparent;
    }

    #smoothie-tab-content .ss-chipstrip::-webkit-scrollbar{
      height: 4px;
    }

    #smoothie-tab-content .ss-chipstrip::-webkit-scrollbar-track{
      background: transparent;
    }

    #smoothie-tab-content .ss-chipstrip::-webkit-scrollbar-thumb{
      background: rgba(15, 23, 42, 0.2);
      border-radius: 2px;
    }

    #smoothie-tab-content .ss-chip{
      flex-shrink: 0;
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 1px solid rgba(15, 23, 42, 0.1);
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    #smoothie-tab-content .ss-chip-name{
      font-weight: 600;
      color: #0f172a;
    }

    #smoothie-tab-content .ss-chip-portion{
      color: var(--text-secondary);
      font-size: 0.7rem;
    }

    #smoothie-tab-content .ss-details{
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      padding: 0;
    }

    #smoothie-tab-content .ss-list-scroll{
      max-height: 240px;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 8px;
    }

    #smoothie-tab-content .ss-list-scroll::-webkit-scrollbar{
      width: 6px;
    }

    #smoothie-tab-content .ss-list-scroll::-webkit-scrollbar-track{
      background: var(--bg-secondary);
      border-radius: 3px;
    }

    #smoothie-tab-content .ss-list-scroll::-webkit-scrollbar-thumb{
      background: rgba(15, 23, 42, 0.2);
      border-radius: 3px;
    }

    #smoothie-tab-content .ss-row{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      min-height: 44px;
      max-height: 52px;
      transition: background 0.15s ease;
    }

    #smoothie-tab-content .ss-row:last-child{
      border-bottom: none;
    }

    #smoothie-tab-content .ss-row:hover{
      background: rgba(14, 165, 164, 0.03);
    }

    #smoothie-tab-content .ss-row-main{
      flex: 1;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #smoothie-tab-content .ss-row-name{
      display: block;
      font-weight: 700;
      font-size: 0.85rem;
      color: #0f172a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    #smoothie-tab-content .ss-tags{
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    #smoothie-tab-content .ss-tag{
      font-size: 0.65rem;
      padding: 2px 5px;
      border-radius: 3px;
      white-space: nowrap;
    }

    #smoothie-tab-content .ss-portion{
      font-size: 0.7rem;
      color: var(--text-secondary);
      white-space: nowrap;
      margin-left: 6px;
    }

    #smoothie-tab-content .ss-row-controls{
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    #smoothie-tab-content .ss-qty-control{
      display: flex;
      align-items: center;
      border: 1.5px solid #f59e0b;
      border-radius: 6px;
      overflow: hidden;
      background: white;
      box-shadow: 0 1px 3px rgba(245, 158, 11, 0.2);
    }

    #smoothie-tab-content .ss-qty-btn{
      border: none;
      background: #fef3c7;
      color: #92400e;
      width: 24px;
      height: 24px;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    #smoothie-tab-content .ss-qty-btn:hover:not(:disabled){
      background: #fde68a;
    }

    #smoothie-tab-content .ss-qty-btn:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }

    #smoothie-tab-content .ss-qty-input{
      width: 42px;
      padding: 3px 2px;
      border: none;
      outline: none;
      text-align: center;
      font-size: 0.8rem;
      font-weight: 700;
      color: #78350f;
      background: white;
    }

    #smoothie-tab-content .ss-remove-btn{
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      cursor: pointer;
      font-size: 0.9rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
      box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
    }

    #smoothie-tab-content .ss-remove-btn:hover{
      background: #dc2626;
      transform: scale(1.1);
    }

    #smoothie-tab-content .ss-info-messages{
      padding: 8px 12px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      font-size: 0.8rem;
    }

    /* Smoothie Summary Modal (ssm-*) */
    #smoothie-tab-content .ssm-summary-card{
      background: white;
      border: 1px solid rgba(15, 23, 42, 0.1);
      border-radius: 12px;
      padding: 12px 14px;
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #smoothie-tab-content .ssm-summary-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    #smoothie-tab-content .ssm-summary-title{
      font-weight: 700;
      font-size: 0.9rem;
      color: #0f172a;
      white-space: nowrap;
    }

    #smoothie-tab-content .ssm-summary-meta{
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      flex-wrap: wrap;
      margin-top: 4px;
    }

    #smoothie-tab-content .ssm-summary-meta-item{
      white-space: nowrap;
    }

    #smoothie-tab-content .ssm-chipstrip{
      display: flex;
      align-items: center;
      gap: 6px;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 4px 0;
      scrollbar-width: thin;
      scrollbar-color: rgba(15, 23, 42, 0.2) transparent;
    }

    #smoothie-tab-content .ssm-chipstrip::-webkit-scrollbar{
      height: 4px;
    }

    #smoothie-tab-content .ssm-chipstrip::-webkit-scrollbar-track{
      background: transparent;
    }

    #smoothie-tab-content .ssm-chipstrip::-webkit-scrollbar-thumb{
      background: rgba(15, 23, 42, 0.2);
      border-radius: 2px;
    }

    #smoothie-tab-content .ssm-chip{
      flex-shrink: 0;
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 1px solid rgba(15, 23, 42, 0.1);
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    #smoothie-tab-content .ssm-chip-name{
      font-weight: 600;
      color: #0f172a;
    }

    #smoothie-tab-content .ssm-chip-portion{
      color: var(--text-secondary);
      font-size: 0.7rem;
    }

    #smoothie-tab-content .ssm-edit-btn{
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    #smoothie-tab-content .ssm-edit-btn:hover{
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(14, 165, 164, 0.3);
    }

    #smoothie-tab-content .ssm-modal{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #smoothie-tab-content .ssm-modal.ssm-modal-open{
      display: flex;
    }

    #smoothie-tab-content .ssm-backdrop{
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    #smoothie-tab-content .ssm-modal-card{
      position: relative;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      z-index: 1;
    }

    #smoothie-tab-content .ssm-modal-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.1);
      flex-shrink: 0;
    }

    #smoothie-tab-content .ssm-modal-title{
      font-weight: 700;
      font-size: 1.1rem;
      color: #0f172a;
    }

    #smoothie-tab-content .ssm-modal-close{
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    #smoothie-tab-content .ssm-modal-close:hover{
      background: var(--bg-secondary);
      color: #0f172a;
    }

    #smoothie-tab-content .ssm-modal-scroll{
      max-height: 70vh;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px 20px 20px;
    }

    #smoothie-tab-content .ssm-modal-scroll::-webkit-scrollbar{
      width: 6px;
    }

    #smoothie-tab-content .ssm-modal-scroll::-webkit-scrollbar-track{
      background: var(--bg-secondary);
      border-radius: 3px;
    }

    #smoothie-tab-content .ssm-modal-scroll::-webkit-scrollbar-thumb{
      background: rgba(15, 23, 42, 0.2);
      border-radius: 3px;
    }

    /* Modal ingredient rows (reuse ss-row classes) */
    #smoothie-tab-content .ssm-modal-scroll .ss-row{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      min-height: 44px;
      max-height: 52px;
      transition: background 0.15s ease;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-row:last-child{
      border-bottom: none;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-row:hover{
      background: rgba(14, 165, 164, 0.03);
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-row-main{
      flex: 1;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-row-name{
      display: block;
      font-weight: 700;
      font-size: 0.85rem;
      color: #0f172a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-tags{
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-tag{
      font-size: 0.65rem;
      padding: 2px 5px;
      border-radius: 3px;
      white-space: nowrap;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-portion{
      font-size: 0.7rem;
      color: var(--text-secondary);
      white-space: nowrap;
      margin-left: 6px;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-row-controls{
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-qty-control{
      display: flex;
      align-items: center;
      border: 1.5px solid #f59e0b;
      border-radius: 6px;
      overflow: hidden;
      background: white;
      box-shadow: 0 1px 3px rgba(245, 158, 11, 0.2);
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-qty-btn{
      border: none;
      background: #fef3c7;
      color: #92400e;
      width: 24px;
      height: 24px;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-qty-btn:hover:not(:disabled){
      background: #fde68a;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-qty-btn:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-qty-input{
      width: 42px;
      padding: 3px 2px;
      border: none;
      outline: none;
      text-align: center;
      font-size: 0.8rem;
      font-weight: 700;
      color: #78350f;
      background: white;
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-remove-btn{
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      cursor: pointer;
      font-size: 0.9rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
      box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
    }

    #smoothie-tab-content .ssm-modal-scroll .ss-remove-btn:hover{
      background: #dc2626;
      transform: scale(1.1);
    }

    @media (max-width: 640px) {
      #smoothie-tab-content .ssm-modal{
        padding: 0;
      }

      #smoothie-tab-content .ssm-modal-card{
        max-width: 100%;
        max-height: 100vh;
        border-radius: 0;
      }
    }

    /* Smoothie: prevent the left accent from bleeding into next rows (fixes "double tile" look) */
    #smoothie-tab-content .nutrition-grid > * {
      position: relative;
      overflow: hidden;
    }

    .nutrition-tile {
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
      text-align: center;
      transition: all 0.2s ease;
      position: relative;
      border-left: 2px solid var(--tile-color, var(--primary));
      flex: 0 0 auto;
      min-width: 80px;
      max-height: 40px;
      box-shadow: 0 1px 1px rgba(15, 23, 42, 0.03);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .nutrition-tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(15, 23, 42, 0.12);
    }

    /* Smoothie Nutrition Tabs */
    .smoothie-nutrition-tab {
      position: relative;
    }
    
    .smoothie-nutrition-tab:hover {
      color: var(--primary) !important;
      background: rgba(14, 165, 164, 0.10) !important;
    }
    
    .smoothie-nutrition-tab-content {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Quantity Control for Servings */
    .quantity-control {
      display: flex;
      align-items: center;
    }
    
    .quantity-btn {
      width: 32px;
      height: 32px;
      background: var(--bg-tertiary);
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      user-select: none;
    }
    
    .quantity-btn:hover {
      background: var(--primary);
      color: white;
    }
    
    .quantity-btn:active {
      transform: scale(0.95);
    }
    
    .quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Extra compact tile style for Smoothie Nutrition (no big card look) */
    .smoothie-metrics-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    /* Smoothie Nutrition redesign (scoped + safe) */
    .sn-wrap { padding: 12px 0; }

    .sn-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: stretch;
    }

    @media (max-width: 920px){
      .sn-grid{ grid-template-columns: 1fr; }
    }

    .sn-card{
      border-radius: 18px;
      border: 2px solid rgba(0,0,0,0.08);
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
      overflow: hidden;

      /* CRITICAL: prevents giant empty blocks */
      height: auto !important;
      min-height: 0 !important;
    }

    .sn-card--warm{
      background: linear-gradient(180deg, #fff1b8 0%, #ffefc9 100%);
      border-color: rgba(245, 158, 11, 0.55);
    }

    .sn-card--cool{
      background: linear-gradient(180deg, #e9f5ff 0%, #eef8ff 100%);
      border-color: rgba(59, 130, 246, 0.55);
    }

    .sn-card--neutral{
      background: #ffffff;
      border-color: rgba(0,0,0,0.10);
    }

    .sn-head{
      display:flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .sn-title{
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .sn-meta{
      font-size: 13px;
      opacity: 0.75;
    }

    .sn-body{
      padding: 14px 16px;
    }

    /* Collapsible nutrition card */
    .sn-details{
      margin-top: 16px;
    }

    .sn-summary{
      cursor: pointer;
      list-style: none;
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .sn-summary::-webkit-details-marker{ display:none; }

    .smoothie-tile {
      background: transparent;
      border-radius: 10px;
      border: 1px solid var(--border);
      box-shadow: none;
      padding: 10px 8px;
      min-width: 95px;
    }

    .smoothie-tile .label {
      font-size: 0.65rem;
    }

    .smoothie-tile .value {
      font-size: 1rem;
    }

    .nutrition-tile .icon {
      font-size: 0.9rem;
      margin: 0;
      display: inline;
      line-height: 1.1;
      vertical-align: middle;
    }

    .nutrition-tile .label {
      font-size: 0.6rem;
      color: var(--text-secondary);
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.05px;
      font-weight: 600;
      line-height: 1.2;
      display: inline;
    }

    .nutrition-tile .value {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--tile-color, var(--primary));
      line-height: 1.2;
      display: inline;
    }

    .nutrition-tile .unit {
      font-size: 0.55rem;
      color: var(--text-secondary);
      margin-left: 2px;
      font-weight: 500;
      display: inline;
    }

    /* Individual nutrition tiles with specific colors */
    .nutrition-tile.calories {
      --tile-color: #0EA5A4;
    }

    .nutrition-tile.protein {
      --tile-color: #10b981;
    }

    .nutrition-tile.carbs {
      --tile-color: #f59e0b;
    }

    .nutrition-tile.fat {
      --tile-color: #ef4444;
    }

    .nutrition-tile.fiber {
      --tile-color: #0EA5A4;
    }

    .nutrition-tile.sugar {
      --tile-color: #ec4899;
    }

    .nutrition-tile.sodium {
      --tile-color: #06b6d4;
    }

    /* Compact Nutrition Summary Grid - removed duplicate, see below */

    /* === Compact Nutrition Results (v2 - no wasted whitespace) === */
    .nutrition-results-card {
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 16px;
      padding: 14px;
      margin: 0;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 12px;
    }

    .nutrition-results-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin: 0;
    }

    .nutrition-title {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .nutrition-title .badge {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: rgba(14,165,164,0.12);
      border: 1px solid rgba(14,165,164,0.22);
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .nutrition-title h3 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 800;
      color: #0f172a;
      line-height: 1.15;
    }

    .nutrition-title p {
      margin: 4px 0 0 0;
      font-size: 0.85rem;
      color: rgba(15, 23, 42, 0.65);
      line-height: 1.25;
    }

    .nutrition-count {
      font-size: 0.85rem;
      font-weight: 700;
      color: #0b7f7e;
      background: rgba(14,165,164,0.10);
      border: 1px solid rgba(14,165,164,0.22);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .nutrition-selected-chip {
      display: inline-flex;
      align-items: baseline;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(14,165,164,0.22);
      background: transparent;
      white-space: nowrap;
    }

    .nutrition-selected-chip .name {
      font-weight: 900;
      font-size: 0.92rem;
      color: #0f172a;
    }

    .nutrition-selected-chip .serving {
      font-weight: 800;
      font-size: 0.82rem;
      color: rgba(15, 23, 42, 0.60);
    }

    /* Ingredient chips directly under header */
    .nutrition-ingredients-list {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 2px 0 6px 0;
      margin: 0 0 10px 0;
      -webkit-overflow-scrolling: touch;
    }

    .nutrition-ingredients-list::-webkit-scrollbar {
      height: 6px;
    }

    .nutrition-ingredients-list::-webkit-scrollbar-thumb {
      background: rgba(14,165,164,0.25);
      border-radius: 999px;
    }

    .nutrition-ing-pill {
      display: inline-flex;
      align-items: baseline;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(14,165,164,0.22);
      background: transparent;
      white-space: nowrap;
    }

    .nutrition-ing-pill .name {
      font-weight: 800;
      font-size: 0.92rem;
      color: #0f172a;
    }

    .nutrition-ing-pill .serving {
      font-weight: 700;
      font-size: 0.82rem;
      color: rgba(15, 23, 42, 0.60);
    }

    /* Calm, brand-consistent tiles (no rainbow borders) */
    .nutrition-summary-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin: 0;
      padding: 0;
      min-height: 0;
      align-content: start;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .nutrition-summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .nutrition-tile-compact {
      background: transparent;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nutrition-tile-compact .top {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nutrition-tile-compact .label {
      font-size: 0.74rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 800;
      color: rgba(15, 23, 42, 0.62);
    }

    .nutrition-tile-compact .value {
      font-size: 1.1rem;
      font-weight: 900;
      color: #0b7f7e;
    }

    .nutrition-tile-compact .unit {
      font-size: 0.82rem;
      font-weight: 800;
      color: rgba(15, 23, 42, 0.55);
      margin-left: 4px;
    }

    /* Allergen Display */
    .allergen-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .allergen-badge {
      padding: 10px 18px;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.2) 100%);
      border: 2px solid var(--danger);
      border-radius: var(--radius);
      color: var(--danger);
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .browse-results-grid {
        grid-template-columns: 1fr !important;
      }
      
      .main-content-grid {
        grid-template-columns: 1fr !important;
      }
      
      .browse-ingredients-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }
      
      /* Mobile: Stacked layout for new browse ingredients */
      .browse-ingredients-layout {
        gap: 20px;
      }

      .selected-summary {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding: 10px 12px;
        position: relative;
        top: 0;
      }

      .goals-chips {
        max-height: none;
      }

      .subcategories-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        max-height: none;
      }

      .ingredients-grid-compact {
        grid-template-columns: 1fr;
        max-height: none;
      }

      .section-header-compact {
        flex-direction: column;
        align-items: stretch;
      }

      .search-input-compact {
        max-width: 100%;
      }
      
      .browse-results-grid {
        grid-template-columns: 1fr !important;
        gap: 20px;
      }
      
      .main-content-grid {
        grid-template-columns: 1fr !important;
        gap: 20px;
      }
      
      .browse-ingredients-grid {
        grid-template-columns: 1fr !important;
      }

      .header h1 {
        font-size: 2rem;
      }

      .card {
        padding: 20px;
      }

    }

    /* Scrollbar */
    .panel-body::-webkit-scrollbar,
    .results-body::-webkit-scrollbar {
      width: 8px;
    }

    .panel-body::-webkit-scrollbar-track,
    .results-body::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .panel-body::-webkit-scrollbar-thumb,
    .results-body::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    .panel-body::-webkit-scrollbar-thumb:hover,
    .results-body::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }

    /* === Nutrition Results Override (force no whitespace) === */
    .nutrition-results-card {
      display: flex !important;
      flex-direction: column !important;
      justify-content: flex-start !important;
      align-items: stretch !important;
      gap: 12px !important;
      min-height: 0 !important;
      height: auto !important;
    }

    .nutrition-results-top {
      margin: 0 0 10px 0 !important;
    }

    .nutrition-summary-grid {
      margin: 0 !important;
      padding: 0 !important;
      min-height: 0 !important;
      align-content: start !important;
    }

    .nutrition-title p {
      margin: 4px 0 0 0 !important;
    }

    /* ---------- Allergen tab: compact "no allergens" state ---------- */
    .pf-allergen-inline {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #fff;
      max-width: 980px;
      margin: 14px auto 0;
    }

    .pf-success {
      border-left: 6px solid #22a06b;
    }

    .pf-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22a06b;
      margin-top: 5px;
      flex: 0 0 auto;
    }

    .pf-title {
      font-weight: 700;
      color: #0f172a;
      line-height: 1.2;
    }

    .pf-sub {
      margin-top: 3px;
      font-size: 14px;
      color: #64748b;
      line-height: 1.35;
    }

    
    /* ---------- Allergen Profile (pf-ap-*) ---------- */
    .pf-ap{
      margin: 12px 0 14px;
      padding: 14px;
      border: 1px solid rgba(15,23,42,0.10);
      border-radius: var(--radius);
      background: var(--bg-secondary);
    }
    .pf-ap-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .pf-ap-title{
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
    }
    .pf-ap-sub{
      margin-top: 2px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .pf-ap-clear{
      border: 1px solid rgba(15,23,42,0.15);
      background: #fff;
      color: var(--text-primary);
      border-radius: 10px;
      padding: 7px 10px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }
    .pf-ap-clear:hover{ filter: brightness(0.98); }
    .pf-ap-chips{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .pf-ap-chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.12);
      background: #fff;
      cursor: pointer;
      user-select: none;
      font-size: 0.92rem;
      line-height: 1;
    }
    .pf-ap-chip-dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(100,116,139,0.7);
    }
    .pf-ap-chip[aria-pressed="true"]{
      border-color: rgba(239,68,68,0.35);
      background: rgba(239,68,68,0.08);
    }
    .pf-ap-chip[aria-pressed="true"] .pf-ap-chip-dot{
      background: rgba(239,68,68,0.85);
    }


    /* ---------- Allergen tab: compact redesign (pf-a-*) ---------- */
    .pf-a-wrap {
      max-width: 980px;
      margin: 12px auto 0;
      display: grid;
      gap: 12px;
    }

    .pf-a-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .pf-a-title {
      font-size: 18px;
      font-weight: 800;
      color: #0f172a;
      line-height: 1.2;
    }

    .pf-a-subtitle {
      margin-top: 4px;
      color: #64748b;
      font-size: 13.5px;
      line-height: 1.35;
      max-width: 720px;
    }

    .pf-a-subchips {
      margin-top: 8px;
    }

    .pf-a-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.10);
      background: #fff;
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
    }

    .pf-a-pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      flex: 0 0 auto;
    }

    .pf-a-pill--ok {
      border-left: 6px solid #22a06b;
    }

    .pf-a-pill--ok .pf-a-pill-dot {
      background: #22a06b;
    }

    .pf-a-pill--bad {
      border-left: 6px solid #ef4444;
    }

    .pf-a-pill--bad .pf-a-pill-dot {
      background: #ef4444;
    }

    .pf-a-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .pf-a-card {
      background: #fff;
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 16px;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      min-height: 0;
      height: auto;
    }

    .pf-a-card-title {
      font-weight: 800;
      color: #0f172a;
      margin-bottom: 10px;
    }

    /* Detected allergens header: centered title + chip on same row */
    .pf-a-card-head {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .pf-a-card-title--center {
      margin: 0 !important;
      text-align: center;
    }
    .pf-a-chip--head {
      padding: 6px 10px;
      font-size: 0.9rem;
      line-height: 1;
      flex-shrink: 0;
    }

    .pf-a-muted {
      color: #64748b;
      font-size: 14px;
      line-height: 1.4;
    }

    .pf-a-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pf-a-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 40px;
      width: auto;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(14,165,164,0.22);
      background: transparent;
      font-size: 14px;
      font-weight: 700;
      line-height: 1.2;
      color: #0f172a;
      white-space: nowrap;
    }
    
    .pf-a-chip .serving {
      color: #0F172A99;
    }

    .pf-a-chip--danger {
      border-color: rgba(239, 68, 68, 0.35);
      background: transparent;
    }

    .pf-a-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pf-a-tag {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(15, 23, 42, 0.16);
      background: transparent;
      font-size: 13px;
      color: #0f172a;
    }

    .pf-a-acc {
      background: #fff;
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 16px;
      overflow: hidden;
    }

    .pf-a-acc-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      background: #fff;
      border: 0;
      text-align: left;
      cursor: pointer;
      font-weight: 800;
      color: #0f172a;
    }

    .pf-a-acc-btn:focus {
      outline: 2px solid rgba(47, 158, 153, 0.35);
      outline-offset: 2px;
    }

    .pf-a-acc-panel {
      padding: 10px 14px 12px 14px;
      height: auto;
      min-height: 0;
      color: #334155;
    }

    .pf-a-acc-panel .pf-a-list {
      margin: 0;
      padding-left: 18px;
    }

    .pf-a-acc-panel .pf-a-list li {
      margin: 6px 0;
      line-height: 1.45;
    }

    .pf-a-acc-panel[hidden] {
      display: none !important;
    }

    .pf-a-acc-panel:not([hidden]) {
      display: block !important;
      height: auto !important;
      min-height: 0 !important;
    }

    .pf-a-list {
      margin: 0;
      padding-left: 18px;
      color: #0f172a;
    }

    .pf-a-list li {
      margin: 6px 0;
      color: #334155;
    }

    .pf-a-chipClamp {
      max-height: 72px;
      overflow: hidden;
      height: auto;
      min-height: 0;
    }

    .pf-a-chipClamp.is-expanded {
      max-height: none;
    }

    .pf-a-toggleRow {
      margin-top: 8px;
    }

    .pf-a-toggleBtn {
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #fff;
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 800;
      font-size: 13px;
      color: #0f172a;
      cursor: pointer;
    }

    .pf-a-toggleBtn:hover {
      background: rgba(15, 23, 42, 0.03);
    }

    /* Scoped override for Notes accordion panel (fix vertical gaps) */
    #pf-a-notes {
      display: block;
      height: auto !important;
      min-height: 0 !important;
      padding: 10px 14px 12px 14px !important;
      align-content: flex-start;
      justify-content: flex-start;
    }

    #pf-a-notes .pf-a-list {
      display: block !important;
      height: auto !important;
      min-height: 0 !important;
      margin: 0 !important;
      padding: 0 0 0 18px !important;
    }

    #pf-a-notes .pf-a-list li {
      display: list-item !important;
      margin: 0 0 12px 0 !important;
      line-height: 1.45 !important;
    }

    #pf-a-notes .pf-a-list li:last-child {
      margin-bottom: 0 !important;
    }

    /* FINAL FIX: Notes must start at top and never space-distribute */
#pf-a-notes.pf-a-acc-panel:not([hidden]){
  display: flex !important;
  flex-direction: column !important;
  justify-content: flex-start !important;
  align-items: flex-start !important;
  padding: 10px 14px 12px 14px !important;
  height: auto !important;
  min-height: 0 !important;
}

#pf-a-notes .pf-a-list{
  display: flex !important;
  flex-direction: column !important;
  justify-content: flex-start !important;
  align-items: flex-start !important;
  gap: 14px !important;

  margin: 0 !important;
  padding-left: 18px !important;
  height: auto !important;
  min-height: 0 !important;
}

#pf-a-notes .pf-a-list li{
  display: list-item !important;
  margin: 0 !important;
  line-height: 1.45 !important;
}

    /* Match Groups panel spacing to Notes */
    #pf-a-groups.pf-a-acc-panel:not([hidden]){
      display: flex !important;
      flex-direction: column !important;
      justify-content: flex-start !important;
      align-items: flex-start !important;
      padding: 10px 14px 12px 14px !important;
      height: auto !important;
      min-height: 0 !important;
    }

    #pf-a-groups .pf-a-tags{
      display: flex !important;
      flex-wrap: wrap !important;
      justify-content: flex-start !important;
      align-items: flex-start !important;
      gap: 10px !important;
      margin: 0 !important;
      padding: 0 !important;
    }


    #pf-a-notes .pf-a-list li {
      display: list-item !important;
      margin: 0 0 12px 0 !important;
      line-height: 1.45 !important;
    }

    #pf-a-notes .pf-a-list li:last-child {
      margin-bottom: 0 !important;
    }

    /* HB pills (filter/info) */
    .pf-hb-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(15,23,42,.10);background:#fff;font-weight:900;font-size:13px;color:#0f172a;white-space:nowrap}
    .pf-hb-pill--filter{border-style:dashed}
    .pf-hb-pill--note{background:#f8fafc}

    /* ---------- Health Benefits tab: compact redesign (pf-hb2-*) ---------- */
    .pf-hb2-wrap{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:16px}
    .pf-hb2-header{display:flex;flex-direction:column;gap:8px}
    .pf-hb2-title{font-size:18px;font-weight:900;color:#0f172a;line-height:1.2;margin:0}
    .pf-hb2-subtitle{color:#64748b;font-size:13.5px;line-height:1.35}
    .pf-hb2-header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .pf-hb2-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(14,165,164,0.22);background:transparent;font-weight:700;font-size:14px;color:#0f172a;white-space:nowrap}
    .pf-hb2-chip .serving{color:#0F172A99}
    .pf-hb2-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:1px solid rgba(15,23,42,.10);background:#fff;font-weight:700;font-size:12px;color:#64748b;white-space:nowrap}
    .pf-hb2-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:768px){.pf-hb2-grid{grid-template-columns:1fr}}
    .pf-hb2-card{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .pf-hb2-cardHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .pf-hb2-name{font-weight:900;color:#0f172a;font-size:14px;line-height:1.3}
    .pf-hb2-tag{font-size:.75rem;padding:5px 10px;border-radius:999px;border:1px solid rgba(14,165,164,.25);background:linear-gradient(135deg,rgba(14,165,164,.08) 0%,rgba(14,165,164,.04) 100%);color:#0ea5a9;font-weight:700;white-space:nowrap;box-shadow:0 1px 2px rgba(14,165,164,.1)}
    .pf-hb2-desc{color:#334155;font-size:.9rem;line-height:1.45;display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .pf-hb2-acc{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:12px;overflow:hidden}
    .pf-hb2-acc-btn{width:100%;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;font-weight:700;color:#0f172a;background:transparent;border:0;cursor:pointer;font-size:13px}
    .pf-hb2-acc-panel{padding:12px 14px;border-top:1px solid rgba(15,23,42,.08)}
    .pf-hb2-acc-panel[hidden]{display:none !important}
    .pf-hb2-nutrients{display:flex;flex-wrap:wrap;gap:8px}
    .pf-hb2-nutr{font-size:.8rem;padding:6px 10px;border-radius:999px;background:#f8fafc;border:1px solid rgba(15,23,42,.08);color:#0f172a}
    .pf-hb2-list{margin:0;padding-left:18px}
    .pf-hb2-list li{margin:6px 0;color:#334155;line-height:1.45;font-size:.9rem}

    /* Feedback Modal */
    #feedback-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    #feedback-modal[style*="display: flex"] {
      display: flex !important;
    }
    .feedback-open:hover {
      background: #f8fafc;
      border-color: rgba(15,23,42,0.25);
    }
    /* Keep only the floating feedback FAB. Hide any other Feedback opener button. */
    button.feedback-open:not(.feedback-fab) {
      display: none !important;
    }
    #feedback-modal button[type="submit"]:hover {
      background: #0b7f7e;
    }
    #feedback-modal button[type="button"]:hover {
      background: #f8fafc;
    }
    .feedback-fab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 10001;
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.18);
      background: #fff;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    .feedback-fab:hover {
      background: #f8fafc;
    }
  </style>
  <script src="{{ url_for('static', filename='js/security.js') }}"></script>
  <script nonce="{{ csp_nonce }}">
    // Check session validity immediately (before page renders)
    // This runs as early as possible to catch invalidated sessions
    console.log('[SESSION CHECK] Starting early session check...');
    (async function checkSessionEarly() {
      try {
        console.log('[SESSION CHECK] Fetching /api/session-check...');
        const response = await fetch('/api/session-check', {
          credentials: 'same-origin',
          method: 'GET'
        });
        
        console.log('[SESSION CHECK] Response status:', response.status, 'ok:', response.ok);
        
        if (response.status === 401) {
          try {
            const data = await response.json();
            console.log('[SESSION CHECK] 401 response data:', data);
            if (data.error === 'session_invalidated') {
              // Session was invalidated (e.g., logged in from another device)
              console.log('[SESSION CHECK] Session invalidated! Redirecting to login...');
              const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
              window.location.href = `/login?next=${nextUrl}`;
              return;
            }
            // If error === 'auth_required', do nothing (free mode - allow access)
            console.log('[SESSION CHECK] auth_required (free mode, ignoring)');
          } catch (parseError) {
            console.warn('[SESSION CHECK] Could not parse 401 response:', parseError);
          }
        } else if (response.ok) {
          const data = await response.json();
          console.log('[SESSION CHECK] Valid session:', data);
        } else {
          console.log('[SESSION CHECK] Unexpected status:', response.status);
        }
      } catch (error) {
        // Network errors are logged but don't block page load
        console.error('[SESSION CHECK] Network error:', error);
      }
    })();
  </script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive_overrides.css') }}">
</head>
<body>
  {% include "_navbar.html" %}

  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>Nutrition & Allergen</h1>
      <p class="subtitle">Explore health categories, discover ingredients, and analyze nutrition data</p>
    </header>

    <!-- Main App Tabs: Ingredient vs Smoothie -->
    <div class="main-tabs-container">
      <div class="main-tabs">
        <button class="main-tab active" data-main-tab="ingredient">
          <span>🥗</span> Ingredient Analysis
        </button>
        <button class="main-tab" data-main-tab="smoothie">
          <span>🥤</span> Smoothie Builder
        </button>
      </div>
    </div>

    <!-- Ingredient Analysis Tab Content -->
    <div id="ingredient-tab-content" class="main-tab-content active">
      <!-- Search Area - Centered -->
      <div class="search-area-container">
      <div class="card search-container">
        <div class="card-header">
          <div>
            <div class="card-title">Search & Analyze Ingredients</div>
            <div class="card-subtitle">Type ingredient names or browse categories below</div>
          </div>
        </div>

        <!-- Ingredients Input -->
        <div class="ingredients-textarea-section">
          <label for="ingredients-input" class="textarea-label">Ingredients</label>
          <textarea
            id="ingredients-input"
            class="ingredients-textarea"
            placeholder="Enter ingredients separated by commas (e.g., mango, spinach, chicken breast)..."
              rows="2"
          ></textarea>
          <!-- Error Message Container -->
          <div id="ingredient-error-message" class="error-message" style="display: none;"></div>
        </div>

        <div id="selected-ingredients" class="selected-ingredients" style="display: none;">
        </div>

        <button id="analyze-btn" class="btn-primary" disabled>
          ⚡ Analyze Ingredients
        </button>
      </div>
    </div>

      <!-- Browse Ingredients & Analysis Results Side by Side -->
      <div class="browse-results-grid pf-ia-equal-row">
        <!-- Left: Browse Ingredients -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Browse Ingredients</div>
          <div class="card-subtitle">Select categories and ingredients to analyze</div>
        </div>
      </div>

      <!-- Sticky Selected Summary -->
      <div class="selected-summary" id="selected-summary">
        <div class="selected-item">
          <span class="selected-label">Goal:</span>
          <span class="selected-value" id="selected-goal-display">None</span>
        </div>
        <div class="selected-item">
          <span class="selected-label">Sub-category:</span>
          <span class="selected-value" id="selected-subcat-display">None</span>
        </div>
        <div class="selected-item">
          <span class="selected-label">Selected:</span>
          <span class="selected-value" id="selected-count-display">0 ingredients</span>
        </div>
      </div>

      <!-- Goal-Driven Layout -->
      <div class="browse-ingredients-layout">
        <!-- Step 1: Health Goals (Horizontal Chips) -->
        <div class="goals-section">
          <div class="section-header-compact">
            <h3 class="section-title-compact">Health Goals</h3>
            <input type="text" class="search-input-compact" id="goal-search" placeholder="Search goals..." />
          </div>
          <div class="goals-chips" id="category-list">
            <div class="empty-state">Loading categories...</div>
          </div>
          <button type="button" class="pf-goal-browse-toggle" id="pf-goal-browse-toggle" style="display: none;" aria-expanded="false">Browse all goals</button>
        </div>

        <!-- Step 2: Sub-categories (Chip Grid) -->
        <div class="subcategories-section" id="subcategories-section" style="display: none;">
          <div class="section-header-compact">
            <h3 class="section-title-compact">Sub-categories</h3>
            <button class="toggle-show-all" id="toggle-subcats" style="display: none;">Show all</button>
          </div>
          <div class="subcategories-grid" id="subcategory-list">
            <div class="empty-state">Select a category first</div>
          </div>
        </div>

        <!-- Step 3: Ingredients (Recommended + All) -->
        <div class="ingredients-section" id="ingredients-section" style="display: none;">
          <div class="section-header-compact">
            <h3 class="section-title-compact">Ingredients</h3>
            <input type="text" class="search-input-compact" id="ingredient-search" placeholder="Search ingredients..." />
          </div>
          
          <!-- Recommended Ingredients -->
          <div class="recommended-ingredients" id="recommended-ingredients" style="display: none;">
            <h4 class="subsection-title">Recommended</h4>
            <div class="ingredients-grid-compact" id="recommended-list"></div>
          </div>

          <!-- All Ingredients -->
          <div class="all-ingredients">
            <h4 class="subsection-title">All Ingredients</h4>
            <div class="ingredients-grid-compact" id="ingredient-list">
            <div class="empty-state">Select a sub-category to see ingredients</div>
            </div>
          </div>
        </div>
      </div>
      </div>

      <!-- Right: Analysis Results -->
      <div class="card results-container" id="ingredient-results-card">
        <div class="results-header">
          <h2 class="card-title">Analysis Results</h2>
          <div class="status-indicator">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Ready to analyze</span>
          </div>
        </div>
        <div class="tabs">
          <button class="tab active" data-tab="nutrition">Nutrition</button>
          <button class="tab" data-tab="allergens">Allergens</button>
          <button class="tab" data-tab="health-benefits">Health Benefits</button>
        </div>
                <!-- Separate scrollable containers for each tab -->
        <div class="tab-pane active" id="nutrition-tab-pane" data-tab="nutrition">
          <div class="results-body" id="nutrition-results-body">
            When you analyze ingredients, the results will appear here. Select ingredients from the panels below and click "Analyze Ingredients" to get started.
          </div>
        </div>

        <div class="tab-pane" id="allergens-tab-pane" data-tab="allergens" style="display: none;">
          
          <!-- My Allergen Profile (saved on this device) -->
          <div class="pf-ap" id="allergen-profile">
            <div class="pf-ap-head">
              <div>
                <div class="pf-ap-title">My Allergen Profile</div>
                <div class="pf-ap-sub">Saved on this device. No account needed.</div>
              </div>
              <button type="button" class="pf-ap-clear" id="pf-ap-clear">Clear</button>
            </div>
            <div class="pf-ap-chips" id="pf-ap-chips"></div>
          </div>

          <div class="results-body" id="allergens-results-body">
            When you analyze ingredients, allergen information will appear here.
          </div>
        </div>

        <div class="tab-pane" id="health-benefits-tab-pane" data-tab="health-benefits" style="display: none;">
          <div class="results-body" id="health-benefits-results-body">
            When you analyze ingredients, health benefits will appear here.
          </div>
        </div>
      </div> <!-- /.card.results-container -->
    </div> <!-- /.main-content-grid -->
  </div> <!-- /#ingredient-tab-content -->

    <!-- End Ingredient Analysis Tab Content -->

    <!-- Feedback Modal -->
    <div id="feedback-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
      <div style="background: #fff; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h3 style="margin: 0 0 20px 0; font-size: 1.25rem; font-weight: 700; color: #0f172a;">Send Feedback</h3>
        <form id="feedback-form">
          <div style="margin-bottom: 16px;">
            <label for="feedback-category" style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #334155;">Category</label>
            <select id="feedback-category" style="width: 100%; padding: 10px; border: 1px solid rgba(15,23,42,0.15); border-radius: 8px; font-size: 0.95rem;">
              <option value="bug">Bug</option>
              <option value="idea">Idea</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div style="margin-bottom: 16px;">
            <label for="feedback-email" style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #334155;">Email (optional)</label>
            <input type="email" id="feedback-email" style="width: 100%; padding: 10px; border: 1px solid rgba(15,23,42,0.15); border-radius: 8px; font-size: 0.95rem; box-sizing: border-box;">
          </div>
          <div style="margin-bottom: 16px;">
            <label for="feedback-message" style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #334155;">Message <span style="color: #ef4444;">*</span></label>
            <textarea id="feedback-message" required rows="5" placeholder="Describe your feedback..." style="width: 100%; padding: 10px; border: 1px solid rgba(15,23,42,0.15); border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
            <div style="margin-top: 4px; font-size: 0.8rem; color: #64748b;">5–1500 characters</div>
          </div>
          <div id="feedback-status" style="margin-bottom: 16px; font-size: 0.9rem;"></div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" id="feedback-cancel" style="padding: 10px 20px; border: 1px solid rgba(15,23,42,0.15); background: #fff; color: #0f172a; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
            <button type="submit" id="feedback-send" style="padding: 10px 20px; border: none; background: #0EA5A4; color: #fff; border-radius: 8px; font-weight: 600; cursor: pointer;">Send</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Smoothie Builder Tab Content -->
    <div id="smoothie-tab-content" class="main-tab-content">
      <div class="main-content-grid">
        <!-- Left: Smoothie Builder -->
        <div class="card search-container">
          <div class="card-header">
            <div>
              <div class="card-title">🥤 Smoothie Builder</div>
              <div class="card-subtitle">Create custom smoothies and view nutrition</div>
            </div>
          </div>

          <!-- Hidden input for smoothie name (used by updateSmoothieRecipe) -->
          <input type="hidden" id="smoothie-name" value="" />

          <!-- Smoothie Name Display Bar -->
          <div id="smoothie-name-bar" style="display: none; margin-bottom: 20px; padding: 18px 24px; background: linear-gradient(135deg, #0EA5A4 0%, #0B7F7E 100%); border-radius: var(--radius); box-shadow: 0 4px 12px rgba(14, 165, 164, 0.2);">
            <div style="display: flex; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
              <span style="font-size: 1.8rem; flex-shrink: 0; margin-top: 2px;">🥤</span>
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.85); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px; font-weight: 600;">Your Smoothie</div>
                <div id="smoothie-name-display" style="font-size: 1.3rem; font-weight: 700; color: white; line-height: 1.3; margin-bottom: 12px;">My Smoothie</div>
                <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                  <div id="smoothie-audience-display" style="display: none; align-items: center; gap: 6px;">
                    <span style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.7); font-weight: 500;">Who is this for:</span>
                    <span id="smoothie-audience-value" style="font-size: 0.85rem; color: white; font-weight: 600; background: rgba(255, 255, 255, 0.15); padding: 4px 10px; border-radius: 6px; backdrop-filter: blur(4px);">—</span>
                  </div>
                  <div id="smoothie-timing-display" style="display: none; align-items: center; gap: 6px;">
                    <span style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.7); font-weight: 500;">Timing:</span>
                    <span id="smoothie-timing-value" style="font-size: 0.85rem; color: white; font-weight: 600; background: rgba(255, 255, 255, 0.15); padding: 4px 10px; border-radius: 6px; backdrop-filter: blur(4px);">—</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 1. Who is this smoothie for -->
          <div class="search-section">
            <label for="smoothie-for" class="textarea-label">Who is this smoothie for?</label>
            <select id="smoothie-for" class="search-input" style="cursor: pointer;">
              <option value="">Select Target Audience...</option>
              <option value="child-4-6">Child 4–6</option>
              <option value="child-7-8">Child 7–8</option>
              <option value="girl-9-13">Girl 9-13</option>
              <option value="boy-9-13">Boy 9-13</option>
              <option value="girl-14-18">Girl 14-18</option>
              <option value="boy-14-18">Boy 14-18</option>
              <option value="woman-19-30">Woman 19-30</option>
              <option value="man-19-30">Man 19-30</option>
              <option value="woman-31-59">Woman 31-59</option>
              <option value="man-31-59">Man 31-59</option>
              <option value="woman-60+">Woman 60+</option>
              <option value="man-60+">Man 60+</option>
            </select>
          </div>

          <!-- 2. Timing -->
          <div class="search-section">
            <label for="smoothie-timing" class="textarea-label">Timing</label>
            <select id="smoothie-timing" class="search-input" style="cursor: pointer;">
              <option value="">Select timing...</option>
              <option value="breakfast">Breakfast</option>
              <option value="morning-snack">Morning Snack</option>
              <option value="lunch">Lunch</option>
              <option value="afternoon-snack">Afternoon Snack</option>
              <option value="dinner">Dinner</option>
              <option value="pre-workout">Pre-Workout</option>
              <option value="post-workout">Post-Workout</option>
              <option value="bedtime">Bedtime</option>
              <option value="anytime">Anytime</option>
            </select>
          </div>

          <!-- 3. Health Goals -->
          <div class="search-section">
            <label for="smoothie-health-goals" class="textarea-label">Health Goals</label>
            <select id="smoothie-health-goals" class="search-input" style="cursor: pointer;">
              <option value="">Select health goal...</option>
              <!-- Options will be populated dynamically from categories -->
            </select>
          </div>

          <!-- Blood Sugar Goal Warning Container (shown when adult selects Diabetes–Blood Sugar goal) -->
          <div id="blood-sugar-goal-warning-container" style="display: none; margin-bottom: 15px;"></div>
          
          <!-- Weight Management Goal Warning Container (shown when adult selects Weight Management goal) -->
          <div id="weight-management-goal-warning-container" style="display: none; margin-bottom: 15px;"></div>
          
          <!-- Blood Pressure Goal Warning Container (shown when user selects Blood Pressure goal) -->
          <div id="blood-pressure-goal-warning-container" style="display: none; margin-bottom: 15px;"></div>

          <!-- 4. Ingredients -->
          <div class="search-section">
            <label for="smoothie-ingredient-search" class="textarea-label">Add Ingredients</label>
            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">
              <span>Limit: </span>
              <span style="color: var(--primary); font-weight: 600;">3 fresh fruits</span>
              <span> • </span>
              <span style="color: var(--primary); font-weight: 600;">1 dried fruit</span>
            </div>
            <input
              type="text"
              id="smoothie-ingredient-search"
              class="search-input"
              placeholder="🔍 Search for ingredients..."
              autocomplete="off"
            />
            <div id="smoothie-ingredient-suggestions" class="ingredient-suggestions"></div>
          </div>

          <!-- Selected Smoothie Ingredients -->
          <div id="smoothie-selected-ingredients" class="selected-ingredients" style="display: none; margin-bottom: 15px;"></div>
          
          <!-- Vegan Milk Recommendation Container (shown when non-recommended milk is selected for kids 4-8) -->
          <div id="vegan-milk-recommendation-container" style="display: none; margin-bottom: 15px;"></div>

          <!-- Smoothie Actions -->
          <div class="sn-actions" style="margin-top: auto;">
            <button id="build-smoothie-btn" class="btn-primary" disabled>
              🥤 Build Smoothie
            </button>
            <button id="smoothie-clear-btn">
              <span style="font-size: 1.1rem;">🗑️</span>
              <span>Clear</span>
            </button>
          </div>
        </div>

        <!-- Right: Smoothie Nutrition Results -->
        <div id="pf-smoothie-card-home"></div>
        <div class="card results-container pf-smoothie-hidden" id="smoothie-results-card">
          <div class="results-header">
            <h2 class="card-title">Smoothie Nutrition</h2>
            <div class="status-indicator">
              <span class="status-dot" id="smoothie-status-dot"></span>
              <span id="smoothie-status-text">Ready to build</span>
            </div>
          </div>
          <div class="results-body" id="smoothie-results-body">
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
              <div style="font-size: 3rem; margin-bottom: 15px;">🥤</div>
              <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No Smoothie Built Yet</div>
              <div style="font-size: 0.9rem;">Add ingredients and click "Build Smoothie" to see nutrition information</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Smoothie Presets / Saved Recipes -->
      <div class="card" style="margin-top: 25px;">
        <div class="card-header">
          <div>
            <div class="card-title">📚 Smoothie Presets</div>
            <div class="card-subtitle">Quick-start recipes for different health goals</div>
          </div>
        </div>
        <div id="smoothie-presets" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 10px 0;">
          <!-- Presets will be loaded here -->
        </div>
      </div>
    </div>
    <!-- End Smoothie Builder Tab Content -->
  </div> <!-- /.container -->

  <!-- Mobile Results Modal (used only in responsive mode) -->
<div id="pf-results-modal" class="pf-results-modal" style="display:none;" aria-hidden="true">
  <div class="pf-results-backdrop" data-close="1"></div>

  <div class="pf-results-sheet" role="dialog" aria-modal="true" aria-label="Analysis Results">
    <div class="pf-results-sheet-header">
      <div class="pf-results-sheet-title">Analysis Results</div>
      <button type="button" id="pf-results-close" class="pf-results-close" aria-label="Close">✕</button>
    </div>

    <div id="pf-results-sheet-body" class="pf-results-sheet-body"></div>
  </div>
</div>

<!-- Smoothie Results Modal (mobile/tablet only) -->
<div id="pf-smoothie-modal" class="pf-results-modal" style="display:none;" aria-hidden="true">
  <div class="pf-results-backdrop" data-close="1" data-modal="smoothie"></div>

  <div class="pf-results-sheet" role="dialog" aria-modal="true" aria-label="Smoothie Nutrition">
    <div class="pf-results-sheet-header">
      <div class="pf-results-sheet-title">Smoothie Nutrition</div>
      <button type="button" id="pf-smoothie-close" class="pf-results-close" aria-label="Close">✕</button>
    </div>

    <div id="pf-smoothie-sheet-body" class="pf-results-sheet-body"></div>
  </div>
</div>


  <script nonce="{{ csp_nonce }}">
    // DOM Elements
    const categoryListEl = document.getElementById('category-list');
    const subcatListEl = document.getElementById('subcategory-list');
    const ingredientListEl = document.getElementById('ingredient-list');
    const ingredientsInputEl = document.getElementById('ingredients-input');
    const selectedIngredientsEl = document.getElementById('selected-ingredients');
    const analyzeBtn = document.getElementById('analyze-btn');
    const ingredientErrorMessageEl = document.getElementById('ingredient-error-message');
    const statusDotEl = document.getElementById('status-dot');
    const statusTextEl = document.getElementById('status-text');
    const resultsBodyEl = document.getElementById('results-body'); // Keep for backward compatibility
    const nutritionResultsBodyEl = document.getElementById('nutrition-results-body');
    const allergensResultsBodyEl = document.getElementById('allergens-results-body');
    const healthBenefitsResultsBodyEl = document.getElementById('health-benefits-results-body');
    const tabs = document.querySelectorAll('.tab');
    const tabPanes = document.querySelectorAll('.tab-pane');

    /* Health Benefits selection context */
    window.pfHBContext = window.pfHBContext || { source: 'search', goal: null, goalLabel: null };
    function pfSetHBContext(source, goal, goalLabel) {
      window.pfHBContext = { source: source || 'search', goal: goal || null, goalLabel: goalLabel || null, ts: Date.now() };
      console.log('[HB_CTX]', window.pfHBContext);
    }
    function pfGetHBContext() {
      return window.pfHBContext || { source: 'search', goal: null, goalLabel: null };
    }
    window.pfInHealthBrowserFlow = window.pfInHealthBrowserFlow || false;
    window.pfActiveHealthGoalLabel = window.pfActiveHealthGoalLabel || null;
    window.pfActiveHealthGoalValue = window.pfActiveHealthGoalValue || null;

    // State
    let categories = [];
    let hierarchy = {};
    let selectedCategory = null;
    let selectedSubcategory = null;
    let currentIngredients = [];
    let selectedIngredients = [];
    let lastAnalysisResult = null;
    let searchTimeout = null;
    let tabScrollPositions = {
      'nutrition': 0,
      'allergens': 0,
      'health-benefits': 0
    };

    // Helpers
    function showIngredientError(message) {
      if (ingredientErrorMessageEl) {
        ingredientErrorMessageEl.textContent = message;
        ingredientErrorMessageEl.style.display = 'flex';
      }
    }
    
    function hideIngredientError() {
      if (ingredientErrorMessageEl) {
        ingredientErrorMessageEl.style.display = 'none';
        ingredientErrorMessageEl.textContent = '';
      }
    }

    function resetBrowseAfterAnalyze() {
      // Reset state
      selectedCategory = null;
      selectedSubcategory = null;
      currentIngredients = [];
      selectedIngredients = [];

      // Clear UI selections
      document.querySelectorAll('.goal-chip.active').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.subcategory-chip.active').forEach(el => el.classList.remove('active'));

      // Clear selected ingredient pills/list
      if (selectedIngredientsEl) selectedIngredientsEl.innerHTML = '';

      // Clear input box
      if (ingredientsInputEl) ingredientsInputEl.value = '';

      // Clear recommended + ingredients lists
      const recommendedEl = document.getElementById('recommended-list');
      if (recommendedEl) recommendedEl.innerHTML = '';

      if (subcatListEl) {
        subcatListEl.innerHTML = `<div class="empty-state">Select a goal first</div>`;
      }

      if (ingredientListEl) {
        ingredientListEl.innerHTML = `<div class="empty-state">Select a sub-category to see ingredients</div>`;
      }

      // Update the summary bar
      if (typeof updateSelectedSummary === 'function') {
        updateSelectedSummary();
      }

      // Also clear any ingredient error
      hideIngredientError?.();
    }

    function scrollToSubcategories() {
      const el = document.getElementById('subcategories-section');
      if (!el) return;

      // If still hidden, don't scroll yet
      const isHidden = (el.style.display === 'none') || el.offsetParent === null;
      if (isHidden) return;

      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const rect = el.getBoundingClientRect();

      // If it's already visible enough, don't jump
      if (rect.top >= 0 && rect.top < window.innerHeight * 0.35) return;

      const offset = 90; // adjust if navbar overlaps
      const top = window.scrollY + rect.top - offset;

      window.scrollTo({ top, behavior: prefersReduced ? 'auto' : 'smooth' });
    }

    function scrollToIngredients() {
      const el = document.getElementById('ingredients-section');
      if (!el) return;

      // If still hidden, don't scroll
      const isHidden = (el.style.display === 'none') || el.offsetParent === null;
      if (isHidden) return;

      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const rect = el.getBoundingClientRect();

      // If already visible enough, don't scroll
      const alreadyVisible = rect.top >= 0 && rect.top < window.innerHeight * 0.35;
      if (alreadyVisible) return;

      const offset = 90; // match your navbar spacing (adjust if needed)
      const top = window.scrollY + rect.top - offset;

      window.scrollTo({ top, behavior: prefersReduced ? 'auto' : 'smooth' });
    }

    let scrollToSearchTimer = null;

    function scrollToSearchArea() {
      const input = ingredientsInputEl || document.getElementById('ingredients-input');
      if (!input) return;

      // Anchor to the Search card so the section title is visible (not just the input)
      const anchor = input.closest('.card') || input;

      // If anchor is hidden, don't scroll
      if (anchor.offsetParent === null) return;

      const prefersReduced = !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
      const rect = anchor.getBoundingClientRect();
      const vh = window.innerHeight || document.documentElement.clientHeight || 800;

      // If already reasonably visible, just focus (no scroll)
      const topOk = rect.top >= vh * 0.10 && rect.top <= vh * 0.45;
      const bottomOk = rect.bottom <= vh * 0.95;
      if (topOk && bottomOk) {
        try { input.focus({ preventScroll: true }); } catch { input.focus(); }
        return;
      }

      // Dynamic offset: place the card top around ~40% of viewport so header is visible (matches desired screenshot)
      const navbar = document.querySelector('.navbar') || document.querySelector('nav') || document.querySelector('header nav');
      const navH = navbar ? navbar.getBoundingClientRect().height : 0;

      const desiredOffset = Math.round(Math.min(vh * 0.55, Math.max(navH + 16, vh * 0.40)));
      const targetTop = window.scrollY + rect.top - desiredOffset;

      window.scrollTo({ top: Math.max(0, targetTop), behavior: prefersReduced ? 'auto' : 'smooth' });

      // Focus after scroll without triggering another scroll
      const focusDelay = prefersReduced ? 0 : 250;
      setTimeout(() => {
        try { input.focus({ preventScroll: true }); } catch { input.focus(); }
      }, focusDelay);
    }
    
    // Toast notification system
    function showToast(message, type = 'info', duration = 5000) {
      const toastContainer = document.getElementById('toast-container');
      if (!toastContainer) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = type === 'success' ? '✓' : type === 'warning' ? '⚠' : type === 'error' ? '✕' : 'ℹ';
      
      const iconEl = document.createElement('div');
      iconEl.className = 'toast-icon';
      iconEl.textContent = icon;

      const contentEl = document.createElement('div');
      contentEl.className = 'toast-content';

      const messageEl = document.createElement('div');
      messageEl.className = 'toast-message';
      messageEl.textContent = message;

      contentEl.appendChild(messageEl);

      const closeBtn = document.createElement('button');
      closeBtn.className = 'toast-close';
      closeBtn.setAttribute('aria-label', 'Close');
      closeBtn.textContent = '×';

      const progressEl = document.createElement('div');
      progressEl.className = 'toast-progress';

      toast.appendChild(iconEl);
      toast.appendChild(contentEl);
      toast.appendChild(closeBtn);
      toast.appendChild(progressEl);
      
      toastContainer.appendChild(toast);
      
      // Auto-remove after duration
      const timeout = setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, duration);
      
      // Manual close
      closeBtn.addEventListener('click', () => {
        clearTimeout(timeout);
        toast.classList.add('hiding');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      });
    }
    
    // Flag to track if dried fruit tip has been shown
    let hasShownDriedFruitTip = false;
    
    /**
     * Reset the dried fruit tip flag (call when a dried fruit is removed)
     */
    function resetDriedFruitTip() {
      hasShownDriedFruitTip = false;
    }
    
    /**
     * Show a gentle tip when a dried fruit is added
     * The tip will show again if the user removes the current dried fruit and adds a different one
     * @param {string} ingredientName - The name of the ingredient being added
     */
    function maybeShowDriedFruitTip(ingredientName) {
      if (!ingredientName) return;
      
      // Check if this is a dried fruit (starts with "dried_" or is identified as a dried fruit by isDriedFruit)
      // Normalize the name to check for "dried_" prefix
      const nameLower = ingredientName.toLowerCase().trim();
      const normalizedName = nameLower.replace(/\s+/g, '_');
      
      // Check if it starts with "dried_" or is identified as a dried fruit by isDriedFruit
      const isDried = normalizedName.startsWith('dried_') || isDriedFruit(ingredientName);
      
      if (!isDried) {
        return;
      }
      
      // Show the tip if it hasn't been shown yet (flag is reset when a dried fruit is removed)
      if (hasShownDriedFruitTip) {
        return;
      }
      
      // Mark as shown
      hasShownDriedFruitTip = true;
      
      // Show the tip with the exact message text requested
      const tipMessage = `Tip for dried fruits 🧊<br><br>For a softer texture and gentler taste, soak dried fruits in water (or milk) for a few hours or overnight before adding them to the smoothie. This can make them easier to blend and kinder to teeth and stomach, especially for kids.`;
      
      showToast(tipMessage, 'info', 8000);
    }
    
    function setStatus(text, isError = false) {
      statusTextEl.textContent = text;
      statusDotEl.classList.toggle('error', isError);
    }

    function renderSelectedIngredients() {
      console.log('[renderSelectedIngredients] Called. selectedIngredients:', selectedIngredients);
      
      if (selectedIngredients.length === 0) {
        selectedIngredientsEl.style.display = 'none';
        selectedIngredientsEl.innerHTML = '';
        // Check textarea for enable/disable
        const hasText = ingredientsInputEl.value.trim().length > 0;
        analyzeBtn.disabled = !hasText;
        console.log('[renderSelectedIngredients] No ingredients, hiding chips');
        return;
      }

      selectedIngredientsEl.style.display = 'flex';
      analyzeBtn.disabled = false;
      
      // Clear existing chips
      selectedIngredientsEl.innerHTML = '';

      // Build chips using DOM APIs to avoid injecting unsanitized HTML
      selectedIngredients.forEach((ing, idx) => {
        const chip = document.createElement('div');
        chip.className = 'ingredient-chip fade-in';

        const label = document.createElement('span');
        label.textContent = ing;

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.dataset.index = String(idx);
        removeBtn.title = 'Remove';
        removeBtn.textContent = '×';

        chip.appendChild(label);
        chip.appendChild(removeBtn);
        selectedIngredientsEl.appendChild(chip);
      });
      console.log('[renderSelectedIngredients] Rendered', selectedIngredients.length, 'chips');

      // Re-attach remove button handlers
      selectedIngredientsEl.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          // Cancel pending "scroll back to search" if user removed quickly
          if (scrollToSearchTimer) {
            clearTimeout(scrollToSearchTimer);
            scrollToSearchTimer = null;
          }
          
          e.preventDefault();
          e.stopPropagation();
          const idx = parseInt(btn.dataset.index);
          const removedIngredient = selectedIngredients[idx];
          selectedIngredients.splice(idx, 1);
          renderSelectedIngredients();
          syncTextareaFromSelected(); // Sync textarea when removing
          updateSelectedSummary(); // Update summary
          
          // Refresh button states after removing (updates both Recommended and All Ingredients)
          if (removedIngredient) {
            refreshIngredientButtons(removedIngredient);
          }
        });
      });
    }

    // Sync textarea with selectedIngredients array
    function syncTextareaFromSelected() {
      if (ingredientsInputEl) {
        ingredientsInputEl.value = selectedIngredients.join(', ');
        // Update analyze button state
        analyzeBtn.disabled = selectedIngredients.length === 0 && ingredientsInputEl.value.trim().length === 0;
      }
    }

    // Helper functions for ingredient button state management
    function ingredientKey(name) {
      return (name || '').trim().toLowerCase();
    }

    function isIngredientSelected(name) {
      const key = ingredientKey(name);
      return selectedIngredients.some(x => ingredientKey(x) === key);
    }

    function setAddButtonState(btn, name) {
      if (!btn) return;
      const selected = isIngredientSelected(name);

      if (selected) {
        btn.textContent = 'Added';
        btn.disabled = true;
        btn.classList.add('added');
        btn.setAttribute('aria-disabled', 'true');
      } else {
        btn.textContent = 'Add';
        btn.disabled = false;
        btn.classList.remove('added');
        btn.removeAttribute('aria-disabled');
      }
    }

    function refreshIngredientButtons(name) {
      const key = ingredientKey(name);
      document
        .querySelectorAll(`button[data-ingredient-key="${CSS.escape(key)}"]`)
        .forEach(btn => setAddButtonState(btn, name));
    }

    function addIngredient(ingredient) {
      console.log('[addIngredient] Called with:', ingredient);
      console.log('[addIngredient] Current selectedIngredients:', selectedIngredients);
      
      // Ingredient tab: single-ingredient only - replace previous selection
      const previousSelected = selectedIngredients.length > 0 ? selectedIngredients[0] : null;
      
      // Replace with new ingredient (single selection only)
      selectedIngredients = [ingredient];
      console.log('[addIngredient] Replaced selection. New array:', selectedIngredients);
        
        renderSelectedIngredients();
        syncTextareaFromSelected(); // Sync textarea immediately
        updateSelectedSummary(); // Update summary
        setStatus(`Added "${ingredient}"`);
        
      // Refresh button states for the newly added ingredient
        refreshIngredientButtons(ingredient);
      
      // If there was a previous selection and it's different, revert its button state
      if (previousSelected && previousSelected !== ingredient) {
        refreshIngredientButtons(previousSelected);
      }
      
      // Debounced: if user adds multiple ingredients quickly, scroll once after 2s
      if (scrollToSearchTimer) clearTimeout(scrollToSearchTimer);
      scrollToSearchTimer = setTimeout(() => {
        requestAnimationFrame(() => requestAnimationFrame(scrollToSearchArea));
      }, 2000);
        
        console.log('[addIngredient] After renderSelectedIngredients, selectedIngredientsEl.innerHTML length:', selectedIngredientsEl.innerHTML.length);
    }

    // Load Categories
    async function loadCategories() {
      try {
        setStatus('Loading categories...');
        const res = await fetch('/api/categories?format=ui');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        // Handle both formats: array of objects {value, label} or array of strings (legacy)
        if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object' && 'value' in data[0]) {
          categories = data; // Array of objects with value/label
        } else {
          // Legacy format: array of strings, convert to objects
          categories = data.map(cat => ({ value: cat, label: cat }));
        }
        renderCategories();
        // Populate smoothie health goals after categories are loaded
        populateSmoothieHealthGoals();
        setStatus('Categories loaded');
      } catch (err) {
        console.error(err);
        setStatus('Failed to load categories', true);
        categoryListEl.innerHTML = '<div class="empty-state">Error loading categories</div>';
      }
    }

    function renderCategories() {
      // Initialize state if not exists
      window.pfGoalSearchTerm = window.pfGoalSearchTerm || '';
      window.pfGoalBrowseAllOpen = window.pfGoalBrowseAllOpen || false;
      
      const searchTerm = (window.pfGoalSearchTerm || '').trim().toLowerCase();
      const isExpanded = window.pfGoalBrowseAllOpen || false;
      
      // Filter categories based on search
      let filteredCategories = categories;
      if (searchTerm) {
        filteredCategories = categories.filter(categoryObj => {
          const categoryLabel = typeof categoryObj === 'object' && 'label' in categoryObj ? categoryObj.label : categoryObj;
          return categoryLabel.toLowerCase().includes(searchTerm);
        });
      }
      
      // Determine which categories to show
      const showAll = isExpanded || filteredCategories.length <= 10;
      const categoriesToShow = showAll ? filteredCategories : filteredCategories.slice(0, 10);
      const hasMore = filteredCategories.length > 10 && !showAll;
      
      // Clear container
      categoryListEl.innerHTML = '';
      
      if (filteredCategories.length === 0) {
        categoryListEl.innerHTML = '<div class="pf-goal-empty">No goals found.</div>';
        // Hide browse toggle when no results
        const browseToggle = document.getElementById('pf-goal-browse-toggle');
        if (browseToggle) browseToggle.style.display = 'none';
        return;
      }

      // Get currently selected category value for highlighting
      const activeCategoryValue = selectedCategory || window.pfActiveHealthGoalValue;
      
      // Render chips
      categoriesToShow.forEach(categoryObj => {
        // Handle both object format {value, label} and string format (legacy)
        const categoryValue = typeof categoryObj === 'object' && 'value' in categoryObj ? categoryObj.value : categoryObj;
        const categoryLabel = typeof categoryObj === 'object' && 'label' in categoryObj ? categoryObj.label : categoryObj;
        
        const chip = document.createElement('div');
        chip.className = 'goal-chip';
        chip.textContent = categoryLabel; // Use label for display
        chip.dataset.categoryValue = categoryValue;
        
        // Preserve active state if this is the selected category
        if (activeCategoryValue && categoryValue === activeCategoryValue) {
          chip.classList.add('active');
        }
        
        chip.addEventListener('click', () => {
          [...categoryListEl.querySelectorAll('.goal-chip')].forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          selectedCategory = categoryValue; // Use value (original DB category) for API calls
          // Track active health goal (label for UI, value for backend filtering)
          window.pfActiveHealthGoalLabel = categoryLabel;
          window.pfActiveHealthGoalValue = categoryValue;
          
          console.log('[HB_GOAL_SET]', {
            label: window.pfActiveHealthGoalLabel,
            value: window.pfActiveHealthGoalValue,
            ctx: pfGetHBContext()
          });
          
          window.pfInHealthBrowserFlow = true;
          updateSelectedSummary();
          setStatus(`Selected "${categoryLabel}"`);
          loadSubcategories(categoryValue);
          // Show subcategories section
          document.getElementById('subcategories-section').style.display = 'block';
          // Hide ingredients section until subcategory is selected
          document.getElementById('ingredients-section').style.display = 'none';
        });
        categoryListEl.appendChild(chip);
      });
      
      // Show/hide browse toggle
      const browseToggle = document.getElementById('pf-goal-browse-toggle');
      if (browseToggle) {
        if (hasMore || (isExpanded && filteredCategories.length > 10)) {
          browseToggle.style.display = 'block';
          browseToggle.setAttribute('aria-expanded', String(isExpanded));
          browseToggle.textContent = isExpanded ? 'Hide all goals' : 'Browse all goals';
        } else {
          browseToggle.style.display = 'none';
        }
      }
    }

    // Load Hierarchy
    async function loadHierarchy() {
      try {
        const res = await fetch('/api/category-hierarchy');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        hierarchy = await res.json();
      } catch (err) {
        console.error(err);
        hierarchy = {};
      }
    }

    // Load Subcategories
    async function loadSubcategories(category) {
      subcatListEl.innerHTML = '<div class="empty-state">Loading subcategories...</div>';
      selectedSubcategory = null;
      ingredientListEl.innerHTML = '<div class="empty-state">Select a sub-category to see ingredients</div>';

      if (!hierarchy[category]) {
        subcatListEl.innerHTML = '<div class="empty-state">No subcategories found</div>';
        return;
      }

      const subcategories = Object.keys(hierarchy[category]);
      subcatListEl.innerHTML = '';

      if (subcategories.length === 0) {
        subcatListEl.innerHTML = '<div class="empty-state">No subcategories available</div>';
        return;
      }

      // Show/hide "Show all" toggle based on subcategory count
      const toggleBtn = document.getElementById('toggle-subcats');
      if (subcategories.length > 12) {
        toggleBtn.style.display = 'block';
        subcatListEl.classList.remove('expanded');
      } else {
        toggleBtn.style.display = 'none';
        subcatListEl.classList.add('expanded');
      }

      subcategories.forEach(subcatObj => {
        // Handle both object format {value, label} and string format (legacy)
        const subcatValue =
          (typeof subcatObj === 'object' && subcatObj && 'value' in subcatObj)
            ? subcatObj.value
            : subcatObj;

        const subcatLabel =
          (typeof subcatObj === 'object' && subcatObj && 'label' in subcatObj)
            ? subcatObj.label
            : subcatObj;

        const count = hierarchy[category][subcatObj]; // Use original subcatObj key for hierarchy lookup
        const chip = document.createElement('div');
        chip.className = 'subcategory-chip';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = subcatLabel; // Use label for display

        const countSpan = document.createElement('span');
        countSpan.className = 'count';
        countSpan.textContent = `${count}`;

        chip.appendChild(nameSpan);
        chip.appendChild(countSpan);
        chip.addEventListener('click', () => {
          [...subcatListEl.children].forEach(c => {
            if (c.classList) c.classList.remove('active');
          });
          chip.classList.add('active');
          // IMPORTANT: use subcatValue (exists now)
          selectedSubcategory = subcatValue;
          
          // show ingredients section
          const ingSec = document.getElementById('ingredients-section');
          if (ingSec) ingSec.style.display = ''; // let CSS decide
          
          // clear search box safely
          const s = document.getElementById('ingredient-search');
          if (s) s.value = '';

          updateSelectedSummary();
          setStatus(`Loading ingredients for "${subcatLabel}"...`);
          // load ingredients using VALUES (not labels)
          loadIngredients(selectedCategory, subcatValue);
          // Smoothly guide user to the next step
          requestAnimationFrame(() => requestAnimationFrame(scrollToIngredients));
        });
        subcatListEl.appendChild(chip);
      });

      // Show subcategories section now that chips are rendered
      const subSection = document.getElementById('subcategories-section');
      if (subSection) subSection.style.display = 'block';

      // Smoothly guide user to the next step (wait for paint)
      if (!selectedSubcategory) {
        requestAnimationFrame(() => requestAnimationFrame(scrollToSubcategories));
      }
    }

    // Load Ingredients
    async function loadIngredients(category, subcategory) {
      ingredientListEl.innerHTML = '<div class="empty-state">Loading ingredients...</div>';

      try {
        const res = await fetch(`/api/categories/${encodeURIComponent(category)}/${encodeURIComponent(subcategory)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Map to ingredient names and filter out blocked ingredients from Browse panel
        const allIngredients = data.map(item => item.ingredient || item.name || item);
        currentIngredients = allIngredients.filter(ing => !isBlockedFromBrowse(ing));
        
        // Log if any ingredients were filtered
        const filteredCount = allIngredients.length - currentIngredients.length;
        if (filteredCount > 0) {
          console.log(`[browse-ingredients] Filtered out ${filteredCount} blocked ingredient(s) from browse panel`);
        }
        
        renderIngredients(currentIngredients);
        setStatus(`Loaded ${currentIngredients.length} ingredients`);
      } catch (err) {
        console.error(err);
        setStatus('Failed to load ingredients', true);
        ingredientListEl.innerHTML = '<div class="empty-state">Error loading ingredients</div>';
      }
    }

    function renderIngredients(ingredients) {
      ingredientListEl.innerHTML = '';
      const recommendedListEl = document.getElementById('recommended-list');
      const recommendedSectionEl = document.getElementById('recommended-ingredients');

      if (ingredients.length === 0) {
        ingredientListEl.innerHTML = '<div class="empty-state">No ingredients found</div>';
        recommendedSectionEl.style.display = 'none';
        return;
      }

      // Show recommended section (first 8-12 ingredients)
      const recommendedCount = Math.min(10, Math.floor(ingredients.length * 0.3));
      const recommended = ingredients.slice(0, recommendedCount);
      const allIngredients = ingredients;

      // Render recommended ingredients
      if (recommended.length > 0) {
        recommendedListEl.innerHTML = '';
        recommended.forEach(ingredient => {
          const item = createIngredientItem(ingredient);
          recommendedListEl.appendChild(item);
        });
        recommendedSectionEl.style.display = 'block';
      } else {
        recommendedSectionEl.style.display = 'none';
      }

      // Render all ingredients
      allIngredients.forEach(ingredient => {
        const item = createIngredientItem(ingredient);
        ingredientListEl.appendChild(item);
      });
    }

    function createIngredientItem(ingredient) {
      const item = document.createElement('div');
      item.className = 'ingredient-item-compact';
      
        const nameSpan = document.createElement('span');
        nameSpan.textContent = ingredient;

      const addBtn = document.createElement('button');
      addBtn.className = 'add-btn';
      addBtn.textContent = 'Add';
      addBtn.dataset.ingredientKey = ingredientKey(ingredient);
      
      // Set initial button state based on whether ingredient is already selected
      setAddButtonState(addBtn, ingredient);
      
      item.appendChild(nameSpan);
      item.appendChild(addBtn);
        
      // Click handler - immediately adds ingredient
      item.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('[renderIngredients] Click detected on ingredient:', ingredient);
          
        // Set context based on selectedCategory, selectedSubcategory, empty search query, and active goal
        const q = (document.getElementById('ingredient-search')?.value || '').trim();
        const isBrowserPick = !!selectedCategory && !!selectedSubcategory && q.length === 0 && !!window.pfActiveHealthGoalValue;
        if (isBrowserPick) {
          pfSetHBContext('browser', window.pfActiveHealthGoalValue || null, window.pfActiveHealthGoalLabel || null);
        } else {
          pfSetHBContext('search', null, null);
        }
          
        // Visual feedback
        item.style.transform = 'scale(0.95)';
          setTimeout(() => {
          item.style.transform = '';
        }, 200);
          
        // Immediately add ingredient
          addIngredient(ingredient);
        updateSelectedSummary();
        
        // Refresh button states after adding (updates both Recommended and All Ingredients)
        refreshIngredientButtons(ingredient);
      });
      
      return item;
    }

    // Update selected summary display
    function updateSelectedSummary() {
      const goalDisplay = document.getElementById('selected-goal-display');
      const subcatDisplay = document.getElementById('selected-subcat-display');
      const countDisplay = document.getElementById('selected-count-display');
      
      // Always update goal: prefer window.pfActiveHealthGoalLabel (UI label), fallback to selectedCategory (backend value), then 'None'
      if (goalDisplay) {
        goalDisplay.textContent = window.pfActiveHealthGoalLabel || selectedCategory || 'None';
      }
      
      // Always update subcategory: prefer active chip text, fallback to state, then 'None'
      if (subcatDisplay) {
        const activeSubcatChip = document.querySelector('.subcategory-chip.active');
        const subText = activeSubcatChip?.textContent?.trim();
        // Remove count from chip text if present (e.g., "Fruits (25)" -> "Fruits")
        const cleanSubText = subText ? subText.replace(/\s*\(\d+\)\s*$/, '').trim() : null;
        subcatDisplay.textContent = cleanSubText || selectedSubcategory || 'None';
      }
      
      // Always update selected count: show 0 when empty
      if (countDisplay) {
        const count = selectedIngredients.length;
        countDisplay.textContent = `${count} ingredient${count !== 1 ? 's' : ''}`;
      }
    }

    // Initialize search and toggle features
    function initializeBrowseIngredientsFeatures() {
      // Goal search
      const goalSearchEl = document.getElementById('goal-search');
      if (goalSearchEl) {
        // Sync input value with state
        if (window.pfGoalSearchTerm) {
          goalSearchEl.value = window.pfGoalSearchTerm;
        }
        
        goalSearchEl.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          window.pfGoalSearchTerm = query;
          // If search is cleared, collapse browse all
          if (!query) {
            window.pfGoalBrowseAllOpen = false;
          }
          renderCategories();
        });
      }
      
      // Browse all goals toggle
      const browseToggle = document.getElementById('pf-goal-browse-toggle');
      if (browseToggle) {
        browseToggle.addEventListener('click', () => {
          window.pfGoalBrowseAllOpen = !window.pfGoalBrowseAllOpen;
          renderCategories();
        });
      }

      // Ingredient search
      const ingredientSearchEl = document.getElementById('ingredient-search');
      if (ingredientSearchEl) {
        ingredientSearchEl.addEventListener('input', (e) => {
          const q = (ingredientSearchEl.value || '').trim();
          if (q.length > 0) {
            pfSetHBContext('search', null, null);
            window.pfActiveHealthGoalLabel = null;
            window.pfActiveHealthGoalValue = null;
          }
          const query = e.target.value.toLowerCase().trim();
          const items = ingredientListEl.querySelectorAll('.ingredient-item-compact');
          const recommendedListEl = document.getElementById('recommended-list');
          const recommendedItems = recommendedListEl ? recommendedListEl.querySelectorAll('.ingredient-item-compact') : [];
          
          [...items, ...recommendedItems].forEach(item => {
            const text = item.querySelector('span').textContent.toLowerCase();
            item.style.display = text.includes(query) ? '' : 'none';
          });
        });
      }

      // Show all toggle for subcategories
      const toggleSubcatsBtn = document.getElementById('toggle-subcats');
      if (toggleSubcatsBtn) {
        toggleSubcatsBtn.addEventListener('click', () => {
          const isExpanded = subcatListEl.classList.contains('expanded');
          if (isExpanded) {
            subcatListEl.classList.remove('expanded');
            toggleSubcatsBtn.textContent = 'Show all';
          } else {
            subcatListEl.classList.add('expanded');
            toggleSubcatsBtn.textContent = 'Show less';
          }
        });
      }
    }


    // Update analyze button state based on textarea input
    // Note: When ingredients are added via browser, syncTextareaFromSelected() updates the textarea
    // When textarea is manually edited, this handler updates the button state
    ingredientsInputEl.addEventListener('input', () => {
      // When user types in search bar, set context to 'search' to show all benefits
      const hasText = ingredientsInputEl.value.trim().length > 0;
      analyzeBtn.disabled = !hasText && selectedIngredients.length === 0;
      // Clear error message when user starts typing
      if (hasText) {
        hideIngredientError();
      }
    });

    // Map UI ingredient names to nutrition database lookup keys
    // This is ONLY for the Ingredient tab nutrition lookup, not for smoothie logic
    
    // BROWSE INGREDIENTS BLOCKLIST
    // These ingredients are hidden from the Browse Ingredients panel ONLY.
    // They will be filtered out when rendering ingredient lists in the browse panel.
    // This does NOT affect the Smoothie tab or Ingredient tab analysis - those use separate blocklists.
    // Matching is case-insensitive and uses exact name comparison (not substring).
    const BROWSE_INGREDIENT_BLOCKLIST = new Set([
      'casein protein',
      'whey protein',
      'extra virgin olive oil',
      'tenderloin pork',
      'pork',
      'kelp',
      'seaweed',
      'ashwagandha',
      'chamomile',
      'holy basil',
      'lavender',
      'lemon balm',
      'passion flower',
      'rhodiola',
      'valerian root',
      'wheat germ',
      'sweet potatoes',
      'dandelion greens',
      'dandelion root',
      'milk thistle',
      'schisandra',
      'schis',
      'bananas',
      'sour pickles',
      'natto',
      'pickles',
      'raisins',
      'raw nuts',
      'sugar free gum',
      'fresh fruits',
      'fresh vegetables',
      'unsalted nuts',
      'nuts'
    ]);
    
    // Helper function to check if an ingredient should be hidden from Browse Ingredients panel
    function isBlockedFromBrowse(ingredientName) {
      if (!ingredientName || typeof ingredientName !== 'string') {
        return false;
      }
      const normalized = ingredientName.toLowerCase().trim();
      return BROWSE_INGREDIENT_BLOCKLIST.has(normalized);
    }
    
    // INGREDIENT TAB BLOCKED INGREDIENTS
    // These ingredients are blocked from analysis in the Ingredient tab ONLY.
    // They will be filtered out before sending to /api/analyze.
    // This does NOT affect the Smoothie tab - all ingredients remain available there.
    // Matching is case-insensitive and uses exact name comparison (not substring).
    const BLOCKED_INGREDIENT_NAMES = [
      "extra vergin olive oil",
      "nuts",
      "casein protien",
      "whey protien",
      "tenderliol pork",
      "pork",
      "kelp",
      "seaweed",
      "ashwagandha",
      "chamomile",
      "holy basil",
      "lavender",
      "lemon balm",
      "passion flower",
      "rhodiola",
      "valerian root",
      "wheat germ",
      "sweet potatoes",
      "dandelion greens",
      "dandelion root",
      "milk thistle",
      "schisandra",
      "schis",
      "bananas",
      "sour pickles",
      "natto",
      "pickles",
      "raisins",
      "raw nuts",
      "sugar free gum",
      "fresh fruits",
      "fresh vegetables",
      "unsalted nuts"
    ];
    
    // Helper function to check if an ingredient is blocked (case-insensitive, trimmed)
    function isBlockedIngredient(ingredientName) {
      if (!ingredientName || typeof ingredientName !== 'string') {
        return false;
      }
      const normalized = ingredientName.toLowerCase().trim();
      return BLOCKED_INGREDIENT_NAMES.some(blocked => blocked.toLowerCase().trim() === normalized);
    }

    // INGREDIENT TAB NUTRITION ALIASES
    // This mapping converts UI ingredient names to canonical database keys
    // for the Ingredient tab nutrition lookup ONLY.
    // Do NOT use this for smoothie serving-size logic.
    // The backend SQL query will look for these exact keys in the nutrition_facts table.
    const INGREDIENT_NUTRITION_ALIASES = {
      // Grains & Seeds
      'amaranth': 'amaranth',
      'buckwheat': 'buckwheat',
      'spirulina': 'spirulina',
      'chia seed': 'chia seeds',  // Map singular to plural DB key
      'chia seeds': 'chia seeds',
      'sesame seed': 'sesame seeds',  // Map singular to plural DB key
      'sesame seeds': 'sesame seeds',
      
      // Dried Fruits
      'dried fig': 'dried fig',
      'dried figs': 'dried fig',
      'prune': 'prune',
      'prunes': 'prune',
      'raisin': 'raisin',  // Both 'raisin' and 'raisins' exist in DB, use 'raisin' as canonical
      'raisins': 'raisin',
      'dried apricot': 'dried apricot',
      'dried apricots': 'dried apricot',
      'dried mango': 'dried mango',  // Must match exactly with nutrition_facts.ingredient
      'dried papaya': 'dried papaya',  // Must match exactly with nutrition_facts.ingredient
      'dried banana': 'dried banana',
      'dried blueberry': 'dried blueberries',  // Map singular to plural DB key
      'dried blueberries': 'dried blueberries',
      
      // Fresh Fruits
      'pears': 'pear',
      'pear': 'pear',
      'kiwi': 'kiwi',
      'lemons': 'lemon',
      'lemon': 'lemon',
      'papaya': 'papaya',
      'red grapes': 'grapes',
      'grapes': 'grapes',
      'pineapple': 'pineapple',
      'strawberry': 'strawberries',  // Map singular to plural DB key
      'strawberries': 'strawberries',
      'blueberry': 'blueberries',  // Map singular to plural DB key
      'blueberries': 'blueberries',
      'blackberry': 'blackberries',  // Map singular to plural DB key
      'blackberries': 'blackberries',
      'raspberry': 'raspberries',  // Map singular to plural DB key
      'raspberries': 'raspberries',
      'dates': 'dates',
      'date': 'dates',  // Map singular to plural DB key
      'pink grapefruit': 'pink grapefruit',
      'tart cherries': 'tart cherries',
      
      // Vegetables
      'celery': 'celery',
      'butternut squash': 'butternut squash',
      'pumpkin': 'pumpkin',
      'red bell pepper': 'red bell pepper',
      'sweet potatoes': 'sweet potato',
      'sweet potato': 'sweet potato',
      'potatoes': 'potatoes',
      'potato': 'potato',
      'beet greens': 'beet greens',
      'beets': 'beets',
      'beet': 'beets',
      'burdock root': 'burdock root',
      'bitter melon': 'bitter melon',
      'chicory': 'chicory',
      'chicory root': 'chicory root',
      'jerusalem artichokes': 'jerusalem artichoke',
      'jerusalem artichoke': 'jerusalem artichoke',
      'jicama': 'jicama',
      'leeks': 'leeks',
      'leek': 'leeks',
      'fennel': 'fennel',
      'corn': 'corn',
      'eggplant': 'eggplant',
      
      // Proteins
      'herring': 'herring',
      'tempeh': 'tempeh',
      'turkey breast': 'turkey breast',
      'haddock': 'haddock',
      'egg yolk': 'egg yolk',
      'egg yolks': 'egg yolks',
      'liver': 'liver',
      'beef liver': 'beef liver',
      
      // Dairy & Alternatives
      'fortified milk': 'fortified milk',
      'fortified plant milk': 'fortified plant milk',
      'fortified yogurt': 'fortified yogurt',
      'kefir': 'kefir',
      
      // Nuts & Nut Butters
      // IMPORTANT: Explicit mappings prevent fuzzy matching to nut milks
      // Standalone nuts must map to exact nut names, NOT nut milks
      'almond': 'almond',  // Must NOT match 'almond milk'
      'almonds': 'almond',
      'cashew': 'cashew',  // Must NOT match 'cashew milk'
      'cashews': 'cashew',
      'walnut': 'walnut',  // Must NOT match 'walnut milk'
      'walnuts': 'walnut',
      'pecan': 'pecan',  // Must NOT match 'pecan milk'
      'pecans': 'pecan',
      'hazelnut': 'hazelnut',  // Must match exactly - do not confuse with 'hazelnut milk'
      'hazelnuts': 'hazelnut',
      'pistachio': 'pistachios',  // Must NOT match 'pistachio milk'
      'pistachios': 'pistachios',
      'macadamia': 'macadamia nuts',  // Must NOT match 'macadamia milk'
      'macadamia nut': 'macadamia nuts',
      'macadamia nuts': 'macadamia nuts',
      'brazil nut': 'brazil nuts',
      'brazil nuts': 'brazil nuts',
      'pine nut': 'pine nuts',
      'pine nuts': 'pine nuts',
      'almond butter': 'almond butter',
      
      // Fermented Foods
      'kimchi': 'kimchi',
      'kombucha': 'kombucha',
      'miso': 'miso',
      'sauerkraut': 'sauerkraut',
      
      // Herbs & Spices
      'turmeric': 'turmeric',
      'cinnamon': 'cinnamon',
      'fenugreek': 'fenugreek',
      'black pepper': 'black pepper',
      'cayenne pepper': 'cayenne pepper',
      'rosemary': 'rosemary',
      'sage': 'sage',
      'thyme': 'thyme',
      'peppermint': 'peppermint',
      'peppermint tea': 'peppermint tea',
      
      // Beverages
      'black tea': 'black tea',
      'green tea': 'green tea',
      
      // Other
      'dark chocolate': 'dark chocolate',
      'whole wheat bread': 'whole wheat bread',
      'whole grains': 'whole grains',
      'applesauce': 'applesauce',
      'psyllium husk': 'psyllium husk',
      'vinegar': 'vinegar',
      'fortified cereals': 'fortified cereal',
      'fortified cereal': 'fortified cereal',
      'walnut oil': 'walnut oil',
      
      // Sweeteners (low/zero calorie)
      'allulose': 'allulose',
      'erythritol': 'erythritol',
      'monk fruit': 'monk fruit sweetener',
      'monk fruit sweetener': 'monk fruit sweetener'
    };
    
    // Helper function to get canonical nutrition lookup name for Ingredient tab
    // This is ONLY used in the Ingredient tab, not in smoothie logic
    function getIngredientTabNutritionKey(uiName) {
      if (!uiName) return '';
      const key = uiName.toLowerCase().trim();
      return INGREDIENT_NUTRITION_ALIASES[key] || key;
    }
    
    // USDA standard serving sizes for Ingredient tab display (in grams)
    // These are the official USDA serving sizes, not health-goal-specific servings
    // This is ONLY for the Ingredient tab, not for smoothie logic
    const USDA_STANDARD_SERVING_SIZES = {
      // Berries - USDA standard is 1 cup fresh
      'blueberry': { grams: 148, display: '148g (1 cup) USDA standard' },
      'strawberry': { grams: 152, display: '152g (1 cup) USDA standard' },
      'blackberry': { grams: 144, display: '144g (1 cup) USDA standard' },
      'raspberry': { grams: 62, display: '62g (1/2 cup) USDA standard' },
      'cranberry': { grams: 50, display: '50g (1/2 cup) USDA standard' },
      
      // Tree Nuts - USDA standard is 28g (1 oz)
      'almond': { grams: 28, display: '28g (1 oz) USDA standard' },
      'cashew': { grams: 28, display: '28g (1 oz) USDA standard' },
      'walnut': { grams: 28, display: '28g (1 oz) USDA standard' },
      'pecan': { grams: 28, display: '28g (1 oz) USDA standard' },
      'hazelnut': { grams: 28, display: '28g (1 oz) USDA standard' },
      'pistachio': { grams: 28, display: '28g (1 oz) USDA standard' },
      'macadamia': { grams: 28, display: '28g (1 oz) USDA standard' },
      'macadamia nut': { grams: 28, display: '28g (1 oz) USDA standard' },
      'brazil nut': { grams: 28, display: '28g (1 oz) USDA standard' },
      'pine nut': { grams: 28, display: '28g (1 oz) USDA standard' },
      
      // Other ingredients - keep as null to use API response
      // Only berries and tree nuts have explicit USDA standard overrides
    };
    
    // Helper function to get USDA standard serving size for Ingredient tab display
    // Returns { grams: number, display: string } or null
    // This overrides health-specific serving sizes to show USDA standard
    // This is ONLY for the Ingredient tab, not for smoothie logic
    function getUSDAStandardServingSize(ingredientName) {
      if (!ingredientName) return null;
      const key = ingredientName.toLowerCase().trim();
      return USDA_STANDARD_SERVING_SIZES[key] || null;
    }

    // CSRF Protection Helpers
    function getCSRFToken() {
      const meta = document.querySelector('meta[name="csrf-token"]');
      return meta ? meta.getAttribute('content') : null;
    }

    function apiFetch(url, options = {}) {
      const token = getCSRFToken(); 
      const method = (options.method || 'GET').toUpperCase();
      
      // Set credentials if not already set
      if (!options.credentials) {
        options.credentials = 'same-origin';
      }
      
      // Add CSRF token for non-GET/HEAD/OPTIONS methods
      if (token && !['GET', 'HEAD', 'OPTIONS'].includes(method)) {
        options.headers = options.headers || {};
        options.headers['X-CSRFToken'] = token;
      }
      
      return fetch(url, options);
    }

    // Feedback Modal
    function getActivePage() {
  const ingredientTab = document.getElementById('ingredient-tab-content');
  const smoothieTab = document.getElementById('smoothie-tab-content');
  const allergensTab = document.getElementById('allergens-tab-pane');

  const isActive = (el) => {
    if (!el) return false;
    if (el.classList.contains('active')) return true;
    const cs = window.getComputedStyle(el);
    return cs && cs.display !== 'none' && cs.visibility !== 'hidden';
  };

  if (isActive(ingredientTab)) return 'ingredient';
  if (isActive(smoothieTab)) return 'smoothie';
  if (isActive(allergensTab)) return 'allergens';

  return 'unknown';
}


    function openFeedbackModal() {
      const modal = document.getElementById('feedback-modal');
      if (modal) {
        modal.style.display = 'flex';
      }
    }

    function closeFeedbackModal() {
      const modal = document.getElementById('feedback-modal');
      if (modal) {
        modal.style.display = 'none';
        const form = document.getElementById('feedback-form');
        if (form) {
          form.reset();
        }
        const status = document.getElementById('feedback-status');
        if (status) {
          status.textContent = '';
          status.style.color = '';
        }
      }
    }

    function showFeedbackStatus(message, isError = false) {
      const status = document.getElementById('feedback-status');
      if (status) {
        status.textContent = message;
        status.style.color = isError ? '#ef4444' : '#10b981';
      }
    }

    async function submitFeedback(e) {
      e.preventDefault();
      
      const messageEl = document.getElementById('feedback-message');
      const emailEl = document.getElementById('feedback-email');
      const categoryEl = document.getElementById('feedback-category');
      const submitBtn = document.getElementById('feedback-send');
      const statusEl = document.getElementById('feedback-status');
      
      if (!messageEl || !categoryEl || !submitBtn) return;
      
      // Clear previous status
      if (statusEl) {
        statusEl.textContent = '';
        statusEl.style.color = '';
      }
      
      // Validate message
      const message = messageEl.value.trim();
      if (message.length < 5 || message.length > 1500) {
        showFeedbackStatus('Message must be 5–1500 characters', true);
        return;
      }
      
      // Validate email if provided
      const email = emailEl ? emailEl.value.trim() : '';
      if (email) {
        if (email.length > 254 || !email.includes('@') || !email.includes('.')) {
          showFeedbackStatus('Please enter a valid email address', true);
          return;
        }
      }
      
      // Get category and page
      const category = categoryEl.value || 'other';
      const page = getActivePage();
      
      // Build payload
      const payload = {
        message: message,
        category: category,
        page: page
      };
      if (email) {
        payload.email = email;
      }
      
      // Disable submit button
      submitBtn.disabled = true;
      
      try {
        const response = await apiFetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (response.status === 200 && data.ok === true) {
          showFeedbackStatus('Thank you! Your feedback has been sent.', false);
          messageEl.value = '';
          if (emailEl) emailEl.value = '';
          setTimeout(() => {
            closeFeedbackModal();
          }, 800);
        } else if (response.status === 400) {
          const errorMsg = data.error || data.message || 'Invalid request';
          showFeedbackStatus(errorMsg, true);
        } else if (response.status === 429) {
          showFeedbackStatus('Too many requests — please wait and try again.', true);
        } else {
          showFeedbackStatus('Server error — please try again.', true);
        }
      } catch (error) {
        showFeedbackStatus('Server error — please try again.', true);
      } finally {
        submitBtn.disabled = false;
      }
    }

    // Initialize feedback modal handlers
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('button[data-feedback-open]').forEach((b) => {
    if (b.id !== 'feedback-open') b.remove();
  });
      document.querySelectorAll('[data-feedback-open]').forEach((btn) => {
        btn.addEventListener('click', openFeedbackModal);
      });
      
      const cancelBtn = document.getElementById('feedback-cancel');
      const modal = document.getElementById('feedback-modal');
      const form = document.getElementById('feedback-form');
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', closeFeedbackModal);
      }
      
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeFeedbackModal();
          }
        });
        
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeFeedbackModal();
          }
        });
      }
      
      if (form) {
        form.addEventListener('submit', submitFeedback);
      }
    });

    // Analyze Ingredients
    async function analyzeIngredients() {
      console.log('Analyze button clicked');
      
      // Get ingredients from textarea (free text input)
      const textareaValue = ingredientsInputEl.value.trim();
      console.log('Textarea value:', textareaValue);
      
      // Parse ingredients from textarea (comma-separated)
      let ingredientsToAnalyze = [];
      if (textareaValue.length > 0) {
        ingredientsToAnalyze = textareaValue
          .split(/[,;]|and|with/i)
          .map(ing => ing.trim())
          .filter(ing => ing.length > 0);
      }
      
      // Also include selected ingredients from chips if any
      if (selectedIngredients.length > 0) {
        ingredientsToAnalyze = [...new Set([...ingredientsToAnalyze, ...selectedIngredients])];
      }
      
      // Ingredient tab: single-ingredient only - keep only the first ingredient
      if (ingredientsToAnalyze.length > 1) {
        const firstIngredient = ingredientsToAnalyze[0];
        ingredientsToAnalyze = [firstIngredient];
        
        // Show user-facing message
        const message = 'Ingredient Analysis supports 1 ingredient at a time. Use Smoothie Builder for multiple.';
        if (typeof showToast === 'function') {
          showToast(message, 'info', 5000);
        } else {
          setStatus(message, false);
        }
        
        // Optionally normalize textarea to show only the first ingredient
        if (ingredientsInputEl && textareaValue.length > 0) {
          ingredientsInputEl.value = firstIngredient;
        }
      }
      
      // Filter out blocked ingredients (Ingredient tab only)
      const blockedIngredients = [];
      const allowedIngredients = [];
      for (const ing of ingredientsToAnalyze) {
        if (isBlockedIngredient(ing)) {
          blockedIngredients.push(ing);
          console.log(`[ingredient-nutrition] Skipping blocked ingredient: "${ing}"`);
        } else {
          allowedIngredients.push(ing);
        }
      }
      
      // Show message if some ingredients were blocked
      if (blockedIngredients.length > 0) {
        const blockedMsg = `Some ingredients are not supported in the analysis yet and were skipped: ${blockedIngredients.join(', ')}`;
        console.log(`[ingredient-nutrition] ${blockedMsg}`);
        // Show as info message, not error
        if (allowedIngredients.length === 0) {
          // All ingredients blocked - show as error
          showIngredientError(blockedMsg);
          setStatus(blockedMsg, true);
          return;
        } else {
          // Some ingredients allowed - show as info
          setStatus(blockedMsg, false);
        }
      }
      
      // Use only allowed ingredients for analysis
      ingredientsToAnalyze = allowedIngredients;
      
      // Map UI ingredient names to nutrition database lookup keys
      // This normalization is ONLY for the Ingredient tab nutrition lookup
      // Do NOT use smoothie serving-size maps here
      // Track both original UI names and normalized DB keys for display purposes
      const ingredientMappings = ingredientsToAnalyze.map(uiName => {
        const originalKey = uiName.toLowerCase().trim();
        const canonName = getIngredientTabNutritionKey(uiName);
        
        // CRITICAL: For standalone nuts, ensure we're NOT sending a name that could match nut milks
        const standaloneNuts = ['almond', 'almonds', 'cashew', 'cashews', 'walnut', 'walnuts', 
                               'pecan', 'pecans', 'hazelnut', 'hazelnuts', 'pistachio', 'pistachios',
                               'macadamia'];
        if (standaloneNuts.includes(originalKey) && canonName !== originalKey) {
          console.warn(`[ingredient-nutrition] Standalone nut "${uiName}" mapped to "${canonName}" - this may cause backend to match nut milk!`);
        }
        
        if (canonName !== originalKey) {
          console.log(`[ingredient-nutrition] Mapping UI name "${uiName}" → canonical key "${canonName}"`);
        } else {
          console.log(`[ingredient-nutrition] Using UI name as-is: "${uiName}" → "${canonName}"`);
        }
        return {
          originalName: uiName,  // Preserve exact user input for display
          normalizedName: canonName  // Use for DB lookup
        };
      });
      
      const normalizedIngredients = ingredientMappings.map(m => m.normalizedName);
      
      console.log('[ingredient-nutrition] Original UI names:', ingredientsToAnalyze);
      console.log('[ingredient-nutrition] Normalized keys for API:', normalizedIngredients);
      
      // Validate: at least one ingredient required
      if (ingredientsToAnalyze.length === 0) {
        const errorMsg = blockedIngredients.length > 0 
          ? `All ingredients are not supported in the analysis yet: ${blockedIngredients.join(', ')}`
          : 'Please enter at least one ingredient';
        showIngredientError(errorMsg);
        setStatus(errorMsg, true);
        return;
      }
      
      // Clear any previous errors
      hideIngredientError();
      
      // Validate: reject single character inputs
      const invalidIngredients = ingredientsToAnalyze.filter(ing => ing.length < 2);
      if (invalidIngredients.length > 0) {
        const errorMsg = `Please type full ingredient names, not single letters. Invalid: ${invalidIngredients.join(', ')}`;
        showIngredientError(errorMsg);
        setStatus(errorMsg, true);
        return;
      }
      
      // Clear any previous errors
      hideIngredientError();

      analyzeBtn.disabled = true;
      setStatus('Analyzing ingredients...');

      try {
        const res = await apiFetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ingredients: normalizedIngredients,  // Use normalized names for nutrition lookup
            originalNames: ingredientMappings.map(m => m.originalName)  // Send original names for display
          })
        });

        if (!res.ok) {
          // Try to get error message from response
          let errorMessage = `HTTP ${res.status}`;
          try {
            const errorData = await res.json();
            if (errorData && errorData.error) {
              errorMessage = errorData.error;
            }
          } catch (e) {
            // If response is not JSON, use status text
            errorMessage = res.statusText || errorMessage;
          }
          const error = new Error(errorMessage);
          error.response = res;
          throw error;
        }

        const data = await res.json();
        
        // Validate ingredient matching: prevent standalone nuts from matching to nut milks
        // Check if backend returned wrong ingredient (e.g., "almond milk" when we sent "almond")
        if (data.ingredients && Array.isArray(data.ingredients) && ingredientMappings.length > 0) {
          const nutMilkPhrases = ['almond milk', 'cashew milk', 'walnut milk', 'pistachio milk', 
                                  'pistachios milk', 'hazelnut milk', 'pecan milk', 'macadamia milk'];
          const standaloneNuts = ['almond', 'almonds', 'cashew', 'cashews', 'walnut', 'walnuts', 
                                  'pecan', 'pecans', 'hazelnut', 'hazelnuts', 'pistachio', 'pistachios',
                                  'macadamia'];
          
          let hasMismatch = false;
          data.ingredients.forEach((ing, idx) => {
            const originalName = ingredientMappings[idx]?.originalName?.toLowerCase().trim();
            const normalizedName = ingredientMappings[idx]?.normalizedName?.toLowerCase().trim();
            const returnedIngredient = (ing.ingredient || ing.display_name || '').toLowerCase().trim();
            
            // Check if we sent a standalone nut but got back a nut milk
            if (originalName && standaloneNuts.includes(originalName) && 
                nutMilkPhrases.some(milk => returnedIngredient.includes(milk))) {
              hasMismatch = true;
              console.error(`[ingredient-match-error] Sent "${originalName}" but got "${returnedIngredient}". Backend fuzzy matching issue.`);
              
              // Show user-facing error
              const errorMsg = `Ingredient matching error: "${ingredientMappings[idx]?.originalName}" was matched to "${returnedIngredient}". Please be more specific (e.g., use "almond" for the nut or "almond milk" for the milk).`;
              setStatus(errorMsg, true);
              showIngredientError(errorMsg);
              
              // Try to fix: replace the ingredient name in the response
              if (ing.ingredient) {
                ing.ingredient = normalizedName || originalName;
              }
              if (ing.display_name) {
                ing.display_name = originalName;
              }
            }
          });
          
          if (hasMismatch) {
            // Show warning but still display results
            console.warn('[ingredient-match-warning] Backend matched standalone nut to nut milk. Results may show incorrect serving sizes.');
          }
        }
        
        lastAnalysisResult = data;
        setStatus('Analysis complete!');
        
        // Reset scroll positions for all tabs when new analysis is performed
        tabScrollPositions = {
          'nutrition': 0,
          'allergens': 0,
          'health-benefits': 0
        };
        
        updateResultsView();
        
        // Clear search area after successful analysis
        resetBrowseAfterAnalyze();
        
        // Disable analyze button since inputs are cleared
        analyzeBtn.disabled = true;
        
        // Focus back on textarea for next search
        if (ingredientsInputEl) ingredientsInputEl.focus();
        
      } catch (err) {
        console.error(err);
        lastAnalysisResult = null;
        
        // Check if error response contains validation error message
        let errorMessage = err.message;
        try {
          const errorData = await err.response?.json();
          if (errorData && errorData.error) {
            errorMessage = errorData.error;
          }
        } catch (e) {
          // If response is not JSON, use original error message
        }
        
        // Show error below the textarea
        showIngredientError(errorMessage || 'Error analyzing ingredients');
        setStatus(errorMessage || 'Error analyzing ingredients', true);
        
        // Show error in the active tab's results body
        const activeTab = getActiveTab();
        let errorTarget = null;
        if (activeTab === 'nutrition' && nutritionResultsBodyEl) {
          errorTarget = nutritionResultsBodyEl;
        } else if (activeTab === 'allergens' && allergensResultsBodyEl) {
          errorTarget = allergensResultsBodyEl;
        } else if (activeTab === 'health-benefits' && healthBenefitsResultsBodyEl) {
          errorTarget = healthBenefitsResultsBodyEl;
        } else if (resultsBodyEl) {
          errorTarget = resultsBodyEl;
        }
        if (errorTarget) {
          // Clear previous content and build error UI using DOM APIs to avoid XSS
          errorTarget.innerHTML = '';
          const wrapper = document.createElement('div');
          wrapper.className = 'empty-state';
          wrapper.style.color = 'var(--danger)';
          wrapper.style.padding = '20px';
          wrapper.style.textAlign = 'center';

          const iconDiv = document.createElement('div');
          iconDiv.style.fontSize = '1.2rem';
          iconDiv.style.marginBottom = '10px';
          iconDiv.textContent = '⚠️';

          const titleDiv = document.createElement('div');
          titleDiv.style.fontWeight = '600';
          titleDiv.style.marginBottom = '5px';
          titleDiv.textContent = 'Error';

          const messageDiv = document.createElement('div');
          messageDiv.textContent = errorMessage;

          wrapper.appendChild(iconDiv);
          wrapper.appendChild(titleDiv);
          wrapper.appendChild(messageDiv);
          errorTarget.appendChild(wrapper);
        }
      } finally {
        // Only update button state if there's still text/ingredients (for error cases)
        const hasText = ingredientsInputEl.value.trim().length > 0;
        if (hasText || selectedIngredients.length > 0) {
          analyzeBtn.disabled = false;
        }
      }
    }
     
        // Mobile Results Modal helpers (FIXED: never delete results card)
        let pfResultsPlaceholder = null;
        let pfModalScrollY = 0;

        function pfIsMobileResultsMode() {
          return window.matchMedia('(max-width: 1024px)').matches;
        }

        function pfLockScroll() {
          pfModalScrollY = window.scrollY || 0;
          document.documentElement.classList.add('pf-modal-open');
          document.body.classList.add('pf-modal-open');
          document.body.style.top = `-${pfModalScrollY}px`;
        }

        function pfUnlockScroll() {
          document.documentElement.classList.remove('pf-modal-open');
          document.body.classList.remove('pf-modal-open');
          document.body.style.top = '';
          window.scrollTo(0, pfModalScrollY || 0);
          pfModalScrollY = 0;
        }

        function pfOpenResultsModal() {
          const modal = document.getElementById('pf-results-modal');
          const body = document.getElementById('pf-results-sheet-body');
          const resultsCard = document.getElementById('ingredient-results-card');
          if (!modal || !body || !resultsCard) return;

          // Place a placeholder where the card originally lived
          if (!pfResultsPlaceholder) {
            pfResultsPlaceholder = document.createElement('div');
            pfResultsPlaceholder.id = 'pf-results-placeholder';
            pfResultsPlaceholder.style.display = 'none';
          }
          if (resultsCard.parentElement && resultsCard.parentElement !== body) {
            resultsCard.parentElement.insertBefore(pfResultsPlaceholder, resultsCard);
          }

          // Move the existing results card into the modal
          if (!body.contains(resultsCard)) {
            body.innerHTML = '';
            body.appendChild(resultsCard);
          }

          modal.style.display = 'flex';
          modal.setAttribute('aria-hidden', 'false');
          pfLockScroll();
        }

        function pfCloseResultsModal() {
          const modal = document.getElementById('pf-results-modal');
          const body = document.getElementById('pf-results-sheet-body');
          const resultsCard = document.getElementById('ingredient-results-card');
          if (!modal) return;

          // Move card back to the exact original spot
          if (resultsCard && pfResultsPlaceholder && pfResultsPlaceholder.parentElement) {
            pfResultsPlaceholder.parentElement.insertBefore(resultsCard, pfResultsPlaceholder);
            pfResultsPlaceholder.remove();
            pfResultsPlaceholder = null;
          }

          if (body) body.innerHTML = '';
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
          pfUnlockScroll();
        }

        // Wire modal close interactions
        (function pfInitResultsModal() {
          const modal = document.getElementById('pf-results-modal');
          if (!modal) return;

          const closeBtn = document.getElementById('pf-results-close');
          if (closeBtn) closeBtn.addEventListener('click', pfCloseResultsModal);

          modal.addEventListener('click', (e) => {
            const t = e.target;
            if (t && t.getAttribute && t.getAttribute('data-close') === '1') {
              pfCloseResultsModal();
            }
          });

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
              pfCloseResultsModal();
            }
          });
        })();

        // Smoothie Results Modal helpers
        let pfSmoothiePlaceholder = null;

        function pfIsMobileSmoothieMode() {
          return window.matchMedia('(max-width: 1024px)').matches;
        }

        function pfOpenSmoothieModal() {
          const modal = document.getElementById('pf-smoothie-modal');
          const body = document.getElementById('pf-smoothie-sheet-body');
          const resultsCard = document.getElementById('smoothie-results-card');
          const homeAnchor = document.getElementById('pf-smoothie-card-home');
          if (!modal || !body || !resultsCard || !homeAnchor) return;

          // Place a placeholder where the card originally lived
          if (!pfSmoothiePlaceholder) {
            pfSmoothiePlaceholder = document.createElement('div');
            pfSmoothiePlaceholder.id = 'pf-smoothie-placeholder';
            pfSmoothiePlaceholder.style.display = 'none';
          }
          if (resultsCard.parentElement && resultsCard.parentElement !== body) {
            resultsCard.parentElement.insertBefore(pfSmoothiePlaceholder, resultsCard);
          }

          // Remove hidden class
          resultsCard.classList.remove('pf-smoothie-hidden');

          // Move the existing results card into the modal
          if (!body.contains(resultsCard)) {
            body.innerHTML = '';
            body.appendChild(resultsCard);
          }

          modal.style.display = 'flex';
          modal.setAttribute('aria-hidden', 'false');
          document.body.classList.add('pf-modal-open');
        }

        function pfCloseSmoothieModal(options = {}) {
          const { hideCard = true } = options;
          const modal = document.getElementById('pf-smoothie-modal');
          const body = document.getElementById('pf-smoothie-sheet-body');
          const resultsCard = document.getElementById('smoothie-results-card');
          const homeAnchor = document.getElementById('pf-smoothie-card-home');
          if (!modal) return;

          // Move card back to the exact original spot
          if (resultsCard && pfSmoothiePlaceholder && pfSmoothiePlaceholder.parentElement) {
            pfSmoothiePlaceholder.parentElement.insertBefore(resultsCard, pfSmoothiePlaceholder);
            pfSmoothiePlaceholder.remove();
            pfSmoothiePlaceholder = null;
          } else if (resultsCard && homeAnchor) {
            // Fallback: use home anchor
            homeAnchor.insertAdjacentElement('afterend', resultsCard);
          }

          if (body) body.innerHTML = '';
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('pf-modal-open');

          // Hide card if requested
          if (hideCard && resultsCard) {
            resultsCard.classList.add('pf-smoothie-hidden');
          }
        }

        // Wire smoothie modal close interactions
        (function pfInitSmoothieModal() {
          const modal = document.getElementById('pf-smoothie-modal');
          if (!modal) return;

          const closeBtn = document.getElementById('pf-smoothie-close');
          if (closeBtn) closeBtn.addEventListener('click', () => pfCloseSmoothieModal({ hideCard: true }));

          modal.addEventListener('click', (e) => {
            const t = e.target;
            if (t && t.getAttribute && t.getAttribute('data-close') === '1' && t.getAttribute('data-modal') === 'smoothie') {
              e.stopPropagation();
              pfCloseSmoothieModal({ hideCard: true });
            }
          });

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
              pfCloseSmoothieModal({ hideCard: true });
            }
          });
        })();

    // Ensure button is not null before adding event listener
    if (analyzeBtn) {
      analyzeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        (async () => {
  await analyzeIngredients();
  if (pfIsMobileResultsMode()) pfOpenResultsModal();
})();

      });
      console.log('Analyze button event listener attached');
    } else {
      console.error('Analyze button not found!');
    }

    // Tab functionality
    function getActiveTab() {
      const active = document.querySelector('.tab.active');
      return active ? active.dataset.tab : 'nutrition';
    }

    function updateResultsView() {
      const tab = getActiveTab();

      // Get the active tab pane and its results body
      const activePane = document.querySelector(`.tab-pane[data-tab="${tab}"].active`);
      const activeResultsBody = activePane ? activePane.querySelector('.results-body') : null;

      if (!lastAnalysisResult) {
        // Reset all tab panes to initial state
        if (nutritionResultsBodyEl) {
          nutritionResultsBodyEl.innerHTML = 'When you analyze ingredients, the results will appear here. Select ingredients from the panels below and click "Analyze Ingredients" to get started.';
        }
        if (allergensResultsBodyEl) {
          allergensResultsBodyEl.innerHTML = 'When you analyze ingredients, allergen information will appear here.';
        }
        if (healthBenefitsResultsBodyEl) {
          healthBenefitsResultsBodyEl.innerHTML = 'When you analyze ingredients, health benefits will appear here.';
        }
        // Reset scroll position for empty state
        if (activeResultsBody) {
          activeResultsBody.scrollTop = 0;
        }
        return;
      }

      // Save current tab's scroll position before updating
      if (activeResultsBody) {
        tabScrollPositions[tab] = activeResultsBody.scrollTop;
      }

      if (tab === 'nutrition') {
        displayNutritionResults(lastAnalysisResult);
      } else if (tab === 'allergens') {
        displayAllergenResults(lastAnalysisResult);
      } else if (tab === 'health-benefits') {
        displayHealthBenefitsResults(lastAnalysisResult);
      }
      
      // Restore scroll position for the current tab after content is rendered
      setTimeout(() => {
        if (activeResultsBody && tabScrollPositions[tab] !== undefined) {
          activeResultsBody.scrollTop = tabScrollPositions[tab];
        }
      }, 10);
    }

    // Shared helper: escape HTML
    function pfEscapeHtml(s) {
      if (!s) return '';
      return String(s).replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c] || c));
    }

    // Shared helper: render ingredient pill consistently
    function pfIngredientPillHTML(name, serving) {
      const safeName = pfEscapeHtml(name || '');
      const safeServing = pfEscapeHtml(serving || '—');
      return `<span class="pf-ing-pill"><span class="pf-ing-pill__name">${safeName}</span><span class="pf-ing-pill__sep">•</span><span class="pf-ing-pill__serving">${safeServing}</span></span>`;
    }

    function displayNutritionResults(data) {
      // Parse exact API response structure
      const ingredients = data.ingredients || [];
      const totalNutrition = data.total_nutrition || {};
      const message = data.message || '';

      if (!ingredients || ingredients.length === 0) {
        resultsBodyEl.innerHTML = '<div class="empty-state">No nutrition data available</div>';
        return;
      }

      // Recalculate totals based on USDA standard serving sizes if needed
      // This ensures totals match the displayed individual ingredient values
      let total = {
        calories: 0,
        protein: 0,
        carbs: 0,
        fat: 0,
        fiber: 0,
        sugar: 0,
        sodium: 0
      };
      
      ingredients.forEach(ing => {
        // Try both ingredient name and display_name for USDA lookup
        const usdaServing = getUSDAStandardServingSize(ing.ingredient || '') || 
                           getUSDAStandardServingSize(ing.display_name || '');
        let calories = ing.calories || 0;
        let protein = ing.protein || 0;
        let carbs = ing.carbs || 0;
        let fat = ing.fat || 0;
        let fiber = ing.fiber || 0;
        let sugar = ing.sugar || 0;
        let sodium = ing.sodium || 0;
        
        // If USDA standard serving is available and different from API serving, recalculate
        if (usdaServing && ing.serving_size_g) {
          const apiServingGrams = ing.serving_size_g;
          const usdaServingGrams = usdaServing.grams;
          
          if (apiServingGrams !== usdaServingGrams && apiServingGrams > 0) {
            // Recalculate: newValue = oldValue * (usdaServingGrams / apiServingGrams)
            const ratio = usdaServingGrams / apiServingGrams;
            calories = (calories * ratio);
            protein = (protein * ratio);
            carbs = (carbs * ratio);
            fat = (fat * ratio);
            fiber = (fiber * ratio);
            sugar = (sugar * ratio);
            sodium = (sodium * ratio);
            
            // Update serving_size_g to USDA standard for consistent display
            ing.serving_size_g = usdaServingGrams;
          }
        }
        
        total.calories += calories;
        total.protein += protein;
        total.carbs += carbs;
        total.fat += fat;
        total.fiber += fiber;
        total.sugar += sugar;
        total.sodium += sodium;
      });

      // Build HTML (compact, user-friendly)
      const formatServingLabel = (ing) => {
        // Check for USDA standard serving size first (for tree nuts and berries)
        // Try both ingredient name and display_name for lookup
        const usdaServing = getUSDAStandardServingSize(ing.ingredient || '') || 
                           getUSDAStandardServingSize(ing.display_name || '');
        if (usdaServing && usdaServing.grams) {
          const g = usdaServing.grams % 1 === 0 ? usdaServing.grams.toFixed(0) : usdaServing.grams.toFixed(1);
          return `${g}g`;
        }
        
        // Fallback to API serving size (which may have been updated to USDA standard above)
        const grams = Number(ing?.serving_size_g);
        if (!Number.isNaN(grams) && grams > 0) {
          // show clean grams, not huge decimals
          const g = grams % 1 === 0 ? grams.toFixed(0) : grams.toFixed(1);
          return `${g}g`;
        }
        const raw = (ing?.serving_size || '').toString().trim();
        return raw;
      };

      const ingredientPills = ingredients.map((ing) => {
          const displayName = ing.display_name || ing.ingredient || 'Unknown';
        const servingText = formatServingLabel(ing);
        return pfIngredientPillHTML(displayName, servingText || '—');
      }).join('');

      const isSingle = ingredients.length === 1;
      const first = ingredients[0] || {};
      const firstDisplayName = first.display_name || first.ingredient || 'Unknown';
      const firstServingRaw = formatServingLabel(first);

      // Ingredient tab: always single ingredient, so always show chip with name • serving
      const headerRight = `<div class="nutrition-selected-chip">${pfIngredientPillHTML(firstDisplayName, firstServingRaw || '—')}</div>`;

      let html = `
        <div class="nutrition-results-card">
          <div class="pf-nutrition-hero">
            <div class="pf-nutrition-hero__copy">
              <div class="nutrition-title">
                <h3>Nutrition Summary</h3>
                <p>Totals across selected ingredients</p>
              </div>
            </div>
            <div class="pf-nutrition-hero__ing">
              ${headerRight}
            </div>
          </div>

          <div class="nutrition-summary-grid">
            <div class="nutrition-tile-compact"><div class="top"><span>🔥</span><span class="label">Calories</span></div><div class="value">${total.calories.toFixed(1)}<span class="unit">kcal</span></div></div>
            <div class="nutrition-tile-compact"><div class="top"><span>💪</span><span class="label">Protein</span></div><div class="value">${total.protein.toFixed(1)}<span class="unit">g</span></div></div>
            <div class="nutrition-tile-compact"><div class="top"><span>🌾</span><span class="label">Carbs</span></div><div class="value">${total.carbs.toFixed(1)}<span class="unit">g</span></div></div>
            <div class="nutrition-tile-compact"><div class="top"><span>🥑</span><span class="label">Fat</span></div><div class="value">${total.fat.toFixed(1)}<span class="unit">g</span></div></div>
            <div class="nutrition-tile-compact"><div class="top"><span>🌿</span><span class="label">Fiber</span></div><div class="value">${total.fiber.toFixed(1)}<span class="unit">g</span></div></div>
            <div class="nutrition-tile-compact"><div class="top"><span>🍬</span><span class="label">Sugar</span></div><div class="value">${total.sugar.toFixed(1)}<span class="unit">g</span></div></div>
            <div class="nutrition-tile-compact"><div class="top"><span>🧂</span><span class="label">Sodium</span></div><div class="value">${total.sodium.toFixed(1)}<span class="unit">mg</span></div></div>
            </div>
          </div>
        `;

      // Note: Per-ingredient breakdown intentionally removed to reduce scrolling and avoid duplicate presentation.

      if (message) {
        html += `<div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: var(--radius); color: var(--text-secondary); font-size: 0.9rem;">${escapeHTML(message)}</div>`;
      }

      // Use the nutrition-specific results body
      const targetBody = nutritionResultsBodyEl || resultsBodyEl;
      if (targetBody) {
        targetBody.innerHTML = html;
      }
    }

    function displayHealthBenefitsResults(data) {
      console.log('[HB_RENDER_CTX]', pfGetHBContext());
      // Helper function for escaping HTML
      function escapeHtml(s) {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, c => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        }[c]));
      }
      
      // Parse exact API response structure
      const ingredients = data.ingredients || [];
      const message = data.message || '';

      // Use the health benefits-specific results body
      const targetBody = healthBenefitsResultsBodyEl || resultsBodyEl;

      if (!ingredients || ingredients.length === 0) {
        if (targetBody) {
          targetBody.innerHTML = '<div class="empty-state">No health benefits data available</div>';
        }
        return;
      }

      // Get first ingredient for header chip
      const firstIngredient = ingredients[0] || {};
      const displayName = firstIngredient.display_name || firstIngredient.ingredient || 'Unknown';
      const servingSizeG = firstIngredient.serving_size_g;
      const servingSize = firstIngredient.serving_size || '';
      const servingText = servingSizeG ? `${servingSizeG % 1 === 0 ? servingSizeG.toFixed(0) : servingSizeG.toFixed(1)}g` : (servingSize || '—');
      // safeName and safeServing kept for backward compatibility in allBenefits array
      const safeName = pfEscapeHtml(displayName);
      const safeServing = pfEscapeHtml(servingText);

      // Collect all health benefits - flatten into array for filtering
      const allBenefits = [];
      ingredients.forEach(ing => {
        if (ing.health_benefits && Array.isArray(ing.health_benefits) && ing.health_benefits.length > 0) {
          ing.health_benefits.forEach(hb => {
            if (hb.health_benefits) {
              allBenefits.push({
                ingredient: safeName,
                category: hb.category || '',
                type: hb.type || '',
                benefit: hb.benefit || '',
                name: hb.name || '',
                title: hb.title || '',
                health_benefits: hb.health_benefits,
                description: hb.description || '',
                summary: hb.summary || '',
                key_nutrients: hb.key_nutrients || ''
              });
            }
          });
        }
      });

      // Apply filtering based on context
      const ctx = pfGetHBContext();
      const displayGoal = (ctx && ctx.goalLabel) ? ctx.goalLabel : (ctx && ctx.goal) ? ctx.goal : '';
      const safeDisplayGoal = escapeHtml(displayGoal);
      
      // Helper function to map backend category value to UI label
      function getCategoryLabel(backendValue) {
        if (!backendValue) return null;
        const normalizedBackend = String(backendValue).trim().toLowerCase();
        for (const cat of categories) {
          const catValue = typeof cat === 'object' && 'value' in cat ? cat.value : cat;
          if (String(catValue).trim().toLowerCase() === normalizedBackend) {
            return typeof cat === 'object' && 'label' in cat ? cat.label : catValue;
          }
        }
        return null;
      }
      
      let benefits = allBenefits;
      let isBrowserFlow = ctx.source === 'browser' && ctx.goal;
      let primaryBenefit = null;
      
      // Browser flow: filter to show only ONE matching benefit
      if (isBrowserFlow && Array.isArray(benefits) && benefits.length) {
        const goalName = String(ctx.goal).trim().toLowerCase();
        
        // Try to match by category/type first
        let matched = benefits.filter(b => {
          const category = String(b.category || b.type || '').trim().toLowerCase();
          return category === goalName;
        });
        
        // If no match by category, try benefit/name/title as fallback
        if (matched.length === 0) {
          matched = benefits.filter(b => {
            const benefit = String(b.benefit || b.name || b.title || '').trim().toLowerCase();
            return benefit.includes(goalName) || goalName.includes(benefit);
          });
        }
        
        // Pick the first match as primaryBenefit
        if (matched.length > 0) {
          primaryBenefit = matched[0];
        }
      }

      // Browser flow: show single benefit or no match message
      if (isBrowserFlow) {
        const pillText = ctx.goalLabel 
          ? `Filtered: ${escapeHtml(ctx.goalLabel)}`
          : 'Filtered';
        
        if (primaryBenefit) {
          const name = escapeHtml(primaryBenefit.benefit || primaryBenefit.name || primaryBenefit.title || 'Health Benefit');
          const desc = escapeHtml(primaryBenefit.description || primaryBenefit.summary || primaryBenefit.health_benefits || '');
          const categoryLabel = ctx.goalLabel ? escapeHtml(ctx.goalLabel) : '';

      let html = `
            <div class="pf-hb2-wrap">
              <div class="pf-hb2-hero">
                <div class="pf-hb2-hero__copy">
                  <div class="pf-hb2-title">Health Benefits</div>
                  <div class="pf-hb2-subtitle">Wellness benefits of analyzed ingredient</div>
                </div>
                <div class="pf-hb2-hero__ing">
                  <span class="pf-hb2-chip">${pfIngredientPillHTML(displayName, servingText)}</span>
                </div>
              </div>
              <div class="pf-hb2-card">
                <div class="pf-hb2-cardHead">
                  <div class="pf-hb2-name">${name}</div>
                  ${categoryLabel ? `<span class="pf-hb2-tag">${categoryLabel}</span>` : ''}
            </div>
                ${desc ? `<div class="pf-hb2-desc">${desc}</div>` : ''}
            </div>
          </div>
          `;
          
          if (message) {
            html += `<div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: var(--radius); color: var(--text-secondary); font-size: 0.9rem;">${escapeHtml(message)}</div>`;
          }
          
          if (targetBody) {
            targetBody.innerHTML = html;
          }
          return;
        } else {
          // No match found in browser flow
          let html = `
            <div class="pf-hb2-wrap">
              <div class="pf-hb2-hero">
                <div class="pf-hb2-hero__copy">
                  <div class="pf-hb2-title">Health Benefits</div>
                  <div class="pf-hb2-subtitle">Wellness benefits of analyzed ingredient</div>
                </div>
                <div class="pf-hb2-hero__ing">
                  <span class="pf-hb2-chip">${pfIngredientPillHTML(displayName, servingText)}</span>
                </div>
              </div>
              <div class="pf-hb2-card">
                <div style="color:#64748b;font-size:.9rem;line-height:1.45">No specific benefit found for this goal for this ingredient.</div>
            </div>
            </div>
          `;
          
          if (message) {
            html += `<div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: var(--radius); color: var(--text-secondary); font-size: 0.9rem;">${escapeHtml(message)}</div>`;
          }
          
          if (targetBody) {
            targetBody.innerHTML = html;
          }
          return;
        }
      }

      // Search flow: show all benefits (existing behavior)
      if (benefits.length === 0) {
        const emptyHtml = `
          <div class="pf-hb2-wrap">
            <div class="pf-hb2-hero">
              <div class="pf-hb2-hero__copy">
                <div class="pf-hb2-title">Health Benefits</div>
                <div class="pf-hb2-subtitle">Wellness benefits of analyzed ingredient</div>
              </div>
              <div class="pf-hb2-hero__ing">
                <span class="pf-hb2-chip">${pfIngredientPillHTML(displayName, servingText)}</span>
              </div>
            </div>
            <div class="pf-hb2-card">
              <div style="color:#64748b;font-size:.9rem;line-height:1.45">No health benefits data available for this ingredient.</div>
              </div>
                  </div>
        `;
        if (targetBody) {
          targetBody.innerHTML = emptyHtml;
        }
        return;
      }

      // Split into top 2 and remaining
      const top2 = benefits.slice(0, 2);
      const remaining = benefits.slice(2);

      // Build top 2 cards
      const top2Cards = top2.map(b => {
        const name = escapeHtml(b.benefit || b.name || b.title || 'Health Benefit');
        const desc = escapeHtml(b.description || b.summary || b.health_benefits || '');
        const category = (ctx.source === 'browser' && safeDisplayGoal) ? safeDisplayGoal : 
                        (b.category ? (getCategoryLabel(b.category) || b.category) : '');
        const safeCategory = category ? escapeHtml(category) : '';
        
        return `
          <div class="pf-hb2-card">
            <div class="pf-hb2-cardHead">
              <div class="pf-hb2-name">${name}</div>
              ${safeCategory ? `<span class="pf-hb2-tag">${safeCategory}</span>` : ''}
                </div>
            ${desc ? `<div class="pf-hb2-desc">${desc}</div>` : ''}
            </div>
          `;
      }).join('');

      // Build remaining benefits (for accordion)
      const remainingCards = remaining.map(b => {
        const name = escapeHtml(b.benefit || b.name || b.title || 'Health Benefit');
        const desc = escapeHtml(b.description || b.summary || b.health_benefits || '');
        const category = (ctx.source === 'browser' && safeDisplayGoal) ? safeDisplayGoal : 
                        (b.category ? (getCategoryLabel(b.category) || b.category) : '');
        const safeCategory = category ? escapeHtml(category) : '';
        
        return `
          <div class="pf-hb2-card">
            <div class="pf-hb2-cardHead">
              <div class="pf-hb2-name">${name}</div>
              ${safeCategory ? `<span class="pf-hb2-tag">${safeCategory}</span>` : ''}
            </div>
            ${desc ? `<div class="pf-hb2-desc">${desc}</div>` : ''}
          </div>
        `;
      }).join('');

      // Build key nutrients pills
      const allNutrients = new Set();
      benefits.forEach(b => {
        if (b.key_nutrients) {
          const nutrients = typeof b.key_nutrients === 'string' 
            ? b.key_nutrients.split(/[,;]/).map(n => n.trim()).filter(Boolean)
            : Array.isArray(b.key_nutrients) ? b.key_nutrients : [];
          nutrients.forEach(n => allNutrients.add(n));
        }
      });
      const uniqueNutrients = Array.from(allNutrients);
      const nutrientsPills = uniqueNutrients.map(n => {
        const safeNutr = escapeHtml(n);
        return `<span class="pf-hb2-nutr">${safeNutr}</span>`;
      }).join('');

      // Build pill text
      const pillText = (ctx.source === 'browser' && ctx.goalLabel) 
        ? `Filtered: ${escapeHtml(ctx.goalLabel)}`
        : 'Showing all benefits';

      let html = `
        <div class="pf-hb2-wrap">
          <div class="pf-hb2-hero">
            <div class="pf-hb2-hero__copy">
              <div class="pf-hb2-title">Health Benefits</div>
              <div class="pf-hb2-subtitle">Wellness benefits of analyzed ingredient</div>
            </div>
            <div class="pf-hb2-hero__ing">
              <span class="pf-hb2-chip">${pfIngredientPillHTML(displayName, servingText)}</span>
            </div>
          </div>
          <div class="pf-hb2-grid">
            ${top2Cards}
          </div>
          ${remaining.length > 0 ? `
            <div class="pf-hb2-acc">
              <button class="pf-hb2-acc-btn" type="button" aria-expanded="false" aria-controls="pf-hb2-all">
                <span>See all benefits (${remaining.length})</span><span aria-hidden="true">▾</span>
              </button>
              <div id="pf-hb2-all" class="pf-hb2-acc-panel" hidden>
                ${remainingCards}
              </div>
            </div>
          ` : ''}
          ${uniqueNutrients.length > 0 ? `
            <div class="pf-hb2-acc">
              <button class="pf-hb2-acc-btn" type="button" aria-expanded="false" aria-controls="pf-hb2-nutrients">
                <span>Key nutrients</span><span aria-hidden="true">▾</span>
              </button>
              <div id="pf-hb2-nutrients" class="pf-hb2-acc-panel" hidden>
                <div class="pf-hb2-nutrients">${nutrientsPills}</div>
              </div>
            </div>
          ` : ''}
        </div>
      `;

      if (message) {
        html += `<div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: var(--radius); color: var(--text-secondary); font-size: 0.9rem;">${escapeHtml(message)}</div>`;
      }

      if (targetBody) {
        targetBody.innerHTML = html;
        initHB2Accordions(targetBody);
      }
    }

    function initHB2Accordions(scope) {
      if (!scope) return;
      const btns = scope.querySelectorAll('.pf-hb2-acc-btn');
      btns.forEach(btn => {
        // Prevent double-binding
        if (btn.dataset.hb2AccBound) return;
        btn.dataset.hb2AccBound = 'true';
        
        btn.addEventListener('click', () => {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          const panelId = btn.getAttribute('aria-controls');
          const panel = panelId ? scope.querySelector('#' + CSS.escape(panelId)) : null;
          btn.setAttribute('aria-expanded', String(!expanded));
          if (panel) panel.hidden = expanded;
        });
      });
    }

    function displayAllergenResults(data) {
      // Parse exact API response structure - allergens are in each ingredient
      const ingredients = data.ingredients || [];
      
      // Use the allergens-specific results body
      const targetBody = allergensResultsBodyEl || resultsBodyEl;
      
      /**
       * Normalize ingredient text for matching
       */
      function normalizeIngredient(text) {
        if (!text) return '';
        return String(text)
          .toLowerCase()
          .trim()
          .replace(/\s+/g, ' ')  // Collapse multiple spaces
          .replace(/-/g, ' ');    // Treat hyphens as spaces
      }
      
      /**
       * Detect allergens from ingredient name (client-side correction)
       * Returns { milk: boolean, treeNuts: boolean, reason: string }
       */
      function detectAllergensFromName(ingredientName) {
        const normalized = normalizeIngredient(ingredientName);
        let milk = false;
        let treeNuts = false;
        let reason = '';
        
        // Nut milk phrases (MUST NOT trigger Milk, but DO trigger Tree Nuts)
        const nutMilkPhrases = [
          'almond milk', 'cashew milk', 'walnut milk', 'pistachio milk',
          'pistachios milk', 'hazelnut milk', 'pecan milk', 'macadamia milk'
        ];
        
        // Plant milk phrases (MUST NOT trigger Milk)
        const plantMilkPhrases = [
          'oat milk', 'soy milk', 'coconut milk', 'rice milk',
          'pea milk', 'hemp milk', 'flax milk',
          // Include all nut milks in plant milks to prevent Milk trigger
          ...nutMilkPhrases
        ];
        
        // Dairy indicators (trigger Milk allergen)
        const dairyIndicators = [
          'whey', 'casein', 'lactose', 'butter', 'ghee', 'cream', 'cheese',
          'yogurt', 'kefir', 'curd'
        ];
        
        // Tree nut indicators (trigger Tree Nuts allergen)
        const treeNutIndicators = [
          'almond', 'cashew', 'walnut', 'pecan', 'hazelnut', 'pistachio',
          'macadamia', 'brazil nut', 'pine nut'
        ];
        
        // Check for nut milk phrases first (highest priority for exclusion from Milk)
        const isNutMilk = nutMilkPhrases.some(phrase => normalized.includes(phrase));
        
        // Check for plant milk phrases
        const hasPlantMilk = plantMilkPhrases.some(phrase => normalized.includes(phrase));
        
        // Check for dairy indicators (even if plant milk is present, dairy takes priority)
        const hasDairyIndicator = dairyIndicators.some(indicator => {
          const regex = new RegExp(`\\b${indicator}\\b`, 'i');
          return regex.test(normalized);
        });
        
        // Check for standalone "milk" (not part of plant milk phrase)
        let hasStandaloneMilk = false;
        if (normalized.includes('milk')) {
          // Check if "milk" is part of a plant milk phrase
          const isInPlantMilk = plantMilkPhrases.some(phrase => {
            const milkIndex = normalized.indexOf('milk');
            const phraseIndex = normalized.indexOf(phrase);
            return phraseIndex !== -1 && milkIndex >= phraseIndex && milkIndex < phraseIndex + phrase.length;
          });
          hasStandaloneMilk = !isInPlantMilk;
        }
        
        // Matching priority: 
        // 1. Dairy indicators take precedence (even in plant milks)
        // 2. Nut milks NEVER trigger any allergens (show green - no allergens)
        // 3. Other plant milks don't trigger Milk
        // 4. Standalone milk triggers Milk
        if (hasDairyIndicator) {
          milk = true;
          const matched = dairyIndicators.find(ind => normalized.includes(ind));
          reason = `dairy indicator: ${matched}`;
        } else if (isNutMilk) {
          // Nut milk found - explicitly do NOT set Milk or Tree Nuts (show green - no allergens)
          milk = false; // Explicitly prevent Milk allergen
          treeNuts = false; // Explicitly prevent Tree Nuts allergen
          const matched = nutMilkPhrases.find(phrase => normalized.includes(phrase));
          reason = `nut milk: ${matched} (no allergens - green)`;
        } else if (hasPlantMilk) {
          // Non-nut plant milk found - do NOT set Milk
          milk = false; // Explicitly prevent Milk allergen
          reason = 'plant milk (non-nut)';
        } else if (hasStandaloneMilk) {
          milk = true;
          reason = 'standalone milk';
        }
        
        // Check for tree nuts separately (even if not in milk form)
        // IMPORTANT: Only skip if it's a nut MILK (not just the nut name)
        // Standalone nuts (like "almond") should trigger Tree Nuts allergen
        if (!treeNuts) {
          // Only check for tree nuts if it's NOT a nut milk
          // If it's a nut milk, we already set treeNuts = false above
          if (!isNutMilk) {
            const hasTreeNut = treeNutIndicators.some(nut => {
              const regex = new RegExp(`\\b${nut}\\b`, 'i');
              return regex.test(normalized);
            });
            if (hasTreeNut) {
              treeNuts = true;
              const matched = treeNutIndicators.find(nut => {
                const regex = new RegExp(`\\b${nut}\\b`, 'i');
                return regex.test(normalized);
              });
              reason = reason ? `${reason} + tree nut: ${matched}` : `tree nut: ${matched}`;
            }
          }
        }
        
        // Special case: coconut milk should NOT trigger Tree Nuts (coconut is not a tree nut in labeling context)
        if (normalized.includes('coconut milk')) {
          treeNuts = false; // Explicitly exclude coconut milk from Tree Nuts
          if (!reason) reason = 'coconut milk (not tree nut)';
        }
        
        return { milk, treeNuts, reason: reason || 'none' };
      }
      
      // Collect all allergens from all ingredients
      const allergenMap = new Map();
      const ingredientsWithAllergens = [];

      ingredients.forEach(ing => {
        // Use display_name if available (user's original input), otherwise fall back to ingredient (DB key)
        const displayName = ing.display_name || ing.ingredient || 'Unknown';
        const rawIngredient = ing.ingredient || displayName;
        
        // Detect allergens from ingredient name
        const detected = detectAllergensFromName(rawIngredient);
        
        // Log detection result
        console.log(`[ALLERGEN_MATCH] ingredient="${rawIngredient}" milk=${detected.milk} treeNuts=${detected.treeNuts} reason="${detected.reason}"`);
        
        const allergenData = ing.allergens;
        
        // Check if allergen data exists (can be object or empty array)
        if (allergenData && typeof allergenData === 'object' && !Array.isArray(allergenData) && Object.keys(allergenData).length > 0 && allergenData.name) {
          const allergenKey = allergenData.name || 'Unknown Allergen';
          
          // Filter allergens based on detection logic
          let shouldInclude = true;
          
          // Fix: Exclude "Eggs" allergen for "Eggplant" (eggplant contains "egg" but is not an egg allergen)
          const normalizedIngredient = String(rawIngredient || displayName).toLowerCase().trim();
          if (allergenKey === 'Eggs' && (normalizedIngredient === 'eggplant' || normalizedIngredient.includes('eggplant'))) {
            shouldInclude = false;
          }
          
          // CRITICAL: Nut milks NEVER trigger Milk allergen (red flag)
          // If backend says "Milk" but our detection says it's a nut milk or plant milk, exclude it
          if (allergenKey === 'Milk' && !detected.milk) {
            shouldInclude = false;
          }
          
          // If backend says "Tree Nuts" but our detection says it's not a tree nut, exclude it
          // (But if we detected tree nuts, include it even if backend didn't)
          if (allergenKey === 'Tree Nuts' && !detected.treeNuts) {
            shouldInclude = false;
          }
          
          // If we detected Milk but backend didn't report it, add it
          if (detected.milk && allergenKey !== 'Milk') {
            // Check if Milk already exists in map
            if (!allergenMap.has('Milk')) {
              allergenMap.set('Milk', {
                name: 'Milk',
                severity: 'Unknown',
                description: 'Dairy milk allergen detected',
                aliases: '',
                common_in: '',
                ingredients: []
              });
            }
            allergenMap.get('Milk').ingredients.push(displayName);
          }
          
          // If we detected Tree Nuts but backend didn't report it, add it
          if (detected.treeNuts && allergenKey !== 'Tree Nuts') {
            // Check if Tree Nuts already exists in map
            if (!allergenMap.has('Tree Nuts')) {
              allergenMap.set('Tree Nuts', {
                name: 'Tree Nuts',
                severity: 'Unknown',
                description: 'Tree nuts allergen detected',
                aliases: '',
                common_in: '',
                ingredients: []
              });
            }
            allergenMap.get('Tree Nuts').ingredients.push(displayName);
          }
          
          // Include the allergen if it passed our filter
          if (shouldInclude) {
          if (!allergenMap.has(allergenKey)) {
            allergenMap.set(allergenKey, {
              name: allergenData.name || 'Unknown',
              severity: allergenData.severity || 'Unknown',
              description: allergenData.description || '',
              aliases: allergenData.aliases || '',
              common_in: allergenData.common_in || '',
              ingredients: []
            });
          }
          
          allergenMap.get(allergenKey).ingredients.push(displayName);  // Use display name for UI
          ingredientsWithAllergens.push({
            ingredient: displayName,  // Use display name for UI
            allergen: allergenData
          });
        }
        } else {
          // No allergen data from backend, but check if we detected any
          if (detected.milk) {
            if (!allergenMap.has('Milk')) {
              allergenMap.set('Milk', {
                name: 'Milk',
                severity: 'Unknown',
                description: 'Dairy milk allergen detected',
                aliases: '',
                common_in: '',
                ingredients: []
              });
            }
            allergenMap.get('Milk').ingredients.push(displayName);
          }
          
          if (detected.treeNuts) {
            if (!allergenMap.has('Tree Nuts')) {
              allergenMap.set('Tree Nuts', {
                name: 'Tree Nuts',
                severity: 'Unknown',
                description: 'Tree nuts allergen detected',
                aliases: '',
                common_in: '',
                ingredients: []
              });
            }
            allergenMap.get('Tree Nuts').ingredients.push(displayName);
          }
        }
      });

      const uniqueAllergens = Array.from(allergenMap.values());

      // Helper function for escaping HTML
      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, c => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        }[c]));
      }

      // Build single ingredient chip for header (1-ingredient mode)
      const formatServingLabel = (ing) => {
        const grams = Number(ing?.serving_size_g);
        if (!Number.isNaN(grams) && grams > 0) {
          const g = grams % 1 === 0 ? grams.toFixed(0) : grams.toFixed(1);
          return `${g}g`;
        }
        const raw = (ing?.serving_size || '').toString().trim();
        return raw || '100g';
      };

      // Use only first ingredient for single-ingredient mode
      const firstIngredient = ingredients[0] || {};
      const displayName = firstIngredient.display_name || firstIngredient.ingredient || 'Unknown';
      const servingText = formatServingLabel(firstIngredient);
      const headerIngredientChip = `<span class="pf-a-chip">${pfIngredientPillHTML(displayName, servingText || '—')}</span>`;

      // Extract allergen names
      const groupsChecked = ['Milk', 'Eggs', 'Fish', 'Shellfish', 'Tree Nuts', 'Peanuts', 'Wheat', 'Soy', 'Sesame'];
      const allergenNames = uniqueAllergens.map(a => {
        if (typeof a === 'string') return a;
        if (a && typeof a === 'object') return a.name || a.allergen || a.label || '';
        return String(a);
      }).filter(Boolean);

      // Status pill (with allergen-badge class for mobile modal styling)
      const statusPill = allergenNames.length === 0
        ? `<div class="pf-a-pill pf-a-pill--ok allergen-badge"><span class="pf-a-pill-dot"></span>No common allergens detected</div>`
        : `<div class="pf-a-pill pf-a-pill--bad allergen-badge"><span class="pf-a-pill-dot"></span>Potential allergens detected</div>`;

      // Allergen panel - exclude first allergen if shown in header
      const remainingAllergens = allergenNames.length > 0 ? allergenNames.slice(1) : [];
      const needsToggle = remainingAllergens.length > 5; // simple threshold to avoid showing button for small lists

const allergenPanel = allergenNames.length === 0
  ? `<div class="pf-a-muted">None detected from common allergen groups.</div>`
  : remainingAllergens.length === 0
  ? `` // No remaining allergens to show (first one is in header)
  : `
    <div id="pf-a-allClamp" class="pf-a-chipClamp">
      <div class="pf-a-chips">
        ${remainingAllergens.map(n => `<span class="pf-a-chip pf-a-chip--danger">${escapeHtml(n)}</span>`).join('')}
              </div>
            </div>
    ${needsToggle ? `
      <div class="pf-a-toggleRow">
        <button type="button" class="pf-a-toggleBtn" data-pf-toggle="pf-a-allClamp">Show all</button>
            </div>
    ` : ``}
  `;

      // Group tags
      const groupTags = groupsChecked.map(g => `<span class="pf-a-tag">${escapeHtml(g)}</span>`).join('');

      // Notes list
      const notesList = `
  <ul class="pf-a-list">
    <li>Results depend on ingredient naming and available data.</li>
    <li>Cross-contamination can occur during processing.</li>
    <li>If severe allergies, verify packaging and consult a clinician.</li>
  </ul>
`;

      // Build HTML
      const redesignedHtml = `
        <div class="pf-a-wrap">
          <div class="pf-allergen-hero">
            <div class="pf-allergen-hero__copy">
              <div class="pf-a-title">Allergen Report</div>
              <div class="pf-a-subtitle">Checks selected ingredient(s) against common allergen groups. Always verify labels if you have severe allergies.</div>
            </div>
            <div class="pf-allergen-hero__badge">
              ${statusPill}
            </div>
            <div class="pf-allergen-hero__ing">
              ${headerIngredientChip}
            </div>
          </div>
          <div class="pf-a-grid">
            <section class="pf-a-card">
              <div class="pf-a-card-head">
                <div class="pf-a-card-title pf-a-card-title--center">Detected allergens</div>
                ${allergenNames.length > 0 ? `<span class="pf-a-chip pf-a-chip--danger pf-a-chip--head">${escapeHtml(allergenNames[0])}</span>` : ``}
              </div>
              ${allergenPanel}
            </section>
        </div>
          <section class="pf-a-acc">
            <button class="pf-a-acc-btn" type="button" aria-expanded="false" aria-controls="pf-a-groups">
              <span>Allergen groups checked</span><span aria-hidden="true">▾</span>
            </button>
            <div id="pf-a-groups" class="pf-a-acc-panel" hidden>
              <div class="pf-a-tags">${groupTags}</div>
            </div>
          </section>
          <section class="pf-a-acc">
            <button class="pf-a-acc-btn" type="button" aria-expanded="false" aria-controls="pf-a-notes">
              <span>Notes</span><span aria-hidden="true">▾</span>
            </button>
            <div id="pf-a-notes" class="pf-a-acc-panel" hidden>
              ${notesList}
            </div>
          </section>
        </div>
      `;

      if (targetBody) {
        targetBody.innerHTML = redesignedHtml;
        initAllergenAccordions(targetBody);
      }
    }

    function initAllergenAccordions(scope) {
      if (!scope) return;
      const btns = scope.querySelectorAll('.pf-a-acc-btn');
      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          const panelId = btn.getAttribute('aria-controls');
          const panel = panelId ? scope.querySelector('#' + CSS.escape(panelId)) : null;
          btn.setAttribute('aria-expanded', String(!expanded));
          if (panel) panel.hidden = expanded;
        });
      });
    }

    // Track scroll position for each tab continuously - attach to each tab pane
    function attachScrollListeners() {
      if (nutritionResultsBodyEl) {
        nutritionResultsBodyEl.addEventListener('scroll', () => {
          tabScrollPositions['nutrition'] = nutritionResultsBodyEl.scrollTop;
        });
      }
      if (allergensResultsBodyEl) {
        allergensResultsBodyEl.addEventListener('scroll', () => {
          tabScrollPositions['allergens'] = allergensResultsBodyEl.scrollTop;
        });
      }
      if (healthBenefitsResultsBodyEl) {
        healthBenefitsResultsBodyEl.addEventListener('scroll', () => {
          tabScrollPositions['health-benefits'] = healthBenefitsResultsBodyEl.scrollTop;
        });
      }
    }
    
    // Attach scroll listeners
    attachScrollListeners();

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Save current tab's scroll position before switching
        const currentTab = getActiveTab();
        const currentPane = document.querySelector(`.tab-pane[data-tab="${currentTab}"].active`);
        const currentResultsBody = currentPane ? currentPane.querySelector('.results-body') : null;
        
        if (currentResultsBody) {
          tabScrollPositions[currentTab] = currentResultsBody.scrollTop;
        }
        
        // Switch tabs
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Switch tab panes - hide all, show active
        tabPanes.forEach(pane => {
          pane.classList.remove('active');
          pane.style.display = 'none';
        });
        
        const newTab = tab.dataset.tab;
        const activePane = document.querySelector(`.tab-pane[data-tab="${newTab}"]`);
        if (activePane) {
          activePane.classList.add('active');
          activePane.style.display = 'block';
        }
        
        // Update view
        updateResultsView();
        
        // Restore scroll position for the new tab after a brief delay to ensure content is rendered
        setTimeout(() => {
          const newPane = document.querySelector(`.tab-pane[data-tab="${newTab}"]`);
          const newResultsBody = newPane ? newPane.querySelector('.results-body') : null;
          if (newResultsBody && tabScrollPositions[newTab] !== undefined) {
            newResultsBody.scrollTop = tabScrollPositions[newTab];
          }
        }, 10);
      });
    });

    // Initialize
    // ============================================
    // SMOOTHIE BUILDER FUNCTIONALITY
    // ============================================
    let smoothieIngredients = []; // Array of objects: { name: string, quantity: number, unit: string }
    let smoothieSearchTimeout = null;
    let smoothieEditPanelOpen = false; // Track if the edit ingredients modal is open
    let currentSmoothie = null; // Store current built smoothie data (only set when user clicks Build)
    let hasBuiltSmoothie = false; // Flag to track if user has explicitly built a smoothie
    let previousHealthGoal = null; // Track previous health goal selection
    
    // Maximum limits for smoothie ingredients
    const MAX_FRESH_FRUITS = 3;
    const MAX_DRIED_FRUITS = 1;
    
    // Keywords to identify dried fruits
    const DRIED_FRUIT_KEYWORDS = ['dried', 'dry', 'raisin', 'date', 'prune', 'apricot', 'fig', 'cranberry'];
    
    // Function to check if an ingredient is a fruit
    function isFruit(ingredientName) {
      // Exclude sweeteners and vegan milks first - they should not be classified as fruits
      if (isSweetener(ingredientName) || isPlantBasedMilk(ingredientName)) {
        return false;
      }
      const fruitKeywords = [
        'apple', 'banana', 'orange', 'grape', 'strawberry', 'blueberry', 'raspberry', 'blackberry',
        'mango', 'pineapple', 'papaya', 'kiwi', 'peach', 'pear', 'plum', 'cherry', 'watermelon',
        'cantaloupe', 'honeydew', 'grapefruit', 'lemon', 'lime', 'coconut', 'avocado', 'pomegranate',
        'cranberry', 'acai', 'goji', 'elderberry', 'mulberry', 'currant', 'date', 'fig', 'prune',
        'apricot', 'raisin', 'dried', 'berry', 'citrus', 'tropical', 'stone fruit', 'dragon', 'guava', 'tangelo', 'passion fruit', 'nectarine', 
      ];
      const nameLower = ingredientName.toLowerCase();
      return fruitKeywords.some(keyword => nameLower.includes(keyword));
    }
    
    // Function to check if an ingredient is a dried fruit
    function isDriedFruit(ingredientName) {
      // Exclude sweeteners and vegan milks first - they should not be classified as dried fruits
      if (isSweetener(ingredientName) || isPlantBasedMilk(ingredientName)) {
        return false;
      }
      const nameLower = ingredientName.toLowerCase();
      // Check for specific dried fruit keys (with "dried_" prefix)
      const DRIED_KEYS = new Set([
        "dried_raisins",
        "dried_sultanas",
        "dried_prunes",
        "dried_figs",
        "dried_dates",
        "dried_apple",
        "dried_pear",
        "dried_peach",
        "dried_plum",
        "dried_mango",
        "dried_pineapple",
        "dried_kiwi",
        "dried_banana",
        "dried_cranberries",
        "dried_cherries",
        "dried_blueberries",
        "dried_strawberries",
        "dried_goji",
        "dried_mulberries",
        "dried_papaya"
      ]);
      
      // Normalize ingredient name to check against keys
      const normalizedKey = nameLower.replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      if (DRIED_KEYS.has(normalizedKey)) {
        return true;
      }
      
      // Also check for keywords (for backward compatibility)
      return DRIED_FRUIT_KEYWORDS.some(keyword => nameLower.includes(keyword));
    }
    
    /**
     * Get smoothie grams for dried fruit based on age group
     * @param {string} ageGroupKey - The normalized age group key (e.g., "child_4_8", "boy_14_18", "woman_19_30")
     * @param {string} ingredientKey - The ingredient key (e.g., "dried_raisins")
     * @param {string} selectedAudience - The UI age group value (e.g., "boy-14-18", "woman-19-30") for fallback logic
     * @param {number} baseAdultGrams - Base adult grams for fallback (default 30)
     * @returns {number|null} - The smoothie default grams, or null if not found
     */
    function getDriedFruitSmoothieGrams(ageGroupKey, ingredientKey, selectedAudience = null, baseAdultGrams = 30) {
      // Normalize ingredient key
      const normalizedKey = ingredientKey.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      
      // Special handling for boy_14_18: check teen map first, then fallback to adult
      if (selectedAudience === 'boy-14-18' || ageGroupKey === 'boy_14_18') {
        const teenGroup = DRIED_FRUIT_SERVINGS.boy_14_18;
        if (teenGroup) {
          const teenEntry = teenGroup[normalizedKey];
          if (teenEntry && typeof teenEntry.smoothieDefaultGrams === "number") {
            return teenEntry.smoothieDefaultGrams;
          }
          // If not found in teen map, fallback to adult
          const adultGrams = ADULT_DRIED_FRUIT_GRAMS[normalizedKey] || ADULT_DRIED_FRUIT_GRAMS.default;
          if (adultGrams) {
            return adultGrams;
          }
          // Final fallback to teen default
          if (typeof teenGroup.defaultBoy1418DriedFruitGrams === "number") {
            return teenGroup.defaultBoy1418DriedFruitGrams;
          }
        }
        // If teen group doesn't exist, fallback to adult
        return ADULT_DRIED_FRUIT_GRAMS[normalizedKey] || ADULT_DRIED_FRUIT_GRAMS.default;
      }
      
      // Special handling for woman_19_30: check woman_19_30 map first, then fallback to adult
      if (selectedAudience === 'woman-19-30' || ageGroupKey === 'woman_19_30' || ageGroupKey === 'adult_19_30') {
        const womanGroup = DRIED_FRUIT_SERVINGS.woman_19_30;
        if (womanGroup) {
          const womanEntry = womanGroup[normalizedKey];
          if (womanEntry && typeof womanEntry.smoothieDefaultGrams === "number") {
            return womanEntry.smoothieDefaultGrams;
          }
          // If not found in woman map, fallback to default
          if (typeof womanGroup.defaultWoman1930DriedFruitGrams === "number") {
            return womanGroup.defaultWoman1930DriedFruitGrams;
          }
        }
        // If woman group doesn't exist, fallback to adult
        return baseAdultGrams;
      }
      
      // Special handling for man_19_30: check man_19_30 map first, then fallback to adult
      if (selectedAudience === 'man-19-30' || ageGroupKey === 'man_19_30') {
        const manGroup = DRIED_FRUIT_SERVINGS.man_19_30;
        if (manGroup) {
          // Try with spaces first (as specified: "dried raisins")
          const keyWithSpaces = normalizedKey.replace(/_/g, ' ');
          const manEntryWithSpaces = manGroup[keyWithSpaces];
          if (manEntryWithSpaces && typeof manEntryWithSpaces.defaultServingGrams === "number") {
            return manEntryWithSpaces.defaultServingGrams;
          }
          // Try with underscores (normalized key)
          const manEntry = manGroup[normalizedKey];
          if (manEntry && typeof manEntry.defaultServingGrams === "number") {
            return manEntry.defaultServingGrams;
          }
          // Handle special case: "dried_goji" -> "dried goji berries"
          if (normalizedKey === 'dried_goji' || normalizedKey === 'dried_goji_berries') {
            const gojiEntry = manGroup['dried goji berries'];
            if (gojiEntry && typeof gojiEntry.defaultServingGrams === "number") {
              return gojiEntry.defaultServingGrams;
            }
          }
        }
        // If man group doesn't exist or entry not found, fallback to adult
        return baseAdultGrams;
      }
      
      // Special handling for woman_31_59: check woman_31_59 map first, then fallback to adult
      if (selectedAudience === 'woman-31-59' || ageGroupKey === 'woman_31_59') {
        const womanGroup = DRIED_FRUIT_SERVINGS.woman_31_59;
        if (womanGroup) {
          const womanEntry = womanGroup[normalizedKey];
          if (womanEntry && typeof womanEntry.smoothieDefaultGrams === "number") {
            return womanEntry.smoothieDefaultGrams;
          }
          // Try alternative key formats (e.g., dried_cranberries_unsweetened -> dried_cranberries)
          const baseKey = normalizedKey.replace(/_unsweetened$/, '');
          if (baseKey !== normalizedKey) {
            const baseEntry = womanGroup[baseKey];
            if (baseEntry && typeof baseEntry.smoothieDefaultGrams === "number") {
              return baseEntry.smoothieDefaultGrams;
            }
          }
          // If not found in woman map, fallback to default
          if (typeof womanGroup.defaultWoman3159DriedFruitGrams === "number") {
            return womanGroup.defaultWoman3159DriedFruitGrams;
          }
        }
        // If woman group doesn't exist, fallback to adult
        return baseAdultGrams;
      }
      
      // Special handling for man_31_59: check man_31_59 map first, then fallback to adult
      if (selectedAudience === 'man-31-59' || ageGroupKey === 'man_31_59') {
        const manGroup = DRIED_FRUIT_SERVINGS.man_31_59;
        if (manGroup) {
          const manEntry = manGroup[normalizedKey];
          if (manEntry && typeof manEntry.smoothieDefaultGrams === "number") {
            return manEntry.smoothieDefaultGrams;
          }
          // Try alternative key formats (e.g., dried_cranberries_unsweetened -> dried_cranberries)
          const baseKey = normalizedKey.replace(/_unsweetened$/, '');
          if (baseKey !== normalizedKey) {
            const baseEntry = manGroup[baseKey];
            if (baseEntry && typeof baseEntry.smoothieDefaultGrams === "number") {
              return baseEntry.smoothieDefaultGrams;
            }
          }
          // If not found in man map, fallback to default
          if (typeof manGroup.defaultMan3159DriedFruitGrams === "number") {
            return manGroup.defaultMan3159DriedFruitGrams;
          }
        }
        // If man group doesn't exist, fallback to adult
        return baseAdultGrams;
      }
      
      // Special handling for 60+ (man_60_plus and woman_60_plus): use unified DRIED_FRUIT_DEFAULT_PORTIONS_60PLUS
      const is60Plus = (selectedAudience === 'man-60+' || ageGroupKey === 'man_60_plus' || 
                        selectedAudience === 'woman-60+' || ageGroupKey === 'woman_60_plus');
      
      if (is60Plus) {
        // Try multiple key formats to match the ingredient
        const keyVariations = [
          normalizedKey, // e.g., "dried_apple"
          normalizedKey.replace(/_/g, ' '), // e.g., "dried apple"
          normalizedKey.replace(/_unsweetened$/, ''), // e.g., "dried_cranberries" from "dried_cranberries_unsweetened"
          normalizedKey.replace(/_unsweetened$/, '').replace(/_/g, ' ') // e.g., "dried cranberries"
        ];
        
        for (const key of keyVariations) {
          if (DRIED_FRUIT_DEFAULT_PORTIONS_60PLUS[key] != null) {
            return DRIED_FRUIT_DEFAULT_PORTIONS_60PLUS[key];
          }
        }
        
        // If not found in 60+ map, fallback to adult default
        return baseAdultGrams;
      }
      
      // For other age groups, use existing logic
      const group = DRIED_FRUIT_SERVINGS[ageGroupKey];
      if (!group) return null;
      
      const entry = group[normalizedKey];
      if (entry && typeof entry.smoothieDefaultGrams === "number") {
        return entry.smoothieDefaultGrams;
      }
      
      // Use the appropriate fallback key based on age group
      let fallbackKey = null;
      if (ageGroupKey === "child_4_8") {
        fallbackKey = "defaultChild48DriedFruitGrams";
      } else if (ageGroupKey === "girl_9_13") {
        fallbackKey = "defaultGirl913DriedFruitGrams";
      } else if (ageGroupKey === "boy_9_13") {
        fallbackKey = "defaultBoy913DriedFruitGrams";
      } else if (ageGroupKey === "girl_14_18") {
        fallbackKey = "defaultGirl1418DriedFruitGrams";
      }
      
      if (fallbackKey && typeof group[fallbackKey] === "number") {
        return group[fallbackKey];
      }
      
      return null;
    }
    
    /**
     * Get dried fruit serving grams for a specific age group (alias for consistency)
     * @param {string} ageGroup - The age group value (e.g., "woman-19-30")
     * @param {string} ingredientName - The ingredient name
     * @param {number} baseAdultGrams - Base adult grams for fallback
     * @returns {number} - Serving grams to use
     */
    function getDriedFruitServingGrams(ageGroup, ingredientName, baseAdultGrams = 30) {
      const ageGroupKey = normalizeAgeGroupKey(ageGroup);
      const ingredientKey = normalizeDriedFruitKey(ingredientName);
      const result = getDriedFruitSmoothieGrams(ageGroupKey, ingredientKey, ageGroup, baseAdultGrams);
      return result !== null ? result : baseAdultGrams;
    }
    
    /**
     * Get dried fruit health flags for woman_19_30
     * @param {string} ingredientKey - The ingredient key (e.g., "dried_raisins")
     * @returns {Object} - Object with health flags (highSugar, highFiber, laxative, sorbitolLike)
     */
    /**
     * Get dried fruit health flags for woman_19_30
     * @param {string} ingredientKey - The ingredient key (e.g., "dried_raisins", "dried_grape_raisins")
     * @returns {Object} - Object with health flags (highSugar, highFiber, laxative, sorbitolLike)
     */
    function getDriedFruitHealthFlagsWoman1930(ingredientKey) {
      const normalizedKey = ingredientKey.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      
      // Handle key variations (e.g., "dried_grape_raisins" -> "dried_raisins")
      let lookupKey = normalizedKey;
      if (normalizedKey === 'dried_grape_raisins' || (normalizedKey.includes('grape') && normalizedKey.includes('raisin'))) {
        lookupKey = 'dried_raisins';
      } else if (normalizedKey === 'dried_apricot' && !DRIED_FRUIT_FLAGS[normalizedKey]) {
        lookupKey = 'dried_apricots';
      } else if (normalizedKey === 'dried_cherry' && !DRIED_FRUIT_FLAGS[normalizedKey]) {
        lookupKey = 'dried_cherries';
      } else if (normalizedKey === 'dried_cranberry' && !DRIED_FRUIT_FLAGS[normalizedKey]) {
        lookupKey = 'dried_cranberries';
      } else if (normalizedKey === 'dried_strawberry' && !DRIED_FRUIT_FLAGS[normalizedKey]) {
        lookupKey = 'dried_strawberries';
      } else if (normalizedKey === 'dried_blueberry' && !DRIED_FRUIT_FLAGS[normalizedKey]) {
        lookupKey = 'dried_blueberries';
      }
      
      const flags = DRIED_FRUIT_FLAGS[lookupKey] || DRIED_FRUIT_FLAGS[normalizedKey] || {};
      return {
        highSugar: !!flags.highSugar,
        highFiber: !!flags.highFiber,
        laxative: !!flags.laxative,
        sorbitolLike: !!flags.sorbitolLike
      };
    }
    
    /**
     * Get health flags for dried fruit based on age group
     * @param {string} ageGroupKey - The normalized age group key (e.g., "girl_14_18")
     * @param {string} ingredientKey - The ingredient key (e.g., "dried_raisins")
     * @returns {Object} - Object with anemiaPrevention, pregnancyCaution, thyroidCaution flags
     */
    function getDriedFruitHealthFlags(ageGroupKey, ingredientKey) {
      const group = DRIED_FRUIT_SERVINGS[ageGroupKey];
      if (!group) {
        return {
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        };
      }
      
      // Normalize ingredient key
      const normalizedKey = ingredientKey.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      
      const entry = group[normalizedKey];
      if (!entry) {
        return {
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        };
      }
      
      return {
        anemiaPrevention: !!entry.anemiaPrevention,
        pregnancyCaution: !!entry.pregnancyCaution,
        thyroidCaution: !!entry.thyroidCaution
      };
    }
    
    /**
     * Get health profile for dried fruit for man 60+ age group
     * @param {string} ingredientKey - The ingredient key (e.g., "dried_raisins")
     * @param {string} healthGoal - The selected health goal (e.g., "heart-health", "diabetes-blood-sugar")
     * @returns {Object|null} - Object with tier, tags, warning, or null if not found
     */
    function getDriedFruitHealthProfileMan60Plus(ingredientKey, healthGoal) {
      if (!ingredientKey) return null;
      
      const normalizedKey = ingredientKey.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      
      // Try alternative key formats
      let lookupKey = normalizedKey;
      const baseKey = normalizedKey.replace(/_unsweetened$/, '');
      if (baseKey !== normalizedKey && DRIED_FRUIT_HEALTH_PROFILE_MAN_60_PLUS[baseKey]) {
        lookupKey = baseKey;
      }
      
      const profile = DRIED_FRUIT_HEALTH_PROFILE_MAN_60_PLUS[lookupKey] || DRIED_FRUIT_HEALTH_PROFILE_MAN_60_PLUS[normalizedKey];
      if (!profile) return null;
      
      // Check if warning should be shown based on health goal
      const healthGoalLower = healthGoal ? healthGoal.toLowerCase().replace(/\s+/g, '-') : '';
      const shouldShowWarning = profile.warning && (
        profile.tier === 'caution' ||
        (healthGoalLower && (
          healthGoalLower.includes('heart') ||
          healthGoalLower.includes('blood-pressure') ||
          healthGoalLower.includes('cholesterol') ||
          healthGoalLower.includes('weight') ||
          healthGoalLower.includes('diabetes') ||
          healthGoalLower.includes('blood-sugar')
        ))
      );
      
      return {
        tier: profile.tier || 'neutral',
        tags: profile.tags || [],
        warning: shouldShowWarning ? profile.warning : null
      };
    }
    
    /**
     * Normalize ingredient name to match dried fruit keys
     * Handles variations like "raisins" -> "dried_raisins", "dried raisins" -> "dried_raisins"
     */
    function normalizeDriedFruitKey(ingredientName) {
      const nameLower = ingredientName.toLowerCase().trim();
      // Remove "dried" prefix if present and normalize
      const withoutDried = nameLower.replace(/^dried\s+/, '').replace(/\s+/g, '_');
      return `dried_${withoutDried}`;
    }
    
    // Function to check if an ingredient is a fresh fruit (fruit but not dried)
    function isFreshFruit(ingredientName) {
      // Exclude sweeteners and vegan milks first - they should not be classified as fruits
      if (isSweetener(ingredientName) || isPlantBasedMilk(ingredientName)) {
        return false;
      }
      return isFruit(ingredientName) && !isDriedFruit(ingredientName);
    }

    function isMicroDoseIngredient(name) {
      if (!name) return false;
      const nameLower = String(name).toLowerCase().trim();
      
      // Tokenize: extract all alphabetic words
      const tokens = (nameLower.match(/[a-z]+/g) || []);
      if (tokens.length === 0) return false;
      
      // Category tokens that indicate micro-dose ingredients
      const categoryTokens = new Set([
        'tea', 'herbal', 'herb', 'infusion', 'extract', 'tincture',
        'flower', 'flowers', 'leaf', 'leaves', 'spice', 'spices',
        'seasoning', 'powder', 'ground'
      ]);
      
      // Check if any token matches a category
      if (tokens.some(t => categoryTokens.has(t))) {
        return true;
      }
      
      // Common herb/spice names (small general list, not single-ingredient special cases)
      const commonHerbSpiceNames = new Set([
        'sage', 'basil', 'mint', 'parsley', 'cilantro', 'oregano', 'thyme', 'rosemary',
        'dill', 'chive', 'tarragon', 'marjoram', 'cinnamon', 'turmeric', 'ginger',
        'nutmeg', 'clove', 'cardamom', 'cumin', 'coriander', 'paprika', 'pepper',
        'allspice', 'chamomile', 'peppermint', 'spearmint', 'vanilla', 'cocoa',
        'cacao', 'matcha', 'spirulina', 'moringa', 'wheatgrass', 'echinacea',
        'ginkgo', 'ginseng', 'ashwagandha', 'rhodiola', 'valerian', 'licorice',
        'burdock', 'nettle', 'elderberry', 'hawthorn', 'schisandra', 'reishi',
        'chaga', 'dandelion', 'passionflower'
      ]);
      
      // Check if any token matches a common herb/spice name
      return tokens.some(t => commonHerbSpiceNames.has(t));
    }
    
    // ============================================
    // RECOMMENDED VEGAN MILKS FOR KIDS 4-8
    // ============================================
    /**
     * Recommended vegan milk types for children 4-8 years old
     * Serving sizes in ml for smoothie servings
     */
    const KID_4_8_RECOMMENDED_VEGAN_MILKS = {
      'soy milk': { 
        displayName: 'Soy Milk (Fortified)', 
        servingMl: 120,
        isFortified: true
      },
      'oat milk': { 
        displayName: 'Oat Milk', 
        servingMl: 120,
        isFortified: false
      },
      'almond milk': { 
        displayName: 'Almond Milk', 
        servingMl: 120,
        isFortified: false
      },
      'pea milk': { 
        displayName: 'Pea Protein Milk', 
        servingMl: 120,
        isFortified: false
      },
      'pea protein milk': { 
        displayName: 'Pea Protein Milk', 
        servingMl: 120,
        isFortified: false
      },
      'rice milk': { 
        displayName: 'Rice Milk', 
        servingMl: 120,
        isFortified: false
      },
      'hemp milk': { 
        displayName: 'Hemp Milk', 
        servingMl: 120,
        isFortified: false
      },
      'flax milk': { 
        displayName: 'Flax Milk', 
        servingMl: 120,
        isFortified: false
      }
    };

    /**
     * Recommended vegan milk types for children 9-13 years old (girls and boys)
     * Serving sizes in ml for smoothie servings
     */
    const KID_9_13_RECOMMENDED_VEGAN_MILKS = {
      'soy milk': { 
        displayName: 'Soy Milk (Fortified)', 
        servingMl: 150,
        isFortified: true
      },
      'oat milk': { 
        displayName: 'Oat Milk', 
        servingMl: 150,
        isFortified: false
      },
      'almond milk': { 
        displayName: 'Almond Milk', 
        servingMl: 150,
        isFortified: false
      },
      'pea milk': { 
        displayName: 'Pea Protein Milk', 
        servingMl: 150,
        isFortified: false
      },
      'rice milk': { 
        displayName: 'Rice Milk', 
        servingMl: 150,
        isFortified: false
      },
      'hemp milk': { 
        displayName: 'Hemp Milk', 
        servingMl: 150,
        isFortified: false
      },
      'flax milk': { 
        displayName: 'Flax Milk', 
        servingMl: 150,
        isFortified: false
      }
    };

    /**
     * Recommended vegan milk types for teens 14-18 years old (girls and boys)
     * Serving sizes in ml for smoothie servings
     */
    const TEEN_14_18_RECOMMENDED_VEGAN_MILKS = {
      'soy milk': { 
        displayName: 'Soy Milk (Fortified)', 
        servingMl: 150,
        isFortified: true
      },
      'oat milk': { 
        displayName: 'Oat Milk', 
        servingMl: 150,
        isFortified: false
      },
      'almond milk': { 
        displayName: 'Almond Milk', 
        servingMl: 150,
        isFortified: false
      },
      'pea milk': { 
        displayName: 'Pea Protein Milk', 
        servingMl: 150,
        isFortified: false
      },
      'rice milk': { 
        displayName: 'Rice Milk', 
        servingMl: 150,
        isFortified: false
      },
      'hemp milk': { 
        displayName: 'Hemp Milk', 
        servingMl: 150,
        isFortified: false
      },
      'flax milk': { 
        displayName: 'Flax Milk', 
        servingMl: 150,
        isFortified: false
      }
    };

    /**
     * Recommended vegan milk types for adults 19-30 years old (women and men)
     * Serving sizes in ml for smoothie servings
     */
    const ADULT_19_30_RECOMMENDED_VEGAN_MILKS = {
      'soy milk': { 
        displayName: 'Soy Milk (Fortified)', 
        servingMl: 150,
        isFortified: true
      },
      'pea milk': { 
        displayName: 'Pea Protein Milk (Fortified)', 
        servingMl: 150,
        isFortified: true
      },
      'oat milk': { 
        displayName: 'Oat Milk', 
        servingMl: 150,
        isFortified: false
      },
      'almond milk': { 
        displayName: 'Almond Milk', 
        servingMl: 150,
        isFortified: false
      },
      'cashew milk': { 
        displayName: 'Cashew Milk', 
        servingMl: 150,
        isFortified: false
      },
      'walnut milk': { 
        displayName: 'Walnut Milk', 
        servingMl: 150,
        isFortified: false
      },
      'pistachio milk': { 
        displayName: 'Pistachio Milk', 
        servingMl: 150,
        isFortified: false
      },
      'hemp milk': { 
        displayName: 'Hemp Milk', 
        servingMl: 150,
        isFortified: false
      },
      'flax milk': { 
        displayName: 'Flax Milk', 
        servingMl: 150,
        isFortified: false
      },
      'rice milk': { 
        displayName: 'Rice Milk', 
        servingMl: 150,
        isFortified: false
      }
    };

    /**
     * Check if a vegan milk is recommended for kids 4-8
     * @param {string} ingredientName - The ingredient name
     * @returns {object|null} - The recommended milk info or null
     */
    function getRecommendedVeganMilkForKids(ingredientName) {
      if (!ingredientName) return null;
      
      const nameLower = ingredientName.toLowerCase().trim();
      
      // Check for exact matches first
      for (const [key, value] of Object.entries(KID_4_8_RECOMMENDED_VEGAN_MILKS)) {
        if (nameLower.includes(key)) {
          return value;
        }
      }
      
      return null;
    }

    /**
     * Check if a vegan milk is recommended for the current age group
     * @param {string} ingredientName - The ingredient name
     * @param {string} ageGroup - The selected age group (e.g., "child-4-8")
     * @returns {object|null} - The recommended milk info or null
     */
    function isVeganMilkRecommended(ingredientName, ageGroup) {
      if (!ingredientName || !ageGroup) return null;
      
      // Check for kids 4-6 and 7-8
      if (ageGroup === 'child-4-6' || ageGroup === 'child-7-8' || ageGroup === 'child-4-8') {
        return getRecommendedVeganMilkForKids(ingredientName);
      }
      
      // Check for girls/boys 9-13
      if (ageGroup === 'girl-9-13' || ageGroup === 'boy-9-13') {
        const nameLower = ingredientName.toLowerCase().trim();
        // Check if the ingredient is in the recommended list
        return KID_9_13_RECOMMENDED_VEGAN_MILKS.hasOwnProperty(nameLower) || 
               Object.keys(KID_9_13_RECOMMENDED_VEGAN_MILKS).some(key => nameLower.includes(key));
      }
      
      // Check for girls/boys 14-18
      if (ageGroup === 'girl-14-18' || ageGroup === 'boy-14-18') {
        const nameLower = ingredientName.toLowerCase().trim();
        // Check if the ingredient is in the recommended list
        return TEEN_14_18_RECOMMENDED_VEGAN_MILKS.hasOwnProperty(nameLower) || 
               Object.keys(TEEN_14_18_RECOMMENDED_VEGAN_MILKS).some(key => nameLower.includes(key));
      }
      
      // Check for women/men 19-30
      if (ageGroup === 'woman-19-30' || ageGroup === 'man-19-30') {
        const nameLower = ingredientName.toLowerCase().trim();
        // Check if the ingredient is in the recommended list
        return ADULT_19_30_RECOMMENDED_VEGAN_MILKS.hasOwnProperty(nameLower) || 
               Object.keys(ADULT_19_30_RECOMMENDED_VEGAN_MILKS).some(key => nameLower.includes(key));
      }
      
      return null;
    }

    // ============================================
    // AGE-SPECIFIC VEGAN MILK SERVING SIZES (ML)
    // ============================================
    /**
     * Recommended serving sizes in ml for vegan milks by age group
     * These are per-smoothie serving sizes for unsweetened, preferably fortified milks
     */
    const recommendedServingMl = {
      child_4_8: {
        // Already handled via KID_4_8_RECOMMENDED_VEGAN_MILKS
        // This structure is for consistency with other age groups
      },
      child_9_13: {
        // For girls and boys 9-13 (normalized from "girl-9-13" and "boy-9-13")
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      girl_9_13: {
        // Alias for child_9_13 (for clarity, but child_9_13 is the primary key)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      teen_14_18: {
        // For girls and boys 14-18 (normalized from "girl-14-18" and "boy-14-18")
        // Official-style dairy alternatives (when fortified)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'cashew milk': 150,
        'cashew_milk': 150,
        'walnut milk': 150,
        'walnut_milk': 150,
        'pistachio milk': 150,
        'pistachio_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      girl_14_18: {
        // Alias for teen_14_18 (for clarity, but teen_14_18 is the primary key)
        // Official-style dairy alternatives (when fortified)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'cashew milk': 150,
        'cashew_milk': 150,
        'walnut milk': 150,
        'walnut_milk': 150,
        'pistachio milk': 150,
        'pistachio_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      boy_14_18: {
        // Alias for teen_14_18 (for clarity, but teen_14_18 is the primary key)
        // Official-style dairy alternatives (when fortified)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'cashew milk': 150,
        'cashew_milk': 150,
        'walnut milk': 150,
        'walnut_milk': 150,
        'pistachio milk': 150,
        'pistachio_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      adult_19_30: {
        // For women and men 19-30 (normalized from "woman-19-30" and "man-19-30")
        // Official-style dairy alternatives (when fortified)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'cashew milk': 150,
        'cashew_milk': 150,
        'walnut milk': 150,
        'walnut_milk': 150,
        'pistachio milk': 150,
        'pistachio_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      woman_19_30: {
        // Alias for adult_19_30 (for clarity, but adult_19_30 is the primary key)
        // Official-style dairy alternatives (when fortified)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'cashew milk': 150,
        'cashew_milk': 150,
        'walnut milk': 150,
        'walnut_milk': 150,
        'pistachio milk': 150,
        'pistachio_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      man_19_30: {
        // Alias for adult_19_30 (for clarity, but adult_19_30 is the primary key)
        // Official-style dairy alternatives (when fortified)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'cashew milk': 150,
        'cashew_milk': 150,
        'walnut milk': 150,
        'walnut_milk': 150,
        'pistachio milk': 150,
        'pistachio_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      woman_31_59: {
        // For women 31-59 years old
        // Official-style dairy alternatives (when fortified)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'cashew milk': 150,
        'cashew_milk': 150,
        'walnut milk': 150,
        'walnut_milk': 150,
        'pistachio milk': 150,
        'pistachio_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      man_31_59: {
        // For men 31-59 years old
        // Official-style dairy alternatives (when fortified)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'cashew milk': 150,
        'cashew_milk': 150,
        'walnut milk': 150,
        'walnut_milk': 150,
        'pistachio milk': 150,
        'pistachio_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      },
      woman_60_plus: {
        // For women 60+ years old (older adults - slightly conservative serving sizes)
        // Official-style dairy alternatives (when fortified)
        'soy milk': 120,
        'soy_milk': 120,
        'pea milk': 120,
        'pea_milk': 120,
        'pea protein milk': 120,
        'pea_protein_milk': 120,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 120,
        'oat_milk': 120,
        'almond milk': 120,
        'almond_milk': 120,
        'cashew milk': 120,
        'cashew_milk': 120,
        'walnut milk': 120,
        'walnut_milk': 120,
        'pistachio milk': 120,
        'pistachio_milk': 120,
        'hemp milk': 120,
        'hemp_milk': 120,
        'flax milk': 120,
        'flax_milk': 120,
        'rice milk': 120,
        'rice_milk': 120
      },
      man_60_plus: {
        // For men 60+ years old (older adults - slightly conservative serving sizes)
        // Default: 150-200ml per smoothie (prefer lower end if smoothie has lots of fruit)
        // Official-style dairy alternatives (when fortified)
        'soy milk': 150,
        'soy_milk': 150,
        'pea milk': 150,
        'pea_milk': 150,
        'pea protein milk': 150,
        'pea_protein_milk': 150,
        // Other plant drinks (app-defined portions, not official servings)
        'oat milk': 150,
        'oat_milk': 150,
        'almond milk': 150,
        'almond_milk': 150,
        'cashew milk': 150,
        'cashew_milk': 150,
        'walnut milk': 150,
        'walnut_milk': 150,
        'pistachio milk': 150,
        'pistachio_milk': 150,
        'hemp milk': 150,
        'hemp_milk': 150,
        'flax milk': 150,
        'flax_milk': 150,
        'rice milk': 150,
        'rice_milk': 150
      }
      // Other age groups can be added here
    };

    // DRIED FRUIT SERVING SIZES FOR CHILD 4-8
    // ============================================
    /**
     * Dried fruit serving sizes for children 4-8 years old
     * USDA alignment: ¼ cup dried fruit = 1 fruit serving equivalent
     * Note: We use smaller app smoothie portions (12-15g) to control sugar intake
     */
    const DRIED_FRUIT_SERVINGS = {
      child_4_8: {
        // Each entry:
        // usdaServingCup: 0.25 (¼ cup dried fruit)
        // usdaServingGrams: approximate weight of ¼ cup
        // smoothieDefaultGrams: how much we actually use in ONE smoothie for a 4–8 year-old (smaller than full serving)
        dried_raisins: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 15
        },
        dried_sultanas: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 15
        },
        dried_prunes: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 15
        },
        dried_figs: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 15
        },
        dried_dates: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 15
        },
        dried_apple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 20,
          smoothieDefaultGrams: 12
        },
        dried_pear: {
          usdaServingCup: 0.25,
          usdaServingGrams: 24,
          smoothieDefaultGrams: 15
        },
        dried_peach: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 15
        },
        dried_plum: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 15
        },
        dried_mango: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 15
        },
        dried_pineapple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 15
        },
        dried_kiwi: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 15
        },
        dried_banana: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 15
        },
        dried_cranberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 15
        },
        dried_cherries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 15
        },
        dried_blueberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 15
        },
        dried_strawberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 22,
          smoothieDefaultGrams: 12
        },
        dried_goji: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 15
        },
        dried_mulberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 15
        },
        // Fallback for any dried fruit not explicitly listed
        defaultChild48DriedFruitGrams: 15
      },
      girl_9_13: {
        // Each entry:
        // usdaServingCup: 0.25 (¼ cup dried fruit)
        // usdaServingGrams: approximate weight of ¼ cup
        // smoothieDefaultGrams: how much we actually use in ONE smoothie for a 9–13 year-old (a bit more than 4–8)
        dried_raisins: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 18
        },
        dried_sultanas: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_prunes: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_figs: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_dates: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_apple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 20,
          smoothieDefaultGrams: 15
        },
        dried_pear: {
          usdaServingCup: 0.25,
          usdaServingGrams: 24,
          smoothieDefaultGrams: 18
        },
        dried_peach: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_plum: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 18
        },
        dried_mango: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_pineapple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 18
        },
        dried_kiwi: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_banana: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_cranberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 18
        },
        dried_cherries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_blueberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_strawberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 22, // USDA standard: 22g (¼ cup)
          smoothieDefaultGrams: 15
        },
        dried_goji: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_mulberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28, // USDA standard: 28g (¼ cup)
          smoothieDefaultGrams: 18
        },
        // Fallback for any dried fruit not explicitly listed
        defaultGirl913DriedFruitGrams: 18
      },
      boy_9_13: {
        // Each entry:
        // usdaServingCup: 0.25 (¼ cup dried fruit)
        // usdaServingGrams: approximate weight of ¼ cup
        // smoothieDefaultGrams: how much we actually use in ONE smoothie for a 9–13 year-old (similar to girl_9_13)
        dried_raisins: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 18
        },
        dried_sultanas: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_prunes: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_figs: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_dates: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_apple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 20,
          smoothieDefaultGrams: 15
        },
        dried_pear: {
          usdaServingCup: 0.25,
          usdaServingGrams: 24,
          smoothieDefaultGrams: 18
        },
        dried_peach: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_plum: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 18
        },
        dried_mango: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_pineapple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 18
        },
        dried_kiwi: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_banana: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_cranberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 18
        },
        dried_cherries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_blueberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_strawberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 22, // USDA standard: 22g (¼ cup)
          smoothieDefaultGrams: 15
        },
        dried_goji: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_mulberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28, // USDA standard: 28g (¼ cup)
          smoothieDefaultGrams: 18
        },
        // Fallback for any dried fruit not explicitly listed
        defaultBoy913DriedFruitGrams: 18
      },
      girl_14_18: {
        // Each entry:
        // usdaServingCup: 0.25 (¼ cup dried fruit)
        // usdaServingGrams: approximate weight of ¼ cup
        // smoothieDefaultGrams: how much we actually use in ONE smoothie for a 14–18 year-old (a bit more than 9–13)
        // anemiaPrevention: boolean
        // pregnancyCaution: boolean
        // thyroidCaution: boolean
        dried_raisins: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 20,
          anemiaPrevention: true,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_sultanas: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 20,
          anemiaPrevention: true,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_prunes: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 20,
          anemiaPrevention: true,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_figs: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 20,
          anemiaPrevention: true,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_dates: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 20,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_apple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 20,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_pear: {
          usdaServingCup: 0.25,
          usdaServingGrams: 24,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_peach: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_plum: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_mango: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_pineapple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_kiwi: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_banana: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_cranberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: true,
          thyroidCaution: false
        },
        dried_cherries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_blueberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_strawberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 22, // USDA standard: 22g (¼ cup)
          smoothieDefaultGrams: 18,
          anemiaPrevention: false,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        dried_goji: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 15,
          anemiaPrevention: true,
          pregnancyCaution: true,
          thyroidCaution: true
        },
        dried_mulberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28, // USDA standard: 28g (¼ cup)
          smoothieDefaultGrams: 18,
          anemiaPrevention: true,
          pregnancyCaution: false,
          thyroidCaution: false
        },
        // Fallback for any dried fruit not explicitly listed
        defaultGirl1418DriedFruitGrams: 18
      },
      boy_14_18: {
        // Each entry:
        // usdaServingCup: 0.25 (¼ cup dried fruit)
        // usdaServingGrams: approximate weight of ¼ cup
        // smoothieDefaultGrams: how much we actually use in ONE smoothie for a 14–18 year-old boy
        // These are app-defined portions, not official USDA/EU serving sizes
        dried_figs: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 20
        },
        dried_dates: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_prunes: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 20
        },
        dried_raisins: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 18
        },
        dried_apple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 20,
          smoothieDefaultGrams: 20
        },
        dried_mango: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_pineapple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 18
        },
        dried_cranberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 18
        },
        dried_blueberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_cherries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 18
        },
        dried_peach: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 20
        },
        dried_pear: {
          usdaServingCup: 0.25,
          usdaServingGrams: 24,
          smoothieDefaultGrams: 20
        },
        dried_plum: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 20
        },
        dried_strawberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 22, // USDA standard: 22g (¼ cup)
          smoothieDefaultGrams: 18
        },
        dried_kiwi: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        dried_mulberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28, // USDA standard: 28g (¼ cup)
          smoothieDefaultGrams: 18
        },
        // Fallback for any dried fruit not explicitly listed
        defaultBoy1418DriedFruitGrams: 18
      },
      woman_19_30: {
        // Each entry:
        // usdaServingCup: 0.25 (¼ cup dried fruit)
        // usdaServingGrams: approximate weight of ¼ cup
        // smoothieDefaultGrams: how much we actually use in ONE smoothie for a woman 19–30 year-old
        // These are app-defined portions, not official USDA/EU serving sizes
        dried_apple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 20,
          smoothieDefaultGrams: 20
        },
        dried_apricots: {
          usdaServingCup: 0.25,
          usdaServingGrams: 34,
          smoothieDefaultGrams: 20
        },
        dried_banana: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 15
        },
        dried_blueberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 15
        },
        dried_cherries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 15
        },
        dried_cranberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 15
        },
        dried_dates: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 15
        },
        dried_figs: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 20
        },
        dried_raisins: {
          usdaServingCup: 0.25,
          usdaServingGrams: 40, // USDA standard: 40g (¼ cup)
          smoothieDefaultGrams: 15
        },
        dried_kiwi: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 15
        },
        dried_mango: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 20
        },
        dried_papaya: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 20
        },
        dried_peach: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 20
        },
        dried_pear: {
          usdaServingCup: 0.25,
          usdaServingGrams: 24,
          smoothieDefaultGrams: 20
        },
        dried_pineapple: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 20
        },
        dried_plum: {
          usdaServingCup: 0.25,
          usdaServingGrams: 32,
          smoothieDefaultGrams: 20
        },
        dried_prunes: {
          usdaServingCup: 0.25,
          usdaServingGrams: 38,
          smoothieDefaultGrams: 20
        },
        dried_strawberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 22,
          smoothieDefaultGrams: 15
        },
        dried_mulberries: {
          usdaServingCup: 0.25,
          usdaServingGrams: 28,
          smoothieDefaultGrams: 18
        },
        // Fallback for any dried fruit not explicitly listed
        defaultWoman1930DriedFruitGrams: 20
      },
      man_19_30: {
        // Each entry:
        // defaultServingGrams: how much we actually use in ONE smoothie for a man 19–30 year-old
        // healthTags: array of health benefits/tags
        // cautions: array of health goals where caution should be shown
        // These are app-defined portions, not official USDA/EU serving sizes
        "dried_raisins": {
          defaultServingGrams: 30,
          healthTags: ["energy_boost", "iron_support"],
          cautions: ["diabetes_blood_sugar", "weight_management"]
        },
        "dried_dates": {
          defaultServingGrams: 28,
          healthTags: ["energy_boost", "iron_support"],
          cautions: ["diabetes_blood_sugar", "weight_management"]
        },
        "dried_figs": {
          defaultServingGrams: 30,
          healthTags: ["bone_health", "digestive_health"],
          cautions: ["diabetes_blood_sugar"]
        },
        "dried_prunes": {
          defaultServingGrams: 25,
          healthTags: ["digestive_health", "bone_health"],
          cautions: ["loose_stools_sensitive_gut"]
        },
        "dried_apricots": {
          defaultServingGrams: 30,
          healthTags: ["bone_health", "anemia_prevention"],
          cautions: ["diabetes_blood_sugar"]
        },
        "dried_apple": {
          defaultServingGrams: 28,
          healthTags: ["digestive_health"],
          cautions: ["diabetes_blood_sugar"]
        },
        "dried_banana": {
          defaultServingGrams: 25,
          healthTags: ["energy_boost", "muscle_health"],
          cautions: ["diabetes_blood_sugar", "weight_management"]
        },
        "dried_mango": {
          defaultServingGrams: 30,
          healthTags: ["immune_system", "skin_health"],
          cautions: ["diabetes_blood_sugar", "weight_management"]
        },
        "dried_blueberries": {
          defaultServingGrams: 28,
          healthTags: ["brain_health", "heart_health", "anti_inflammatory"],
          cautions: ["diabetes_blood_sugar"]
        },
        "dried_cranberries": {
          defaultServingGrams: 28,
          healthTags: ["urinary_tract_support", "immune_system"],
          cautions: ["diabetes_blood_sugar"]
        },
        "dried_cherries": {
          defaultServingGrams: 28,
          healthTags: ["anti_inflammatory", "sleep_support"],
          cautions: ["diabetes_blood_sugar", "weight_management"]
        },
        "dried_goji_berries": {
          defaultServingGrams: 20,
          healthTags: ["immune_system", "eye_health"],
          cautions: ["thyroid_health_meds_interaction"]
        },
        "dried_mulberries": {
          defaultServingGrams: 30,
          healthTags: ["blood_circulation", "immune_system"],
          cautions: ["diabetes_blood_sugar"]
        },
        "dried_strawberries": {
          defaultServingGrams: 22,
          healthTags: ["immune_system", "skin_health"],
          cautions: ["diabetes_blood_sugar"]
        }
      },
      woman_31_59: {
        // Each entry:
        // smoothieDefaultGrams: how much we actually use in ONE smoothie for a woman 31–59 year-old
        // These are app-defined portions, not official USDA/EU serving sizes
        dried_apricot: {
          smoothieDefaultGrams: 20
        },
        dried_apricots: {
          smoothieDefaultGrams: 20
        },
        dried_prunes: {
          smoothieDefaultGrams: 20
        },
        dried_figs: {
          smoothieDefaultGrams: 20
        },
        dried_dates: {
          smoothieDefaultGrams: 15
        },
        dried_raisins: {
          smoothieDefaultGrams: 15
        },
        dried_cranberries: {
          smoothieDefaultGrams: 15
        },
        dried_cranberries_unsweetened: {
          smoothieDefaultGrams: 15
        },
        dried_cherries: {
          smoothieDefaultGrams: 15
        },
        dried_cherries_unsweetened: {
          smoothieDefaultGrams: 15
        },
        dried_blueberries: {
          smoothieDefaultGrams: 15
        },
        dried_blueberries_unsweetened: {
          smoothieDefaultGrams: 15
        },
        dried_strawberries: {
          smoothieDefaultGrams: 15
        },
        dried_strawberries_unsweetened: {
          smoothieDefaultGrams: 15
        },
        dried_apple: {
          smoothieDefaultGrams: 18
        },
        dried_banana: {
          smoothieDefaultGrams: 15
        },
        dried_mango: {
          smoothieDefaultGrams: 18
        },
        dried_pineapple: {
          smoothieDefaultGrams: 18
        },
        dried_peach: {
          smoothieDefaultGrams: 18
        },
        dried_pear: {
          smoothieDefaultGrams: 18
        },
        dried_kiwi: {
          smoothieDefaultGrams: 15
        },
        // Fallback for any dried fruit not explicitly listed
        defaultWoman3159DriedFruitGrams: 18
      },
      man_31_59: {
        // Each entry:
        // smoothieDefaultGrams: how much we actually use in ONE smoothie for a man 31–59 year-old
        // These are app-defined portions, not official USDA/EU serving sizes
        // Using same values as woman_31_59 for consistency
        dried_apricot: {
          smoothieDefaultGrams: 20
        },
        dried_apricots: {
          smoothieDefaultGrams: 20
        },
        dried_prunes: {
          smoothieDefaultGrams: 20
        },
        dried_figs: {
          smoothieDefaultGrams: 20
        },
        dried_dates: {
          smoothieDefaultGrams: 15
        },
        dried_raisins: {
          smoothieDefaultGrams: 15
        },
        dried_cranberries: {
          smoothieDefaultGrams: 15
        },
        dried_cranberries_unsweetened: {
          smoothieDefaultGrams: 15
        },
        dried_cherries: {
          smoothieDefaultGrams: 15
        },
        dried_cherries_unsweetened: {
          smoothieDefaultGrams: 15
        },
        dried_blueberries: {
          smoothieDefaultGrams: 15
        },
        dried_blueberries_unsweetened: {
          smoothieDefaultGrams: 15
        },
        dried_strawberries: {
          smoothieDefaultGrams: 15
        },
        dried_strawberries_unsweetened: {
          smoothieDefaultGrams: 15
        },
        dried_apple: {
          smoothieDefaultGrams: 18
        },
        dried_banana: {
          smoothieDefaultGrams: 15
        },
        dried_mango: {
          smoothieDefaultGrams: 18
        },
        dried_pineapple: {
          smoothieDefaultGrams: 18
        },
        dried_peach: {
          smoothieDefaultGrams: 18
        },
        dried_pear: {
          smoothieDefaultGrams: 18
        },
        dried_kiwi: {
          smoothieDefaultGrams: 15
        },
        // Fallback for any dried fruit not explicitly listed
        defaultMan3159DriedFruitGrams: 18
      },
      man_60_plus: {
        // Each entry:
        // smoothieDefaultGrams: how much we actually use in ONE smoothie for a man 60+ year-old
        // Target: 10-20g per dried fruit (conservative for men 60+)
        // These are app-defined portions, not official USDA/EU serving sizes
        dried_apricot: {
          smoothieDefaultGrams: 15
        },
        dried_apricots: {
          smoothieDefaultGrams: 15
        },
        dried_prunes: {
          smoothieDefaultGrams: 15
        },
        dried_figs: {
          smoothieDefaultGrams: 15
        },
        dried_dates: {
          smoothieDefaultGrams: 10
        },
        dried_raisins: {
          smoothieDefaultGrams: 10
        },
        dried_cranberries: {
          smoothieDefaultGrams: 12
        },
        dried_cranberries_unsweetened: {
          smoothieDefaultGrams: 12
        },
        dried_cherries: {
          smoothieDefaultGrams: 12
        },
        dried_cherries_unsweetened: {
          smoothieDefaultGrams: 12
        },
        dried_blueberries: {
          smoothieDefaultGrams: 12
        },
        dried_blueberries_unsweetened: {
          smoothieDefaultGrams: 12
        },
        dried_strawberries: {
          smoothieDefaultGrams: 12
        },
        dried_strawberries_unsweetened: {
          smoothieDefaultGrams: 12
        },
        dried_apple: {
          smoothieDefaultGrams: 15
        },
        dried_banana: {
          smoothieDefaultGrams: 10
        },
        dried_mango: {
          smoothieDefaultGrams: 15
        },
        dried_pineapple: {
          smoothieDefaultGrams: 15
        },
        dried_peach: {
          smoothieDefaultGrams: 15
        },
        dried_pear: {
          smoothieDefaultGrams: 15
        },
        dried_kiwi: {
          smoothieDefaultGrams: 12
        },
        // Fallback for any dried fruit not explicitly listed
        defaultMan60PlusDriedFruitGrams: 15
      }
    };
    
    // Dried fruit health profile for man 60+ age group
    // Flags: preferred, neutral, caution
    // Warnings show when relevant health goals are selected
    const DRIED_FRUIT_HEALTH_PROFILE_MAN_60_PLUS = {
      dried_apricot: {
        tier: "preferred",
        tags: ["bone health", "digestive health"],
        warning: "High fiber; may cause gas/bloating in some people."
      },
      dried_apricots: {
        tier: "preferred",
        tags: ["bone health", "digestive health"],
        warning: "High fiber; may cause gas/bloating in some people."
      },
      dried_prunes: {
        tier: "preferred",
        tags: ["digestive health", "bone health"],
        warning: "High fiber; may cause gas/bloating in some people. Can loosen stools if eaten in large amounts."
      },
      dried_figs: {
        tier: "caution",
        tags: ["digestive health", "heart health"],
        warning: "High-sugar dried fruit – use smaller portions for Heart/Diabetes/Weight goals, especially for men 60+."
      },
      dried_dates: {
        tier: "caution",
        tags: ["energy boost"],
        warning: "High-sugar dried fruit – use smaller portions for Heart/Diabetes/Weight goals, especially for men 60+."
      },
      dried_raisins: {
        tier: "caution",
        tags: ["energy boost"],
        warning: "High-sugar dried fruit – use smaller portions for Heart/Diabetes/Weight goals, especially for men 60+."
      },
      dried_cranberries: {
        tier: "neutral",
        tags: ["urinary support", "immune system"],
        warning: null
      },
      dried_cranberries_unsweetened: {
        tier: "neutral",
        tags: ["urinary support", "immune system"],
        warning: null
      },
      dried_cherries: {
        tier: "neutral",
        tags: ["anti-inflammatory", "sleep support"],
        warning: null
      },
      dried_cherries_unsweetened: {
        tier: "neutral",
        tags: ["anti-inflammatory", "sleep support"],
        warning: null
      },
      dried_blueberries: {
        tier: "neutral",
        tags: ["brain health", "anti-inflammatory"],
        warning: null
      },
      dried_blueberries_unsweetened: {
        tier: "neutral",
        tags: ["brain health", "anti-inflammatory"],
        warning: null
      },
      dried_strawberries: {
        tier: "neutral",
        tags: ["heart health", "skin health"],
        warning: null
      },
      dried_strawberries_unsweetened: {
        tier: "neutral",
        tags: ["heart health", "skin health"],
        warning: null
      },
      dried_apple: {
        tier: "neutral",
        tags: ["digestive health"],
        warning: null
      },
      dried_banana: {
        tier: "caution",
        tags: ["energy boost", "muscle health"],
        warning: "High-sugar dried fruit – use smaller portions for Heart/Diabetes/Weight goals, especially for men 60+."
      },
      dried_mango: {
        tier: "caution",
        tags: ["immune system", "skin health"],
        warning: "High-sugar dried fruit – use smaller portions for Heart/Diabetes/Weight goals, especially for men 60+."
      },
      dried_pineapple: {
        tier: "neutral",
        tags: ["digestion support"],
        warning: null
      },
      dried_peach: {
        tier: "neutral",
        tags: ["heart health"],
        warning: null
      },
      dried_pear: {
        tier: "neutral",
        tags: ["digestive health"],
        warning: "Can cause gas/bloating in some people."
      },
      dried_kiwi: {
        tier: "neutral",
        tags: ["immune system"],
        warning: null
      }
    };
    
    // Dried fruit health profile for woman 31–59 age group
    // Tags map to health goals, warnings show when relevant health goals are selected
    const DRIED_FRUIT_HEALTH_PROFILE_WOMAN_31_59 = {
      dried_apricot: {
        tags: ["bone health", "blood pressure", "pregnancy support"],
        warning: "May contain sulfites; some people are sensitive."
      },
      dried_apricots: {
        tags: ["bone health", "blood pressure", "pregnancy support"],
        warning: "May contain sulfites; some people are sensitive."
      },
      dried_prunes: {
        tags: ["digestive health", "bone health"],
        warning: "Can loosen stools if eaten in large amounts."
      },
      dried_figs: {
        tags: ["digestive health", "heart health"],
        warning: "High in natural sugars; use smaller portions for diabetes or weight management goals."
      },
      dried_dates: {
        tags: ["energy boost"],
        warning: "Very high in sugar; mark as 'caution' for Diabetes–Blood Sugar and Weight Management goals."
      },
      dried_raisins: {
        tags: ["energy boost"],
        warning: "High sugar and sticky; for Dental Health show a note to rinse/brush afterwards."
      },
      dried_cranberries: {
        tags: ["urinary support", "immune system"],
        warning: "If sweetened versions are used, sugar load increases; keep as 'caution' for Diabetes–Blood Sugar."
      },
      dried_cranberries_unsweetened: {
        tags: ["urinary support", "immune system"],
        warning: "If sweetened versions are used, sugar load increases; keep as 'caution' for Diabetes–Blood Sugar."
      },
      dried_cherries: {
        tags: ["anti-inflammatory", "sleep support"],
        warning: "High sugar; caution for Diabetes–Blood Sugar and Weight Management."
      },
      dried_cherries_unsweetened: {
        tags: ["anti-inflammatory", "sleep support"],
        warning: "High sugar; caution for Diabetes–Blood Sugar and Weight Management."
      },
      dried_blueberries: {
        tags: ["brain health", "anti-inflammatory"],
        warning: null
      },
      dried_blueberries_unsweetened: {
        tags: ["brain health", "anti-inflammatory"],
        warning: null
      },
      dried_strawberries: {
        tags: ["heart health", "skin health"],
        warning: null
      },
      dried_strawberries_unsweetened: {
        tags: ["heart health", "skin health"],
        warning: null
      },
      dried_apple: {
        tags: ["digestive health"],
        warning: "High sugar; caution for Diabetes–Blood Sugar goals."
      },
      dried_banana: {
        tags: ["energy boost", "muscle health"],
        warning: "Very high in sugar; mark 'caution' for Diabetes–Blood Sugar and Weight Management."
      },
      dried_mango: {
        tags: ["immune system", "skin health"],
        warning: "High sugar; caution for Diabetes–Blood Sugar and Weight Management."
      },
      dried_pineapple: {
        tags: ["digestion support"],
        warning: "Very high sugar and acidity; caution for Diabetes–Blood Sugar."
      },
      dried_peach: {
        tags: ["heart health"],
        warning: "High natural sugar; caution for Diabetes–Blood Sugar."
      },
      dried_pear: {
        tags: ["digestive health"],
        warning: "Can cause gas/bloating in some people."
      },
      dried_kiwi: {
        tags: ["immune system"],
        warning: "Possible allergen in sensitive users."
      }
    };
    
    // Dried fruit default portions for adults 60+ (men & women)
    // These are app smoothie portions, not official USDA/EU serving sizes
    // Conservative portions for age group 60+ because dried fruit is very sugar-dense
    const DRIED_FRUIT_DEFAULT_PORTIONS_60PLUS = {
      "dried apple": 25,
      "dried_apple": 25,
      "dried apricot": 25,
      "dried_apricot": 25,
      "dried_apricots": 25,
      "dried banana": 20,
      "dried_banana": 20,
      "dried blueberry": 20,
      "dried_blueberry": 20,
      "dried_blueberries": 20,
      "dried cherry": 25,
      "dried_cherry": 25,
      "dried_cherries": 25,
      "dried cranberry": 20,
      "dried_cranberry": 20,
      "dried_cranberries": 20,
      "dried date": 20,
      "dried_date": 20,
      "dried_dates": 20,
      "dried fig": 25,
      "dried_fig": 25,
      "dried_figs": 25,
      "dried mango": 25,
      "dried_mango": 25,
      "dried peach": 25,
      "dried_peach": 25,
      "dried pear": 25,
      "dried_pear": 25,
      "dried pineapple": 25,
      "dried_pineapple": 25,
      "dried plum": 25,
      "dried_plum": 25,
      "dried_prunes": 25,
      "dried raisins": 25,
      "dried_raisins": 25,
      "dried strawberry": 20,
      "dried_strawberry": 20,
      "dried_strawberries": 20,
      "mixed dried fruit": 30,
      "mixed_dried_fruit": 30
    };
    
    // Dried fruit health flags for health-goal-specific warnings
    // Used for woman_19_30 age group
    // Note: Keys should match normalized ingredient names (e.g., "dried_raisins", not "dried_grape_raisins")
    const DRIED_FRUIT_FLAGS = {
      dried_dates: { highSugar: true },
      dried_figs: { highSugar: true, highFiber: true },
      dried_raisins: { highSugar: true },
      dried_grape_raisins: { highSugar: true }, // Alias for dried_raisins
      dried_prunes: { highSugar: true, highFiber: true, laxative: true },
      dried_apricots: { highSugar: true, sorbitolLike: true },
      dried_apricot: { highSugar: true, sorbitolLike: true }, // Alias for dried_apricots
      dried_apple: { highSugar: true, sorbitolLike: true },
      dried_mango: { highSugar: true },
      dried_pineapple: { highSugar: true },
      dried_cherries: { highSugar: true },
      dried_cherry: { highSugar: true }, // Alias for dried_cherries
      dried_cranberries: { highSugar: true },
      dried_cranberry: { highSugar: true }, // Alias for dried_cranberries
      dried_kiwi: { highSugar: true },
      dried_strawberries: { highSugar: true },
      dried_strawberry: { highSugar: true }, // Alias for dried_strawberries
      dried_banana: { highSugar: true },
      dried_blueberries: { highSugar: true },
      dried_blueberry: { highSugar: true }, // Alias for dried_blueberries
      dried_peach: { highSugar: true },
      dried_pear: { highSugar: true },
      dried_plum: { highSugar: true }
    };
    
    // Adult dried fruit serving sizes (fallback for teen boy 14-18 when fruit not in teen map)
    // These are app-defined portions, not official USDA/EU serving sizes
    const ADULT_DRIED_FRUIT_GRAMS = {
      dried_apricots: 30,
      dried_figs: 30,
      dried_dates: 30,
      dried_prunes: 30,
      dried_raisins: 30,
      dried_sultanas: 30,
      dried_apple: 30,
      dried_pear: 30,
      dried_peach: 30,
      dried_plum: 30,
      dried_mango: 30,
      dried_pineapple: 30,
      dried_kiwi: 30,
      dried_banana: 30,
      dried_cranberries: 30,
      dried_cherries: 30,
      dried_blueberries: 30,
      dried_strawberries: 30,
      dried_goji: 30,
      dried_mulberries: 30,
      // Default fallback for any dried fruit not explicitly listed
      default: 30
    };

    // ============================================
    // VEGAN MILK HEALTH PROFILES
    // ============================================
    /**
     * Health tier and reason for each vegan milk type
     * Used to provide guidance in the UI
     */
    const VEGAN_MILK_HEALTH_PROFILE = {
      // OFFICIAL-STYLE DAIRY ALTERNATIVES (when fortified)
      'soy milk': {
        tier: 'preferred',
        isOfficialDairyAlt: true,
        isAppPortionOnly: false,
        reason: 'Higher protein and usually fortified with calcium and vitamin D. Good main milk alternative.',
        reasonGirl1418: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonBoy1418: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonWoman1930: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonMan1930: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonWoman3159: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonMan3159: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonWoman60Plus: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonMan60Plus: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.'
      },
      'soy_milk': {
        tier: 'preferred',
        isOfficialDairyAlt: true,
        isAppPortionOnly: false,
        reason: 'Higher protein and usually fortified with calcium and vitamin D. Good main milk alternative.',
        reasonGirl1418: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonBoy1418: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonWoman1930: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonMan1930: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonWoman3159: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonMan3159: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonWoman60Plus: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.',
        reasonMan60Plus: 'Fortified soy milk is recognized as a suitable dairy alternative when it matches cow\'s milk in protein, calcium, and vitamin D.'
      },
      'pea milk': {
        tier: 'preferred',
        isOfficialDairyAlt: true,
        isAppPortionOnly: false,
        reason: 'High protein and often fortified. Good main milk alternative.',
        reasonGirl1418: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonBoy1418: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman1930: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan1930: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman3159: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan3159: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman60Plus: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan60Plus: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.'
      },
      'pea_milk': {
        tier: 'preferred',
        isOfficialDairyAlt: true,
        isAppPortionOnly: false,
        reason: 'High protein and often fortified. Good main milk alternative.',
        reasonGirl1418: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonBoy1418: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman1930: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan1930: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman3159: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan3159: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman60Plus: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan60Plus: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.'
      },
      'pea protein milk': {
        tier: 'preferred',
        isOfficialDairyAlt: true,
        isAppPortionOnly: false,
        reason: 'High protein and often fortified. Good main milk alternative.',
        reasonGirl1418: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonBoy1418: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman1930: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan1930: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman3159: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan3159: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman60Plus: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan60Plus: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.'
      },
      'pea_protein_milk': {
        tier: 'preferred',
        isOfficialDairyAlt: true,
        isAppPortionOnly: false,
        reason: 'High protein and often fortified. Good main milk alternative.',
        reasonGirl1418: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonBoy1418: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman1930: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan1930: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman3159: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan3159: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonWoman60Plus: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.',
        reasonMan60Plus: 'High-protein, fortified pea milk can be nutritionally similar to dairy; treated as a dairy alternative in this app.'
      },
      // OTHER PLANT DRINKS – NOT OFFICIAL DAIRY ALTERNATIVES
      'oat milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Creamy but low in protein. Fine if diet has other protein sources.',
        reasonGirl1418: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official serving.',
        reasonBoy1418: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman1930: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan1930: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman3159: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan3159: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman60Plus: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan60Plus: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.'
      },
      'oat_milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Creamy but low in protein. Fine if diet has other protein sources.',
        reasonGirl1418: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official serving.',
        reasonBoy1418: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman1930: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan1930: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman3159: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan3159: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman60Plus: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan60Plus: 'Grain-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.'
      },
      'almond milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Very low protein. Mostly for flavor/light smoothies.',
        reasonGirl1418: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonBoy1418: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman1930: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan1930: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman3159: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan3159: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman60Plus: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan60Plus: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.'
      },
      'almond_milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Very low protein. Mostly for flavor/light smoothies.',
        reasonGirl1418: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonBoy1418: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman1930: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan1930: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman3159: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan3159: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonWoman60Plus: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.',
        reasonMan60Plus: 'Nut-based drink, low protein. Portion size is an app smoothie suggestion, not an official USDA/EU serving.'
      },
      'cashew milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Nut-based drink, low protein. Mostly for flavor.',
        reasonGirl1418: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonBoy1418: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonWoman1930: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonMan1930: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonWoman3159: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonMan3159: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonWoman60Plus: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonMan60Plus: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.'
      },
      'cashew_milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Nut-based drink, low protein. Mostly for flavor.',
        reasonGirl1418: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonBoy1418: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonWoman1930: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonMan1930: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonWoman3159: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonMan3159: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonWoman60Plus: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.',
        reasonMan60Plus: 'Nut-based drink, low protein. Portion size is app-defined, not officially standardized.'
      },
      'walnut milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Nut-based drink with healthy fats but low protein.',
        reasonGirl1418: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonBoy1418: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonWoman1930: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonMan1930: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonWoman3159: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonMan3159: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonWoman60Plus: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonMan60Plus: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.'
      },
      'walnut_milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Nut-based drink with healthy fats but low protein.',
        reasonGirl1418: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonBoy1418: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonWoman1930: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonMan1930: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonWoman3159: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonMan3159: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonWoman60Plus: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.',
        reasonMan60Plus: 'Nut-based drink with healthy fats but low protein. Portion is app-defined.'
      },
      'pistachio milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Nut-based drink, mostly flavor and fats.',
        reasonGirl1418: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonBoy1418: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonWoman1930: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonMan1930: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonWoman3159: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonMan3159: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonWoman60Plus: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonMan60Plus: 'Nut-based drink, mostly flavor and fats; portion is app-defined.'
      },
      'pistachio_milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Nut-based drink, mostly flavor and fats.',
        reasonGirl1418: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonBoy1418: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonWoman1930: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonMan1930: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonWoman3159: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonMan3159: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonWoman60Plus: 'Nut-based drink, mostly flavor and fats; portion is app-defined.',
        reasonMan60Plus: 'Nut-based drink, mostly flavor and fats; portion is app-defined.'
      },
      'hemp milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Balanced fats, often fortified, but not very high in protein.',
        reasonGirl1418: 'Seed-based drink; portion size is app-defined.',
        reasonBoy1418: 'Seed-based drink; portion size is app-defined.',
        reasonWoman1930: 'Seed-based drink; portion size is app-defined.',
        reasonMan1930: 'Seed-based drink; portion size is app-defined.',
        reasonWoman3159: 'Seed-based drink; portion size is app-defined.',
        reasonMan3159: 'Seed-based drink; portion size is app-defined.',
        reasonWoman60Plus: 'Seed-based drink; portion size is app-defined.',
        reasonMan60Plus: 'Seed-based drink; portion size is app-defined.'
      },
      'hemp_milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Balanced fats, often fortified, but not very high in protein.',
        reasonGirl1418: 'Seed-based drink; portion size is app-defined.',
        reasonBoy1418: 'Seed-based drink; portion size is app-defined.',
        reasonWoman1930: 'Seed-based drink; portion size is app-defined.',
        reasonMan1930: 'Seed-based drink; portion size is app-defined.',
        reasonWoman3159: 'Seed-based drink; portion size is app-defined.',
        reasonMan3159: 'Seed-based drink; portion size is app-defined.',
        reasonWoman60Plus: 'Seed-based drink; portion size is app-defined.',
        reasonMan60Plus: 'Seed-based drink; portion size is app-defined.'
      },
      'flax milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Often fortified; low protein unless it is a special high-protein version.',
        reasonGirl1418: 'Seed-based drink; portion size is app-defined.',
        reasonBoy1418: 'Seed-based drink; portion size is app-defined.',
        reasonWoman1930: 'Seed-based drink; portion size is app-defined.',
        reasonMan1930: 'Seed-based drink; portion size is app-defined.',
        reasonWoman3159: 'Seed-based drink; portion size is app-defined.',
        reasonMan3159: 'Seed-based drink; portion size is app-defined.',
        reasonWoman60Plus: 'Seed-based drink; portion size is app-defined.',
        reasonMan60Plus: 'Seed-based drink; portion size is app-defined.'
      },
      'flax_milk': {
        tier: 'neutral',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Often fortified; low protein unless it is a special high-protein version.',
        reasonGirl1418: 'Seed-based drink; portion size is app-defined.',
        reasonBoy1418: 'Seed-based drink; portion size is app-defined.',
        reasonWoman1930: 'Seed-based drink; portion size is app-defined.',
        reasonMan1930: 'Seed-based drink; portion size is app-defined.',
        reasonWoman3159: 'Seed-based drink; portion size is app-defined.',
        reasonMan3159: 'Seed-based drink; portion size is app-defined.',
        reasonWoman60Plus: 'Seed-based drink; portion size is app-defined.',
        reasonMan60Plus: 'Seed-based drink; portion size is app-defined.'
      },
      'coconut milk': {
        tier: 'caution',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Higher in saturated fat. Better in smaller amounts.',
        reasonGirl1418: 'Higher in saturated fat; portion size is app-defined, not an official serving.',
        reasonBoy1418: 'Higher in saturated fat; portion is app-defined, not an official serving.',
        reasonWoman1930: 'Higher in saturated fat; portion is app-defined, not an official serving.'
      },
      'coconut_milk': {
        tier: 'caution',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Higher in saturated fat. Better in smaller amounts.',
        reasonGirl1418: 'Higher in saturated fat; portion size is app-defined, not an official serving.',
        reasonBoy1418: 'Higher in saturated fat; portion is app-defined, not an official serving.',
        reasonWoman1930: 'Higher in saturated fat; portion is app-defined, not an official serving.'
      },
      'rice milk': {
        tier: 'caution',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Higher carbs and low protein. Use moderately, not as the only milk.',
        reasonGirl1418: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonBoy1418: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonWoman1930: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonMan1930: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonWoman3159: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonMan3159: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonWoman60Plus: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonMan60Plus: 'High carb, low protein; portion is app-defined, not an official dairy serving.'
      },
      'rice_milk': {
        tier: 'caution',
        isOfficialDairyAlt: false,
        isAppPortionOnly: true,
        reason: 'Higher carbs and low protein. Use moderately, not as the only milk.',
        reasonGirl1418: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonBoy1418: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonWoman1930: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonMan1930: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonWoman3159: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonMan3159: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonWoman60Plus: 'High carb, low protein; portion is app-defined, not an official dairy serving.',
        reasonMan60Plus: 'High carb, low protein; portion is app-defined, not an official dairy serving.'
      }
    };

    /**
     * Normalize vegan milk ingredient name for lookup
     * Converts various formats to a standard key for serving size lookup
     */
    function normalizeVeganMilkName(ingredientName) {
      if (!ingredientName) return null;
      
      const nameLower = ingredientName.toLowerCase().trim();
      
      // Map common variations to standard keys
      const nameMap = {
        'soy milk': 'soy milk',
        'soymilk': 'soy milk',
        'soy_milk': 'soy milk',
        'pea milk': 'pea milk',
        'pea protein milk': 'pea milk',
        'pea_protein_milk': 'pea milk',
        'oat milk': 'oat milk',
        'oat_milk': 'oat milk',
        'almond milk': 'almond milk',
        'almond_milk': 'almond milk',
        'hemp milk': 'hemp milk',
        'hemp_milk': 'hemp milk',
        'flax milk': 'flax milk',
        'flax_milk': 'flax milk',
        'coconut milk': 'coconut milk',
        'coconut_milk': 'coconut milk',
        'rice milk': 'rice milk',
        'rice_milk': 'rice milk',
        'cashew milk': 'cashew milk',
        'cashew_milk': 'cashew milk',
        'walnut milk': 'walnut milk',
        'walnut_milk': 'walnut milk',
        'pistachio milk': 'pistachio milk',
        'pistachio_milk': 'pistachio milk'
      };
      
      // Check for exact matches first
      if (nameMap[nameLower]) {
        return nameMap[nameLower];
      }
      
      // Check for partial matches
      for (const [key, value] of Object.entries(nameMap)) {
        if (nameLower.includes(key) || nameLower.includes(value)) {
          return value;
        }
      }
      
      return null;
    }

    /**
     * Get serving size in ml for a liquid ingredient (vegan milk) based on age group
     * @param {string} ageGroupKey - The normalized age group key (e.g., "girl_9_13", "child_4_8")
     * @param {string} ingredientName - The ingredient name
     * @param {number} defaultMl - The default/adult serving size in ml
     * @returns {number} - Serving size in ml (age-specific or default)
     */
    function getServingMlForLiquid(ageGroupKey, ingredientName, defaultMl) {
      if (!ageGroupKey || !ingredientName) return defaultMl;
      
      const normalizedName = normalizeVeganMilkName(ingredientName);
      if (!normalizedName) return defaultMl;
      
      // Special handling for child_4_8 - use KID_4_8_RECOMMENDED_VEGAN_MILKS
      if (ageGroupKey === 'child_4_8' && KID_4_8_RECOMMENDED_VEGAN_MILKS[normalizedName]) {
        return KID_4_8_RECOMMENDED_VEGAN_MILKS[normalizedName].servingMl || defaultMl;
      }
      
      // Check if we have age-specific serving ml for this age group
      if (recommendedServingMl[ageGroupKey]) {
        const groupMap = recommendedServingMl[ageGroupKey];
        
        // Try normalized name first
        if (groupMap[normalizedName] != null) {
          return groupMap[normalizedName];
        }
        
        // Try with underscores
        const underscoreName = normalizedName.replace(/\s+/g, '_');
        if (groupMap[underscoreName] != null) {
          return groupMap[underscoreName];
        }
      }
      
      // Fallback to default ml
      return defaultMl;
    }

    /**
     * Central helper to get serving grams for an ingredient based on age group
     * This is the SINGLE SOURCE OF TRUTH for serving sizes - respects fresh vs dried
     * 
     * IMPORTANT: This function does NOT normalize "dried_apple" to "apple"
     * It treats "dried_apple" and "apple" as completely different ingredients
     * 
     * @param {string} ingredientId - The full ingredient ID (e.g., "dried_apple", "apple", "dried_banana", "banana")
     * @param {string} ageGroup - The age group (e.g., "child-4-8", "girl-9-13", "woman-19-30", "man-60+")
     * @returns {number} - Serving grams for this ingredient at this age group
     * 
     * SANITY TEST SCENARIOS:
     * 
     * Scenario A: ageGroup = "child-4-8", ingredients = ["apple", "dried_apple"]
     *   - "apple" → uses recommendedServingGrams.child_4_8.apple (fresh child portion, e.g., 95g)
     *   - "dried_apple" → uses DRIED_FRUIT_SERVINGS.child_4_8.dried_apple.smoothieDefaultGrams (dried child portion, e.g., 12g)
     *   - They do NOT share the same grams
     * 
     * Scenario B: ageGroup = "woman-31-59", ingredients = ["dried_banana", "banana"]
     *   - "dried_banana" → uses DRIED_FRUIT_SERVINGS.woman_31_59.dried_banana.smoothieDefaultGrams (e.g., 15g)
     *   - "banana" → uses recommendedServingGrams.woman_31_59.banana (fresh portion, e.g., 120g)
     *   - Nutrition macros reflect these different weights
     * 
     * Scenario C: ageGroup = "man-60+", ingredients = ["dried_apple", "apple"]
     *   - "dried_apple" → uses DRIED_FRUIT_DEFAULT_PORTIONS_60PLUS["dried apple"] or ["dried_apple"] (e.g., 25g)
     *   - "apple" → uses recommendedServingGrams.man_60_plus.apple (fresh portion, e.g., 100g)
     *   - Different grams for dried vs fresh, consistent between chips, smoothie summary, and nutrition output
     *   - No "0.0 kcal / 0.0 g" issues for dried fruits
     */
    function getServingGramsForIngredient(ingredientId, ageGroup) {
      if (!ingredientId) return 0;
      
      const isDried = isDriedFruit(ingredientId);
      const isFresh = isFreshFruit(ingredientId);
      
      // Use the unified getPortionGrams function for all fruits
      if (isDried || isFresh) {
        // Normalize ingredient key - remove "dried_" prefix for lookup
        let ingredientKey = ingredientId.toLowerCase().trim();
        if (ingredientKey.startsWith('dried_')) {
          ingredientKey = ingredientKey.replace(/^dried_/, '');
        } else if (ingredientKey.startsWith('dried ')) {
          ingredientKey = ingredientKey.replace(/^dried /, '');
        }
        
        // Get default adult grams (fallback)
        // For fresh fruits: use 182g for apple, 120g for banana, etc. (adult base)
        // For dried fruits: use 28g for apple, 30g for raisins, etc. (adult base)
        let defaultAdultGrams = 0;
        if (isDried) {
          defaultAdultGrams = 30; // Default dried fruit portion
        } else {
          // Try to get from adult_19_30 map as fallback
          const normalizedKey = normalizeIngredientNameForServing(ingredientKey);
          if (normalizedKey && recommendedServingGrams.adult_19_30 && recommendedServingGrams.adult_19_30[normalizedKey]) {
            defaultAdultGrams = recommendedServingGrams.adult_19_30[normalizedKey];
          } else {
            defaultAdultGrams = 150; // Default fresh fruit portion
          }
        }
        
        // Use the unified function
        return getPortionGrams({
          ageGroup: ageGroup,
          ingredientKey: ingredientKey,
          isDried: isDried,
          defaultAdultGrams: defaultAdultGrams
        });
      }
      
      // Not a fruit - return 0 (handled by other logic for milks, etc.)
      return 0;
    }
    
    /**
     * Age-based vegetable portion map for smoothies
     * Structure: RECOMMENDED_VEG_PORTIONS_GRAMS[ageGroupKey][fresh][vegKey] = grams
     * These grams are per smoothie per child, NOT per day.
     * 
     * Example:
     *   RECOMMENDED_VEG_PORTIONS_GRAMS.child_4_8.fresh.spinach = 15
     *   RECOMMENDED_VEG_PORTIONS_GRAMS.girl_9_13.fresh.carrot = 30
     */
    const RECOMMENDED_VEG_PORTIONS_GRAMS = {
      child_4_8: {
        fresh: {
          spinach:          15,
          kale:             15,
          romaine_lettuce:  15,
          cucumber:         25,
          zucchini:         25,
          carrot:           25,
          pumpkin:          25,
          butternut_squash: 25,
          sweet_potato:     25,
          avocado:          15,   // ~1 tbsp mashed / small chunk, kid friendly
          cauliflower:      15,
          beetroot:         10,
          celery:           10,
          broccoli:         10
        }
      },
      girl_9_13: {
        fresh: {
          spinach:          20,
          kale:             20,
          romaine_lettuce:  20,
          cucumber:         35,
          zucchini:         35,
          carrot:           30,
          pumpkin:          30,
          butternut_squash: 30,
          sweet_potato:     30,
          avocado:          25,   // modest teen portion
          cauliflower:      20,
          beetroot:         15,
          celery:           15,
          broccoli:         15
        }
      },
      boy_9_13: {
        fresh: {
          spinach:          22,
          kale:             22,
          romaine_lettuce:  22,
          cucumber:         40,
          zucchini:         40,
          carrot:           35,
          pumpkin:          35,
          butternut_squash: 35,
          sweet_potato:     35,
          avocado:          30,   // modest teen portion
          cauliflower:      22,
          beetroot:         18,
          celery:           18,
          broccoli:         18
        }
      },
      girl_14_18: {
        fresh: {
          spinach:          25,  // ~small handful
          kale:             25,
          romaine_lettuce:  30,
          cucumber:         60,
          zucchini:         45,
          carrot:           35,
          pumpkin:          40,
          butternut_squash: 45,
          sweet_potato:     55,
          avocado:          35,  // ~1/4 medium avocado
          cauliflower:      45,
          beetroot:         35,
          celery:           25,
          broccoli:         45
        }
      },
      boy_14_18: {
        fresh: {
          spinach:          30,
          kale:             30,
          romaine_lettuce:  35,
          cucumber:         70,
          zucchini:         55,
          carrot:           40,
          pumpkin:          50,
          butternut_squash: 55,
          sweet_potato:     65,
          avocado:          45,  // ~1/3–1/2 medium avocado
          cauliflower:      55,
          beetroot:         40,
          celery:           30,
          broccoli:         55
        }
      },
      woman_19_30: {
        fresh: {
          spinach:          30,
          kale:             40,
          romaine_lettuce:  35,
          cucumber:         60,
          zucchini:         60,
          carrot:           60,
          beetroot:         60,
          celery:           60,
          broccoli:         60,
          cauliflower:      60,
          pumpkin:          75,
          butternut_squash: 75,
          sweet_potato:     75,
          avocado:          40
        }
      },
      man_19_30: {
        fresh: {
          spinach:          40,
          kale:             50,
          romaine_lettuce:  40,
          cucumber:         80,
          zucchini:         80,
          carrot:           75,
          beetroot:         75,
          celery:           75,
          broccoli:         80,
          cauliflower:      80,
          pumpkin:          90,
          butternut_squash: 90,
          sweet_potato:     90,
          avocado:          50
        }
      },
      woman_31_59: {
        fresh: {
          spinach:          30,
          kale:             40,
          romaine_lettuce:  35,
          cucumber:         60,
          zucchini:         60,
          carrot:           60,
          beetroot:         60,
          celery:           60,
          broccoli:         60,
          cauliflower:      60,
          pumpkin:          75,
          butternut_squash: 75,
          sweet_potato:     75,
          avocado:          40
        }
      },
      man_31_59: {
        fresh: {
          spinach:          40,
          kale:             50,
          romaine_lettuce:  40,
          cucumber:         80,
          zucchini:         80,
          carrot:           75,
          beetroot:         75,
          celery:           75,
          broccoli:         80,
          cauliflower:      80,
          pumpkin:          90,
          butternut_squash: 90,
          sweet_potato:     90,
          avocado:          50
        }
      },
      woman_60_plus: {
        fresh: {
          spinach:          30,
          kale:             40,
          romaine_lettuce:  35,
          cucumber:         60,
          zucchini:         60,
          carrot:           60,
          beetroot:         60,
          celery:           60,
          broccoli:         60,
          cauliflower:      60,
          pumpkin:          75,
          butternut_squash: 75,
          sweet_potato:     75,
          avocado:          40
        }
      },
      man_60_plus: {
        fresh: {
          spinach:          40,
          kale:             50,
          romaine_lettuce:  40,
          cucumber:         80,
          zucchini:         80,
          carrot:           75,
          beetroot:         75,
          celery:           75,
          broccoli:         80,
          cauliflower:      80,
          pumpkin:          90,
          butternut_squash: 90,
          sweet_potato:     90,
          avocado:          50
        }
      }
    };
    
    /**
     * Age-aware sweetener profile for natural added sweeteners
     * Structure: SWEETENER_PROFILE[sweetenerKey].recommendedMaxGramsByAge[uiAgeGroup] = maxGrams
     * 
     * These are MAX grams per smoothie, not per day.
     * Sweetness should come mainly from fruit; these are optional additions.
     */
    const SWEETENER_PROFILE = {
      honey: {
        displayName: "Honey",
        category: "natural_added_sweetener",
        // MAX grams of honey per smoothie by UI age group:
        // (4g ≈ 1 tsp)
        recommendedMaxGramsByAge: {
          "child-4-8":     4,  // prefer 0, but allow up to 4g
          "girl-9-13":     6,
          "boy-9-13":      7,
          "girl-14-18":    6,
          "boy-14-18":     6,
          "woman-19-30":   8,
          "man-19-30":     8,
          "woman-31-59":   8,
          "man-31-59":     8,
          "woman-60+":     8,
          "man-60+":       8
        }
      },
      maple_syrup: {
        displayName: "Maple syrup",
        category: "natural_added_sweetener",
        recommendedMaxGramsByAge: {
          "child-4-8":     4,
          "girl-9-13":     6,
          "boy-9-13":      7,
          "girl-14-18":    6,
          "boy-14-18":     6,
          "woman-19-30":   8,
          "man-19-30":     8,
          "woman-31-59":   8,
          "man-31-59":     8,
          "woman-60+":     8,
          "man-60+":       8
        }
      },
      coconut_sugar: {
        displayName: "Coconut sugar",
        category: "natural_added_sweetener",
        recommendedMaxGramsByAge: {
          "child-4-8":     4,
          "girl-9-13":     5,
          "boy-9-13":      6,
          "girl-14-18":    6,
          "boy-14-18":     6,
          "woman-19-30":   8,
          "man-19-30":     8,
          "woman-31-59":   8,
          "man-31-59":     8,
          "woman-60+":     8,
          "man-60+":       8
        }
      },
      date_syrup: {
        displayName: "Date syrup",
        category: "natural_added_sweetener",
        // Date syrup is a concentrated added sugar made from dates.
        // We allow slightly higher grams than honey/maple, but still limited:
        recommendedMaxGramsByAge: {
          "child-4-8":     6,  // Updated to 6g for child 4-8 as requested
          "girl-9-13":     8,
          "boy-9-13":      9,
          "girl-14-18":    15,
          "boy-14-18":     15,
          "woman-19-30":   20,
          "man-19-30":     20,
          "woman-31-59":   20,
          "man-31-59":     20,
          "woman-60+":     20,
          "man-60+":       20
        }
      }
    };
    
    /**
     * Normalize sweetener name to internal key
     * @param {string} name - The ingredient name
     * @returns {string} - Normalized key (e.g., "maple_syrup", "date_syrup")
     */
    function normalizeSweetenerKey(name) {
      if (!name) return "";
      const key = name.trim().toLowerCase();
      
      // Handle exact matches
      if (key === "maple syrup" || key === "maple_syrup") return "maple_syrup";
      if (key === "date syrup" || key === "date paste" || key === "date sugar" || key === "date_syrup") {
        return "date_syrup";
      }
      if (key === "coconut sugar" || key === "coconut_sugar") return "coconut_sugar";
      if (key === "honey" || key === "raw honey") return "honey";
      
      // Fallback: replace spaces with underscores
      return key.replace(/\s+/g, "_");
    }
    
    /**
     * Check if an ingredient is a sweetener
     * @param {string} ingredientName - The ingredient name
     * @returns {boolean} - True if the ingredient is a sweetener
     */
    function isSweetener(ingredientName) {
      if (!ingredientName) return false;
      const key = normalizeSweetenerKey(ingredientName);
      return SWEETENER_PROFILE.hasOwnProperty(key);
    }
    
    /**
     * Get sweetener serving size in grams for a given age group
     * @param {string} ingredientKey - The ingredient name
     * @param {string} ageGroup - The UI age group (e.g., "child-4-8")
     * @returns {number|null} - Grams for the sweetener, or null if not a sweetener or no age-specific portion
     */
    function getSweetenerPortionGrams(ingredientKey, ageGroup) {
      if (!ingredientKey || !ageGroup) return null;
      
      const normalizedKey = normalizeSweetenerKey(ingredientKey);
      const profile = SWEETENER_PROFILE[normalizedKey];
      
      if (!profile || !profile.recommendedMaxGramsByAge) return null;
      
      // Get the max grams for this age group (this is the serving size we want to use)
      const maxGrams = profile.recommendedMaxGramsByAge[ageGroup];
      
      if (maxGrams != null && maxGrams > 0) {
        return maxGrams;
      }
      
      return null;
    }
    
    /**
     * Check if a smoothie has any sweeteners
     * @param {Array} ingredients - Array of ingredient objects
     * @returns {boolean} - True if the smoothie contains at least one sweetener
     */
    function smoothieHasSweetener(ingredients) {
      if (!Array.isArray(ingredients)) return false;
      
      for (const ing of ingredients) {
        const rawName = typeof ing === 'string' ? ing : (ing && ing.name ? ing.name : '');
        if (!rawName) continue;
        
        const key = normalizeSweetenerKey(rawName);
        
        if (key === "honey" ||
            key === "maple_syrup" ||
            key === "coconut_sugar" ||
            key === "date_syrup") {
          return true;
        }
      }
      return false;
    }
    
    /**
     * Check if an age group is a child or teen
     * @param {string} uiAgeGroup - The UI age group string
     * @returns {boolean} - True if the age group is a child or teen
     */
    function isChildOrTeenAge(uiAgeGroup) {
      return uiAgeGroup === "child-4-6" ||
             uiAgeGroup === "child-7-8" ||
             uiAgeGroup === "child-4-8" || // backward compatibility
             uiAgeGroup === "girl-9-13" ||
             uiAgeGroup === "boy-9-13" ||
             uiAgeGroup === "girl-14-18" ||
             uiAgeGroup === "boy-14-18";
    }
    
    /**
     * Get sweetener age tip message for children/teens
     * @param {string} uiAgeGroup - The UI age group string
     * @param {Array} ingredients - Array of ingredient objects
     * @returns {string|null} - The tip message or null if not applicable
     */
    function getSweetenerAgeTip(uiAgeGroup, ingredients) {
      if (!isChildOrTeenAge(uiAgeGroup)) return null;
      if (!smoothieHasSweetener(ingredients)) return null;
      
      // Gender and age-specific messages
      if (uiAgeGroup === "child-4-6" || uiAgeGroup === "child-7-8" || uiAgeGroup === "child-4-8") {
        return "For kids, added sweeteners like honey, maple syrup, coconut sugar or date syrup should stay small. " +
               "Try to let most of the sweetness come from fruit.";
      }
      
      if (uiAgeGroup === "girl-9-13") {
        return "For girls 9-13, added sweeteners like honey, maple syrup, coconut sugar or date syrup should stay small. " +
               "Try to let most of the sweetness come from fruit.";
      }
      
      if (uiAgeGroup === "boy-9-13") {
        return "For boys 9-13, added sweeteners like honey, maple syrup, coconut sugar or date syrup should stay small. " +
               "Try to let most of the sweetness come from fruit.";
      }
      
      if (uiAgeGroup === "girl-14-18") {
        return "For teen girls, added sweeteners like honey, maple syrup, coconut sugar or date syrup are best kept in small amounts. " +
               "Rely more on fruit for sweetness when possible.";
      }
      
      if (uiAgeGroup === "boy-14-18") {
        return "For teen boys, added sweeteners like honey, maple syrup, coconut sugar or date syrup are best kept in small amounts. " +
               "Rely more on fruit for sweetness when possible.";
      }
      
      return null;
    }
    
    /**
     * Check if an age group is an adult (19+)
     * @param {string} ageGroup - The UI age group string
     * @returns {boolean} - True if the age group is an adult
     */
    function isAdultAgeGroup(ageGroup) {
      return ageGroup === "woman-19-30" ||
             ageGroup === "man-19-30" ||
             ageGroup === "woman-31-59" ||
             ageGroup === "man-31-59" ||
             ageGroup === "woman-60+" ||
             ageGroup === "man-60+";
    }
    
    /**
     * Normalize goal value by converting special dashes to hyphens and standardizing format
     * @param {string} v - The goal value to normalize
     * @returns {string} - Normalized goal value
     */
    function normalizeGoalValue(v) {
      return String(v || '')
        .toLowerCase()
        .trim()
        .replace(/[\u2010-\u2015]/g, '-')          // normalize fancy dashes to hyphen
        .replace(/[^a-z0-9]+/g, '-')              // keep only a-z0-9, convert others to hyphen
        .replace(/^-+|-+$/g, '');                 // trim hyphens
    }
    
    /**
     * Check if the health goal is "Diabetes–Blood Sugar"
     * @param {string} healthGoalValue - The health goal value from the dropdown
     * @returns {boolean} - True if the goal is Diabetes–Blood Sugar
     */
    function isDiabetesBloodSugarGoal(healthGoalValue) {
      const goal = normalizeGoalValue(healthGoalValue);
      return goal === 'diabetes-blood-sugar' || goal === 'blood-sugar-support';
    }
    
    /**
     * Check if the health goal is "Weight Management"
     * @param {string} healthGoalValue - The health goal value from the dropdown
     * @returns {boolean} - True if the goal is Weight Management
     */
    function isWeightManagementGoal(healthGoalValue) {
      if (!healthGoalValue) return false;
      const v = String(healthGoalValue).toLowerCase().trim();
      // Normalize by replacing multiple dashes/spaces with single dash, then check
      const normalized = v.replace(/[\s\-]+/g, '-');
      // Check for "weight-management" or "weight-loss" format (API uses "Weight Loss" -> value is "weight-loss")
      return normalized === "weight-management" ||
             normalized === "weight-loss" ||
             (normalized.includes("weight") && normalized.includes("management")) ||
             (normalized.includes("weight") && normalized.includes("loss"));
    }
    
    /**
     * Check if the health goal is "Blood Pressure"
     * @param {string} healthGoalValue - The health goal value from the dropdown
     * @returns {boolean} - True if the goal is Blood Pressure
     */
    function isBloodPressureGoal(healthGoalValue) {
      if (!healthGoalValue) return false;
      const v = String(healthGoalValue).toLowerCase().trim();
      // Normalize by replacing multiple dashes/spaces with single dash, then check
      const normalized = v.replace(/[\s\-]+/g, '-');
      // Check for "blood-pressure" format
      return normalized === "blood-pressure" ||
             (normalized.includes("blood") && normalized.includes("pressure"));
    }
    
    /**
     * Get blood pressure tip message based on health goal
     * @param {string} healthGoalValue - The health goal value from the dropdown
     * @returns {string|null} - The tip message or null if not applicable
     */
    function getBloodPressureTip(healthGoalValue) {
      if (!isBloodPressureGoal(healthGoalValue)) return null;
      
      return "We're watching out for your blood pressure—every ingredient matters.<br><br>" +
             "High blood pressure is serious, and we're here to guide you toward blood pressure-friendly ingredients. " +
             "From this moment on, we'll help you avoid ingredients that could raise your blood " +
             "pressure and guide you toward foods that naturally support healthy levels.<br><br>" +
             "<strong>Hidden dangers we'll help you avoid:</strong><br>" +
             "❌ Added sodium/salt (even small amounts add up)<br>" +
             "❌ Added sugars (raises blood pressure over time)<br>" +
             "❌ High-sodium ingredients (some protein powders, cheeses)<br>" +
             "❌ Excess caffeine (if you're sensitive)<br>" +
             "❌ Licorice root (can raise blood pressure)<br><br>" +
             "<strong>Natural blood pressure supporters we'll recommend:</strong><br>" +
             "✅ Potassium-rich foods (bananas, oranges, berries)<br>" +
             "✅ Magnesium sources (spinach, kale, pumpkin seeds)<br>" +
             "✅ Beets (natural nitrates relax blood vessels)<br>" +
             "✅ Berries (anthocyanins support vascular health)<br>" +
             "✅ Low-fat dairy (calcium + potassium combination)<br>" +
             "✅ Leafy greens (loaded with minerals that help)<br>" +
             "✅ Unsweetened bases (no hidden sodium)<br><br>" +
             "<strong>📊 YOUR INGREDIENT COMPANION:</strong> Not sure which option is better? Check the " +
             "Ingredient Tab to see sodium, potassium, calcium, magnesium, and protein " +
             "levels in every ingredient. We've made it easy to compare and choose what's " +
             "best for your heart.<br><br>" +
             "Every smoothie you make with us is a step toward better control. You're " +
             "taking care of yourself, and we're honored to help.<br><br>" +
             "Your heart health matters—to your family, your future, and to us. ❤️<br><br>" +
             "<em>Remember: Work closely with your healthcare team for the best results.</em>";
    }
    
    /**
     * Get weight management tip message based on age group and health goal
     * @param {string} uiAgeGroup - The UI age group string
     * @param {string} healthGoalValue - The health goal value from the dropdown
     * @returns {string|null} - The tip message or null if not applicable
     */
    function getWeightManagementTip(uiAgeGroup, healthGoalValue) {
      if (!isWeightManagementGoal(healthGoalValue)) return null;
      
      // Use the same encouraging message for all age groups
      return "💙 We're here to help you succeed.<br><br>" +
             "You've chosen Weight Management, and we want you to know: we're going to make " +
             "sure every ingredient works FOR you, not against you.<br><br>" +
             "<strong>Here's what can sabotage your goals:</strong><br>" +
             "• Large fruit portions (natural sugar adds up fast)<br>" +
             "• Dried fruits (concentrated calories)<br>" +
             "• Nut butters & oils (200+ calories per serving)<br>" +
             "• Added sweeteners (empty calories you don't need)<br><br>" +
             "<strong>What we'll guide you toward instead:</strong><br>" +
             "✓ Fresh vegetables (bulk without calories)<br>" +
             "✓ Berries & moderate fruit (satisfying sweetness)<br>" +
             "✓ Unsweetened bases (protein keeps you full)<br>" +
             "✓ Smart portions (delicious AND effective)<br><br>" +
             "Your success matters to us. Let's build a smoothie that helps you reach your goals. 💪";
    }
    
    /**
     * Compute total sweetener grams in a smoothie
     * @param {Array} ingredients - Array of ingredient objects
     * @returns {number} - Total grams of sweeteners
     */
    function computeTotalSweetenerGrams(ingredients) {
      let total = 0;
      if (!ingredients || !Array.isArray(ingredients)) {
        console.log("[sweetener-debug] computeTotalSweetenerGrams: invalid ingredients array", ingredients);
        return total;
      }
      
      console.log("[sweetener-debug] computeTotalSweetenerGrams: scanning", ingredients.length, "ingredients");
      console.log("[sweetener-debug] computeTotalSweetenerGrams: full ingredients array", ingredients);
      
      for (const ing of ingredients) {
        // Check multiple possible name fields
        const rawName = ing.name || ing.key || ing.nutritionLookupName || "";
        let key = normalizeSweetenerKey(rawName);
        let profile = SWEETENER_PROFILE[key];
        
        // If no profile found, try checking all profile keys directly
        if (!profile && rawName) {
          const rawNameLower = rawName.toLowerCase().trim();
          // Check if any profile key matches (case-insensitive partial match)
          for (const profileKey in SWEETENER_PROFILE) {
            if (rawNameLower.includes(profileKey.replace(/_/g, ' ')) || 
                rawNameLower.includes(profileKey.replace(/_/g, ''))) {
              key = profileKey;
              profile = SWEETENER_PROFILE[profileKey];
              console.log("[sweetener-debug] found profile via fallback matching:", {
                rawName: rawName,
                matchedProfileKey: profileKey
              });
              break;
            }
          }
        }
        
        console.log("[sweetener-debug] scanning ingredient:", {
          rawName: rawName,
          normalizedKey: key,
          hasProfile: !!profile,
          name: ing.name,
          key: ing.key,
          nutritionLookupName: ing.nutritionLookupName,
          ingObject: ing
        });
        
        if (!profile) {
          continue;
        }
        
        const grams = typeof ing.grams === "number"
          ? ing.grams
          : typeof ing.portionGrams === "number"
          ? ing.portionGrams
          : typeof ing.totalGrams === "number"
          ? ing.totalGrams
          : 0;
        
        console.log("[sweetener-debug] matched sweetener:", {
          key: key,
          grams: grams,
          gramsField: typeof ing.grams === "number" ? "grams" : typeof ing.portionGrams === "number" ? "portionGrams" : typeof ing.totalGrams === "number" ? "totalGrams" : "none"
        });
        
        if (grams > 0) {
          total += grams;
        }
      }
      
      console.log("[sweetener-debug] totalSweetenerGrams:", total);
      return total;
    }
    
    /**
     * Get max total sweetener grams per smoothie by UI age group
     * @param {string} uiAgeGroup - The UI age group string (e.g., "child-4-8", "woman-19-30")
     * @returns {number} - Max total sweetener grams for this age group
     */
    function getMaxTotalSweetenerGrams(uiAgeGroup) {
      switch (uiAgeGroup) {
        case "child-4-6":
        case "child-7-8":
        case "child-4-8":
          return 10;  // up to ~1 tsp honey + a bit of date syrup
        case "girl-9-13":
        case "boy-9-13":
          return 15;
        case "girl-14-18":
        case "boy-14-18":
          return 15;
        case "woman-19-30":
        case "man-19-30":
        case "woman-31-59":
        case "man-31-59":
        case "woman-60+":
        case "man-60+":
          return 20;
        default:
          // fallback: treat unknown as adult
          return 20;
      }
    }
    
    /**
     * Check if a health goal is blood sugar or weight related
     * @param {string} healthGoal - The health goal value
     * @returns {boolean} - True if goal is blood sugar or weight related
     */
    function isBloodSugarOrWeightGoal(healthGoal) {
      if (!healthGoal) return false;
      const goalLower = healthGoal.toLowerCase();
      return goalLower.includes('diabetes') || 
             goalLower.includes('blood sugar') ||
             goalLower.includes('weight') ||
             goalLower.includes('weight loss') ||
             goalLower.includes('weight management');
    }
    
    /**
     * Check if an ingredient is a vegetable
     * @param {string} ingredientName - The ingredient name
     * @returns {boolean} - True if the ingredient is a vegetable
     */
    function isVegetable(ingredientName) {
      if (!ingredientName) return false;
      
      const vegetables = [
        'spinach', 'kale', 'romaine lettuce', 'romaine_lettuce',
        'cucumber', 'zucchini',
        'carrot', 'pumpkin', 'butternut squash', 'butternut_squash',
        'sweet potato', 'sweet_potato',
        'avocado', 'cauliflower',
        'beetroot', 'beets', 'celery', 'broccoli'
      ];
      
      const nameLower = ingredientName.toLowerCase().trim();
      return vegetables.some(veg => {
        // Check for exact match or if name contains the vegetable
        const vegLower = veg.toLowerCase();
        return nameLower === vegLower || 
               nameLower.includes(vegLower) || 
               vegLower.includes(nameLower);
      });
    }
    
    /**
     * Normalize vegetable ingredient name to canonical key
     * Maps UI display names to simple DB keys without creating new entries
     * @param {string} ingredientName - The ingredient name from UI
     * @returns {string} - Normalized key (e.g., "spinach", "carrot", "sweet_potato")
     */
    function normalizeVegetableKey(ingredientName) {
      if (!ingredientName) return '';
      
      const nameLower = ingredientName.toLowerCase().trim();
      
      // Mapping of UI names to canonical keys
      const vegMap = {
        'spinach': 'spinach',
        'kale': 'kale',
        'romaine lettuce': 'romaine_lettuce',
        'romaine_lettuce': 'romaine_lettuce',
        'cucumber': 'cucumber',
        'zucchini': 'zucchini',
        'carrot': 'carrot',
        'pumpkin': 'pumpkin',
        'butternut squash': 'butternut_squash',
        'butternut_squash': 'butternut_squash',
        'sweet potato': 'sweet_potato',
        'sweet_potato': 'sweet_potato',
        'avocado': 'avocado',
        'cauliflower': 'cauliflower',
        'beetroot': 'beetroot',
        'beets': 'beetroot',
        'celery': 'celery',
        'broccoli': 'broccoli'
      };
      
      // Try exact match first
      if (vegMap[nameLower]) {
        return vegMap[nameLower];
      }
      
      // Try partial matches
      for (const [uiName, key] of Object.entries(vegMap)) {
        if (nameLower.includes(uiName) || uiName.includes(nameLower)) {
          return key;
        }
      }
      
      // Fallback: return normalized version (replace spaces with underscores, lowercase)
      return nameLower.replace(/\s+/g, '_');
    }
    
    /**
     * Get vegetable portion grams for a given age group
     * @param {string} ageGroup - The age group (e.g., "child-4-8", "girl-9-13", "boy-9-13")
     * @param {string} ingredientKey - The ingredient key
     * @param {number} defaultAdultGrams - Default grams for adults (fallback)
     * @returns {number} - Grams for the vegetable portion
     */
    function getVegPortionGrams(ageGroup, ingredientKey, defaultAdultGrams = 0) {
      if (!ageGroup) return defaultAdultGrams || 0;
      
      // Map UI age group strings to internal keys (same logic as getPortionGrams)
      let internalKey = null;
      if (ageGroup === 'girl-9-13') {
        internalKey = 'girl_9_13';
      } else if (ageGroup === 'boy-9-13') {
        internalKey = 'boy_9_13';
      } else if (ageGroup === 'child-4-6' || ageGroup === 'child-7-8' || ageGroup === 'child-4-8') {
        internalKey = 'child_4_8';
      } else if (ageGroup === 'girl-14-18') {
        internalKey = 'girl_14_18';
      } else if (ageGroup === 'boy-14-18') {
        internalKey = 'boy_14_18';
      } else if (ageGroup === 'woman-19-30') {
        internalKey = 'woman_19_30';
      } else if (ageGroup === 'man-19-30') {
        internalKey = 'man_19_30';
      } else if (ageGroup === 'woman-31-59') {
        internalKey = 'woman_31_59';
      } else if (ageGroup === 'man-31-59') {
        internalKey = 'man_31_59';
      } else if (ageGroup === 'woman-60+') {
        internalKey = 'woman_60_plus';
      } else if (ageGroup === 'man-60+') {
        internalKey = 'man_60_plus';
      } else {
        // For other age groups, use default
        return defaultAdultGrams || 0;
      }
      
      if (!internalKey) {
        return defaultAdultGrams || 0;
      }
      
      const group = RECOMMENDED_VEG_PORTIONS_GRAMS[internalKey];
      if (!group || !group.fresh) {
        return defaultAdultGrams || 0;
      }
      
      // Normalize vegetable key
      const vegKey = normalizeVegetableKey(ingredientKey);
      
      if (group.fresh[vegKey] != null) {
        return group.fresh[vegKey];
      }
      
      return defaultAdultGrams || 0;
    }

    /**
     * Unified ingredient portion helper - returns serving size for any ingredient type
     * This is the single source of truth for portion sizes based on age group
     * 
     * @param {string} ingredientKey - The ingredient name/key
     * @param {string} ageGroup - The age group (e.g., "child-4-8", "girl-9-13", "woman-19-30")
     * @returns {object} - { amount: number, unit: "g" | "ml", source: string }
     */
    // ============================================
    // Smoothie ZERO portion audit (global)
    // ============================================
    window.__smoothieZeroPortions = window.__smoothieZeroPortions || new Map();

    window.__recordSmoothieZeroPortion = function ({ ingredient, age, source, unit }) {
      try {
        const key = `${age || 'no-age'} | ${ingredient || 'unknown'} | ${source || 'unknown'} | ${unit || ''}`;
        const row = window.__smoothieZeroPortions.get(key) || {
          ingredient, age, source, unit, count: 0
        };
        row.count += 1;
        window.__smoothieZeroPortions.set(key, row);
      } catch (e) {}
    };

    window.printSmoothieZeroPortions = function () {
      if (!window.__smoothieZeroPortions || !(window.__smoothieZeroPortions instanceof Map)) {
        console.log("No zero portions recorded yet");
        return [];
      }
      const rows = Array.from(window.__smoothieZeroPortions.values())
        .sort((a, b) => (b.count - a.count) || String(a.ingredient).localeCompare(String(b.ingredient)));
      if (rows.length > 0) {
        console.table(rows);
      } else {
        console.log("No zero portions recorded");
      }
      return rows;
    };

    window.clearSmoothieZeroPortions = function () {
      if (!window.__smoothieZeroPortions || !(window.__smoothieZeroPortions instanceof Map)) {
        return;
      }
      window.__smoothieZeroPortions.clear();
      console.log("Cleared __smoothieZeroPortions");
    };

    // ===============================
    // NUTS / SEEDS (smoothie portions)
    // ===============================
    function isNutOrSeed(name) {
      if (!name) return false;
      const s = String(name).toLowerCase().trim();

      // Avoid misclassifying milks like "almond milk"
      if (typeof isPlantBasedMilk === 'function' && isPlantBasedMilk(s)) return false;
      if (s.includes('milk')) return false;

      const keys = [
        'almond','almonds',
        'walnut','walnuts',
        'cashew','cashews',
        'peanut','peanuts',
        'pistachio','pistachios',
        'hazelnut','hazelnuts',
        'pecan','pecans',
        'chia','flax',
        'pumpkin seed','pumpkin seeds',
        'sunflower seed','sunflower seeds',
        'hemp','sesame','tahini'
      ];

      return keys.some(k => s.includes(k));
    }

    function getNutSeedPortionGrams(ageGroup, ingredientKey) {
      const k = typeof normalizeAgeGroupKey === 'function' ? normalizeAgeGroupKey(ageGroup) : null;

      // Conservative smoothie portions (can refine later)
      if (k === 'child_4_8') return 10;
      if (k === 'child_9_13') return 15;
      if (k === 'teen_14_18') return 20;

      return 28; // adults default (≈ 1 oz)
    }

    function getIngredientPortion(ingredientKey, ageGroup) {
      const __final = (res) => {
        const amt = Number(res?.amount);
        if (!Number.isFinite(amt) || amt === 0) {
          window.__recordSmoothieZeroPortion({
            ingredient: ingredientKey,
            age: ageGroup,
            source: res?.source,
            unit: res?.unit
          });
        }
        return res;
      };

      if (!ingredientKey) {
        return __final({ amount: 0, unit: 'g', source: 'fallback' });
      }

      // If no age group is selected, use default adult portions
      if (!ageGroup) {
        // For vegan milks, use default 240ml (1 cup)
        if (isPlantBasedMilk(ingredientKey)) {
          return __final({ amount: 240, unit: 'ml', source: 'milkMap' });
        }
        // For dried fruits, use default 30g
        if (isDriedFruit(ingredientKey)) {
          return __final({ amount: 30, unit: 'g', source: 'driedFruitMap' });
        }
        // For fresh fruits, use default 100g
        if (isFreshFruit(ingredientKey)) {
          return __final({ amount: 100, unit: 'g', source: 'fruitMap' });
        }
        return __final({ amount: 0, unit: 'g', source: 'fallback' });
      }

      const ageGroupKey = normalizeAgeGroupKey(ageGroup);
      
      // 1. Check if it's a vegan milk
      if (isPlantBasedMilk(ingredientKey)) {
        // Use age-specific default: 120ml for child 4-8, 150ml for man_60_plus and others
        let defaultMl = 150;
        if (ageGroupKey === 'child_4_8') {
          defaultMl = 120;
        } else if (ageGroupKey === 'man_60_plus' || ageGroupKey === 'woman_60_plus') {
          defaultMl = 150; // 150-200ml range, using 150ml as default
        }
        const mlValue = getServingMlForLiquid(ageGroupKey, ingredientKey, defaultMl);
        
        // Sanity check: log warning if ml value is too high
        if (mlValue > 400) {
          console.warn('[getIngredientPortion] High ml value for vegan milk:', {
            ingredientKey,
            ageGroup,
            mlValue
          });
        }
        
        return __final({ amount: mlValue, unit: 'ml', source: 'milkMap' });
      }
      
      // 2. Check if it's a dried fruit
      if (isDriedFruit(ingredientKey)) {
        // Use the existing dried fruit logic
        let targetKey = ageGroupKey;
        const selectedAudience = ageGroup; // Use ageGroup directly as selectedAudience
        
        // Map to specific dried fruit age group keys
        if (ageGroup === 'girl-9-13' && DRIED_FRUIT_SERVINGS.girl_9_13) {
          targetKey = 'girl_9_13';
        } else if (ageGroup === 'boy-9-13' && DRIED_FRUIT_SERVINGS.boy_9_13) {
          targetKey = 'boy_9_13';
        } else if (ageGroup === 'girl-14-18' && DRIED_FRUIT_SERVINGS.girl_14_18) {
          targetKey = 'girl_14_18';
        } else if (ageGroup === 'boy-14-18' && DRIED_FRUIT_SERVINGS.boy_14_18) {
          targetKey = 'boy_14_18';
        } else if (ageGroup === 'woman-19-30' && DRIED_FRUIT_SERVINGS.woman_19_30) {
          targetKey = 'woman_19_30';
        } else if (ageGroup === 'man-19-30' && DRIED_FRUIT_SERVINGS.man_19_30) {
          targetKey = 'man_19_30';
        } else if (ageGroup === 'woman-31-59' && DRIED_FRUIT_SERVINGS.woman_31_59) {
          targetKey = 'woman_31_59';
        } else if (ageGroup === 'man-31-59' && DRIED_FRUIT_SERVINGS.man_31_59) {
          targetKey = 'man_31_59';
        } else if (ageGroup === 'man-60+' && DRIED_FRUIT_SERVINGS.man_60_plus) {
          targetKey = 'man_60_plus';
        }
        
        const driedFruitKey = normalizeDriedFruitKey(ingredientKey);
        const gramsValue = getDriedFruitSmoothieGrams(targetKey, driedFruitKey, selectedAudience, 30);
        
        // Sanity check: log error if amount is 0
        if (gramsValue === null || gramsValue === 0) {
          console.error('[getIngredientPortion] Zero or null grams for dried fruit:', {
            ingredientKey,
            ageGroup,
            targetKey,
            driedFruitKey
          });
        }
        
        if (gramsValue != null) {
          // Sanity check: log warning if grams value is too high
          if (gramsValue > 400) {
            console.warn('[getIngredientPortion] High grams value for dried fruit:', {
              ingredientKey,
              ageGroup,
              gramsValue
            });
          }
          
          return __final({ amount: gramsValue, unit: 'g', source: 'driedFruitMap' });
        }
        
        // Fallback for dried fruits - use adult default
        return __final({ amount: 30, unit: 'g', source: 'driedFruitFallback' });
      }
      
      // 3. Check if it's a sweetener (before vegetables to prioritize)
      if (isSweetener(ingredientKey)) {
        const sweetenerGrams = getSweetenerPortionGrams(ingredientKey, ageGroup);
        
        if (sweetenerGrams != null && sweetenerGrams > 0) {
          console.log('[smoothie-build-sweetener]', {
            uiName: ingredientKey,
            normalizedKey: normalizeSweetenerKey(ingredientKey),
            ageGroup: ageGroup,
            gramsUsed: sweetenerGrams
          });
          
          return __final({ amount: sweetenerGrams, unit: 'g', source: 'sweetenerMap' });
        }
        
        // Fallback for sweeteners - use default adult serving sizes
        // Honey: 21g (1 tbsp), Maple syrup: 20g (1 tbsp), Coconut sugar: 4g (1 tsp), Date syrup: 20g (1 tbsp)
        const normalizedKey = normalizeSweetenerKey(ingredientKey);
        let defaultGrams = 20; // Default for most sweeteners
        if (normalizedKey === 'honey') {
          defaultGrams = 21;
        } else if (normalizedKey === 'coconut_sugar') {
          defaultGrams = 4;
        }
        
        return __final({ amount: defaultGrams, unit: 'g', source: 'sweetenerFallback' });
      }
      
      // 4. Check if it's a vegetable
      if (isVegetable(ingredientKey)) {
        const normalizedKey = normalizeVegetableKey(ingredientKey);
        const vegGrams = getVegPortionGrams(ageGroup, ingredientKey, 0);
        
        // Debug logging for avocado specifically
        if (normalizedKey === 'avocado') {
          console.log('[veg-portion] avocado for ageGroup', ageGroup, '-> grams:', vegGrams);
        }
        
        // Debug logging for vegetable serving sizes
        console.log('[smoothie-build-veg]', {
          uiName: ingredientKey,
          normalizedKey: normalizedKey,
          ageGroup: ageGroup,
          gramsUsed: vegGrams
        });
        
        if (vegGrams > 0) {
          return __final({ amount: vegGrams, unit: 'g', source: 'vegMap' });
        }

        const key = JSON.stringify({ ageGroup, ingredientKey, normalizedKey });
        window.__smoothieZeroVeg.add(key);
        console.warn('[ZERO-VEG-PORTION]', { ageGroup, ingredientKey, normalizedKey });
        
        // Fallback for vegetables - use 0 if no age-specific portion found
        return __final({ amount: 0, unit: 'g', source: 'vegFallback' });
      }
      
      // 5. Check if it's a fresh fruit
      if (isFreshFruit(ingredientKey)) {
        // Normalize ingredient key
        const fruitKey = normalizeIngredientNameForServing(ingredientKey) || ingredientKey.toLowerCase().trim();
        
        // Get default adult grams as fallback
        let defaultAdultGrams = 150;
        if (recommendedServingGrams.adult_19_30 && recommendedServingGrams.adult_19_30[fruitKey]) {
          defaultAdultGrams = recommendedServingGrams.adult_19_30[fruitKey];
        }
        
        // Use the unified getPortionGrams function
        const gramsValue = getPortionGrams({
          ageGroup: ageGroup,
          ingredientKey: fruitKey,
          isDried: false,
          defaultAdultGrams: defaultAdultGrams
        });
        
        if (gramsValue > 0) {
          return __final({ amount: gramsValue, unit: 'g', source: 'fruitMap' });
        }
        
        // Fallback for fresh fruits - use age-appropriate default instead of 0
        // Apply age group scaling to defaultAdultGrams
        const ageGroupKey = normalizeAgeGroupKey(ageGroup);
        let fallbackGrams = defaultAdultGrams;
        
        // Scale down for children
        if (ageGroupKey === 'child_4_8') {
          fallbackGrams = Math.round(defaultAdultGrams * 0.6); // ~60% of adult
        } else if (ageGroupKey === 'child_9_13') {
          fallbackGrams = Math.round(defaultAdultGrams * 0.8); // ~80% of adult
        } else if (ageGroupKey === 'teen_14_18') {
          // Teens can use adult portions
          fallbackGrams = defaultAdultGrams;
        }
        
        // Ensure minimum of 50g for any age group
        fallbackGrams = Math.max(50, fallbackGrams);
        
        return __final({ amount: fallbackGrams, unit: 'g', source: 'fruitFallback' });
      }
      
      // 6) Nuts / seeds (almonds etc.)
      if (isNutOrSeed(ingredientKey)) {
        const grams = getNutSeedPortionGrams(ageGroup, ingredientKey);
        return __final({ amount: grams, unit: 'g', source: 'nutSeedMap' });
      }
      
      // 7) Micro-dose ingredients (herbs, spices, teas, extracts, botanicals)
      if (isMicroDoseIngredient(ingredientKey)) {
        return __final({ amount: 1, unit: 'g', source: 'microDoseDefault' });
      }
      
      // 8. Fallback for other ingredients - mark as missing portion
      return __final({ amount: 0, unit: 'g', source: 'missingPortion' });
    }

    // ============================================
    // SINGLE SOURCE OF TRUTH: getSmoothiePortion
    // ============================================
    // This function is the ONLY way to get portion sizes in the Smoothie tab.
    // All chips rendering and post-build display MUST use this.
    function getSmoothiePortion(ingredientName, ageGroup) {
      if (!ingredientName) {
        return { amount: 0, unit: 'g', source: 'missingPortion', isMissing: true };
      }

      // Call the existing getIngredientPortion function
      const portion = getIngredientPortion(ingredientName, ageGroup);
      const amount = Number(portion?.amount) || 0;
      const isMissing = !Number.isFinite(amount) || amount <= 0 || portion?.source === 'missingPortion';

      // Record missing portions in tracker
      if (isMissing) {
        window.__recordSmoothieZeroPortion({
          ingredient: ingredientName,
          age: ageGroup,
          source: portion?.source || 'missingPortion',
          unit: portion?.unit || 'g'
        });
      }

      return {
        amount: amount,
        unit: portion?.unit || 'g',
        source: portion?.source || 'missingPortion',
        isMissing: isMissing
      };
    }

    // Helper function to check if an ingredient has a valid age-based portion
    // Returns true if the ingredient can be added for the given age group
    function hasValidAgePortion(ingredientName, ageGroup) {
      if (!ingredientName || !ageGroup) return false;
      
      // getIngredientPortion normalizes internally, so pass ageGroup as-is
      const portion = getIngredientPortion(ingredientName, ageGroup);
      if (!portion) return false;
      
      // Check for missing/zero portion
      const amount = Number(portion.amount) || 0;
      const isMissing = !Number.isFinite(amount) || amount <= 0 || portion.source === 'missingPortion';
      const isBad = portion.bad === true;
      
      // Check for API/fallback sources (treat as invalid)
      // Sources containing 'api', 'serving', or 'fallback' are invalid
      // Exception: allow 'microDoseDefault' and other legitimate sources (e.g., 'milkMap', 'fruitMap')
      const src = String(portion.source || '').toLowerCase();
      const isApiFallback = (src.includes('api') || src.includes('serving') || src.includes('fallback')) 
        && !src.includes('microdose'); // Allow microdose sources (e.g., 'microDoseDefault')
      
      return !isMissing && !isBad && !isApiFallback;
    }

    /**
     * Get health profile for a vegan milk
     * @param {string} ingredientName - The ingredient name
     * @returns {object|null} - Health profile object or null
     */
    function getVeganMilkHealthProfile(ingredientName) {
      if (!ingredientName) return null;
      
      const normalizedName = normalizeVeganMilkName(ingredientName);
      if (!normalizedName) return null;
      
      // Try normalized name first
      if (VEGAN_MILK_HEALTH_PROFILE[normalizedName]) {
        return VEGAN_MILK_HEALTH_PROFILE[normalizedName];
      }
      
      // Try with underscores
      const underscoreName = normalizedName.replace(/\s+/g, '_');
      if (VEGAN_MILK_HEALTH_PROFILE[underscoreName]) {
        return VEGAN_MILK_HEALTH_PROFILE[underscoreName];
      }
      
      return null;
    }

    // Function to check if an ingredient is a plant-based milk (vegan)
    function isPlantBasedMilk(ingredientName) {
      const plantMilks = [
        'almond milk', 'soy milk', 'oat milk', 'coconut milk', 'rice milk',
        'hemp milk', 'cashew milk', 'macadamia milk', 'hazelnut milk',
        'walnut milk', 'pistachio milk', 'flax milk', 'pea milk', 'quinoa milk',
        'millet milk', 'barley milk', 'brazil nut milk', 'pecan milk',
        'fortified plant milk', 'plant milk', 'plant-based milk'
      ];
      const nameLower = ingredientName.toLowerCase();
      return plantMilks.some(milk => nameLower.includes(milk));
    }

    /**
     * Check if a vegan milk is unsweetened
     * @param {string} ingredientName - The ingredient name
     * @returns {boolean} - True if the milk is unsweetened
     */
    function isUnsweetenedMilk(ingredientName) {
      if (!ingredientName) return false;
      
      const nameLower = ingredientName.toLowerCase();
      
      // Check for explicit "unsweetened" in the name
      if (nameLower.includes('unsweetened')) {
        return true;
      }
      
      // Check for "no sugar" or "sugar-free" variants
      if (nameLower.includes('no sugar') || nameLower.includes('sugar-free') || nameLower.includes('sugar free')) {
        return true;
      }
      
      // If it contains "sweetened" explicitly, it's not unsweetened
      if (nameLower.includes('sweetened')) {
        return false;
      }
      
      // Default: assume unsweetened if it's a vegan milk (most plant milks are unsweetened by default in our system)
      // This is a safe default since we recommend unsweetened milks
      return isPlantBasedMilk(ingredientName);
    }
    
    // Function to count current fresh and dried fruits in smoothie (sums quantities)
    function countFruitTypes() {
      let freshFruitCount = 0;
      let driedFruitCount = 0;
      
      smoothieIngredients.forEach(ing => {
        const ingredientName = typeof ing === 'string' ? ing : ing.name;
        const quantity = typeof ing === 'object' && ing.quantity ? ing.quantity : 1;
        
        // Exclude sweeteners and vegan milks from fruit counts
        if (isSweetener(ingredientName) || isPlantBasedMilk(ingredientName)) {
          return; // Skip sweeteners and vegan milks - they don't count as fruits
        }
        
        if (isDriedFruit(ingredientName)) {
          driedFruitCount += quantity;
        } else if (isFreshFruit(ingredientName)) {
          freshFruitCount += quantity;
        }
      });
      
      return { freshFruitCount, driedFruitCount };
    }
    
    /**
     * Calculate total dried fruit grams in the smoothie for 60+ age groups
     * @param {string} ageGroup - The age group (e.g., "man-60+", "woman-60+")
     * @returns {number} - Total dried fruit grams
     */
    function calculateTotalDriedFruitGrams60Plus(ageGroup) {
      if (!ageGroup || (ageGroup !== 'man-60+' && ageGroup !== 'woman-60+')) {
        return 0;
      }
      
      let totalGrams = 0;
      
      smoothieIngredients.forEach(ing => {
        const ingredientName = typeof ing === 'string' ? ing : ing.name;
        const quantity = typeof ing === 'object' && ing.quantity ? ing.quantity : 1;
        
        if (isDriedFruit(ingredientName)) {
          // Get the portion size for this dried fruit using the 60+ map
          const normalizedKey = ingredientName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
          const keyVariations = [
            normalizedKey,
            normalizedKey.replace(/_/g, ' '),
            normalizedKey.replace(/_unsweetened$/, ''),
            normalizedKey.replace(/_unsweetened$/, '').replace(/_/g, ' ')
          ];
          
          let gramsPerUnit = 0;
          for (const key of keyVariations) {
            if (DRIED_FRUIT_DEFAULT_PORTIONS_60PLUS[key] != null) {
              gramsPerUnit = DRIED_FRUIT_DEFAULT_PORTIONS_60PLUS[key];
              break;
            }
          }
          
          // If not found in map, use fallback (shouldn't happen, but safety check)
          if (gramsPerUnit === 0) {
            gramsPerUnit = 25; // Default fallback
          }
          
          totalGrams += gramsPerUnit * quantity;
        }
      });
      
      return totalGrams;
    }
    
    // Function to check if ingredient already exists in smoothie
    function ingredientExists(ingredientName) {
      return smoothieIngredients.some(ing => {
        const name = typeof ing === 'string' ? ing : ing.name;
        return name.toLowerCase() === ingredientName.toLowerCase();
      });
    }
    
    // Function to get ingredient index by name
    function getIngredientIndex(ingredientName) {
      return smoothieIngredients.findIndex(ing => {
        const name = typeof ing === 'string' ? ing : ing.name;
        return name.toLowerCase() === ingredientName.toLowerCase();
      });
    }
    const smoothieIngredientSearchEl = document.getElementById('smoothie-ingredient-search');
    const smoothieIngredientSuggestionsEl = document.getElementById('smoothie-ingredient-suggestions');
    const smoothieSelectedIngredientsEl = document.getElementById('smoothie-selected-ingredients');
    const veganMilkRecommendationContainerEl = document.getElementById('vegan-milk-recommendation-container');
    const smoothieRecipeEl = null; // Container removed
    const buildSmoothieBtn = document.getElementById('build-smoothie-btn');
    
    // Bind once: delegated click handler on document (capture phase for reliability)
    if (!window.__ss_modal_click_bound) {
      window.__ss_modal_click_bound = true;
      
      document.addEventListener('click', (e) => {
        // Match both possible button class systems for quantity buttons
        const qtyBtn = e.target.closest('.smoothie-quantity-btn, .ss-qty-btn');
        // Match both possible button class systems for remove buttons
        const removeBtn = e.target.closest('.smoothie-remove-btn, .ss-remove-btn, [data-action="remove"]');
        
        if (!qtyBtn && !removeBtn) return;

        // CRITICAL: Only process if button has the modal control marker
        // This ensures we don't interfere with liquid portion controls or other +/- buttons
        const btn = qtyBtn || removeBtn;
        if (btn.dataset.ssModalControl !== '1') {
          // Not a modal control button - let other handlers process it
          return;
        }

        // Only act when the edit-ingredients modal is currently open
        const modalEl = document.getElementById('ssm-modal');
        if (!modalEl || !modalEl.classList.contains('ssm-modal-open')) {
          // Modal is not open - let other handlers process it
          return;
        }

        // Now we know it's a modal control button and modal is open
        // Prevent form submits / bubbling to backdrop
        e.preventDefault();
        e.stopPropagation();

        // If button is disabled, return
        if (btn.disabled) return;

        // Determine index from data-idx (preferred) or data-index (fallback)
        const idx = Number(btn.dataset.idx ?? btn.dataset.index);
        if (!Number.isInteger(idx) || idx < 0 || idx >= smoothieIngredients.length) {
          console.warn('[smoothie] Invalid button index:', idx);
          return;
        }

        // Handle remove button
        if (removeBtn) {
          const removedIngredient = smoothieIngredients[idx];
          if (!removedIngredient) {
            console.warn('[smoothie] No ingredient at index:', idx);
            return;
          }
          
          // If a dried fruit is being removed, reset the tip flag so it can show again
          if (removedIngredient && typeof removedIngredient === 'object' && removedIngredient.name) {
            const ingredientName = removedIngredient.name;
            if (isDriedFruit(ingredientName)) {
              resetDriedFruitTip();
            }
          } else if (typeof removedIngredient === 'string' && isDriedFruit(removedIngredient)) {
            resetDriedFruitTip();
          }
          
          // Preserve modal open state before removing
          smoothieEditPanelOpen = true;
          
          // Remove the ingredient
          smoothieIngredients.splice(idx, 1);
          
          // Re-render (this will preserve modal state)
          renderSmoothieIngredients();
          updateSmoothieRecipe();
          checkAndShowVeganMilkRecommendation();
          return;
        }

        // Handle quantity +/- buttons
        if (qtyBtn) {
          const ing = smoothieIngredients?.[idx];
          if (!ing) {
            console.warn('[smoothie] No ingredient at index:', idx);
            return;
          }

          // Determine ingredient name
          const ingredientName = typeof ing === 'object' && ing.name ? ing.name : (typeof ing === 'string' ? ing : '');
          if (!ingredientName) {
            console.warn('[smoothie] No ingredient name at index:', idx);
            return;
          }

          // Get current age group
          const currentAgeGroup = smoothieForEl ? smoothieForEl.value : '';
          
          // Get portion info to determine if it's a liquid and what unit/step/min/max to use
          const portion = getSmoothiePortion(ingredientName, currentAgeGroup);
          const isVegan = isPlantBasedMilk(ingredientName);
          const isLiquid = isVegan && (portion.unit === 'ml' || portion.unit === 'cup');

          // Determine increment direction
          const isIncrement = qtyBtn.classList.contains('increment');
          const sign = isIncrement ? 1 : -1;

          // Get current quantity
          const cur = Number(ing.quantity) || (isLiquid ? (portion.unit === 'ml' ? 50 : 0.5) : 1);

          // Calculate step, min, max based on ingredient type
          let step, min, max;
          if (isLiquid) {
            if (portion.unit === 'ml') {
              step = 10;
              min = 50;
              max = 720;
            } else if (portion.unit === 'cup') {
              step = 0.5;
              min = 0.5;
              max = 3;
            } else {
              // Fallback for other liquid units
              step = 1;
              min = 1;
              max = 100;
            }
          } else {
            // Non-liquid: use step 1, min 1
            step = 1;
            min = 1;
            max = 100; // Reasonable max for non-liquids
          }

          // Calculate next value with proper clamping
          const next = Math.max(min, Math.min(max, cur + (sign * step)));

          // Round appropriately based on step
          let roundedNext = next;
          if (step < 1) {
            // For 0.5 step (cups), round to 1 decimal place
            roundedNext = Math.round(next * 10) / 10;
          } else if (step >= 10) {
            // For 10 step (ml), round to nearest 10
            roundedNext = Math.round(next / 10) * 10;
          } else {
            // For 1 step, round to whole number
            roundedNext = Math.round(next);
          }

          // Clamp again after rounding
          roundedNext = Math.max(min, Math.min(max, roundedNext));

          // Preserve modal open state before updating
          smoothieEditPanelOpen = true;

          // Update data model
          if (typeof ing === 'object') {
            ing.quantity = roundedNext;
            // Ensure unit is set correctly for liquids
            if (isLiquid && portion.unit) {
              ing.unit = portion.unit;
            }
          } else {
            // Convert string to object if needed
            const unit = isLiquid && portion.unit ? portion.unit : 'g';
            smoothieIngredients[idx] = { name: ing, quantity: roundedNext, unit: unit };
          }

          // Re-render (this will preserve modal state)
          renderSmoothieIngredients();
        }
      }, true); // Use capture phase to be extra safe against any bubbling blockers
    }

    const clearSmoothieBtn = document.getElementById('smoothie-clear-btn');
    const smoothieNameEl = document.getElementById('smoothie-name');
    const smoothieNameBarEl = document.getElementById('smoothie-name-bar');
    const smoothieNameDisplayEl = document.getElementById('smoothie-name-display');
    const smoothieForEl = document.getElementById('smoothie-for');
    const smoothieTimingEl = document.getElementById('smoothie-timing');
    const smoothieHealthGoalsEl = document.getElementById('smoothie-health-goals');
    
    // ============================================
    // SENIOR HEALTH GOALS (Man 60+) - Official CDC/NIH/NIA/USDA/EFSA
    // ============================================
    /**
     * SeniorHealthGoal - Enum-like constant for Man 60+ health goals
     * Based on official CDC, NIH, NIA, USDA, EFSA recommendations
     */
    const SeniorHealthGoal = {
      HeartHealth: 'HeartHealth',
      BloodPressure: 'BloodPressure',
      BoneHealth: 'BoneHealth',
      BrainHealth: 'BrainHealth',
      JointHealth: 'JointHealth',
      MuscleHealth: 'MuscleHealth',
      CholesterolManagement: 'CholesterolManagement',
      DiabetesBloodSugar: 'DiabetesBloodSugar',
      EyeHealth: 'EyeHealth',
      ImmuneSystem: 'ImmuneSystem',
      DigestiveHealth: 'DigestiveHealth',
      AntiInflammatory: 'AntiInflammatory',
      EnergyBoost: 'EnergyBoost',
      BloodCirculation: 'BloodCirculation',
      SleepHealth: 'SleepHealth'
    };

    /**
     * SENIOR_HEALTH_GOALS - Readable array of health goals for Man 60+
     * Matches existing category naming convention in the system
     * Updated to include all 15 official health goals
     */
    const SENIOR_HEALTH_GOALS = [
      'Heart Health',
      'Blood Pressure',
      'Bone Health',
      'Brain Health',
      'Joint Health',
      'Muscle Health',
      'Cholesterol Management',
      'Diabetes-Blood Sugar',
      'Eye Health',
      'Immune System',
      'Digestive Health',
      'Anti-Inflammatory',
      'Energy Boost',
      'Blood Circulation',
      'Sleep Health'
    ];

    // ============================================
    // MAN 19-30 HEALTH GOALS - Official Categories
    // ============================================
    /**
     * MAN_19_30_HEALTH_GOALS - Health goals for Man 19-30
     * Official list of 16 health goals
     */
    const MAN_19_30_HEALTH_GOALS = [
      'Stress Management',
      'Weight Management',
      'Brain Health',
      'Liver Health',
      'Energy Boost',
      'Muscle Health',
      'Immune System',
      'Heart Health',
      'Blood Pressure',
      'Anti-Inflammatory',
      'Cholesterol Management',
      'Diabetes-Blood Sugar',
      'Joint Health',
      'Digestive Health',
      'Dental Health',
      'Skin Health',
      'Blood Circulation',
      'Bone Health'
    ];

    // ============================================
    // BOY 14-18 HEALTH GOALS - Official Categories
    // ============================================
    /**
     * BOY_14_18_HEALTH_GOALS - Health goals for Boy 14-18
     * Official list of 16 health goals
     */
    const BOY_14_18_HEALTH_GOALS = [
      'Stress Management',
      'Weight Management',
      'Brain Health',
      'Muscle Health',
      'Energy Boost',
      'Dental Health',
      'Skin Health',
      'Immune System',
      'Bone Health',
      'Joint Health',
      'Liver Health',
      'Anti-Inflammatory',
      'Digestive Health',
      'Heart Health',
      'Anemia Prevention'
    ];

    // ============================================
    // BOY 9-13 HEALTH GOALS - Official Categories
    // ============================================
    /**
     * BOY_9_13_HEALTH_GOALS - Health goals for Boy 9-13
     * Official list of 17 health goals
     */
    const BOY_9_13_HEALTH_GOALS = [
      'Stress Management',
      'Weight Management',
      'Brain Health',
      'Immune System',
      'Bone Health',
      'Muscle Health',
      'Energy Boost',
      'Dental Health',
      'Skin Health',
      'Anti-Inflammatory',
      'Digestive Health',
      'Joint Health',
      'Heart Health',
      'Anemia Prevention',
      'Liver Health'
    ];

    // ============================================
    // CHILD 4-8 HEALTH GOALS - Official Categories
    // ============================================
    /**
     * CHILD_4_8_HEALTH_GOALS - Health goals for Child 4-8
     * Official list of 10 health goals
     */
    const CHILD_4_8_HEALTH_GOALS = [
      'Muscle Health',
      'Eye Health',
      'Digestive Health',
      'Energy Boost',
      'Brain Health',
      'Immune System',
      'Dental Health',
      'Bone Health'
    ];

    // ============================================
    // GIRL 9-13 HEALTH GOALS - Official Categories
    // ============================================
    /**
     * GIRL_9_13_HEALTH_GOALS - Health goals for Girl 9-13
     * Official list of 16 health goals
     */
    const GIRL_9_13_HEALTH_GOALS = [
      'Stress Management',
      'Weight Management',
      'Brain Health',
      'Anemia Prevention',
      'Immune System',
      'Bone Health',
      'Muscle Health',
      'Energy Boost',
      'Dental Health',
      'Skin Health',
      'Anti-Inflammatory',
      'Digestive Health',
      'Joint Health',
      'Heart Health',
      'Thyroid Health'
    ];

    // ============================================
    // GIRL 14-18 HEALTH GOALS - Official Categories
    // ============================================
    /**
     * GIRL_14_18_HEALTH_GOALS - Health goals for Girl 14-18
     * Official list of 16 health goals
     */
    const GIRL_14_18_HEALTH_GOALS = [
      'Stress Management',
      'Anemia Prevention',
      'Pregnancy Support',
      'Weight Management',
      'Brain Health',
      'Energy Boost',
      'Immune System',
      'Skin Health',
      'Bone Health',
      'Thyroid Health',
      'Anti-Inflammatory',
      'Muscle Health',
      'Dental Health',
      'Digestive Health',
      'Heart Health'
    ];

    // ============================================
    // WOMAN 19-30 HEALTH GOALS - Official Categories
    // ============================================
    /**
     * WOMAN_19_30_HEALTH_GOALS - Health goals for Woman 19-30
     * Official list of 16 health goals
     */
    const WOMAN_19_30_HEALTH_GOALS = [
      'Stress Management',
      'Anemia Prevention',
      'Pregnancy Support',
      'Weight Management',
      'Brain Health',
      'Energy Boost',
      'Immune System',
      'Thyroid Health',
      'Anti-Inflammatory',
      'Muscle Health',
      'Heart Health',
      'Blood Pressure',
      'Cholesterol Management',
      'Diabetes-Blood Sugar',
      'Digestive Health',
      'Skin Health',
      'Blood Circulation',
      'Bone Health',
      'Dental Health',
      'Liver Health'
    ];

    // ============================================
    // MAN 31-59 HEALTH GOALS - Official Categories
    // ============================================
    /**
     * MAN_31_59_HEALTH_GOALS - Health goals for Man 31-59
     * Official list of 16 health goals
     */
    const MAN_31_59_HEALTH_GOALS = [
      'Heart Health',
      'Blood Pressure',
      'Cholesterol Management',
      'Diabetes-Blood Sugar',
      'Weight Management',
      'Stress Management',
      'Muscle Health',
      'Anti-Inflammatory',
      'Liver Health',
      'Immune System',
      'Digestive Health',
      'Energy Boost',
      'Brain Health',
      'Eye Health',
      'Blood Circulation'
    ];

    // ============================================
    // WOMAN 31-59 HEALTH GOALS - Official Categories
    // ============================================
    /**
     * WOMAN_31_59_HEALTH_GOALS - Health goals for Woman 31-59
     * Official list of 18 health goals
     */
    const WOMAN_31_59_HEALTH_GOALS = [
      'Heart Health',
      'Blood Pressure',
      'Cholesterol Management',
      'Diabetes-Blood Sugar',
      'Weight Management',
      'Stress Management',
      'Bone Health',
      'Anemia Prevention',
      'Thyroid Health',
      'Anti-Inflammatory',
      'Muscle Health',
      'Brain Health',
      'Immune System',
      'Pregnancy Support',
      'Digestive Health',
      'Energy Boost',
      'Joint Health'
    ];

    // ============================================
    // WOMEN 60+ HEALTH GOALS - Official Categories
    // ============================================
    /**
     * Women60PlusHealthGoal - Enum-like constant for Women 60+ health goals
     * Based on existing health categories in the project
     */
    const Women60PlusHealthGoal = {
      BoneHealth: 'BoneHealth',
      HeartHealth: 'HeartHealth',
      BrainHealth: 'BrainHealth',
      BreastHealth: 'BreastHealth',
      JointHealth: 'JointHealth',
      MuscleHealth: 'MuscleHealth',
      BloodPressure: 'BloodPressure',
      CholesterolManagement: 'CholesterolManagement',
      DiabetesBloodSugar: 'DiabetesBloodSugar',
      EyeHealth: 'EyeHealth',
      ImmuneSystem: 'ImmuneSystem',
      DigestiveHealth: 'DigestiveHealth',
      AntiInflammatory: 'AntiInflammatory',
      EnergyBoost: 'EnergyBoost',
      ThyroidHealth: 'ThyroidHealth',
      MoodAndMentalHealth: 'MoodAndMentalHealth',
      SleepHealth: 'SleepHealth'
    };

    /**
     * WOMEN_60_PLUS_LABELS - Readable array of health goals for Women 60+
     * Matches existing category naming convention in the system
     * Updated to include all 17 official health goals
     */
    const WOMEN_60_PLUS_LABELS = [
      'Bone Health',
      'Heart Health',
      'Brain Health',
      'Breast Health',
      'Joint Health',
      'Muscle Health',
      'Blood Pressure',
      'Cholesterol Management',
      'Diabetes-Blood Sugar',
      'Eye Health',
      'Immune System',
      'Digestive Health',
      'Anti-Inflammatory',
      'Energy Boost',
      'Thyroid Health',
      'Mood & Mental Health',
      'Sleep Health'
    ];

    // Function to populate health goals dropdown from categories
    // Health goals allowed for each target audience
    // Maps target audience values to allowed health goal category names
    const healthGoalsByAudience = {
      'child-4-6': CHILD_4_8_HEALTH_GOALS, // same restricted kid goals
      'child-7-8': CHILD_4_8_HEALTH_GOALS, // same restricted kid goals
      'child-4-8': CHILD_4_8_HEALTH_GOALS, // backward compatibility
      'child-9-13': [
        'Bone Health',
        'Dental Health',
        'Digestive Health',
        'Energy Boost',
        'Eye Health',
        'Immune System',
        'Muscle Health',
        'Skin Health',
        'Stress Management',
        'Anemia Prevention',
        'Anti-Inflammatory'
      ],
      'girl-9-13': GIRL_9_13_HEALTH_GOALS, // Official 16 health goals for Girl 9-13
      'boy-9-13': BOY_9_13_HEALTH_GOALS, // Official 17 health goals for Boy 9-13
      'teen-14-18': [
        'Bone Health',
        'Dental Health',
        'Digestive Health',
        'Energy Boost',
        'Eye Health',
        'Immune System',
        'Muscle Health',
        'Skin Health',
        'Stress Management',
        'Blood Circulation',
        'Anti-Inflammatory',
        'Anemia Prevention',
        'Cholesterol Management',
        'Heart Health',
        'Joint Health',
        'Liver Health',
        'Weight Management',
        'Brain Health',
        'Blood Pressure'
      ],
      'girl-14-18': GIRL_14_18_HEALTH_GOALS, // Official 16 health goals for Girl 14-18
      'boy-14-18': BOY_14_18_HEALTH_GOALS, // Official 16 health goals for Boy 14-18
      // Note: Adult age groups (woman-19-30, man-19-30, woman-31-59, man-31-59, woman-60+, man-60+)
      // are handled specially in populateSmoothieHealthGoals() to show ALL health goals
      // (with Thyroid Health filtered for men only)
      'woman-19-30': null, // Show all health goals (handled in populateSmoothieHealthGoals)
      'man-19-30': null, // Show all health goals except Thyroid Health (handled in populateSmoothieHealthGoals)
      'woman-31-59': null, // Show all health goals (handled in populateSmoothieHealthGoals)
      'man-31-59': null, // Show all health goals except Thyroid Health (handled in populateSmoothieHealthGoals)
      'woman-60+': null, // Show all health goals (handled in populateSmoothieHealthGoals)
      'man-60+': null, // Show all health goals except "Pregnancy Support" and "Thyroid Health" (handled in populateSmoothieHealthGoals)
      // Add more mappings as needed
      // For now, if not specified, show all categories
    };

    function populateSmoothieHealthGoals() {
      if (!smoothieHealthGoalsEl || !categories || categories.length === 0) {
        return;
      }
      
      // Get selected target audience
      const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
      
      // Helper to extract category value (handles both object {value, label} and string format)
      const getCategoryValue = (cat) => {
        return typeof cat === 'object' && 'value' in cat ? cat.value : cat;
      };
      
      // Helper to normalize goal names using aliases
      const normalizeGoalName = (goalName) => {
        const aliases = {
          'Prenatal': 'Pregnancy Support',
          'Prenatal Support': 'Pregnancy Support',
          'Pregnancy': 'Pregnancy Support',
          'Thyroid': 'Thyroid Health',
          'Thyroid support': 'Thyroid Health',
          'Thyroid Support': 'Thyroid Health',
          'Thyroid Health': 'Thyroid Health',
          'Thyroid Healtsupport': 'Thyroid Health', // Handle typo from user config
          'Weight balance': 'Weight Management',
          'Weight Balance': 'Weight Management',
          'Weight management': 'Weight Management',
          'Weight Management': 'Weight Management'
        };
        const normalized = goalName.trim();
        return aliases[normalized] || normalized;
      };
      
      // Helper to check if a category matches a goal name (with alias handling)
      const matchesGoal = (categoryObj, goalName) => {
        const categoryValue = getCategoryValue(categoryObj);
        const categoryLower = categoryValue.toLowerCase().trim();
        const goalLower = goalName.toLowerCase().trim();
        const normalizedGoal = normalizeGoalName(goalName).toLowerCase().trim();
        return categoryLower === goalLower || categoryLower === normalizedGoal || 
               categoryLower.includes(goalLower) || categoryLower.includes(normalizedGoal);
      };
      
      // Determine which health goals to show
      let allowedGoals = categories; // Default: show all
      
      // Audiences that should show ALL health goals
      const showAllAudiences = ['girl-14-18', 'boy-14-18', 'woman-19-30', 'man-19-30', 
                                'woman-31-59', 'man-31-59', 'woman-60+', 'man-60+'];
      
      // Required goals for each audience (using aliases)
      // Note: Aliases will handle variations like "Prenatal Support" -> "Pregnancy Support",
      // "Weight Balance" -> "Weight Management", "Thyroid support" -> "Thyroid Health"
      const ensureGoalsByAudience = {
        'girl-14-18': ['Thyroid Health', 'Weight Management'], // "Thyroid Healtsupport" typo handled via alias
        'boy-14-18': ['Weight Management'],
        'woman-19-30': ['Pregnancy Support', 'Thyroid Health', 'Weight Management'],
        'woman-31-59': ['Pregnancy Support', 'Thyroid Health', 'Weight Management'],
        'woman-60+': ['Pregnancy Support', 'Thyroid Health', 'Weight Management'],
        'man-19-30': ['Weight Management'],
        'man-31-59': ['Weight Management'],
        'man-60+': ['Weight Management']
      };
      
      if (showAllAudiences.includes(selectedAudience)) {
        // For these audiences, show ALL health goals from categories
        allowedGoals = Array.isArray(categories) ? [...categories] : [];
        
        // For men, filter out "Thyroid Health" and "Pregnancy Support"
        if (selectedAudience.startsWith('man-')) {
          allowedGoals = allowedGoals.filter(categoryObj => {
          const categoryValue = getCategoryValue(categoryObj);
          const categoryLower = categoryValue.toLowerCase().trim();
            const isPregnancy = categoryLower.includes('pregnancy') || categoryLower.includes('prenatal');
            const isThyroid = categoryLower.includes('thyroid');
            return !isPregnancy && !isThyroid;
          });
        }
        
        // Ensure required goals are present (add them if missing)
        const requiredGoals = ensureGoalsByAudience[selectedAudience] || [];
        const existingGoalValues = allowedGoals.map(cat => {
          const val = getCategoryValue(cat);
          return normalizeGoalName(val);
        });
        
        requiredGoals.forEach(requiredGoal => {
          const normalizedRequired = normalizeGoalName(requiredGoal);
          // Check if this goal already exists (with alias matching)
          const exists = allowedGoals.some(cat => matchesGoal(cat, requiredGoal));
          
          if (!exists) {
            // Try to find a category that matches (with aliases)
            const matchingCategory = categories.find(cat => matchesGoal(cat, requiredGoal));
            if (matchingCategory) {
              allowedGoals.push(matchingCategory);
            }
          }
        });
      } else if (selectedAudience && healthGoalsByAudience[selectedAudience]) {
        // For non-adult age groups, use the restricted lists
        const allowedGoalsList = healthGoalsByAudience[selectedAudience];
        allowedGoals = categories.filter(categoryObj => {
          const categoryValue = getCategoryValue(categoryObj);
          // Check for exact match (case-insensitive)
            return allowedGoalsList.some(allowed => 
            categoryValue.toLowerCase() === allowed.toLowerCase()
            );
        });
      }
      
      // Clear existing options except the first one
      const firstOption = smoothieHealthGoalsEl.querySelector('option[value=""]');
      smoothieHealthGoalsEl.innerHTML = '';
      if (firstOption) {
        smoothieHealthGoalsEl.appendChild(firstOption);
      } else {
        smoothieHealthGoalsEl.innerHTML = '<option value="">Select health goal...</option>';
      }
      
      // Add filtered categories as options
      allowedGoals.forEach(categoryObj => {
        const option = document.createElement('option');
        // Extract value and label (handle both object and string formats)
        const categoryValue = getCategoryValue(categoryObj);
        const categoryLabel = typeof categoryObj === 'object' && 'label' in categoryObj ? categoryObj.label : categoryValue;
        
        // Use normalized value (lowercase with hyphens) for option.value
        option.value = normalizeGoalValue(categoryValue);
        // Use label for display
        option.textContent = categoryLabel;
        smoothieHealthGoalsEl.appendChild(option);
      });
      
      // Update warnings after health goals are populated (in case a value was already selected)
      updateGoalGuidanceCardsSoon();
    }
    
    // Health goal to display name mapping (dynamically created from categories)
    /**
     * Map category name for display (e.g., "Weight Loss" -> "Weight Management")
     * Only changes display name, not database/API values
     */
    function mapCategoryDisplayName(categoryName) {
      if (!categoryName) return categoryName;
      // Map "Weight Loss" to "Weight Management" for display
      if (categoryName === 'Weight Loss') {
        return 'Weight Management';
      }
      return categoryName;
    }

    function getHealthGoalName(value) {
      if (!categories || categories.length === 0) {
        const name = value.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        return name;
      }
      
      // value is normalized (e.g., "weight-loss" or "diabetes-blood-sugar")
      // Find matching category by comparing normalized value
      const categoryObj = categories.find(cat => {
        const catValue = typeof cat === 'object' && 'value' in cat ? cat.value : cat;
        return catValue.toLowerCase().replace(/\s+/g, '-') === value;
      });
      
      if (categoryObj) {
        // Return label if available, otherwise return value
        return typeof categoryObj === 'object' && 'label' in categoryObj ? categoryObj.label : categoryObj;
      }
      
      // Fallback: reconstruct name from normalized value
      return value.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    
    // Function to update smoothie name from health goal
    function updateSmoothieNameFromHealthGoal() {
      if (!smoothieHealthGoalsEl || !smoothieNameEl || !smoothieNameDisplayEl || !smoothieNameBarEl) {
        return;
      }
      
      const selectedGoal = smoothieHealthGoalsEl.value;
      if (selectedGoal) {
        const goalName = getHealthGoalName(selectedGoal);
        const smoothieName = `${goalName} Smoothie`;
        
        // Update the hidden input field
        smoothieNameEl.value = smoothieName;
        
        // Update the display bar
        smoothieNameDisplayEl.textContent = smoothieName;
        smoothieNameBarEl.style.display = 'block';
        
        // Update "Who is this smoothie for" display
        updateSmoothieAudienceDisplay();
        
        // Update "Timing" display
        updateSmoothieTimingDisplay();
      } else {
        // Hide the bar if no health goal is selected
        smoothieNameBarEl.style.display = 'none';
        smoothieNameEl.value = '';
        hideSmoothieAudienceDisplay();
        hideSmoothieTimingDisplay();
      }
    }

    /**
     * Update the "Who is this smoothie for" display in the smoothie name bar
     */
    function updateSmoothieAudienceDisplay() {
      const audienceDisplayEl = document.getElementById('smoothie-audience-display');
      const audienceValueEl = document.getElementById('smoothie-audience-value');
      
      if (!audienceDisplayEl || !audienceValueEl || !smoothieForEl) {
        return;
      }
      
      const selectedAudience = smoothieForEl.value;
      if (selectedAudience) {
        // Get the display text from the selected option
        const selectedOption = smoothieForEl.options[smoothieForEl.selectedIndex];
        const displayText = selectedOption ? selectedOption.textContent : selectedAudience;
        
        audienceValueEl.textContent = displayText;
        audienceDisplayEl.style.display = 'flex';
      } else {
        hideSmoothieAudienceDisplay();
      }
    }

    /**
     * Hide the "Who is this smoothie for" display
     */
    function hideSmoothieAudienceDisplay() {
      const audienceDisplayEl = document.getElementById('smoothie-audience-display');
      if (audienceDisplayEl) {
        audienceDisplayEl.style.display = 'none';
      }
    }

    /**
     * Update the "Timing" display in the smoothie name bar
     */
    function updateSmoothieTimingDisplay() {
      const timingDisplayEl = document.getElementById('smoothie-timing-display');
      const timingValueEl = document.getElementById('smoothie-timing-value');
      
      if (!timingDisplayEl || !timingValueEl || !smoothieTimingEl) {
        return;
      }
      
      const selectedTiming = smoothieTimingEl.value;
      if (selectedTiming) {
        // Get the display text from the selected option
        const selectedOption = smoothieTimingEl.options[smoothieTimingEl.selectedIndex];
        const displayText = selectedOption ? selectedOption.textContent : selectedTiming;
        
        timingValueEl.textContent = displayText;
        timingDisplayEl.style.display = 'flex';
      } else {
        hideSmoothieTimingDisplay();
      }
    }

    /**
     * Hide the "Timing" display
     */
    function hideSmoothieTimingDisplay() {
      const timingDisplayEl = document.getElementById('smoothie-timing-display');
      if (timingDisplayEl) {
        timingDisplayEl.style.display = 'none';
      }
    }
    
    // Function to clear smoothie state and reset UI to initial empty state
    function clearSmoothieState() {
      // Reset state flags
      currentSmoothie = null;
      hasBuiltSmoothie = false;
      
      // Reset Smoothie Nutrition panel to initial empty state
      if (smoothieResultsBodyEl) {
        smoothieResultsBodyEl.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <div style="font-size: 3rem; margin-bottom: 15px;">🥤</div>
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No Smoothie Built Yet</div>
            <div style="font-size: 0.9rem;">Add ingredients and click "Build Smoothie" to see nutrition information</div>
          </div>
        `;
      }
      
      // Hide card and close modal
      const smoothieResultsCard = document.getElementById('smoothie-results-card');
      if (smoothieResultsCard) {
        smoothieResultsCard.classList.add('pf-smoothie-hidden');
      }
      if (typeof pfCloseSmoothieModal === 'function') {
        pfCloseSmoothieModal({ hideCard: true });
      }
      
      // Reset status
      setSmoothieStatus('Ready to build');
    }
    
    // Listen for health goal changes
    // Bind goal guidance card updates (only once) using delegated listeners
    if (!window.__goal_guidance_bound) {
      window.__goal_guidance_bound = true;
      
      document.addEventListener('change', (e) => {
        if (e.target && e.target.id === 'smoothie-health-goals') {
          const currentHealthGoal = e.target.value;
          
          // Hide badge when value changes (will be shown again by updateSmoothieNameFromHealthGoal if a goal is selected)
          if (smoothieNameBarEl && !currentHealthGoal) {
            smoothieNameBarEl.style.display = 'none';
          }
          
          // Only clear "Who is this smoothie for?" and "Timing" if changing from one health goal to another
          // (not on the first selection when previousHealthGoal is null)
          if (previousHealthGoal !== null && previousHealthGoal !== '' && currentHealthGoal !== previousHealthGoal) {
            // User is changing from one health goal to another, clear related fields
            if (smoothieForEl) smoothieForEl.value = '';
            if (smoothieTimingEl) smoothieTimingEl.value = '';
            // Hide badge when changing health goals
            if (smoothieNameBarEl) {
              smoothieNameBarEl.style.display = 'none';
            }
          }
          
          // Update previous health goal for next change
          previousHealthGoal = currentHealthGoal;
          
          updateSmoothieNameFromHealthGoal();
          // Clear smoothie state when health goal changes
          clearSmoothieState();
          
          updateGoalGuidanceCardsSoon();
        }
        if (e.target && e.target.id === 'smoothie-for') updateGoalGuidanceCardsSoon();
      });

      document.addEventListener('input', (e) => {
        if (e.target && e.target.id === 'smoothie-health-goals') updateGoalGuidanceCardsSoon();
      });
      
      document.addEventListener('click', (e) => {
        if (e.target && e.target.id === 'smoothie-health-goals') {
          // Hide badge when dropdown is clicked (keep existing behavior)
          if (smoothieNameBarEl) {
            smoothieNameBarEl.style.display = 'none';
          }
        }
      });
    }
    
    /**
     * Update the blood sugar goal warning display based on current health goal and age group
     */
    /**
     * Generate compact goal guidance card HTML with expand/collapse
     */
    function createGoalGuidanceCard(title, icon, summary, avoidItems, preferItems, fullText) {
      const avoid = Array.isArray(avoidItems) ? avoidItems : [];
      const prefer = Array.isArray(preferItems) ? preferItems : [];
      const detailsHtml = fullText || '';
      
      // One-line format for collapsed state (max 3 items each)
      const avoidLine = avoid.slice(0, 3).join(' • ');
      const preferLine = prefer.slice(0, 3).join(' • ');
      
      // Bullet lists for expanded details
      const avoidList = avoid.slice(0, 3).map(item => `<li>${item}</li>`).join('');
      const preferList = prefer.slice(0, 3).map(item => `<li>${item}</li>`).join('');
      
      return `
        <div class="goal-guidance-card" style="background: #e0f2fe; border: 2px solid #0284c7; border-radius: 8px; padding: 12px 16px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(2, 132, 199, 0.15);">
          <div style="display: flex; align-items: flex-start; gap: 10px;">
            <span style="font-size: 1.2rem; flex-shrink: 0;">${icon}</span>
            <div style="flex: 1;">
              <div style="font-size: 0.95rem; font-weight: 700; color: #075985; margin-bottom: 4px;">${title}</div>
              <div style="font-size: 0.85rem; color: #075985; line-height: 1.4; margin-bottom: 6px;">${summary}</div>
              ${avoidLine ? `<div style="font-size: 0.8rem; color: #075985; margin-bottom: 4px;"><strong>Avoid:</strong> ${avoidLine}</div>` : ''}
              ${preferLine ? `<div style="font-size: 0.8rem; color: #075985; margin-bottom: 4px;"><strong>Prefer:</strong> ${preferLine}</div>` : ''}
            </div>
          </div>
          <details style="margin-top: 8px;">
            <summary style="font-size: 0.8rem; color: #0284c7; cursor: pointer; font-weight: 600; user-select: none;">Show details</summary>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(2, 132, 199, 0.2); font-size: 0.85rem; color: #075985; line-height: 1.6;">
              ${avoidList ? `<div style="margin-bottom: 10px;"><strong>Avoid:</strong><ul style="margin: 4px 0 0 18px; padding: 0;">${avoidList}</ul></div>` : ''}
              ${preferList ? `<div style="margin-bottom: 10px;"><strong>Prefer:</strong><ul style="margin: 4px 0 0 18px; padding: 0;">${preferList}</ul></div>` : ''}
              ${detailsHtml}
              <div style="margin-top: 12px; font-size: 0.75rem; color: #64748b; font-style: italic;">Educational guidance only — not medical advice.</div>
            </div>
          </details>
        </div>
      `;
    }

    // Helper function to update all goal guidance cards consistently
    function updateGoalGuidanceCards() {
      updateBloodSugarGoalWarning();
      updateWeightManagementGoalWarning();
      updateBloodPressureGoalWarning();
    }

    function updateGoalGuidanceCardsSoon() {
      // Run immediately and again after the DOM settles/rebuilds
      updateGoalGuidanceCards();
      requestAnimationFrame(() => updateGoalGuidanceCards());
      setTimeout(() => updateGoalGuidanceCards(), 80);
    }

    function updateBloodSugarGoalWarning() {
      const warningContainer = document.getElementById('blood-sugar-goal-warning-container');
      if (!warningContainer) return;
      
      const goalEl = document.getElementById('smoothie-health-goals');
      const forEl = document.getElementById('smoothie-for');
      
      const selectedHealthGoalRaw = goalEl ? goalEl.value : '';
      const selectedHealthGoal = normalizeGoalValue(selectedHealthGoalRaw);
      const selectedAgeGroup = forEl ? forEl.value : '';
      
      const isTeen1418 = selectedAgeGroup === 'girl-14-18' || selectedAgeGroup === 'boy-14-18';
      
      // Show warning only if: adult age group AND Diabetes–Blood Sugar goal
      if ((isAdultAgeGroup(selectedAgeGroup) || isTeen1418) && isDiabetesBloodSugarGoal(selectedHealthGoal)) {
        const fullText = "Guidance for managing blood sugar with confidence.<br><br>" +
                         "You've chosen <strong>Diabetes–Blood Sugar</strong> management. " +
                         "Guidance for choosing ingredients that help keep glucose levels steady.<br><br>" +
                         "<strong>Here's what to avoid:</strong><br>" +
                           "❌ Added sweeteners (honey, maple syrup, date syrup—they spike blood sugar)<br>" +
                           "❌ Large fruit portions (even natural sugar affects glucose)<br>" +
                           "❌ High-sugar fruits (tropical fruits like mango, pineapple)<br>" +
                           "❌ Dried fruits (concentrated sugar bombs)<br><br>" +
                           "<strong>What actually helps stabilize blood sugar:</strong><br><br>" +
                           "🎯 Berries (lowest glycemic impact)<br>" +
                           "🎯 Protein (Greek yogurt, unsweetened soy milk)<br>" +
                           "🎯 Healthy fats (avocado, chia seeds)<br>" +
                           "🎯 Leafy greens (spinach, kale—fiber is your friend)<br>" +
                           "🎯 Small portions (½ cup fruit max)<br><br>" +
                         "Guidance for supporting stable glucose levels. 💚";
        
        const cardHtml = createGoalGuidanceCard(
          'Blood Sugar Support',
          '💚',
          'Guidance for avoiding blood sugar spikes and choosing ingredients that stabilize glucose levels.',
          [
            'Added sweeteners (honey, maple syrup)',
            'Large fruit portions',
            'High-sugar fruits (mango, pineapple)'
          ],
          [
            'Berries (lowest glycemic impact)',
            'Protein sources (Greek yogurt, soy milk)',
            'Healthy fats (avocado, chia seeds)'
          ],
          fullText
        );
        
        warningContainer.innerHTML = cardHtml;
        warningContainer.style.display = 'block';
      } else {
        // Hide warning if conditions are not met
        warningContainer.innerHTML = '';
        warningContainer.style.display = 'none';
      }
    }
    
    /**
     * Update the weight management goal warning display based on current health goal and age group
     */
    function updateWeightManagementGoalWarning() {
      const warningContainer = document.getElementById('weight-management-goal-warning-container');
      if (!warningContainer) {
        console.log('[weight-mgmt-warning] Container not found');
        return;
      }
      
      const goalEl = document.getElementById('smoothie-health-goals');
      const forEl = document.getElementById('smoothie-for');
      
      const selectedHealthGoalRaw = goalEl ? goalEl.value : '';
      const selectedHealthGoal = normalizeGoalValue(selectedHealthGoalRaw);
      const selectedAgeGroup = forEl ? forEl.value : '';
      
      console.log('[weight-mgmt-warning] Checking:', {
        selectedHealthGoal,
        selectedAgeGroup,
        isWeightManagement: isWeightManagementGoal(selectedHealthGoal)
      });
      
      // Show warning for all age groups when Weight Management goal is selected
      const weightMgmtTip = getWeightManagementTip(selectedAgeGroup, selectedHealthGoal);
      console.log('[weight-mgmt-warning] Tip result:', weightMgmtTip);
      if (weightMgmtTip) {
        const cardHtml = createGoalGuidanceCard(
          'Weight Management',
          '💙',
          'Guidance for choosing ingredients that support weight goals without sabotaging progress.',
          [
            'Large fruit portions (natural sugar adds up)',
            'Dried fruits (concentrated calories)',
            'Added sweeteners (empty calories)'
          ],
          [
            'Fresh vegetables (bulk without calories)',
            'Berries & moderate fruit (satisfying)',
            'Unsweetened bases (protein keeps you full)'
          ],
          weightMgmtTip.replace(/We're here to help you succeed\./g, '').replace(/we're going to make/g, 'guidance for').replace(/Your success matters to us\./g, '').replace(/Let's build a smoothie that helps you reach your goals\./g, '')
        );
        warningContainer.innerHTML = cardHtml;
        warningContainer.style.display = 'block';
      } else {
        // Hide warning if conditions are not met
        warningContainer.innerHTML = '';
        warningContainer.style.display = 'none';
      }
    }
    
    /**
     * Update the blood pressure goal warning display based on current health goal
     */
    function updateBloodPressureGoalWarning() {
      const warningContainer = document.getElementById('blood-pressure-goal-warning-container');
      if (!warningContainer) return;
      
      const goalEl = document.getElementById('smoothie-health-goals');
      
      const selectedHealthGoalRaw = goalEl ? goalEl.value : '';
      const selectedHealthGoal = normalizeGoalValue(selectedHealthGoalRaw);
      
      // Show warning for all age groups when Blood Pressure goal is selected
      const bloodPressureTip = getBloodPressureTip(selectedHealthGoal);
      if (bloodPressureTip) {
        const cardHtml = createGoalGuidanceCard(
          'Blood Pressure Support',
          '❤️',
          'Guidance for avoiding ingredients that raise blood pressure and choosing foods that support healthy levels.',
          [
            'Added sodium/salt (even small amounts add up)',
            'Added sugars (raises blood pressure over time)',
            'High-sodium ingredients (some cheeses, powders)'
          ],
          [
            'Potassium-rich foods (bananas, oranges, berries)',
            'Magnesium sources (spinach, kale, pumpkin seeds)',
            'Beets (natural nitrates relax blood vessels)'
          ],
          bloodPressureTip.replace(/We're watching out for your blood pressure/g, 'Guidance for blood pressure').replace(/we're here to guide you/g, 'guidance for').replace(/we're honored to help/g, '').replace(/Your heart health matters.*?to us\./g, '').replace(/Every smoothie you make with us is a step toward better control\./g, '')
        );
        warningContainer.innerHTML = cardHtml;
        warningContainer.style.display = 'block';
      } else {
        // Hide warning if conditions are not met
        warningContainer.innerHTML = '';
        warningContainer.style.display = 'none';
      }
    }
    
    // Listen for "Who is this smoothie for" changes
    if (smoothieForEl) {
      // Hide badge when dropdown is clicked
      smoothieForEl.addEventListener('click', () => {
        if (smoothieNameBarEl) {
          smoothieNameBarEl.style.display = 'none';
        }
      });
      
      smoothieForEl.addEventListener('change', () => {
        // Hide badge when value changes
        if (smoothieNameBarEl) {
          smoothieNameBarEl.style.display = 'none';
        }
        
        // Re-render ingredient suggestions to update disabled state for new age group
        if (smoothieIngredientSearchEl && smoothieIngredientSearchEl.value.trim().length >= 2) {
          // Trigger search again to refresh suggestions with new age group validation
          smoothieIngredientSearchEl.dispatchEvent(new Event('input'));
        }
        
        // Repopulate health goals based on selected target audience
        populateSmoothieHealthGoals();
        // Clear health goal selection when target audience changes
        if (smoothieHealthGoalsEl) {
          smoothieHealthGoalsEl.value = '';
        }
        // Clear timing when target audience changes (if needed)
        if (previousHealthGoal !== null) {
          if (smoothieTimingEl) smoothieTimingEl.value = '';
          previousHealthGoal = null;
        }
        
        // Update warnings IMMEDIATELY when age group changes
        updateBloodSugarGoalWarning();
        updateWeightManagementGoalWarning();
        updateBloodPressureGoalWarning();
        
        // Update vegan milk serving sizes when audience changes
        updateVeganMilkServingSizes();
        
        // Check and show vegan milk recommendation for the new age group
        checkAndShowVeganMilkRecommendation();
        
        // Re-render ingredient chips to update serving sizes and health tier information
        renderSmoothieIngredients();
        
        // Update audience display if smoothie name bar is visible (after health goal is selected)
        // Note: Bar is hidden above, so this won't run until health goal is selected again
        // But we'll update it in updateSmoothieNameFromHealthGoal when health goal is selected
        
        // Clear smoothie state when target audience changes
        clearSmoothieState();
      });
    }
    
    // Listen for timing changes
    if (smoothieTimingEl) {
      // Hide badge when dropdown is clicked
      smoothieTimingEl.addEventListener('click', () => {
        if (smoothieNameBarEl) {
          smoothieNameBarEl.style.display = 'none';
        }
      });
      
      smoothieTimingEl.addEventListener('change', () => {
        // Hide badge when value changes
        if (smoothieNameBarEl) {
          smoothieNameBarEl.style.display = 'none';
        }
        
        // Update timing display if smoothie name bar is visible
        if (smoothieNameBarEl && smoothieNameBarEl.style.display !== 'none') {
          updateSmoothieTimingDisplay();
        }
        
        // Clear smoothie state when timing changes
        clearSmoothieState();
      });
    }
    
    const smoothieResultsBodyEl = document.getElementById('smoothie-results-body');
    const smoothieStatusTextEl = document.getElementById('smoothie-status-text');
    const smoothieStatusDotEl = document.getElementById('smoothie-status-dot');
    const smoothiePresetsEl = document.getElementById('smoothie-presets');
    
    // Smoothie servings state (for nutrition tabs)
    let smoothieServings = 1;
    let currentSmoothieData = null; // Store current smoothie data for recalculation
    let smoothieBatchMlOverride = null; // null = auto
    let manualServingsOverride = false; // user touched the servings control
    let smoothieServingMode = 'recommended'; // 'recommended' | 'manual'

    
    // Smoothie weight servings state (for per-serving weight display)
    // This is separate from nutrition servings and can be hooked to age/target audience later
    let smoothieWeightServings = 1; // Default: 1 serving
    let totalSmoothieWeightGrams = 0; // Store total smoothie weight for per-serving calculation
    let recommendedPerServingG = 0; // Recommended per-serving weight in grams (calculated by computeRecommendedServing)
    let recommendedServings = 1; // Recommended number of servings (calculated by computeRecommendedServing)
    let smoothieComputedTotals = null; // {calories, protein, carbs, fat, fiber, sugar, sodium}
    let lastSmoothieTotals = null; // { totalNutrients: {...}, totalWeightG: number }
    
    // ============================================
    // AGE-SPECIFIC SERVING SIZE MAP (Frontend Only)
    // ============================================
    // Age-specific serving grams per ingredient (children 4-8, 9-13, and adults 19-30)
    // These override the adult/base serving sizes ONLY when age group matches
    // DO NOT modify database or API - this is frontend-only logic
    const recommendedServingGrams = {
      child_4_8: {
        mango: 80,           // ½ cup sliced
        apple: 95,           // ½ medium
        banana: 55,          // ½ medium
        berries_mixed: 70,   // ½ cup
        grapes: 75,          // 14-16 grapes
        peach: 90,           // ½ fruit
        pear: 95,            // ½ fruit
        pineapple: 80,       // ½ cup chunks
        watermelon: 110,     // ¾ cup diced
        orange: 95,          // ½ small orange / tangerine
        kiwi: 75,           // 1 fruit
        papaya: 80,         // ½ cup
        strawberries: 75,   // 4-5 berries
        blueberries: 65,    // ½ cup
        raspberries: 60    // ½ cup
      },
      child_9_13: {
        mango: 120,
        apple: 120,
        banana: 100,
        grapes: 90,
        berries_mixed: 90,
        strawberries: 90,
        blueberries: 80,
        raspberries: 80,
        blackberries: 80,
        peach: 120,
        nectarine: 120,
        pear: 120,
        orange: 120,
        clementine: 80,
        kiwi: 90,
        pineapple: 110,
        watermelon: 130,
        cantaloupe: 120,
        honeydew: 120,
        papaya: 110,
        plum: 80,
        cherry: 80
      },
      adult_19_30: {
        apple: 150,
        banana: 120,
        mango: 150,
        strawberries: 120,
        blueberries: 120,
        raspberries: 120,
        blackberries: 120,
        berries_mixed: 120,
        grapes: 120,
        peach: 150,
        nectarine: 150,
        pear: 150,
        orange: 150,
        mandarin: 80,
        clementine: 80,
        kiwi: 100,
        pineapple: 140,
        watermelon: 170,
        cantaloupe: 150,
        honeydew: 150,
        papaya: 140,
        cherry: 120,
        cherries: 120,
        plum: 100,
        pomegranate_arils: 120
      },
      teen_14_18: {
        apple: 150,
        banana: 120,
        mango: 150,
        strawberries: 120,
        blueberries: 120,
        raspberries: 120,
        blackberries: 120,
        berries_mixed: 120,
        grapes: 120,
        peach: 150,
        nectarine: 150,
        pear: 150,
        orange: 150,
        mandarin: 80,
        clementine: 80,
        kiwi: 100,
        pineapple: 140,
        watermelon: 170,
        cantaloupe: 150,
        honeydew: 150,
        papaya: 140,
        cherry: 120,
        cherries: 120,
        plum: 100,
        pomegranate_arils: 120
      },
      adult_60_plus: {
        apple: 150,
        banana: 120,
        mango: 150,
        strawberries: 120,
        blueberries: 120,
        raspberries: 120,
        blackberries: 120,
        berries_mixed: 120,
        grapes: 120,
        peach: 150,
        nectarine: 150,
        pear: 150,
        orange: 150,
        mandarin: 80,
        clementine: 80,
        kiwi: 100,
        pineapple: 140,
        watermelon: 170,
        cantaloupe: 150,
        honeydew: 150,
        papaya: 140,
        cherry: 120,
        cherries: 120,
        plum: 100,
        pomegranate_arils: 120
      },
      man_31_59: {
        // For men 31-59 years old - same as adult_19_30
        apple: 150,
        banana: 120,
        mango: 150,
        strawberries: 120,
        blueberries: 120,
        raspberries: 120,
        blackberries: 120,
        berries_mixed: 120,
        grapes: 120,
        peach: 150,
        nectarine: 150,
        pear: 150,
        orange: 150,
        mandarin: 80,
        clementine: 80,
        kiwi: 100,
        pineapple: 140,
        watermelon: 170,
        cantaloupe: 150,
        honeydew: 150,
        papaya: 140,
        cherry: 120,
        cherries: 120,
        plum: 100,
        pomegranate_arils: 120
      },
      man_60_plus: {
        // For men 60+ years old - slightly conservative serving sizes (80-120g range)
        // Target: 220-260g total fruits + dried fruits per smoothie
        apple: 100,
        banana: 100,
        mango: 100,
        strawberries: 100,
        blueberries: 90,
        raspberries: 90,
        blackberries: 90,
        berries_mixed: 90,
        grapes: 90,
        peach: 100,
        nectarine: 100,
        pear: 100,
        orange: 100,
        mandarin: 80,
        clementine: 80,
        kiwi: 90,
        pineapple: 110,
        watermelon: 130,
        cantaloupe: 100,
        honeydew: 100,
        papaya: 110,
        cherry: 90,
        cherries: 90,
        plum: 90,
        pomegranate_arils: 90
      }
    };

    /**
     * UNIFIED FRUIT PORTIONS STRUCTURE
     * Consolidates fresh and dried fruit portions for all age groups
     * This is the SINGLE SOURCE OF TRUTH for fruit serving sizes
     * 
     * Structure: RECOMMENDED_FRUIT_PORTIONS_GRAMS[ageGroupKey][fresh|dried][fruitKey] = grams
     * 
     * Example:
     *   RECOMMENDED_FRUIT_PORTIONS_GRAMS.child_4_8.fresh.apple = 95
     *   RECOMMENDED_FRUIT_PORTIONS_GRAMS.child_4_8.dried.apple = 12
     */
    const RECOMMENDED_FRUIT_PORTIONS_GRAMS = {
      child_4_8: {
        fresh: {
          apple: 95,           // From recommendedServingGrams.child_4_8.apple
          banana: 55,
          mango: 80,
          strawberries: 75,
          blueberries: 65,
          raspberries: 60,
          blackberries: 60,
          berries_mixed: 70,
          grapes: 75,
          peach: 90,
          pear: 95,
          pineapple: 80,
          watermelon: 110,
          orange: 95,
          kiwi: 75,
          papaya: 80
        },
        dried: {
          apple: 12,           // From DRIED_FRUIT_SERVINGS.child_4_8.dried_apple.smoothieDefaultGrams
          banana: 15,
          mango: 15,
          pineapple: 15,
          peach: 15,
          pear: 15,
          kiwi: 15,
          raisins: 15,
          prunes: 15,
          figs: 15,
          dates: 15,
          cranberries: 15,
          cherries: 15,
          blueberries: 15,
          strawberries: 12
        }
      },
      girl_9_13: {
        fresh: {
          apple: 120,          // From recommendedServingGrams.child_9_13.apple
          banana: 100,
          mango: 120,
          strawberries: 90,   // From recommendedServingGrams.child_9_13.strawberries
          blueberries: 80,     // From recommendedServingGrams.child_9_13.blueberries
          raspberries: 80,     // From recommendedServingGrams.child_9_13.raspberries
          blackberries: 80,    // From recommendedServingGrams.child_9_13.blackberries
          berries_mixed: 90,
          grapes: 90,
          peach: 120,
          nectarine: 120,
          pear: 120,
          orange: 120,
          clementine: 80,
          kiwi: 90,
          pineapple: 110,
          watermelon: 130,
          cantaloupe: 120,
          honeydew: 120,
          papaya: 110,
          plum: 80,
          cherry: 80
        },
        dried: {
          apple: 15,           // From DRIED_FRUIT_SERVINGS.girl_9_13.dried_apple.smoothieDefaultGrams
          banana: 18,
          mango: 18,
          pineapple: 18,
          peach: 18,
          pear: 18,
          kiwi: 18,
          raisins: 18,
          prunes: 18,
          figs: 18,
          dates: 18,
          cranberries: 18,
          cherries: 18,
          blueberries: 18,
          strawberries: 15
        }
      },
      boy_9_13: {
        fresh: {
          apple: 120,
          banana: 100,
          mango: 120,
          strawberries: 90,
          blueberries: 80,
          raspberries: 80,
          blackberries: 80,
          berries_mixed: 90,
          grapes: 90,
          peach: 120,
          nectarine: 120,
          pear: 120,
          orange: 120,
          clementine: 80,
          kiwi: 90,
          pineapple: 110,
          watermelon: 130,
          cantaloupe: 120,
          honeydew: 120,
          papaya: 110,
          plum: 80,
          cherry: 80
        },
        dried: {
          apple: 15,
          banana: 18,
          mango: 18,
          pineapple: 18,
          peach: 18,
          pear: 18,
          kiwi: 18,
          raisins: 18,
          prunes: 18,
          figs: 18,
          dates: 18,
          cranberries: 18,
          cherries: 18,
          blueberries: 18,
          strawberries: 15
        }
      },
      girl_14_18: {
        fresh: {
          apple: 150,          // From recommendedServingGrams.teen_14_18.apple
          banana: 120,
          mango: 150,
          strawberries: 120,
          blueberries: 120,
          raspberries: 120,
          blackberries: 120,
          berries_mixed: 120,
          grapes: 120,
          peach: 150,
          nectarine: 150,
          pear: 150,
          orange: 150,
          mandarin: 80,
          clementine: 80,
          kiwi: 100,
          pineapple: 140,
          watermelon: 170,
          cantaloupe: 150,
          honeydew: 150,
          papaya: 140,
          cherry: 120,
          cherries: 120,
          plum: 100,
          pomegranate_arils: 120
        },
        dried: {
          apple: 18,           // From DRIED_FRUIT_SERVINGS.girl_14_18.dried_apple.smoothieDefaultGrams
          banana: 18,
          mango: 18,
          pineapple: 18,
          peach: 18,
          pear: 18,
          kiwi: 18,
          raisins: 20,
          prunes: 20,
          figs: 20,
          dates: 20,
          cranberries: 18,
          cherries: 18,
          blueberries: 18,
          strawberries: 18
        }
      },
      boy_14_18: {
        fresh: {
          apple: 150,
          banana: 120,
          mango: 150,
          strawberries: 120,
          blueberries: 120,
          raspberries: 120,
          blackberries: 120,
          berries_mixed: 120,
          grapes: 120,
          peach: 150,
          nectarine: 150,
          pear: 150,
          orange: 150,
          mandarin: 80,
          clementine: 80,
          kiwi: 100,
          pineapple: 140,
          watermelon: 170,
          cantaloupe: 150,
          honeydew: 150,
          papaya: 140,
          cherry: 120,
          cherries: 120,
          plum: 100,
          pomegranate_arils: 120
        },
        dried: {
          apple: 18,
          banana: 18,
          mango: 18,
          pineapple: 18,
          peach: 18,
          pear: 18,
          kiwi: 18,
          raisins: 20,
          prunes: 20,
          figs: 20,
          dates: 20,
          cranberries: 18,
          cherries: 18,
          blueberries: 18,
          strawberries: 18
        }
      },
      adult_19_30: {
        fresh: {
          apple: 150,          // From recommendedServingGrams.adult_19_30.apple
          banana: 120,
          mango: 150,
          strawberries: 120,
          blueberries: 120,
          raspberries: 120,
          blackberries: 120,
          berries_mixed: 120,
          grapes: 120,
          peach: 150,
          nectarine: 150,
          pear: 150,
          orange: 150,
          mandarin: 80,
          clementine: 80,
          kiwi: 100,
          pineapple: 140,
          watermelon: 170,
          cantaloupe: 150,
          honeydew: 150,
          papaya: 140,
          cherry: 120,
          cherries: 120,
          plum: 100,
          pomegranate_arils: 120
        },
        dried: {
          apple: 28,           // From DRIED_FRUIT_SERVINGS.man_19_30.dried_apple.defaultServingGrams (or similar)
          banana: 25,
          mango: 30,
          pineapple: 30,
          peach: 28,
          pear: 28,
          kiwi: 28,
          raisins: 30,
          prunes: 25,
          figs: 30,
          dates: 28,
          cranberries: 28,
          cherries: 28,
          blueberries: 28,
          strawberries: 22
        }
      },
      woman_19_30: {
        fresh: {
          apple: 150,
          banana: 120,
          mango: 150,
          strawberries: 120,
          blueberries: 120,
          raspberries: 120,
          blackberries: 120,
          berries_mixed: 120,
          grapes: 120,
          peach: 150,
          nectarine: 150,
          pear: 150,
          orange: 150,
          mandarin: 80,
          clementine: 80,
          kiwi: 100,
          pineapple: 140,
          watermelon: 170,
          cantaloupe: 150,
          honeydew: 150,
          papaya: 140,
          cherry: 120,
          cherries: 120,
          plum: 100,
          pomegranate_arils: 120
        },
        dried: {
          apple: 28,
          banana: 25,
          mango: 30,
          pineapple: 30,
          peach: 28,
          pear: 28,
          kiwi: 28,
          raisins: 30,
          prunes: 25,
          figs: 30,
          dates: 28,
          cranberries: 28,
          cherries: 28,
          blueberries: 28,
          strawberries: 22
        }
      },
      man_19_30: {
        fresh: {
          apple: 150,
          banana: 120,
          mango: 150,
          strawberries: 120,
          blueberries: 120,
          raspberries: 120,
          blackberries: 120,
          berries_mixed: 120,
          grapes: 120,
          peach: 150,
          nectarine: 150,
          pear: 150,
          orange: 150,
          mandarin: 80,
          clementine: 80,
          kiwi: 100,
          pineapple: 140,
          watermelon: 170,
          cantaloupe: 150,
          honeydew: 150,
          papaya: 140,
          cherry: 120,
          cherries: 120,
          plum: 100,
          pomegranate_arils: 120
        },
        dried: {
          apple: 28,
          banana: 25,
          mango: 30,
          pineapple: 30,
          peach: 28,
          pear: 28,
          kiwi: 28,
          raisins: 30,
          prunes: 25,
          figs: 30,
          dates: 28,
          cranberries: 28,
          cherries: 28,
          blueberries: 28,
          strawberries: 22
        }
      },
      woman_31_59: {
        fresh: {
          apple: 150,          // From recommendedServingGrams.adult_19_30.apple (same as adult_19_30)
          banana: 120,
          mango: 150,
          strawberries: 120,
          blueberries: 120,
          raspberries: 120,
          blackberries: 120,
          berries_mixed: 120,
          grapes: 120,
          peach: 150,
          nectarine: 150,
          pear: 150,
          orange: 150,
          mandarin: 80,
          clementine: 80,
          kiwi: 100,
          pineapple: 140,
          watermelon: 170,
          cantaloupe: 150,
          honeydew: 150,
          papaya: 140,
          cherry: 120,
          cherries: 120,
          plum: 100,
          pomegranate_arils: 120
        },
        dried: {
          apple: 18,           // From DRIED_FRUIT_SERVINGS.woman_31_59.dried_apple.smoothieDefaultGrams
          banana: 15,
          mango: 18,
          pineapple: 18,
          peach: 18,
          pear: 18,
          kiwi: 15,
          raisins: 15,
          prunes: 20,
          figs: 20,
          dates: 15,
          cranberries: 15,
          cherries: 15,
          blueberries: 15,
          strawberries: 15
        }
      },
      man_31_59: {
        fresh: {
          apple: 150,          // From recommendedServingGrams.man_31_59.apple
          banana: 120,
          mango: 150,
          strawberries: 120,
          blueberries: 120,
          raspberries: 120,
          blackberries: 120,
          berries_mixed: 120,
          grapes: 120,
          peach: 150,
          nectarine: 150,
          pear: 150,
          orange: 150,
          mandarin: 80,
          clementine: 80,
          kiwi: 100,
          pineapple: 140,
          watermelon: 170,
          cantaloupe: 150,
          honeydew: 150,
          papaya: 140,
          cherry: 120,
          cherries: 120,
          plum: 100,
          pomegranate_arils: 120
        },
        dried: {
          apple: 18,           // From DRIED_FRUIT_SERVINGS.man_31_59.dried_apple.smoothieDefaultGrams
          banana: 15,
          mango: 18,
          pineapple: 18,
          peach: 18,
          pear: 18,
          kiwi: 15,
          raisins: 15,
          prunes: 20,
          figs: 20,
          dates: 15,
          cranberries: 15,
          cherries: 15,
          blueberries: 15,
          strawberries: 15
        }
      },
      man_60_plus: {
        fresh: {
          apple: 100,          // From recommendedServingGrams.man_60_plus.apple
          banana: 100,
          mango: 100,
          strawberries: 100,
          blueberries: 90,
          raspberries: 90,
          blackberries: 90,
          berries_mixed: 90,
          grapes: 90,
          peach: 100,
          nectarine: 100,
          pear: 100,
          orange: 100,
          mandarin: 80,
          clementine: 80,
          kiwi: 90,
          pineapple: 110,
          watermelon: 130,
          cantaloupe: 100,
          honeydew: 100,
          papaya: 110,
          cherry: 90,
          cherries: 90,
          plum: 90,
          pomegranate_arils: 90
        },
        dried: {
          apple: 25,           // From DRIED_FRUIT_DEFAULT_PORTIONS_60PLUS["dried apple"]
          banana: 20,
          mango: 25,
          pineapple: 25,
          peach: 25,
          pear: 25,
          kiwi: 20,
          raisins: 25,
          prunes: 25,
          figs: 25,
          dates: 20,
          cranberries: 20,
          cherries: 25,
          blueberries: 20,
          strawberries: 20
        }
      },
      woman_60_plus: {
        fresh: {
          apple: 100,          // Same as man_60_plus
          banana: 100,
          mango: 100,
          strawberries: 100,
          blueberries: 90,
          raspberries: 90,
          blackberries: 90,
          berries_mixed: 90,
          grapes: 90,
          peach: 100,
          nectarine: 100,
          pear: 100,
          orange: 100,
          mandarin: 80,
          clementine: 80,
          kiwi: 90,
          pineapple: 110,
          watermelon: 130,
          cantaloupe: 100,
          honeydew: 100,
          papaya: 110,
          cherry: 90,
          cherries: 90,
          plum: 90,
          pomegranate_arils: 90
        },
        dried: {
          apple: 25,
          banana: 20,
          mango: 25,
          pineapple: 25,
          peach: 25,
          pear: 25,
          kiwi: 20,
          raisins: 25,
          prunes: 25,
          figs: 25,
          dates: 20,
          cranberries: 20,
          cherries: 25,
          blueberries: 20,
          strawberries: 20
        }
      }
    };

    /**
     * Central helper to get portion grams for a fruit (fresh or dried) based on age group
     * This is the SINGLE SOURCE OF TRUTH for fruit serving sizes
     * 
     * @param {object} params - Parameters object
     * @param {string} params.ageGroup - The age group key (e.g., "child-4-8", "girl-9-13", "woman-31-59", "man-60+")
     * @param {string} params.ingredientKey - The fruit key (e.g., "apple", "banana") - normalized, no "dried_" prefix
     * @param {boolean} params.isDried - Whether this is a dried fruit (true) or fresh fruit (false)
     * @param {number} params.defaultAdultGrams - The default adult/base portion grams (fallback if age-specific not found)
     * @returns {number} - Portion grams for this fruit at this age group
     * 
     * Example usage:
     *   getPortionGrams({ ageGroup: "child-4-8", ingredientKey: "apple", isDried: false, defaultAdultGrams: 182 })
     *   // Returns: 95 (child fresh apple portion)
     * 
     *   getPortionGrams({ ageGroup: "child-4-8", ingredientKey: "apple", isDried: true, defaultAdultGrams: 28 })
     *   // Returns: 12 (child dried apple portion)
     */
    function getPortionGrams({ ageGroup, ingredientKey, isDried, defaultAdultGrams }) {
      if (!ageGroup || !ingredientKey) {
        return defaultAdultGrams || 0;
      }

      // Map UI age group strings directly to internal keys (don't use normalizeAgeGroupKey here)
      // because normalizeAgeGroupKey converts "girl-9-13" to "child_9_13", but we need "girl_9_13"
      let internalKey = null;
      if (ageGroup === 'girl-9-13') {
        internalKey = 'girl_9_13';
      } else if (ageGroup === 'boy-9-13') {
        internalKey = 'boy_9_13';
      } else if (ageGroup === 'girl-14-18') {
        internalKey = 'girl_14_18';
      } else if (ageGroup === 'boy-14-18') {
        internalKey = 'boy_14_18';
      } else if (ageGroup === 'woman-19-30') {
        internalKey = 'woman_19_30';
      } else if (ageGroup === 'man-19-30') {
        internalKey = 'man_19_30';
      } else if (ageGroup === 'woman-31-59') {
        internalKey = 'woman_31_59';
      } else if (ageGroup === 'man-31-59') {
        internalKey = 'man_31_59';
      } else if (ageGroup === 'man-60+' || ageGroup === 'man-60_plus') {
        internalKey = 'man_60_plus';
      } else if (ageGroup === 'woman-60+' || ageGroup === 'woman-60_plus') {
        internalKey = 'woman_60_plus';
      } else if (ageGroup === 'child-4-8') {
        internalKey = 'child_4_8';
      } else {
        // Fallback: use normalizeAgeGroupKey for other formats
        const ageGroupKey = normalizeAgeGroupKey(ageGroup);
        internalKey = ageGroupKey;
      }
      
      if (!internalKey) {
        return defaultAdultGrams || 0;
      }

      // Normalize ingredient key (handle variations like "dried_apple" → "apple", "strawberries" → "strawberries")
      const normalizedKey = normalizeIngredientNameForServing(ingredientKey) || ingredientKey.toLowerCase().trim();
      
      // For dried fruits, also try removing "dried_" prefix if present
      let fruitKey = normalizedKey;
      if (isDried && fruitKey.startsWith('dried_')) {
        fruitKey = fruitKey.replace(/^dried_/, '');
      }
      // Also handle "dried apple" → "apple"
      if (isDried && fruitKey.startsWith('dried ')) {
        fruitKey = fruitKey.replace(/^dried /, '');
      }

      // Look up in unified structure
      // Try the primary internal key first, then fallback to normalized key if needed
      let ageMap = RECOMMENDED_FRUIT_PORTIONS_GRAMS[internalKey];
      
      // Fallback: if internalKey doesn't exist, try normalizeAgeGroupKey result
      // (e.g., if internalKey is "girl_9_13" but structure has "child_9_13")
      if (!ageMap) {
        const normalizedAgeKey = normalizeAgeGroupKey(ageGroup);
        if (normalizedAgeKey && normalizedAgeKey !== internalKey) {
          ageMap = RECOMMENDED_FRUIT_PORTIONS_GRAMS[normalizedAgeKey];
        }
      }
      
      if (ageMap) {
        const group = isDried ? ageMap.dried : ageMap.fresh;
        
        // Try multiple key variations to handle plural/singular and different formats
        const keyVariations = [
          fruitKey,                    // e.g., "strawberries"
          normalizedKey,               // e.g., "strawberries" (from normalizeIngredientNameForServing)
          ingredientKey.toLowerCase().trim(), // Original key lowercased
          fruitKey.replace(/ies$/, 'y'),      // "strawberries" → "strawberry"
          fruitKey.replace(/s$/, ''),         // "strawberries" → "strawberrie" (less common)
          fruitKey + 's',                     // "strawberry" → "strawberries"
          fruitKey.replace(/y$/, 'ies')       // "strawberry" → "strawberries"
        ];
        
        // Try each variation
        for (const key of keyVariations) {
          if (group && group[key] != null) {
            console.log('[getPortionGrams] Found match:', {
              ageGroup,
              internalKey,
              ingredientKey,
              matchedKey: key,
              value: group[key]
            });
            return group[key];
          }
        }
        
        // Debug: log what keys are available
        console.warn('[getPortionGrams] No match found, available keys:', {
          ageGroup,
          internalKey,
          ingredientKey,
          normalizedKey,
          fruitKey,
          keyVariations,
          availableKeys: group ? Object.keys(group) : [],
          groupType: isDried ? 'dried' : 'fresh'
        });
      } else {
        console.warn('[getPortionGrams] Age map not found:', {
          ageGroup,
          internalKey,
          availableAgeGroups: Object.keys(RECOMMENDED_FRUIT_PORTIONS_GRAMS)
        });
      }

      // If no age-specific entry found, use the default adult/base portion
      // This ensures we never return 0 for a known fruit
      return defaultAdultGrams || 0;
    }

    /**
     * Normalize ingredient name to match recommendedServingGrams keys
     * Maps various ingredient name formats to standardized keys
     * 
     * @param {string} ingredientName - The ingredient name from API/database
     * @returns {string|null} - Normalized key or null if not found
     */
    function normalizeIngredientNameForServing(ingredientName) {
      if (!ingredientName || typeof ingredientName !== 'string') {
        return null;
      }

      // Convert to lowercase and remove extra whitespace
      const normalized = ingredientName.toLowerCase().trim();
      
      // IMPORTANT: Do NOT strip "dried" prefix - it's part of the ingredient identity
      // "dried apple" and "apple" are different ingredients with different serving sizes
      // Only remove redundant suffixes like "(fresh)" or "(dried)" in parentheses
      let cleanName = normalized
        .replace(/\s*\(fresh\)/gi, '')
        .replace(/\s*\(dried\)/gi, '')
        // DO NOT remove standalone "dried" - it's part of the ingredient name
        // .replace(/\s*dried/gi, '')  // REMOVED - preserves "dried apple" vs "apple"
        .replace(/\s*\(.*?\)/g, '') // Remove any other parentheses content
        .trim();

      // IMPORTANT: If the name contains "dried", do NOT normalize it to a fresh fruit
      // "dried apple" and "apple" are different ingredients with different serving sizes
      if (cleanName.includes('dried')) {
        // Return the name as-is (with "dried" prefix) to preserve the distinction
        // This ensures "dried apple" doesn't get normalized to "apple"
        return cleanName;
      }
      
      // Direct mapping for common variations (only for fresh fruits)
      const nameMap = {
        'mango': 'mango',
        'apple': 'apple',
        'banana': 'banana',
        'grapes': 'grapes',
        'grape': 'grapes',
        'strawberries': 'strawberries',
        'strawberry': 'strawberries',
        'blueberries': 'blueberries',
        'blueberry': 'blueberries',
        'raspberries': 'raspberries',
        'raspberry': 'raspberries',
        'blackberries': 'blackberries',
        'blackberry': 'blackberries',
        'pineapple': 'pineapple',
        'peach': 'peach',
        'nectarine': 'nectarine',
        'pear': 'pear',
        'kiwi': 'kiwi',
        'watermelon': 'watermelon',
        'cantaloupe': 'cantaloupe',
        'honeydew': 'honeydew',
        'orange': 'orange',
        'mandarin': 'mandarin',
        'clementine': 'clementine',
        'papaya': 'papaya',
        'plum': 'plum',
        'cherry': 'cherry',
        'cherries': 'cherry',
        'pomegranate': 'pomegranate_arils',
        'pomegranate arils': 'pomegranate_arils',
        'pomegranate aril': 'pomegranate_arils',
        'mixed berries': 'berries_mixed',
        'mixed berry': 'berries_mixed',
        'berries': 'berries_mixed'
      };

      // Check direct match first
      if (nameMap[cleanName]) {
        return nameMap[cleanName];
      }

      // Check if it contains any fruit name (only for fresh fruits, not dried)
      for (const [key, value] of Object.entries(nameMap)) {
        if (cleanName.includes(key)) {
          return value;
        }
      }

      return null;
    }

    /**
     * Convert UI age group value to internal key format
     * Maps "girl-9-13" and "boy-9-13" to "child_9_13", "child-4-8" to "child_4_8"
     * Maps "woman-19-30" and "man-19-30" to "adult_19_30"
     * Maps "girl-14-18" and "boy-14-18" to "teen_14_18"
     * Maps "woman-60+" and "man-60+" to "adult_60_plus"
     * 
     * @param {string} ageGroup - The age group value from UI (e.g., "child-4-8", "girl-9-13", "boy-9-13", "girl-14-18", "boy-14-18", "woman-19-30", "man-19-30", "woman-60+", "man-60+")
     * @returns {string|null} - Internal key format or null
     */
    function normalizeAgeGroupKey(ageGroup) {
      if (!ageGroup) return null;
     
      // Treat child-4-6 and child-7-8 as child_4_8 for all existing serving-size logic/maps

      if (ageGroup === 'child-4-6' || ageGroup === 'child-7-8' || ageGroup === 'child-4-8') {
        return 'child_4_8';
      }



      
      // Map girl-9-13 and boy-9-13 to child_9_13
      if (ageGroup === 'girl-9-13' || ageGroup === 'boy-9-13') {
        return 'child_9_13';
      }
      
      // Map girl-14-18 and boy-14-18 to teen_14_18
      if (ageGroup === 'girl-14-18' || ageGroup === 'boy-14-18') {
        return 'teen_14_18';
      }
      
      // Map woman-19-30 and man-19-30 to adult_19_30
      if (ageGroup === 'woman-19-30' || ageGroup === 'man-19-30') {
        return 'adult_19_30';
      }
      
      // Map woman-31-59 to woman_31_59
      if (ageGroup === 'woman-31-59') {
        return 'woman_31_59';
      }
      
      // Map man-31-59 to man_31_59
      if (ageGroup === 'man-31-59') {
        return 'man_31_59';
      }
      
      // Map woman-60+ to woman_60_plus
      if (ageGroup === 'woman-60+') {
        return 'woman_60_plus';
      }
      
      // Map man-60+ to man_60_plus
      if (ageGroup === 'man-60+') {
        return 'man_60_plus';
      }
      
      // Convert other formats: "child-4-8" -> "child_4_8", etc.
      return ageGroup.replace(/-/g, '_');
    }

    /**
     * Get serving grams for an ingredient based on age group
     * Returns age-specific serving grams if age group matches (child-4-8, child-9-13, teen-14-18, adult-19-30, adult-60+) and ingredient matches,
     * otherwise falls back to adult/base serving grams from API
     * 
     * IMPORTANT: 
     * - Child age groups (4-8, 9-13) have reduced serving sizes
     * - Teens (14-18) have specific serving sizes defined in teen_14_18 map (adult-like servings)
     * - Adults 19-30 have specific serving sizes defined in adult_19_30 map
     * - Adults 60+ have specific serving sizes defined in adult_60_plus map
     * - Other adults (31-59) use default/adult serving grams from API
     * 
     * @param {string} ageGroup - The age group value (e.g., "child-4-8", "girl-9-13", "boy-9-13", "girl-14-18", "boy-14-18", "woman-19-30", "man-19-30", "woman-60+", "man-60+")
     * @param {string} ingredientName - The ingredient name
     * @param {number} quantity - The quantity multiplier (default: 1)
     * @param {number|null} apiServingGrams - The serving grams from API (adult/base value)
     * @returns {number} - Serving grams to use (age-specific or default)
     */
    function getServingGrams(ageGroup, ingredientName, quantity = 1, apiServingGrams = null, selectedAudience = null) {
      // Convert age group format: "girl-9-13"/"boy-9-13" -> "child_9_13", "child-4-8" -> "child_4_8"
      // "girl-14-18"/"boy-14-18" -> "teen_14_18", "woman-19-30"/"man-19-30" -> "adult_19_30"
      // "woman-60+"/"man-60+" -> "adult_60_plus"
      const ageGroupKey = normalizeAgeGroupKey(ageGroup);
      
      // Check if this is a dried fruit for child_4_8, girl_9_13, boy_9_13, girl_14_18, boy_14_18, or woman_19_30 age group
      // Note: normalizeAgeGroupKey maps "girl-9-13" and "boy-9-13" to "child_9_13", "girl-14-18" and "boy-14-18" to "teen_14_18"
      // "woman-19-30" and "man-19-30" to "adult_19_30", but we also check for specific keys
      if ((ageGroupKey === "child_4_8" || ageGroupKey === "child_9_13" || ageGroupKey === "girl_9_13" || ageGroupKey === "boy_9_13" || ageGroupKey === "teen_14_18" || ageGroupKey === "girl_14_18" || ageGroupKey === "boy_14_18" || ageGroupKey === "adult_19_30" || ageGroupKey === "woman_19_30") && isDriedFruit(ingredientName)) {
        // Try specific age group keys first, then fall back if needed
        let targetKey = ageGroupKey;
        if (ageGroup === 'girl-9-13' && DRIED_FRUIT_SERVINGS.girl_9_13) {
          targetKey = 'girl_9_13';
        } else if (ageGroup === 'boy-9-13' && DRIED_FRUIT_SERVINGS.boy_9_13) {
          targetKey = 'boy_9_13';
        } else if (ageGroup === 'girl-14-18' && DRIED_FRUIT_SERVINGS.girl_14_18) {
          targetKey = 'girl_14_18';
        } else if (ageGroup === 'boy-14-18' && DRIED_FRUIT_SERVINGS.boy_14_18) {
          targetKey = 'boy_14_18';
        } else if (ageGroup === 'woman-19-30' && DRIED_FRUIT_SERVINGS.woman_19_30) {
          targetKey = 'woman_19_30';
        } else if (ageGroup === 'man-19-30' && DRIED_FRUIT_SERVINGS.man_19_30) {
          targetKey = 'man_19_30';
        }
        const driedFruitKey = normalizeDriedFruitKey(ingredientName);
        const driedGrams = getDriedFruitSmoothieGrams(targetKey, driedFruitKey, ageGroup, apiServingGrams ? (apiServingGrams / quantity) : 30);
        if (driedGrams != null) {
          return driedGrams * quantity;
        }
      }
      
      // Check if we have age-specific serving grams for this age group
      // Supported keys: child_4_8, child_9_13, teen_14_18, adult_19_30, adult_60_plus
      if (ageGroupKey && recommendedServingGrams[ageGroupKey]) {
        const normalizedKey = normalizeIngredientNameForServing(ingredientName);
        
        if (normalizedKey && recommendedServingGrams[ageGroupKey][normalizedKey]) {
          // Use age-specific serving grams and multiply by quantity
          const ageServingGrams = recommendedServingGrams[ageGroupKey][normalizedKey];
          return ageServingGrams * quantity;
        }
      }
      
      // Fallback to adult/base serving grams from API
      // This applies to: other adults (31+), and any unmapped ingredients
      // If apiServingGrams is provided, use it (already includes quantity from API)
      // Otherwise return 0 (shouldn't happen, but safe fallback)
      return apiServingGrams !== null && apiServingGrams !== undefined ? apiServingGrams : 0;
    }

    /**
     * Get serving grams for an ingredient based on age group (alias for consistency)
     * This is the main helper function that should be used throughout the codebase
     * 
     * IMPORTANT: 
     * - Child age groups (4-8, 9-13) have reduced serving sizes
     * - Teens (14-18) have specific serving sizes defined in teen_14_18 map (adult-like servings)
     * - Adults 19-30 have specific serving sizes defined in adult_19_30 map
     * - Adults 60+ have specific serving sizes defined in adult_60_plus map
     * - Other adults (31-59) use default/adult serving grams from API
     * 
     * @param {string} ageGroup - The age group value (e.g., "child-4-8", "girl-9-13", "boy-9-13", "girl-14-18", "boy-14-18", "woman-19-30", "man-19-30", "woman-60+", "man-60+")
     * @param {string} ingredientName - The ingredient name
     * @param {number} defaultGrams - The default/adult serving grams from API
     * @returns {number} - Serving grams to use (age-specific or default)
     */
    function getServingGramsForIngredient(ageGroup, ingredientName, defaultGrams) {
      // Convert age group format
      // Maps: girl-9-13/boy-9-13 -> child_9_13, girl-14-18/boy-14-18 -> teen_14_18
      // woman-19-30/man-19-30 -> adult_19_30, woman-60+/man-60+ -> adult_60_plus
      const ageGroupKey = normalizeAgeGroupKey(ageGroup);
      
      // Check if this is a dried fruit for child_4_8, girl_9_13, boy_9_13, girl_14_18, boy_14_18, or woman_19_30 age group
      // Note: normalizeAgeGroupKey maps "girl-9-13" and "boy-9-13" to "child_9_13", "girl-14-18" and "boy-14-18" to "teen_14_18"
      // "woman-19-30" and "man-19-30" to "adult_19_30", but we also check for specific keys
      if ((ageGroupKey === "child_4_8" || ageGroupKey === "child_9_13" || ageGroupKey === "girl_9_13" || ageGroupKey === "boy_9_13" || ageGroupKey === "teen_14_18" || ageGroupKey === "girl_14_18" || ageGroupKey === "boy_14_18" || ageGroupKey === "adult_19_30" || ageGroupKey === "woman_19_30") && isDriedFruit(ingredientName)) {
        // Try specific age group keys first, then fall back if needed
        let targetKey = ageGroupKey;
        if (ageGroup === 'girl-9-13' && DRIED_FRUIT_SERVINGS.girl_9_13) {
          targetKey = 'girl_9_13';
        } else if (ageGroup === 'boy-9-13' && DRIED_FRUIT_SERVINGS.boy_9_13) {
          targetKey = 'boy_9_13';
        } else if (ageGroup === 'girl-14-18' && DRIED_FRUIT_SERVINGS.girl_14_18) {
          targetKey = 'girl_14_18';
        } else if (ageGroup === 'boy-14-18' && DRIED_FRUIT_SERVINGS.boy_14_18) {
          targetKey = 'boy_14_18';
        } else if (ageGroup === 'woman-19-30' && DRIED_FRUIT_SERVINGS.woman_19_30) {
          targetKey = 'woman_19_30';
        } else if (ageGroup === 'man-19-30' && DRIED_FRUIT_SERVINGS.man_19_30) {
          targetKey = 'man_19_30';
        }
        const driedFruitKey = normalizeDriedFruitKey(ingredientName);
        const driedGrams = getDriedFruitSmoothieGrams(targetKey, driedFruitKey, ageGroup, defaultGrams);
        if (driedGrams != null) {
          return driedGrams;
        }
      }
      
      // Check if we have age-specific serving grams for this age group
      // Supported keys: child_4_8, child_9_13, teen_14_18, adult_19_30, adult_60_plus
      if (ageGroupKey && recommendedServingGrams[ageGroupKey]) {
        const normalizedKey = normalizeIngredientNameForServing(ingredientName);
        
        if (normalizedKey && recommendedServingGrams[ageGroupKey][normalizedKey]) {
          // Return age-specific serving grams (per portion, not multiplied by quantity here)
          return recommendedServingGrams[ageGroupKey][normalizedKey];
        }
      }
      
      // Fallback to default/adult grams
      // This applies to: other adults (31-59), and any unmapped ingredients
      return defaultGrams;
    }

    /**
     * Get effective serving grams for display in ingredient chips
     * Returns child serving grams if age group matches (child-4-8, child-9-13) and ingredient matches,
     * otherwise returns the base grams from API
     * 
     * @param {string} ageGroup - The age group value (e.g., "child-4-8", "girl-9-13", "boy-9-13", "woman-19-30")
     * @param {string} ingredientName - The ingredient name
     * @param {number} baseGrams - The base serving grams from API (adult value)
     * @returns {number} - Effective serving grams to display (child or adult)
     */
    function getEffectiveServingGrams(ageGroup, ingredientName, baseGrams) {
      // Use the main helper function for consistency
      return getServingGramsForIngredient(ageGroup, ingredientName, baseGrams);
    }
    
    /**
     * Compute recommended serving size based on target audience and health goal
     * 
     * This function calculates the optimal per-serving weight and number of servings
     * for a smoothie based on the user's age/gender and health goals.
     * 
     * @param {string} targetAudience - The target audience value (e.g., "child-4-8", "woman-19-30")
     * @param {string} healthGoal - The health goal category name (e.g., "Weight Management", "Muscle Health")
     * @param {number} totalWeightG - Total smoothie weight in grams
     * @returns {Object} { perServingG: number, servings: number }
     */
    function computeRecommendedServing(targetAudience, healthGoal, totalWeightG) {
      if (!totalWeightG || totalWeightG <= 0) {
        return { perServingG: 250, servings: 1 };
      }
      
      // IMPORTANT: UI values already match servingRanges keys. Do NOT normalize here.
      const audienceKey = targetAudience;

      const goal = (healthGoal || '').trim();

      const servingRanges = {
        'child-4-6': { min: 150, max: 200 },
        'child-7-8': { min: 150, max: 200 },
        'child-4-8': { min: 150, max: 200 }, // backward compatibility
        'girl-9-13': { min: 200, max: 250 },
        'boy-9-13': { min: 200, max: 250 },
        'girl-14-18': { min: 250, max: 300 },
        'boy-14-18': { min: 250, max: 300 },
        'woman-19-30': { min: 250, max: 350 },
        'man-19-30': { min: 300, max: 400 },
        'woman-31-59': { min: 250, max: 350 },
        'man-31-59': { min: 300, max: 400 },
        'woman-60+': { min: 250, max: 350 },
        'man-60+': { min: 300, max: 400 }
      };
      
      const range = servingRanges[audienceKey] || { min: 250, max: 350 };
      
      // Categorize health goals (include both original DB names and UI labels for compatibility)
      const lowEndGoals = [
        'Weight Management', 'Weight Loss', 'Weight Balance', // Weight goals (DB name and label)
        'Diabetes-Blood Sugar', 'Blood Sugar Support', // Diabetes goals
        'Cholesterol Management', 'Cholesterol Support', // Cholesterol goals
        'Blood Pressure', 'Blood Pressure Support', // Blood pressure goals
        'Liver Health', 'Liver Support', // Liver goals
        'Stress Management', 'Stress Relief' // Stress goals
      ];
      
      const highEndGoals = [
        'Muscle Health', 'Muscle Recovery', // Muscle goals
        'Energy Boost', 'Energy & Stamina', // Energy goals
        'Pregnancy Support', 'Prenatal Support', // Pregnancy goals
        'Bone Health', 'Bone Strength', // Bone goals
        'Anemia Prevention', 'Iron Support', // Anemia/Iron goals
        'Immune System', 'Immune Support' // Immune goals
      ];
      
      // Determine base serving size based on health goal category
      let base;
      if (lowEndGoals.includes(goal)) {
        // Use minimum of range for low-end goals (e.g., weight loss, diabetes)
        base = range.min;
      } else if (highEndGoals.includes(goal)) {
        // Use maximum of range for high-end goals (e.g., muscle health, energy boost)
        base = range.max;
      } else {
        // Use midpoint for all other health goals
        base = (range.min + range.max) / 2;
      }
      
      // Clamp perServingG to not exceed totalWeightG
      const perServingG = Math.min(base, totalWeightG);
      
      // Calculate number of servings (ensure at least 1 serving)
      const servings = Math.max(1, Math.ceil(totalWeightG / perServingG));
      
      return { perServingG, servings };
    }

    // ============================================
    // CHILD 4-8 FRUIT PORTION LOGIC
    // ============================================
    // Fruit-specific grams per portion for children 4-8 years
    // Each fruit has its own portion size - NO global default
    const CHILD_4_8_FRUIT_PORTIONS = {
      mango_fresh: {
        displayName: "Mango (fresh)",
        gramsPerChildPortion: 80,   // ~1/2 cup cubes
        cupsPerChildPortion: 0.5
      },
      apple_fresh: {
        displayName: "Apple (fresh)",
        gramsPerChildPortion: 70,   // ~1/2 small apple or 1/2 cup chopped
        cupsPerChildPortion: 0.5
      },
      banana_fresh: {
        displayName: "Banana (fresh)",
        gramsPerChildPortion: 65,
        cupsPerChildPortion: 0.5
      },
      orange_fresh: {
        displayName: "Orange (fresh)",
        gramsPerChildPortion: 80,
        cupsPerChildPortion: 0.5
      },
      grapes_fresh: {
        displayName: "Grapes (fresh, seedless)",
        gramsPerChildPortion: 80,
        cupsPerChildPortion: 0.5
      },
      strawberries_fresh: {
        displayName: "Strawberries (fresh)",
        gramsPerChildPortion: 75,
        cupsPerChildPortion: 0.5
      },
      blueberries_fresh: {
        displayName: "Blueberries (fresh)",
        gramsPerChildPortion: 80,
        cupsPerChildPortion: 0.5
      },
      pineapple_fresh: {
        displayName: "Pineapple (fresh)",
        gramsPerChildPortion: 85,
        cupsPerChildPortion: 0.5
      },
      peach_fresh: {
        displayName: "Peach (fresh)",
        gramsPerChildPortion: 80,
        cupsPerChildPortion: 0.5
      },
      pear_fresh: {
        displayName: "Pear (fresh)",
        gramsPerChildPortion: 75,
        cupsPerChildPortion: 0.5
      },
      kiwi_fresh: {
        displayName: "Kiwi (fresh)",
        gramsPerChildPortion: 75,
        cupsPerChildPortion: 0.5
      },
      watermelon_fresh: {
        displayName: "Watermelon (fresh)",
        gramsPerChildPortion: 85,
        cupsPerChildPortion: 0.75
      },
      cantaloupe_fresh: {
        displayName: "Cantaloupe (fresh)",
        gramsPerChildPortion: 80,
        cupsPerChildPortion: 0.5
      },
      mixed_berries_fresh: {
        displayName: "Mixed berries (fresh)",
        gramsPerChildPortion: 80,
        cupsPerChildPortion: 0.5
      }
    };

    // Maximum fruit portions per smoothie for children 4-8
    const CHILD_4_8_MAX_FRUIT_PORTIONS_PER_SMOOTHIE = 1.5;

    /**
     * Normalize ingredient name to match CHILD_4_8_FRUIT_PORTIONS keys
     * Converts ingredient names like "Mango", "mango", "Mango (fresh)" to "mango_fresh"
     * 
     * @param {string} ingredientName - The ingredient name from API/database
     * @returns {string|null} - Normalized key or null if not a mapped fruit
     */
    function normalizeFruitNameForChildPortions(ingredientName) {
      if (!ingredientName || typeof ingredientName !== 'string') {
        return null;
      }

      // Convert to lowercase and remove extra whitespace
      const normalized = ingredientName.toLowerCase().trim();
      
      // Remove common suffixes/prefixes
      let cleanName = normalized
        .replace(/\s*\(fresh\)/gi, '')
        .replace(/\s*\(dried\)/gi, '')
        .replace(/\s*fresh/gi, '')
        .replace(/\s*dried/gi, '')
        .trim();

      // Map common variations to keys
      const nameMap = {
        'mango': 'mango_fresh',
        'apple': 'apple_fresh',
        'banana': 'banana_fresh',
        'orange': 'orange_fresh',
        'grapes': 'grapes_fresh',
        'grape': 'grapes_fresh',
        'strawberries': 'strawberries_fresh',
        'strawberry': 'strawberries_fresh',
        'blueberries': 'blueberries_fresh',
        'blueberry': 'blueberries_fresh',
        'pineapple': 'pineapple_fresh',
        'peach': 'peach_fresh',
        'pear': 'pear_fresh',
        'kiwi': 'kiwi_fresh',
        'watermelon': 'watermelon_fresh',
        'cantaloupe': 'cantaloupe_fresh',
        'mixed berries': 'mixed_berries_fresh',
        'mixed berry': 'mixed_berries_fresh'
      };

      // Check direct match first
      if (nameMap[cleanName]) {
        return nameMap[cleanName];
      }

      // Check if it contains any fruit name
      for (const [key, value] of Object.entries(nameMap)) {
        if (cleanName.includes(key)) {
          return value;
        }
      }

      return null;
    }

    /**
     * Compute total fruit portions for children 4-8 based on ingredient grams
     * 
     * @param {Array} smoothieIngredients - Array of ingredient objects from API response
     *   Each ingredient should have: { ingredient: string, serving_size_g?: number, serving_size?: string }
     * @returns {Object} { totalFruitGrams: number, totalPortions: number }
     */
    function computeChild48FruitPortions(smoothieIngredients) {
      let totalPortions = 0;
      let totalFruitGrams = 0;

      if (!smoothieIngredients || !Array.isArray(smoothieIngredients)) {
        return { totalFruitGrams: 0, totalPortions: 0 };
      }

      smoothieIngredients.forEach(ing => {
        const ingredientName = ing.ingredient || ing.name || '';
        const normalizedKey = normalizeFruitNameForChildPortions(ingredientName);
        
        // Skip if not a mapped fruit (could be veg, milk, seeds, etc.)
        if (!normalizedKey) {
          return;
        }

        const portionDef = CHILD_4_8_FRUIT_PORTIONS[normalizedKey];
        if (!portionDef) {
          return;
        }

        // Get grams from ingredient
        let grams = 0;
        if (ing.serving_size_g !== undefined && ing.serving_size_g !== null) {
          grams = parseFloat(ing.serving_size_g);
        } else if (ing.serving_size) {
          // Parse from serving_size string (e.g., "100g", "150 grams")
          const servingStr = String(ing.serving_size).toLowerCase();
          const gramMatch = servingStr.match(/(\d+(?:\.\d+)?)\s*g(?:rams?)?/);
          if (gramMatch) {
            grams = parseFloat(gramMatch[1]);
          } else {
            // Try to extract any number and assume grams
            const numMatch = servingStr.match(/(\d+(?:\.\d+)?)/);
            if (numMatch) {
              grams = parseFloat(numMatch[1]);
            }
          }
        }

        if (grams > 0 && portionDef.gramsPerChildPortion > 0) {
          totalFruitGrams += grams;
          totalPortions += grams / portionDef.gramsPerChildPortion;
        }
      });

      return { totalFruitGrams, totalPortions };
    }

    // Smoothie presets
    const smoothiePresets = [
      {
        name: "Green Energy Boost",
        description: "High in vitamins and natural energy",
        ingredients: ["spinach", "banana", "apple", "ginger", "lemon"],
        healthGoal: "Energy Boost"
      },
      {
        name: "Berry Antioxidant",
        description: "Rich in antioxidants for immune support",
        ingredients: ["blueberry", "strawberry", "raspberry", "acai berry"],
        healthGoal: "Immune System"
      },
      {
        name: "Protein Power",
        description: "High protein for muscle recovery",
        ingredients: ["greek yogurt", "banana", "almond butter", "protein powder"],
        healthGoal: "Muscle Health"
      },
      {
        name: "Tropical Immunity",
        description: "Vitamin C rich tropical blend",
        ingredients: ["mango", "pineapple", "orange", "coconut milk"],
        healthGoal: "Immune System"
      },
      {
        name: "Digestive Health",
        description: "Fiber-rich for gut health",
        ingredients: ["banana", "blueberry", "apple", "chia seed", "yogurt"],
        healthGoal: "Digestive Health"
      },
      {
        name: "Heart Healthy",
        description: "Omega-3 and antioxidants",
        ingredients: ["blueberry", "walnut", "spinach", "flaxseed"],
        healthGoal: "Heart Health"
      }
    ];

    function setSmoothieStatus(text, isError = false) {
      // Safety guard: Only run if smoothie status elements exist (Smoothie tab is active)
      if (!smoothieStatusTextEl || !smoothieStatusDotEl) {
        // Smoothie tab is not active, skip update
        return;
      }
      smoothieStatusTextEl.textContent = text;
      smoothieStatusDotEl.classList.toggle('error', isError);
    }

    function renderSmoothieIngredients() {
      // Safety guard: Only run if smoothie UI elements exist (Smoothie tab is active)
      const container = smoothieSelectedIngredientsEl || document.getElementById('smoothie-selected-ingredients');
      if (!container) {
        console.warn('[renderSmoothieIngredients] Container element not found, skipping render');
        return;
      }
      
      // Define ageGroupOption early so it's available throughout the function
      const ageGroupOption = smoothieForEl?.selectedOptions?.[0] || smoothieForEl?.options?.[smoothieForEl?.selectedIndex] || null;
      if (!buildSmoothieBtn) {
        console.warn('[renderSmoothieIngredients] buildSmoothieBtn not found, skipping render');
        return;
      }
      
      console.log('[renderSmoothieIngredients] Rendering', smoothieIngredients.length, 'ingredients:', smoothieIngredients);

      if (smoothieIngredients.length === 0) {
        container.style.display = 'none';
        container.innerHTML = '';
        buildSmoothieBtn.disabled = true;
        return;
      }

      // Get current counts for display
      const { freshFruitCount, driedFruitCount } = countFruitTypes();

      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      buildSmoothieBtn.disabled = false;
      
      // Add count display
      let countDisplay = '';
      if (freshFruitCount > 0 || driedFruitCount > 0) {
        countDisplay = `<div id="fruit-counter-display" class="ss-edit-summary" style="width: 100%; margin-bottom: 8px; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 0.8rem; color: var(--text-secondary);">
          <span>Fresh fruits: <strong style="color: ${freshFruitCount >= MAX_FRESH_FRUITS ? 'var(--danger)' : 'var(--success)'}">${freshFruitCount}/${MAX_FRESH_FRUITS}</strong></span>
          <span style="margin-left: 12px;">Dried fruits: <strong style="color: ${driedFruitCount >= MAX_DRIED_FRUITS ? 'var(--danger)' : 'var(--success)'}">${driedFruitCount}/${MAX_DRIED_FRUITS}</strong></span>
        </div>`;
      }
      
      // Add health warning for 60+ users when total dried fruit > 30-40g
      const currentAgeGroup = smoothieForEl ? smoothieForEl.value : '';
      let healthWarning60Plus = '';
      if (currentAgeGroup === 'man-60+' || currentAgeGroup === 'woman-60+') {
        const totalDriedFruitGrams = calculateTotalDriedFruitGrams60Plus(currentAgeGroup);
        if (totalDriedFruitGrams > 30) {
          const selectedHealthGoal = smoothieHealthGoalsEl ? smoothieHealthGoalsEl.value : '';
          const hasRelevantGoal = selectedHealthGoal && (
            selectedHealthGoal.toLowerCase().includes('diabetes') ||
            selectedHealthGoal.toLowerCase().includes('blood sugar') ||
            selectedHealthGoal.toLowerCase().includes('heart') ||
            selectedHealthGoal.toLowerCase().includes('weight')
          );
          
          healthWarning60Plus = `
            <div id="dried-fruit-warning-60plus" style="width: 100%; margin-bottom: 8px; padding: 10px 12px; background: #fef3c7; border-left: 3px solid #d97706; border-radius: 6px; font-size: 0.8rem; color: #78350f; line-height: 1.4;">
              <strong>ℹ️ Dried Fruit Portion Note:</strong><br>
              <span style="margin-top: 4px; display: block;">Dried fruit is very concentrated in sugar. For older adults${hasRelevantGoal ? ', especially with blood sugar, heart or weight concerns' : ''}, keep dried fruit portions small or balance with fresh fruit and vegetables.</span>
            </div>
          `;
        }
      }
      
      // Add vegetable cooking tip for kids 4-8 when certain vegetables are present
      let vegCookingTip = '';
      if (currentAgeGroup === 'child-4-8') {
        // Vegetables that may be better tolerated if lightly cooked for kids 4-8
        const cookingVegs = ['carrot', 'pumpkin', 'butternut_squash', 'butternut squash', 
                            'sweet_potato', 'sweet potato', 'beetroot', 'beets', 
                            'broccoli', 'cauliflower'];
        
        // Check if any of these vegetables are in the smoothie
        const hasCookingVeg = smoothieIngredients.some(ing => {
          const ingredientName = typeof ing === 'string' ? ing : (ing && ing.name ? ing.name : '');
          if (!ingredientName) return false;
          const nameLower = ingredientName.toLowerCase().trim();
          return cookingVegs.some(veg => {
            const vegLower = veg.toLowerCase();
            return nameLower === vegLower || nameLower.includes(vegLower) || vegLower.includes(nameLower);
          });
        });
        
        if (hasCookingVeg) {
          vegCookingTip = `
            <div id="veg-cooking-tip-kids" style="width: 100%; margin-bottom: 8px; padding: 10px 12px; background: #e0f2fe; border-left: 3px solid #0284c7; border-radius: 6px; font-size: 0.8rem; color: #0c4a6e; line-height: 1.4;">
              <strong>💡 Tip:</strong><br>
              <span style="margin-top: 4px; display: block;">For kids 4–8, some vegetables (like carrot, pumpkin, sweet potato, beetroot, broccoli and cauliflower) may be better tolerated if lightly cooked and cooled before blending. This app assumes a typical home preparation.</span>
            </div>
          `;
        }
      }
      
      // Add sweetener age tip for children and teens when sweeteners are present
      let sweetenerAgeTip = '';
      const sweetenerTip = getSweetenerAgeTip(currentAgeGroup, smoothieIngredients);
      if (sweetenerTip) {
        sweetenerAgeTip = `
          <div id="sweetener-age-tip" style="width: 100%; margin-bottom: 8px; padding: 10px 12px; background: #fff7e0; border-left: 3px solid #f4b000; border-radius: 6px; font-size: 0.8rem; color: #78350f; line-height: 1.4;">
            <strong>💡 Sweetness tip:</strong><br>
            <span style="margin-top: 4px; display: block;">${sweetenerTip}</span>
          </div>
        `;
      }
      
      // Combine all info messages (will be inserted before chips)
      const infoMessages = countDisplay + healthWarning60Plus + vegCookingTip + sweetenerAgeTip;
      
      let chipsHtml = '';
      try {
        chipsHtml = smoothieIngredients
          .map((ing, idx) => {
            try {
              // Handle both old string format and new object format
              const ingredientName = typeof ing === 'string' ? ing : (ing && ing.name ? ing.name : '');
              if (!ingredientName) {
                console.warn('[renderSmoothieIngredients] Skipping ingredient with no name:', ing);
                return '';
              }
              let quantity = typeof ing === 'object' && ing.quantity ? ing.quantity : 1;
              let unit = typeof ing === 'object' && ing.unit ? ing.unit : 'cup';
          
          // Check if it's a sweetener or vegan milk first (before fruit classification)
          const isSweet = isSweetener(ingredientName);
          const isVegan = isPlantBasedMilk(ingredientName);
          let isDried = !isSweet && !isVegan && isDriedFruit(ingredientName);
          let isFresh = !isSweet && !isVegan && isFreshFruit(ingredientName);
          const isUnsweetened = isUnsweetenedMilk(ingredientName);
          
          // Ensure sweeteners and vegan milks are not tagged as fresh or dried fruits
          if (isSweet || isVegan) {
            isFresh = false;
            isDried = false;
          }
          
          // Get portion info early so we can use portionUnit in calculations
          const currentAgeGroup = smoothieForEl ? smoothieForEl.value : '';
          
          // SINGLE SOURCE OF TRUTH: Use getSmoothiePortion() for all ingredients
          // This ensures consistent portion calculation across chips, validation, and display
          let portion;
          try {
            // Check for stored portionGrams first (from when ingredient was added)
            let storedGrams = 0;
            if (typeof ing === 'object') {
              storedGrams = ing.portionGrams || ing.quantityInGrams || ing.gramsUsed || 0;
            }
            
            if (storedGrams > 0) {
              // Use stored portion grams (calculated when ingredient was added)
              portion = { amount: storedGrams, unit: 'g', source: 'stored', isMissing: false };
            } else {
              // Use the single source of truth function
              portion = getSmoothiePortion(ingredientName, currentAgeGroup);
            }
            } catch (err) {
              console.error('[renderSmoothieIngredients] Error getting portion for', ingredientName, err);
            portion = { amount: 0, unit: 'g', source: 'error', isMissing: true };
          }
          const portionUnit = portion.unit || 'g';
          
          // For liquids (vegan milks), if quantity is 1 or 0, use the portion amount as the quantity
          // This allows users to directly edit the ml value
          if (isVegan && (quantity === 1 || quantity === 0 || !quantity) && unit === 'ml') {
            // Get the portion amount and use it as the quantity
            try {
              if (portion && portion.unit === 'ml' && portion.amount > 0) {
                quantity = portion.amount;
                // Update the ingredient object to store the ml value
                if (typeof ing === 'object') {
                  ing.quantity = portion.amount;
                  ing.unit = 'ml';
                }
              } else {
                // Fallback: use default ml based on age group
                const defaultMl = currentAgeGroup === 'child-4-8' ? 120 : 150;
                quantity = defaultMl;
                if (typeof ing === 'object') {
                  ing.quantity = defaultMl;
                  ing.unit = 'ml';
                }
              }
            } catch (err) {
              console.error('[renderSmoothieIngredients] Error getting portion for liquid:', err);
              // Fallback to default
              quantity = 150;
              if (typeof ing === 'object') {
                ing.quantity = 150;
                ing.unit = 'ml';
              }
            }
          }
          
          // Ensure quantity is valid (not 0, not undefined, not null)
          if (!quantity || quantity === 0) {
            quantity = isVegan ? 150 : 1;
            if (typeof ing === 'object') {
              ing.quantity = quantity;
            }
          }
          
          // Check if fresh fruit limit is reached
          const { freshFruitCount: currentFreshCount } = countFruitTypes();
          const currentIngQuantity = typeof ing === 'object' && ing.quantity ? ing.quantity : quantity;
          const otherFreshCount = isFresh ? (currentFreshCount - currentIngQuantity) : 0; // Count from other fresh fruits
          const maxAllowedForThisIng = isFresh ? Math.max(1, MAX_FRESH_FRUITS - otherFreshCount) : (isVegan ? (portionUnit === 'ml' ? 720 : (portionUnit === 'cup' ? 3 : 100)) : 3);
          const canIncrementFresh = isFresh ? (currentFreshCount < MAX_FRESH_FRUITS) : true;
          
          // Debug logging for dried fruits
          if (isDried) {
            console.log('[renderSmoothieIngredients] Rendering dried fruit:', ingredientName, 'quantity:', quantity, 'unit:', unit);
          }
          
          // Build badges - can have multiple badges
          let badges = [];
          if (isDried) {
            badges.push('<span class="smoothie-ingredient-badge" style="color: #92400e; background: #fef3c7;">Dried</span>');
          } else if (isFresh) {
            badges.push('<span class="smoothie-ingredient-badge" style="color: #065f46; background: #d1fae5;">Fresh</span>');
          }
          if (isVegan) {
            badges.push('<span class="smoothie-ingredient-badge" style="color: #059669; background: #d1fae5;">🌱 Vegan</span>');
          }
          if (isUnsweetened && isVegan) {
            badges.push('<span class="smoothie-ingredient-badge" style="color: #0EA5A4; background: rgba(14, 165, 164, 0.10);">Unsweetened</span>');
          }
          const badge = badges.join('');
          
          // Calculate total amount based on quantity
          // Note: portion and portionUnit are already defined above
          const portionAmount = portion.amount || 0;
          
          // SINGLE SOURCE OF TRUTH: For liquids, quantity IS the total amount (ml)
          // For solids, quantity is a multiplier (portion × quantity = total)
          const isLiquid = isVegan && portionUnit === 'ml';
          const totalAmount = isLiquid ? quantity : (portionAmount * quantity);
          
          // Debug safeguard: prevent multiplication for liquids
          if (isLiquid && totalAmount !== quantity) {
            console.warn('[renderSmoothieIngredients] Liquid totalAmount bug detected!', {
              ingredient: ingredientName,
              quantity,
              portionAmount,
              calculated: totalAmount,
              corrected: quantity
            });
          }
          
          // Record zero portions in tracker (for chips rendering)
          if (!Number.isFinite(portionAmount) || portionAmount <= 0) {
            window.__recordSmoothieZeroPortion({
              ingredient: ingredientName,
              age: currentAgeGroup,
              source: portion.source || 'renderSmoothieIngredients',
              unit: portionUnit
            });
          }
          
          // Format serving size display based on quantity
          let servingDisplay = '';
          
          // Get age group label for display (short form, no "portion" word)
          const ageGroupLabel = currentAgeGroup ? ` (${ageGroupOption?.textContent || currentAgeGroup})` : '';
          
          if (isLiquid) {
            // For liquids (milks) - quantity IS the total amount (ml), not a multiplier
            // Show simplified format: "160ml (Boy 14-18)"
            const displayMl = isVegan && typeof ing === 'object' && ing.quantity ? ing.quantity : quantity;
            servingDisplay = `${Math.round(displayMl)}${portionUnit}${ageGroupLabel}`;
          } else {
            // For solids (fruits, dried fruits) - unit is 'g', quantity is a multiplier
            if (quantity === 1) {
              servingDisplay = `${Math.round(portionAmount)}${portionUnit}${ageGroupLabel}`;
            } else {
              servingDisplay = `${Math.round(portionAmount)}${portionUnit} × ${quantity} = ${Math.round(totalAmount)}${portionUnit}${ageGroupLabel}`;
            }
          }
          
          // Check if this is soy milk and mark as fortified
          // For vegan milks, use the base name (serving size is already in servingDisplay)
          let displayName = ingredientName;
          if (isVegan) {
            // Normalize the ingredient name for checking
            const normalizedName = ingredientName.toLowerCase().trim();
            
            // Check for soy milk variations
            if (normalizedName.includes('soy milk') || normalizedName.includes('soymilk')) {
              displayName = 'Soy Milk (Fortified)';
            }
          }
          
          // Get health profile for vegan milks (for girls 9-13, teens 14-18, adults 19-30, adults 31-59, and seniors 60+)
          let healthTierHtml = '';
          const isTeen1418 = currentAgeGroup === 'girl-14-18' || currentAgeGroup === 'boy-14-18';
          const isAdult1930 = currentAgeGroup === 'woman-19-30' || currentAgeGroup === 'man-19-30';
          const isAdult3159 = currentAgeGroup === 'woman-31-59' || currentAgeGroup === 'man-31-59';
          const isSenior60Plus = currentAgeGroup === 'woman-60+' || currentAgeGroup === 'man-60+';
          if (isVegan && (currentAgeGroup === 'girl-9-13' || isTeen1418 || isAdult1930 || isAdult3159 || isSenior60Plus)) {
            const healthProfile = getVeganMilkHealthProfile(ingredientName);
            if (healthProfile) {
              let tierColor = '#64748b'; // neutral gray
              let tierBg = '#f1f5f9'; // light gray
              let tierIcon = 'ℹ️';
              
              if (healthProfile.tier === 'preferred') {
                tierColor = '#059669'; // green
                tierBg = '#d1fae5'; // light green
                tierIcon = '✓';
              } else if (healthProfile.tier === 'caution') {
                tierColor = '#d97706'; // amber
                tierBg = '#fef3c7'; // light amber
                tierIcon = '⚠️';
              }
              
              // Use age-specific reason for teens 14-18, adults 19-30, adults 31-59, and seniors 60+, otherwise use default reason
              let displayReason = healthProfile.reason;
              if (isTeen1418) {
                if (currentAgeGroup === 'girl-14-18' && healthProfile.reasonGirl1418) {
                  displayReason = healthProfile.reasonGirl1418;
                } else if (currentAgeGroup === 'boy-14-18' && healthProfile.reasonBoy1418) {
                  displayReason = healthProfile.reasonBoy1418;
                }
              } else if (isAdult1930) {
                if (currentAgeGroup === 'woman-19-30' && healthProfile.reasonWoman1930) {
                  displayReason = healthProfile.reasonWoman1930;
                } else if (currentAgeGroup === 'man-19-30' && healthProfile.reasonMan1930) {
                  displayReason = healthProfile.reasonMan1930;
                }
              } else if (isAdult3159) {
                if (currentAgeGroup === 'woman-31-59' && healthProfile.reasonWoman3159) {
                  displayReason = healthProfile.reasonWoman3159;
                } else if (currentAgeGroup === 'man-31-59' && healthProfile.reasonMan3159) {
                  displayReason = healthProfile.reasonMan3159;
                }
              } else if (isSenior60Plus) {
                if (currentAgeGroup === 'woman-60+' && healthProfile.reasonWoman60Plus) {
                  displayReason = healthProfile.reasonWoman60Plus;
                } else if (currentAgeGroup === 'man-60+' && healthProfile.reasonMan60Plus) {
                  displayReason = healthProfile.reasonMan60Plus;
                }
              }
              
              // Build the health tier message
              let tierMessage = `${tierIcon} ${displayReason}`;
              
              // For teens 14-18, adults 19-30, adults 31-59, and seniors 60+, add additional context based on flags
              if (isTeen1418 || isAdult1930 || isAdult3159 || isSenior60Plus) {
                if (healthProfile.isOfficialDairyAlt === true) {
                  tierMessage += '<br><span style="font-size: 0.7rem; opacity: 0.9; margin-top: 4px; display: block;">Recognized as a suitable dairy alternative when fortified and nutritionally similar to cow\'s milk.</span>';
                } else if (healthProfile.isAppPortionOnly === true) {
                  tierMessage += '<br><span style="font-size: 0.7rem; opacity: 0.9; margin-top: 4px; display: block;">Portion size is an app smoothie suggestion, not an official USDA/EU serving size.</span>';
                }
              }
              
              healthTierHtml = `
                <div style="margin-top: 8px; padding: 8px 10px; background: ${tierBg}; border-left: 3px solid ${tierColor}; border-radius: 6px; font-size: 0.75rem; line-height: 1.4;">
                  <span style="color: ${tierColor}; font-weight: 600;">${tierMessage}</span>
                </div>
              `;
            }
          }
          
          // Add dried fruit info for child_4_8, girl_9_13, boy_9_13, girl_14_18, boy_14_18, woman_19_30, man_19_30, and man_60_plus age groups
          if (isDried && (currentAgeGroup === 'child-4-8' || currentAgeGroup === 'girl-9-13' || currentAgeGroup === 'boy-9-13' || currentAgeGroup === 'girl-14-18' || currentAgeGroup === 'boy-14-18' || currentAgeGroup === 'woman-19-30' || currentAgeGroup === 'man-19-30' || currentAgeGroup === 'man-60+')) {
            const ageGroupKey = normalizeAgeGroupKey(currentAgeGroup);
            const driedFruitKey = normalizeDriedFruitKey(ingredientName);
            const selectedAudience = currentAgeGroup; // Define selectedAudience for use in dried fruit logic
            
            // Try to get dried fruit entry from current age group (girl_9_13, boy_9_13, girl_14_18, boy_14_18, woman_19_30, or man_19_30), fallback to child_4_8
            let targetKey = ageGroupKey;
            if (currentAgeGroup === 'girl-9-13' && DRIED_FRUIT_SERVINGS.girl_9_13) {
              targetKey = 'girl_9_13';
            } else if (currentAgeGroup === 'boy-9-13' && DRIED_FRUIT_SERVINGS.boy_9_13) {
              targetKey = 'boy_9_13';
            } else if (currentAgeGroup === 'girl-14-18' && DRIED_FRUIT_SERVINGS.girl_14_18) {
              targetKey = 'girl_14_18';
            } else if (currentAgeGroup === 'boy-14-18' && DRIED_FRUIT_SERVINGS.boy_14_18) {
              targetKey = 'boy_14_18';
            } else if (currentAgeGroup === 'woman-19-30' && DRIED_FRUIT_SERVINGS.woman_19_30) {
              targetKey = 'woman_19_30';
            } else if (currentAgeGroup === 'man-19-30' && DRIED_FRUIT_SERVINGS.man_19_30) {
              targetKey = 'man_19_30';
            } else if (currentAgeGroup === 'man-60+' && DRIED_FRUIT_SERVINGS.man_60_plus) {
              targetKey = 'man_60_plus';
            }
            
            const driedGroup = DRIED_FRUIT_SERVINGS[targetKey];
            // For man_19_30, keys use spaces (e.g., "dried raisins"), so try both formats
            let driedEntry = null;
            if (targetKey === 'man_19_30' && driedGroup) {
              // Try with spaces first (as specified: "dried raisins")
              const keyWithSpaces = driedFruitKey.replace(/_/g, ' ');
              driedEntry = driedGroup[keyWithSpaces] || driedGroup[driedFruitKey];
            } else {
              driedEntry = driedGroup && driedGroup[driedFruitKey];
            }
            
            // Get health flags for girl_14_18 and woman_19_30
            const healthFlags = targetKey === 'girl_14_18' ? getDriedFruitHealthFlags(targetKey, driedFruitKey) : null;
            const healthFlagsWoman1930 = targetKey === 'woman_19_30' ? getDriedFruitHealthFlagsWoman1930(driedFruitKey) : null;
            // For man_19_30, health tags and cautions are in the entry itself
            const man1930Entry = targetKey === 'man_19_30' ? driedEntry : null;
            const selectedHealthGoal = smoothieHealthGoalsEl ? smoothieHealthGoalsEl.value : '';
            const hasAnemiaGoal = selectedHealthGoal && (selectedHealthGoal.toLowerCase().includes('anemia') || selectedHealthGoal === 'Anemia Prevention');
            const isPregnant = selectedHealthGoal && (selectedHealthGoal.toLowerCase().includes('pregnancy') || selectedHealthGoal === 'Pregnancy Support');
            const hasThyroidGoal = selectedHealthGoal && (selectedHealthGoal.toLowerCase().includes('thyroid') || selectedHealthGoal === 'Thyroid Health');
            
            // Health goal checks for boy_14_18 and woman_19_30
            const hasWeightGoal = selectedHealthGoal && (selectedHealthGoal.toLowerCase().includes('weight') || selectedHealthGoal === 'Weight Management');
            const hasDiabetesGoal = selectedHealthGoal && (selectedHealthGoal.toLowerCase().includes('diabetes') || selectedHealthGoal.toLowerCase().includes('blood sugar') || selectedHealthGoal === 'Diabetes–Blood Sugar');
            const hasHeartGoal = selectedHealthGoal && (selectedHealthGoal.toLowerCase().includes('heart') || selectedHealthGoal === 'Heart Health');
            const hasGutGoal = selectedHealthGoal && (selectedHealthGoal.toLowerCase().includes('digestive') || selectedHealthGoal === 'Digestive Health');
            const hasDentalGoal = selectedHealthGoal && (selectedHealthGoal.toLowerCase().includes('dental') || selectedHealthGoal === 'Dental Health');
            
            // High-sugar dried fruits (for boy_14_18 and woman_19_30 with weight/diabetes/heart goals)
            const highSugarFruits = ['dried_dates', 'dried_raisins', 'dried_mango', 'dried_pineapple', 'dried_cranberries', 'dried_blueberries', 'dried_cherries'];
            const isHighSugarFruit = highSugarFruits.includes(driedFruitKey);
            const showSugarWarningBoy = currentAgeGroup === 'boy-14-18' && isHighSugarFruit && (hasWeightGoal || hasDiabetesGoal || hasHeartGoal);
            const showSugarWarningWoman = currentAgeGroup === 'woman-19-30' && healthFlagsWoman1930 && healthFlagsWoman1930.highSugar && (hasWeightGoal || hasDiabetesGoal);
            
            // Digestive health fruits (for boy_14_18 and woman_19_30 with digestive goals)
            const gutHealthFruits = ['dried_prunes', 'dried_figs', 'dried_raisins'];
            const isGutHealthFruit = gutHealthFruits.includes(driedFruitKey);
            const showGutWarningBoy = currentAgeGroup === 'boy-14-18' && isGutHealthFruit && hasGutGoal;
            const showGutWarningWoman = currentAgeGroup === 'woman-19-30' && healthFlagsWoman1930 && (healthFlagsWoman1930.laxative || healthFlagsWoman1930.highFiber) && hasGutGoal;
            
            // Pregnancy warning for woman_19_30
            const showPregnancyWarningWoman = currentAgeGroup === 'woman-19-30' && healthFlagsWoman1930 && healthFlagsWoman1930.highSugar && isPregnant;
            
            // Dental health reminder for woman_19_30 (any dried fruit)
            const showDentalReminderWoman = currentAgeGroup === 'woman-19-30' && hasDentalGoal;
            
            if (driedEntry) {
              const ageText = currentAgeGroup === 'child-4-8' ? '4–8 year-olds' : 
                             (currentAgeGroup === 'woman-19-30' ? 'women 19–30' :
                             (currentAgeGroup === 'man-19-30' ? 'men 19–30' :
                             (currentAgeGroup === 'man-60+' ? 'men 60+' :
                             ((currentAgeGroup === 'girl-14-18' || currentAgeGroup === 'boy-14-18') ? '14–18 year-olds' : '9–13 year-olds'))));
              // Get serving grams - man_19_30 uses defaultServingGrams, others use smoothieDefaultGrams
              const servingGrams = targetKey === 'man_19_30' && driedEntry.defaultServingGrams ? driedEntry.defaultServingGrams : (driedEntry.smoothieDefaultGrams || 20);
              const fallbackText = currentAgeGroup === 'child-4-8' ? '12–15g' : 
                                  (currentAgeGroup === 'woman-19-30' ? '15–20g' :
                                  (currentAgeGroup === 'man-19-30' ? '25–30g' :
                                  (currentAgeGroup === 'man-60+' ? '10–15g' :
                                  ((currentAgeGroup === 'girl-14-18' || currentAgeGroup === 'boy-14-18') ? '18–20g' : '15–18g'))));
              
              let healthFlagsHtml = '';
              
              // Add health flags info for girl_14_18
              if (targetKey === 'girl_14_18' && healthFlags) {
                if (hasAnemiaGoal && healthFlags.anemiaPrevention) {
                  healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #059669; font-weight: 500;">✓ May help support anemia prevention; still keep dried fruit portions moderate.</span>';
                }
                
                if (isPregnant && healthFlags.pregnancyCaution) {
                  healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ Check with your clinician if you have pregnancy-related concerns.</span>';
                }
                
                if (hasThyroidGoal && healthFlags.thyroidCaution) {
                  healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ Check with your clinician if you have thyroid-related concerns.</span>';
                }
              }
              
              // Add health warnings for boy_14_18
              if (showSugarWarningBoy) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ Note: Dried fruits like dates, raisins and sweet tropical fruits are very concentrated sources of sugar. Keep portions modest, especially for weight or blood sugar goals.</span>';
              }
              
              if (showGutWarningBoy) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ Note: Dried prunes and some other dried fruits can have a laxative effect in some people. Start with a small portion and see how you feel.</span>';
              }
              
              // Add health warnings for woman_19_30
              if (showSugarWarningWoman) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ High in natural sugars; keep portions modest if blood sugar or weight is a concern. Talk with your clinician if you have diabetes or PCOS.</span>';
              }
              
              if (showGutWarningWoman) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ Very high fiber / gently laxative; can cause gas or loose stools in some people. Start with a small portion.</span>';
              }
              
              if (showPregnancyWarningWoman) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ High in natural sugars. If you are pregnant or planning pregnancy and have gestational diabetes, PCOS, or insulin resistance, check portion sizes with your clinician.</span>';
              }
              
              if (showDentalReminderWoman) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">ℹ️ Dried fruits are sticky and sugary; good oral hygiene and rinsing water after your smoothie can help protect teeth.</span>';
              }
              
              // Add health profile warnings for man_60_plus
              if (targetKey === 'man_60_plus') {
                const healthProfile = getDriedFruitHealthProfileMan60Plus(driedFruitKey, selectedHealthGoal);
                if (healthProfile) {
                  // Show tier indicator
                  if (healthProfile.tier === 'preferred') {
                    healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #059669; font-weight: 500;">✓ Preferred for this health goal</span>';
                  } else if (healthProfile.tier === 'caution') {
                    healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ Caution: Use smaller portions for this health goal</span>';
                  }
                  
                  // Show warning if applicable
                  if (healthProfile.warning) {
                    healthFlagsHtml += `<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ ${healthProfile.warning}</span>`;
                  }
                  
                  // Show matching tags
                  if (healthProfile.tags && healthProfile.tags.length > 0 && selectedHealthGoal) {
                    const healthGoalLower = selectedHealthGoal.toLowerCase().replace(/\s+/g, '-');
                    const matchingTags = healthProfile.tags.filter(tag => {
                      const tagLower = tag.toLowerCase().replace(/\s+/g, '-');
                      return healthGoalLower.includes(tagLower) || tagLower.includes(healthGoalLower);
                    });
                    if (matchingTags.length > 0) {
                      const tagLabels = {
                        'bone health': 'Bone Health',
                        'blood pressure': 'Blood Pressure',
                        'digestive health': 'Digestive Health',
                        'heart health': 'Heart Health',
                        'energy boost': 'Energy Boost',
                        'urinary support': 'Urinary Support',
                        'immune system': 'Immune System',
                        'anti-inflammatory': 'Anti-Inflammatory',
                        'sleep support': 'Sleep Support',
                        'brain health': 'Brain Health',
                        'skin health': 'Skin Health',
                        'digestion support': 'Digestion Support',
                        'muscle health': 'Muscle Health'
                      };
                      const tagDisplay = matchingTags.map(tag => tagLabels[tag] || tag).join(', ');
                      healthFlagsHtml += `<br><span style="margin-top: 4px; display: block; color: #059669; font-weight: 500;">✓ May support: ${tagDisplay}</span>`;
                    }
                  }
                }
              }
              
              // Add health tags and cautions for man_19_30
              if (targetKey === 'man_19_30' && man1930Entry) {
                // Map health goal names to normalized keys for matching
                const normalizeHealthGoal = (goal) => {
                  if (!goal) return '';
                  return goal.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
                };
                const normalizedHealthGoal = normalizeHealthGoal(selectedHealthGoal);
                
                // Display health tags if they match the selected health goal
                if (man1930Entry.healthTags && Array.isArray(man1930Entry.healthTags)) {
                  const matchingTags = man1930Entry.healthTags.filter(tag => {
                    const normalizedTag = tag.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    // Map some tag variations
                    const tagMap = {
                      'energy_boost': ['energy', 'boost'],
                      'iron_support': ['anemia', 'iron'],
                      'bone_health': ['bone'],
                      'digestive_health': ['digestive', 'gut', 'stomach'],
                      'muscle_health': ['muscle'],
                      'immune_system': ['immune'],
                      'skin_health': ['skin'],
                      'brain_health': ['brain'],
                      'heart_health': ['heart'],
                      'anti_inflammatory': ['anti', 'inflammatory', 'inflammation'],
                      'urinary_tract_support': ['urinary'],
                      'sleep_support': ['sleep'],
                      'eye_health': ['eye'],
                      'blood_circulation': ['circulation', 'blood'],
                      'anemia_prevention': ['anemia', 'iron']
                    };
                    const tagKeywords = tagMap[normalizedTag] || [normalizedTag];
                    return tagKeywords.some(keyword => normalizedHealthGoal.includes(keyword));
                  });
                  
                  if (matchingTags.length > 0) {
                    const tagLabels = {
                      'energy_boost': 'Energy Boost',
                      'iron_support': 'Iron Support',
                      'bone_health': 'Bone Health',
                      'digestive_health': 'Digestive Health',
                      'muscle_health': 'Muscle Health',
                      'immune_system': 'Immune System',
                      'skin_health': 'Skin Health',
                      'brain_health': 'Brain Health',
                      'heart_health': 'Heart Health',
                      'anti_inflammatory': 'Anti-Inflammatory',
                      'urinary_tract_support': 'Urinary Tract Support',
                      'sleep_support': 'Sleep Support',
                      'eye_health': 'Eye Health',
                      'blood_circulation': 'Blood Circulation',
                      'anemia_prevention': 'Anemia Prevention'
                    };
                    const tagDisplay = matchingTags.map(tag => tagLabels[tag] || tag).join(', ');
                    healthFlagsHtml += `<br><span style="margin-top: 4px; display: block; color: #059669; font-weight: 500;">✓ May support: ${tagDisplay}</span>`;
                  }
                }
                
                // Display cautions if they match the selected health goal
                if (man1930Entry.cautions && Array.isArray(man1930Entry.cautions)) {
                  const matchingCautions = man1930Entry.cautions.filter(caution => {
                    const normalizedCaution = caution.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    const cautionMap = {
                      'diabetes_blood_sugar': ['diabetes', 'blood', 'sugar'],
                      'weight_management': ['weight'],
                      'loose_stools_sensitive_gut': ['gut', 'stomach', 'digestive', 'loose'],
                      'thyroid_health_meds_interaction': ['thyroid']
                    };
                    const cautionKeywords = cautionMap[normalizedCaution] || [normalizedCaution];
                    return cautionKeywords.some(keyword => normalizedHealthGoal.includes(keyword));
                  });
                  
                  if (matchingCautions.length > 0) {
                    const cautionMessages = {
                      'diabetes_blood_sugar': 'High in natural sugars; keep portions modest if blood sugar is a concern.',
                      'weight_management': 'High in natural sugars; keep portions modest for weight management goals.',
                      'loose_stools_sensitive_gut': 'Can cause loose stools in sensitive individuals. Start with a small portion.',
                      'thyroid_health_meds_interaction': 'May interact with thyroid medications. Check with your clinician.'
                    };
                    matchingCautions.forEach(caution => {
                      const message = cautionMessages[caution] || 'Use with caution.';
                      healthFlagsHtml += `<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ ${message}</span>`;
                    });
                  }
                }
              }
              
              // Add disclaimer for boy_14_18, woman_19_30, and man_19_30
              let disclaimerText = '';
              if (selectedAudience === 'boy-14-18') {
                disclaimerText = '<br><span style="margin-top: 4px; display: block; font-size: 0.7rem; opacity: 0.8;">Portion sizes are based on general fruit intake guidance for teens and are app suggestions, not official serving standards.</span>';
              } else if (selectedAudience === 'woman-19-30' || selectedAudience === 'man-19-30') {
                disclaimerText = '<br><span style="margin-top: 4px; display: block; font-size: 0.7rem; opacity: 0.8;">Portion sizes are app portions derived from typical fruit equivalents/guidelines, not official USDA/EU serving sizes.</span>';
              }
              
              healthTierHtml = `
                <div style="margin-top: 6px; padding: 8px 10px; background: #fef3c7; border-left: 3px solid #d97706; border-radius: 4px; font-size: 0.75rem; color: #78350f; line-height: 1.4;">
                  <strong>ℹ️ Dried Fruit Serving Info:</strong><br>
                  <span style="margin-top: 4px; display: block;">¼ cup dried fruit counts as a fruit serving in USDA-style guidance. For ${ageText}, this smoothie uses a portion (about ${servingGrams}g) because dried fruit is very concentrated.</span>
                  ${healthFlagsHtml}
                  ${disclaimerText}
                </div>
              `;
            } else {
              // Fallback message if specific entry not found
              const ageText = currentAgeGroup === 'child-4-8' ? '4–8 year-olds' : 
                             (currentAgeGroup === 'woman-19-30' ? 'women 19–30' :
                             (currentAgeGroup === 'man-19-30' ? 'men 19–30' :
                             (currentAgeGroup === 'man-60+' ? 'men 60+' :
                             ((currentAgeGroup === 'girl-14-18' || currentAgeGroup === 'boy-14-18') ? '14–18 year-olds' : '9–13 year-olds'))));
              const fallbackText = currentAgeGroup === 'child-4-8' ? '12–15g' : 
                                  (currentAgeGroup === 'woman-19-30' ? '15–20g' :
                                  (currentAgeGroup === 'man-19-30' ? '25–30g' :
                                  (currentAgeGroup === 'man-60+' ? '10–15g' :
                                  ((currentAgeGroup === 'girl-14-18' || currentAgeGroup === 'boy-14-18') ? '18–20g' : '15–18g'))));
              
              let healthFlagsHtml = '';
              if (showSugarWarningBoy) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ Note: Dried fruits like dates, raisins and sweet tropical fruits are very concentrated sources of sugar. Keep portions modest, especially for weight or blood sugar goals.</span>';
              }
              if (showGutWarningBoy) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ Note: Dried prunes and some other dried fruits can have a laxative effect in some people. Start with a small portion and see how you feel.</span>';
              }
              
              // Add health warnings for woman_19_30 (fallback case)
              if (showSugarWarningWoman) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ High in natural sugars; keep portions modest if blood sugar or weight is a concern. Talk with your clinician if you have diabetes or PCOS.</span>';
              }
              if (showGutWarningWoman) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ Very high fiber / gently laxative; can cause gas or loose stools in some people. Start with a small portion.</span>';
              }
              if (showPregnancyWarningWoman) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">⚠️ High in natural sugars. If you are pregnant or planning pregnancy and have gestational diabetes, PCOS, or insulin resistance, check portion sizes with your clinician.</span>';
              }
              if (showDentalReminderWoman) {
                healthFlagsHtml += '<br><span style="margin-top: 4px; display: block; color: #d97706; font-weight: 500;">ℹ️ Dried fruits are sticky and sugary; good oral hygiene and rinsing water after your smoothie can help protect teeth.</span>';
              }
              
              let disclaimerText = '';
              if (selectedAudience === 'boy-14-18') {
                disclaimerText = '<br><span style="margin-top: 4px; display: block; font-size: 0.7rem; opacity: 0.8;">Portion sizes are based on general fruit intake guidance for teens and are app suggestions, not official serving standards.</span>';
              } else if (selectedAudience === 'woman-19-30' || selectedAudience === 'man-19-30') {
                disclaimerText = '<br><span style="margin-top: 4px; display: block; font-size: 0.7rem; opacity: 0.8;">Portion sizes are app portions derived from typical fruit equivalents/guidelines, not official USDA/EU serving sizes.</span>';
              }
              
              healthTierHtml = `
                <div style="margin-top: 6px; padding: 8px 10px; background: #fef3c7; border-left: 3px solid #d97706; border-radius: 4px; font-size: 0.75rem; color: #78350f; line-height: 1.4;">
                  <strong>ℹ️ Dried Fruit Serving Info:</strong><br>
                  <span style="margin-top: 4px; display: block;">¼ cup dried fruit counts as a fruit serving in USDA-style guidance. For ${ageText}, this smoothie uses a smaller portion (about ${fallbackText}) because dried fruit is very concentrated.</span>
                  ${healthFlagsHtml}
                  ${disclaimerText}
                </div>
              `;
            }
          }
          
          // Ultra-compact row layout for smoothie ingredients
          return `
          <div class="ssm-row fade-in" data-idx="${idx}">
            <div class="ssm-info">
              <div class="ssm-name">${escapeHTML(displayName)}</div>
              <div class="ssm-meta">${escapeHTML(servingDisplay)}</div>
              ${badge ? `<div class="ssm-tags">${badge}</div>` : ''}
            </div>
            <div class="ssm-qty">
              <div class="ss-qty-control">
                <button class="ss-qty-btn decrement" data-index="${idx}" data-idx="${idx}" data-delta="-1" data-ss-modal-control="1" type="button" ${(isDried || (isFresh && !canIncrementFresh && quantity >= MAX_FRESH_FRUITS)) ? 'disabled' : ''}>−</button>
                    <input 
                      type="number" 
                  class="ss-qty-input" 
                      data-index="${idx}" 
                      value="${quantity}" 
                      min="${isDried ? '1' : (isVegan ? (portionUnit === 'ml' ? '50' : (portionUnit === 'cup' ? '0.5' : '1')) : (unit === 'cup' && quantity === 0.5 ? '0.5' : '1'))}" 
                      max="${isDried ? '1' : (isFresh ? maxAllowedForThisIng : (isVegan ? (portionUnit === 'ml' ? '720' : (portionUnit === 'cup' ? '3' : '100')) : '3'))}" 
                      step="${isDried ? '1' : (isVegan ? (portionUnit === 'ml' ? '10' : (portionUnit === 'cup' ? '0.5' : '1')) : (unit === 'cup' && quantity === 0.5 ? '0.5' : '1'))}"
                  style="width: ${(isVegan && portionUnit === 'ml') ? '55px' : '40px'};"
                      ${isDried ? 'readonly' : ''}
                    />
                <button class="ss-qty-btn increment" data-index="${idx}" data-idx="${idx}" data-delta="1" data-ss-modal-control="1" type="button" ${(isDried || (isFresh && !canIncrementFresh)) ? 'disabled' : ''}>+</button>
                  </div>
            </div>
            <button class="ss-remove-btn" data-index="${idx}" data-idx="${idx}" data-action="remove" data-ss-modal-control="1" title="Remove" type="button">×</button>
          </div>
        `;
            } catch (err) {
              console.error('[renderSmoothieIngredients] Error rendering ingredient at index', idx, ':', err, ing);
              return '';
            }
          })
          .join('');
      } catch (err) {
        console.error('[renderSmoothieIngredients] Error in map function:', err);
        chipsHtml = '<div style="padding: 10px; background: #fee2e2; color: #991b1b; border-radius: 6px;">Error rendering ingredients list.</div>';
      }
      
      // Check if there are any dried fruits in the smoothie for the "soak tip"
      const hasDriedFruit = smoothieIngredients.some(ing => {
        const ingredientName = typeof ing === 'object' && ing.name ? ing.name : ing;
        return isDriedFruit(ingredientName);
      });
      
      // Add "soak dried fruits" tip for woman-19-30 and man-19-30 (or any age group with dried fruits)
      let soakTipHtml = '';
      const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
      if (hasDriedFruit && (selectedAudience === 'woman-19-30' || selectedAudience === 'man-19-30')) {
        soakTipHtml = `
          <div style="margin-top: 12px; padding: 10px 12px; background: #e0f2fe; border-left: 3px solid #0284c7; border-radius: 6px; font-size: 0.8rem; color: #0c4a6e; line-height: 1.5;">
            <strong>💡 Tip:</strong> For better taste and digestion, consider soaking dried fruits in water overnight or for at least 30 minutes before blending.
          </div>
        `;
      }
      
      try {
        // Calculate total weight for yield display
        let totalWeightGrams = 0;
        smoothieIngredients.forEach(ing => {
          const ingredientName = typeof ing === 'string' ? ing : (ing && ing.name ? ing.name : '');
          if (!ingredientName) return;
          const quantity = typeof ing === 'object' && ing.quantity ? ing.quantity : 1;
          const portion = getSmoothiePortion(ingredientName, currentAgeGroup);
          const portionAmount = portion.amount || 0;
          const isVegan = isPlantBasedMilk(ingredientName);
          const isLiquid = isVegan && portion.unit === 'ml';
          const totalAmount = isLiquid ? quantity : (portionAmount * quantity);
          totalWeightGrams += totalAmount;
        });
        
        // Format yield display
        const formatWeight = (grams) => {
          if (!grams || grams <= 0) return '—';
          if (grams >= 1000) {
            return `${(grams / 1000).toFixed(1)}kg`;
          }
          return `${Math.round(grams)}g`;
        };
        const yieldDisplay = formatWeight(totalWeightGrams);
        
        // Build chip strip for summary (preview of first 6 ingredients)
        const previewCount = 6;
        const previewIngredients = smoothieIngredients.slice(0, previewCount);
        const remainingCount = Math.max(0, smoothieIngredients.length - previewCount);
        
        const chipStripHtml = previewIngredients.map((ing, idx) => {
          const ingredientName = typeof ing === 'string' ? ing : (ing && ing.name ? ing.name : '');
          if (!ingredientName) return '';
          const quantity = typeof ing === 'object' && ing.quantity ? ing.quantity : 1;
          const portion = getSmoothiePortion(ingredientName, currentAgeGroup);
          const portionAmount = portion.amount || 0;
          const isVegan = isPlantBasedMilk(ingredientName);
          const isLiquid = isVegan && portion.unit === 'ml';
          const totalAmount = isLiquid ? quantity : (portionAmount * quantity);
          const portionUnit = portion.unit || 'g';
          const servingDisplay = isLiquid 
            ? `${Math.round(quantity)}${portionUnit}`
            : (quantity === 1 ? `${Math.round(portionAmount)}${portionUnit}` : `${Math.round(totalAmount)}${portionUnit}`);
          return `<div class="ssm-chip"><span class="ssm-chip-name">${escapeHTML(ingredientName)}</span><span class="ssm-chip-portion">${escapeHTML(servingDisplay)}</span></div>`;
        }).join('');
        
        const moreChipHtml = remainingCount > 0 ? `<div class="ssm-chip" style="background: var(--primary); color: white; border-color: var(--primary);"><span class="ssm-chip-name">+${remainingCount} more</span></div>` : '';
        
        // Build compact summary card (no scroll, no tall list)
        const summaryHtml = `
          <div class="ssm-summary-card">
            <div class="ssm-summary-header sb-ing-header">
              <div style="flex: 1; min-width: 0;">
                <div class="ssm-summary-title">Smoothie Ingredients <span style="color: var(--text-secondary); font-weight: 600;">(${smoothieIngredients.length})</span></div>
                <div class="ssm-summary-meta">
                  ${freshFruitCount > 0 || driedFruitCount > 0 ? `<span class="ssm-summary-meta-item">Fresh fruits ${freshFruitCount}/${MAX_FRESH_FRUITS}</span>` : ''}
                  ${driedFruitCount > 0 ? `<span class="ssm-summary-meta-item">• Dried fruits ${driedFruitCount}/${MAX_DRIED_FRUITS}</span>` : ''}
                </div>
              </div>
              <button class="ssm-edit-btn" id="ssm-edit-btn" type="button">Edit ingredients</button>
            </div>
            <div class="ssm-chipstrip">${chipStripHtml}${moreChipHtml}</div>
          </div>
        `;
        
        // Build modal structure with full ingredient list
        const modalHtml = `
          <div class="ssm-modal ss-edit-modal" id="ssm-modal">
            <div class="ssm-backdrop" id="ssm-backdrop"></div>
            <div class="ssm-modal-card">
              <div class="ssm-modal-header">
                <div class="ssm-modal-title">Edit ingredients</div>
                <button class="ssm-modal-close" id="ssm-modal-close" type="button" aria-label="Close">×</button>
              </div>
              <div class="ssm-modal-scroll ss-edit-body">
                ${infoMessages ? `<div class="ss-info-messages">${infoMessages}</div>` : ''}
                ${chipsHtml}
                ${soakTipHtml ? `<div style="margin-top: 12px; padding: 10px 12px; background: #e0f2fe; border-left: 3px solid #0284c7; border-radius: 6px; font-size: 0.8rem; color: #0c4a6e; line-height: 1.5;">${soakTipHtml}</div>` : ''}
              </div>
            </div>
          </div>
        `;
        
        // Preserve modal open state before rebuilding innerHTML
        // Check both the DOM state and the global state variable
        const prevModal = container.querySelector('#ssm-modal');
        const wasOpen = (prevModal && prevModal.classList.contains('ssm-modal-open')) || smoothieEditPanelOpen;
        // Always preserve the state - if it was open, keep it open
        smoothieEditPanelOpen = wasOpen;
        
        container.innerHTML = summaryHtml + modalHtml;
        
        // Setup modal open/close handlers
        const modalEl = document.getElementById('ssm-modal');
        const editBtn = document.getElementById('ssm-edit-btn');
        const closeBtn = document.getElementById('ssm-modal-close');
        const backdropEl = document.getElementById('ssm-backdrop');
        
        const openModal = () => {
          if (modalEl) {
            modalEl.classList.add('ssm-modal-open');
            document.body.style.overflow = 'hidden'; // Prevent body scroll
            smoothieEditPanelOpen = true;
          }
        };
        
        const closeModal = () => {
          if (modalEl) {
            modalEl.classList.remove('ssm-modal-open');
            document.body.style.overflow = ''; // Restore body scroll
            smoothieEditPanelOpen = false;
          }
        };
        
        // Restore modal open state if it was open before rerender
        // Use requestAnimationFrame to ensure DOM is fully ready
        if (wasOpen && modalEl) {
          requestAnimationFrame(() => {
            if (modalEl) {
              modalEl.classList.add('ssm-modal-open');
              document.body.style.overflow = 'hidden';
              smoothieEditPanelOpen = true;
            }
          });
        }
        
        if (editBtn) {
          editBtn.addEventListener('click', openModal);
        }
        
        if (closeBtn) {
          closeBtn.addEventListener('click', closeModal);
        }
        
        if (backdropEl) {
          backdropEl.addEventListener('click', (e) => {
            // Only close if clicking the backdrop itself, not modal content
            if (e.target === backdropEl) {
              closeModal();
            }
          });
        }
        
        // Close on Escape key (use a single global handler to avoid duplicates)
        if (!window.__ssmEscapeHandler) {
          window.__ssmEscapeHandler = (e) => {
            if (e.key === 'Escape') {
              const modal = document.getElementById('ssm-modal');
              if (modal && modal.classList.contains('ssm-modal-open')) {
                modal.classList.remove('ssm-modal-open');
                document.body.style.overflow = '';
              }
            }
          };
          document.addEventListener('keydown', window.__ssmEscapeHandler);
        }
      } catch (err) {
        console.error('[renderSmoothieIngredients] Error setting innerHTML:', err);
        console.error('chipsHtml length:', chipsHtml.length);
        console.error('smoothieIngredients:', smoothieIngredients);
        // Try to set a simple error message
        container.innerHTML = '<div style="padding: 10px; background: #fee2e2; color: #991b1b; border-radius: 6px;">Error rendering ingredients. Please refresh the page.</div>';
      }

      // Function to update fruit counter display without re-rendering everything
      function updateFruitCounter() {
        const counterEl = document.getElementById('fruit-counter-display');
        if (!counterEl) return;
        
        const { freshFruitCount, driedFruitCount } = countFruitTypes();
        counterEl.innerHTML = `
          <span>Fresh fruits: <strong style="color: ${freshFruitCount >= MAX_FRESH_FRUITS ? 'var(--danger)' : 'var(--success)'}">${freshFruitCount}/${MAX_FRESH_FRUITS}</strong></span>
          <span style="margin-left: 12px;">Dried fruits: <strong style="color: ${driedFruitCount >= MAX_DRIED_FRUITS ? 'var(--danger)' : 'var(--success)'}">${driedFruitCount}/${MAX_DRIED_FRUITS}</strong></span>
        `;
      }

      // Handle quantity input changes
      container.querySelectorAll('.ss-qty-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.index);
          const ing = smoothieIngredients[idx];
          const isVegan = typeof ing === 'object' && ing.name ? isPlantBasedMilk(ing.name) : false;
          const isDried = typeof ing === 'object' && ing.name ? isDriedFruit(ing.name) : false;
          const isFresh = typeof ing === 'object' && ing.name ? isFreshFruit(ing.name) : false;
          const currentUnit = typeof ing === 'object' && ing.unit ? ing.unit : 'cup';
          
          // For dried fruits, quantity must always be 1 (1 serving)
          if (isDried) {
            e.target.value = 1;
            if (typeof ing === 'object') {
              ing.quantity = 1;
            }
            updateSmoothieRecipe();
            updateFruitCounter();
            return;
          }
          
          let newQuantity = parseFloat(e.target.value);
          
          // For fresh fruits, check if new quantity would exceed the limit
          if (isFresh) {
            const { freshFruitCount: currentFreshCount } = countFruitTypes();
            const currentIngQuantity = typeof ing === 'object' && ing.quantity ? ing.quantity : 1;
            const otherFreshCount = currentFreshCount - currentIngQuantity; // Count from other fresh fruits
            const maxAllowedForThisIng = MAX_FRESH_FRUITS - otherFreshCount; // Max allowed for this ingredient
            
            if (newQuantity > maxAllowedForThisIng) {
              // Cap at the maximum allowed
              newQuantity = Math.max(1, maxAllowedForThisIng);
              e.target.value = newQuantity;
            }
          }
          
          // Validate and update based on unit
          if (isVegan && currentUnit === 'ml') {
            // For ml, validate between 50 and 720
            if (newQuantity >= 50 && !isNaN(newQuantity) && newQuantity <= 720) {
              if (typeof ing === 'object') {
                ing.quantity = Math.round(newQuantity);
              } else {
                smoothieIngredients[idx] = {
                  name: smoothieIngredients[idx],
                  quantity: Math.round(newQuantity),
                  unit: 'ml'
                };
              }
              updateSmoothieRecipe();
              updateFruitCounter();
            } else {
              const validQuantity = Math.max(50, Math.min(720, newQuantity || 120));
              e.target.value = validQuantity;
              if (typeof ing === 'object') {
                ing.quantity = Math.round(validQuantity);
              }
              updateFruitCounter();
            }
          } else if (currentUnit === 'cup') {
            // For cups, validate between 0.5 and 3
            if (newQuantity >= 0.5 && !isNaN(newQuantity) && newQuantity <= 3) {
              if (typeof ing === 'object') {
                ing.quantity = Math.round(newQuantity * 100) / 100; // Round to 2 decimals
              } else {
                smoothieIngredients[idx] = {
                  name: smoothieIngredients[idx],
                  quantity: Math.round(newQuantity * 100) / 100,
                  unit: 'cup'
                };
              }
              updateSmoothieRecipe();
              updateFruitCounter();
            } else {
              const validQuantity = Math.max(0.5, Math.min(3, newQuantity || 1));
              e.target.value = validQuantity;
              if (typeof ing === 'object') {
                ing.quantity = Math.round(validQuantity * 100) / 100;
              }
              updateFruitCounter();
            }
          } else {
            // For other units (oz, g), validate appropriately
            if (newQuantity >= 1 && !isNaN(newQuantity) && newQuantity <= 3) {
              if (typeof ing === 'object') {
                ing.quantity = newQuantity;
              } else {
                smoothieIngredients[idx] = {
                  name: smoothieIngredients[idx],
                  quantity: newQuantity,
                  unit: currentUnit || 'cup'
                };
              }
              updateSmoothieRecipe();
              updateFruitCounter();
            } else {
              const validQuantity = Math.max(1, Math.min(3, newQuantity || 1));
              e.target.value = validQuantity;
              if (typeof ing === 'object') {
                ing.quantity = validQuantity;
              }
              updateFruitCounter();
            }
          }
        });
      });

      // Handle quantity button clicks (increment/decrement)
      container.querySelectorAll('.ss-qty-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(btn.dataset.index);
          const input = smoothieSelectedIngredientsEl.querySelector(`.smoothie-quantity-input[data-index="${idx}"]`);
          if (!input) return;

          const ing = smoothieIngredients[idx];
          const isDried = typeof ing === 'object' && ing.name ? isDriedFruit(ing.name) : false;
          const isFresh = typeof ing === 'object' && ing.name ? isFreshFruit(ing.name) : false;
          const isVegan = typeof ing === 'object' && ing.name ? isPlantBasedMilk(ing.name) : false;
          const currentUnit = typeof ing === 'object' && ing.unit ? ing.unit : 'cup';
          
          // For dried fruits, quantity must always be 1 (1 serving), prevent changes
          if (isDried) {
            input.value = 1;
            if (typeof ing === 'object') {
              ing.quantity = 1;
            }
            updateSmoothieRecipe();
            updateFruitCounter();
            return;
          }

          const currentValue = parseFloat(input.value) || 1;
          // For liquids (ml), use step of 10ml; for others use the input's step
          const step = (isVegan && currentUnit === 'ml') ? 10 : (parseFloat(input.step) || 1);
          const min = parseFloat(input.min) || 1;
          let max = parseFloat(input.max) || 3;
          
          // For fresh fruits, check if incrementing would exceed the limit
          if (isFresh && btn.classList.contains('increment')) {
            const { freshFruitCount: currentFreshCount } = countFruitTypes();
            const currentIngQuantity = typeof ing === 'object' && ing.quantity ? ing.quantity : 1;
            const otherFreshCount = currentFreshCount - currentIngQuantity; // Count from other fresh fruits
            const maxAllowedForThisIng = MAX_FRESH_FRUITS - otherFreshCount; // Max allowed for this ingredient
            max = Math.min(max, maxAllowedForThisIng); // Cap the max at the limit
          }

          let newValue;
          if (btn.classList.contains('increment')) {
            newValue = Math.min(currentValue + step, max);
          } else if (btn.classList.contains('decrement')) {
            newValue = Math.max(currentValue - step, min);
          }

          if (newValue !== undefined && newValue >= min && newValue <= max) {
            // Round to appropriate decimal places based on step
            if (step < 1) {
              newValue = Math.round(newValue * 10) / 10; // Round to 1 decimal place for 0.5 step
            } else if (step >= 10) {
              // For ml (step 10), round to nearest 10
              newValue = Math.round(newValue / 10) * 10;
            } else {
              newValue = Math.round(newValue); // Round to whole number for 1 step
            }
            
            input.value = newValue;
            
            // Update the ingredient data
            if (typeof ing === 'object' && ing.name) {
              // Round appropriately based on unit
              if (ing.unit === 'cup' || ing.unit === 'oz') {
                ing.quantity = Math.round(newValue * 100) / 100; // Round to 2 decimals for cups/oz
              } else {
                ing.quantity = Math.round(newValue); // Round to whole number for ml/g
              }
            } else {
              // Convert old string format to object
              smoothieIngredients[idx] = {
                name: smoothieIngredients[idx],
                quantity: currentUnit === 'cup' || currentUnit === 'oz' ? Math.round(newValue * 100) / 100 : Math.round(newValue),
                unit: currentUnit
              };
            }
            updateSmoothieRecipe();
            // Update the counter display without re-rendering everything
            updateFruitCounter();
            // Re-render to update the serving display
            renderSmoothieIngredients();
          }
        });
      });
      
      // Handle unit select changes
      container.querySelectorAll('.unit-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.index);
          const newUnit = e.target.value;
          const ing = smoothieIngredients[idx];
          
          if (typeof ing === 'object' && ing.name) {
            const ingredientName = ing.name;
            const isVegan = isPlantBasedMilk(ingredientName);
            const isDried = isDriedFruit(ingredientName);
            const oldUnit = ing.unit;
            const oldQuantity = ing.quantity;
            
            // Handle dried fruits separately (weight-based conversion)
            if (isDried) {
              // Get dried fruit data for conversion
              const driedFruitKey = normalizeDriedFruitKey(ingredientName);
              const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
              // Try girl_9_13 or boy_9_13 first if available, then child_4_8, then fallback
              let targetKey = 'child_4_8';
              if (selectedAudience === 'girl-9-13' && DRIED_FRUIT_SERVINGS.girl_9_13) {
                targetKey = 'girl_9_13';
              } else if (selectedAudience === 'boy-9-13' && DRIED_FRUIT_SERVINGS.boy_9_13) {
                targetKey = 'boy_9_13';
              }
              const driedEntry = DRIED_FRUIT_SERVINGS[targetKey] && DRIED_FRUIT_SERVINGS[targetKey][driedFruitKey]
                ? DRIED_FRUIT_SERVINGS[targetKey][driedFruitKey]
                : (DRIED_FRUIT_SERVINGS.child_4_8 && DRIED_FRUIT_SERVINGS.child_4_8[driedFruitKey])
                ? DRIED_FRUIT_SERVINGS.child_4_8[driedFruitKey]
                : null;
              
              // Use USDA serving data: ¼ cup = usdaServingGrams, so 1 cup = usdaServingGrams * 4
              // Fallback: if no entry, use average (¼ cup ≈ 30g, so 1 cup ≈ 120g)
              const gramsPerCup = driedEntry ? driedEntry.usdaServingGrams * 4 : 120;
              const gramsPerOz = gramsPerCup / 8; // 1 cup = 8 oz
              
              let quantityInGrams = oldQuantity;
              
              // Convert old unit to grams
              if (oldUnit === 'cup') {
                quantityInGrams = oldQuantity * gramsPerCup;
              } else if (oldUnit === 'oz') {
                quantityInGrams = oldQuantity * gramsPerOz;
              } else if (oldUnit === 'ml') {
                // For dried fruits, ml doesn't make sense, but convert as if 1ml ≈ 1g
                quantityInGrams = oldQuantity;
              } else if (oldUnit === 'g') {
                quantityInGrams = oldQuantity;
              }
              
              // Convert from grams to new unit
              if (newUnit === 'cup') {
                ing.quantity = Math.round((quantityInGrams / gramsPerCup) * 100) / 100; // Round to 2 decimals
                ing.unit = 'cup';
              } else if (newUnit === 'oz') {
                ing.quantity = Math.round((quantityInGrams / gramsPerOz) * 100) / 100; // Round to 2 decimals
                ing.unit = 'oz';
              } else if (newUnit === 'ml') {
                // For dried fruits, ml doesn't make sense, but convert as if 1g ≈ 1ml
                ing.quantity = Math.round(quantityInGrams);
                ing.unit = 'ml';
              } else if (newUnit === 'g') {
                ing.quantity = Math.round(quantityInGrams);
                ing.unit = 'g';
              } else {
                ing.unit = newUnit;
              }
            } else {
              // Convert between units for liquids (cup, ml, oz, g)
              // Conversion factors: 1 cup = 240ml, 1 oz ≈ 30ml, 1 ml ≈ 1g (for liquids)
              let quantityInMl = oldQuantity;
              
              // Convert old unit to ml first
              if (oldUnit === 'cup') {
                quantityInMl = oldQuantity * 240;
              } else if (oldUnit === 'oz') {
                quantityInMl = oldQuantity * 30;
              } else if (oldUnit === 'ml') {
                quantityInMl = oldQuantity;
              } else if (oldUnit === 'g') {
                // For liquids, 1g ≈ 1ml
                quantityInMl = oldQuantity;
              }
              
              // Convert from ml to new unit
              if (newUnit === 'cup') {
                ing.quantity = Math.round((quantityInMl / 240) * 100) / 100; // Round to 2 decimals
                ing.unit = 'cup';
              } else if (newUnit === 'ml') {
                ing.quantity = Math.round(quantityInMl);
                ing.unit = 'ml';
              } else if (newUnit === 'oz') {
                ing.quantity = Math.round((quantityInMl / 30) * 100) / 100; // Round to 2 decimals
                ing.unit = 'oz';
              } else if (newUnit === 'g') {
                // For liquids, 1ml ≈ 1g
                ing.quantity = Math.round(quantityInMl);
                ing.unit = 'g';
              } else {
                ing.unit = newUnit;
              }
            }
          } else {
            // Convert old string format to object
            smoothieIngredients[idx] = {
              name: smoothieIngredients[idx],
              quantity: 1,
              unit: newUnit
            };
          }
          updateSmoothieRecipe();
          renderSmoothieIngredients(); // Re-render to update display
        });
      });
      
      // Handle remove button clicks
      container.querySelectorAll('.ss-remove-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.index);
          const removedIngredient = smoothieIngredients[idx];
          
          // If a dried fruit is being removed, reset the tip flag so it can show again
          if (removedIngredient && typeof removedIngredient === 'object' && removedIngredient.name) {
            const ingredientName = removedIngredient.name;
            if (isDriedFruit(ingredientName)) {
              resetDriedFruitTip();
            }
          } else if (typeof removedIngredient === 'string' && isDriedFruit(removedIngredient)) {
            resetDriedFruitTip();
          }
          
          smoothieIngredients.splice(idx, 1);
          renderSmoothieIngredients();
          updateSmoothieRecipe();
          checkAndShowVeganMilkRecommendation();
        });
      });
      
      // Check and show vegan milk recommendation after rendering
      checkAndShowVeganMilkRecommendation();
    }

    /**
     * Check if any non-recommended vegan milk is selected for kids 4-8
     * and display recommendation container if needed
     */
    function checkAndShowVeganMilkRecommendation() {
      if (!veganMilkRecommendationContainerEl) return;
      
      // Get selected target audience
      const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
      
      // Only show for kids 4-6, 7-8, girls 9-13, boys 9-13, girls 14-18, boys 14-18, women 19-30, and men 19-30
      const isChild46 = selectedAudience === 'child-4-6';
      const isChild78 = selectedAudience === 'child-7-8';
      const isChild48 = selectedAudience === 'child-4-8'; // backward compatibility
      const isGirl913 = selectedAudience === 'girl-9-13';
      const isBoy913 = selectedAudience === 'boy-9-13';
      const isGirl1418 = selectedAudience === 'girl-14-18';
      const isBoy1418 = selectedAudience === 'boy-14-18';
      const isWoman1930 = selectedAudience === 'woman-19-30';
      const isMan1930 = selectedAudience === 'man-19-30';
      
      if (!isChild46 && !isChild78 && !isChild48 && !isGirl913 && !isBoy913 && !isGirl1418 && !isBoy1418 && !isWoman1930 && !isMan1930) {
        veganMilkRecommendationContainerEl.style.display = 'none';
        veganMilkRecommendationContainerEl.innerHTML = '';
        return;
      }
      
      // Find all vegan milks in the smoothie ingredients
      const veganMilksInSmoothie = smoothieIngredients.filter(ing => {
        const name = typeof ing === 'string' ? ing : ing.name;
        return isPlantBasedMilk(name);
      });
      
      // Check if any vegan milk is not recommended
      const nonRecommendedMilks = veganMilksInSmoothie.filter(ing => {
        const name = typeof ing === 'string' ? ing : ing.name;
        const recommended = isVeganMilkRecommended(name, selectedAudience);
        return !recommended;
      });
      
      if (nonRecommendedMilks.length > 0) {
        // Determine which recommendation list to use and the age group text
        let recommendedMilksObj;
        let ageGroupText;
        let servingText;
        
        if (isChild46 || isChild78 || isChild48) {
          recommendedMilksObj = KID_4_8_RECOMMENDED_VEGAN_MILKS;
          ageGroupText = 'children 4-8 years';
          servingText = '4–8 smoothie serving (ml)';
        } else if (isGirl913 || isBoy913) {
          recommendedMilksObj = KID_9_13_RECOMMENDED_VEGAN_MILKS;
          ageGroupText = 'children 9-13 years';
          servingText = '9–13 smoothie serving (ml)';
        } else if (isGirl1418 || isBoy1418) {
          recommendedMilksObj = TEEN_14_18_RECOMMENDED_VEGAN_MILKS;
          ageGroupText = 'teens 14-18 years';
          servingText = '14–18 smoothie serving (ml)';
        } else if (isWoman1930 || isMan1930) {
          recommendedMilksObj = ADULT_19_30_RECOMMENDED_VEGAN_MILKS;
          ageGroupText = 'adults 19-30 years';
          servingText = '19–30 smoothie serving (ml)';
        }
        
        // Build recommendation table
        const recommendedMilksList = Object.entries(recommendedMilksObj)
          .map(([key, value]) => {
          const servingDisplayRaw = typeof value.servingMl === 'string' 
              ? value.servingMl 
              : `${value.servingMl} ml`;
          const servingDisplay = escapeHTML(servingDisplayRaw);
          const milkName = escapeHTML(value.displayName);
            return `<tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
              <td style="padding: 8px 12px; font-size: 0.85rem; color: white;">${milkName}</td>
              <td style="padding: 8px 12px; font-size: 0.85rem; color: white; text-align: center; font-weight: 600;">${servingDisplay}</td>
            </tr>`;
          }).join('');
        
        veganMilkRecommendationContainerEl.innerHTML = `
          <details class="vmr-card">
            <summary class="vmr-summary-row">
              <span style="font-size: 1.1rem;">💡</span>
              <span class="vmr-title">Vegan Milk Recommendation</span>
              <span>Recommended for ${escapeHTML(ageGroupText)} (unsweetened, fortified when possible).</span>
            </summary>
            <div class="vmr-table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Vegan milk type (unsweetened, fortified when possible)</th>
                    <th>${escapeHTML(servingText)}</th>
                  </tr>
                </thead>
                <tbody>
                  ${recommendedMilksList}
                </tbody>
              </table>
            </div>
          </details>
        `;
        veganMilkRecommendationContainerEl.style.display = 'block';
      } else {
        veganMilkRecommendationContainerEl.style.display = 'none';
        veganMilkRecommendationContainerEl.innerHTML = '';
      }
    }

    /**
     * Update vegan milk serving sizes based on current target audience
     * For Child 4-8: set to 120ml (same for all vegan milks)
     * For Girl/Boy 9-13: set to appropriate ml (150ml for most, 120ml for coconut, same for all)
     * For Girl/Boy 14-18: set to appropriate ml (150ml for most, 120ml for coconut, same for all)
     * For others: set to 240ml (1 cup equivalent)
     */
    function updateVeganMilkServingSizes() {
      if (!smoothieIngredients || smoothieIngredients.length === 0) return;
      
      const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
      const ageGroupKey = normalizeAgeGroupKey(selectedAudience);
      const isChild46 = selectedAudience === 'child-4-6';
      const isChild78 = selectedAudience === 'child-7-8';
      const isChild48 = selectedAudience === 'child-4-8'; // backward compatibility
      const isGirl913 = selectedAudience === 'girl-9-13';
      const isBoy913 = selectedAudience === 'boy-9-13';
      
      let needsUpdate = false;
      
      smoothieIngredients.forEach(ing => {
        if (typeof ing === 'object' && ing.name) {
          const ingredientName = ing.name;
          
          if (isPlantBasedMilk(ingredientName)) {
            if (isChild46 || isChild78 || isChild48) {
              // For kids 4-8, set to 120ml (same for ALL vegan milks, recommended or not)
              if (ing.quantity !== 120 || ing.unit !== 'ml') {
                ing.quantity = 120;
                ing.unit = 'ml';
                needsUpdate = true;
              }
            } else if (isGirl913 || isBoy913) {
              // For girls/boys 9-13, use age-specific ml serving sizes
              // If not in recommended list, use default 150ml (same as recommended milks)
              // This ensures ALL vegan milks use the same serving size for consistency
              const servingMl = getServingMlForLiquid(ageGroupKey, ingredientName, 150); // Default 150ml for 9-13
              
              if (ing.quantity !== servingMl || ing.unit !== 'ml') {
                ing.quantity = servingMl;
                ing.unit = 'ml';
                needsUpdate = true;
              }
            } else if (selectedAudience === 'girl-14-18' || selectedAudience === 'boy-14-18') {
              // For girls/boys 14-18, use age-specific ml serving sizes
              // If not in recommended list, use default 150ml (same as recommended milks)
              // This ensures ALL vegan milks use the same serving size for consistency
              const servingMl = getServingMlForLiquid(ageGroupKey, ingredientName, 150); // Default 150ml for 14-18
              
              if (ing.quantity !== servingMl || ing.unit !== 'ml') {
                ing.quantity = servingMl;
                ing.unit = 'ml';
                needsUpdate = true;
              }
            } else if (selectedAudience === 'woman-19-30' || selectedAudience === 'man-19-30') {
              // For women/men 19-30, use age-specific ml serving sizes
              // If not in recommended list, use default 150ml (same as recommended milks)
              // This ensures ALL vegan milks use the same serving size for consistency
              const servingMl = getServingMlForLiquid(ageGroupKey, ingredientName, 150); // Default 150ml for 19-30
              
              if (ing.quantity !== servingMl || ing.unit !== 'ml') {
                ing.quantity = servingMl;
                ing.unit = 'ml';
                needsUpdate = true;
              }
            } else if (selectedAudience === 'woman-31-59' || selectedAudience === 'man-31-59') {
              // For women/men 31-59, use age-specific ml serving sizes
              // If not in recommended list, use default 150ml (same as recommended milks)
              // This ensures ALL vegan milks use the same serving size for consistency
              const servingMl = getServingMlForLiquid(ageGroupKey, ingredientName, 150); // Default 150ml for 31-59
              
              if (ing.quantity !== servingMl || ing.unit !== 'ml') {
                ing.quantity = servingMl;
                ing.unit = 'ml';
                needsUpdate = true;
              }
            } else if (selectedAudience === 'woman-60+' || selectedAudience === 'man-60+') {
              // For women/men 60+, use age-specific ml serving sizes (slightly conservative)
              // If not in recommended list, use default 120ml (same as recommended milks)
              // This ensures ALL vegan milks use the same serving size for consistency
              const servingMl = getServingMlForLiquid(ageGroupKey, ingredientName, 120); // Default 120ml for 60+
              
              if (ing.quantity !== servingMl || ing.unit !== 'ml') {
                ing.quantity = servingMl;
                ing.unit = 'ml';
                needsUpdate = true;
              }
            } else {
              // For other age groups, set to 240ml (1 cup equivalent) if currently less
              if (ing.unit === 'ml' && ing.quantity < 240) {
                ing.quantity = 240;
                ing.unit = 'ml';
                needsUpdate = true;
              } else if (ing.unit === 'cup' && ing.quantity <= 0.5) {
                // Convert from cups to ml
                ing.quantity = 240;
                ing.unit = 'ml';
                needsUpdate = true;
              }
            }
          }
        }
      });
      
      if (needsUpdate) {
        renderSmoothieIngredients();
        updateSmoothieRecipe();
      }
    }

    function updateSmoothieRecipe() {
      // Container removed - function kept for compatibility but does nothing
      return;
    }

    // Smoothie ingredient search
    // Helper function to clear smoothie ingredient search UI
    function clearSmoothieIngredientSearchUI() {
      // Query DOM fresh (do not use cached variables)
      const input = document.getElementById('smoothie-ingredient-search');
      if (!input) {
        console.warn('[clearSmoothieIngredientSearchUI] Input element not found');
        return;
      }
      
      // Clear any pending search timeout first
      if (typeof smoothieSearchTimeout !== 'undefined' && smoothieSearchTimeout) {
        clearTimeout(smoothieSearchTimeout);
        smoothieSearchTimeout = null;
      }
      
      // Find and clear/hide suggestions container FIRST (before clearing input)
      const suggestionsEl = document.getElementById('smoothie-ingredient-suggestions');
      if (suggestionsEl) {
        suggestionsEl.innerHTML = '';
        suggestionsEl.style.display = 'none';
      }
      
      // Clear input value
      input.value = '';
      
      // Dispatch input event to force suggestion renderer to react
      // This will trigger the input listener which will see empty value and hide suggestions
      input.dispatchEvent(new Event('input', { bubbles: true }));
      
      // Focus input with preventScroll to avoid page jump
      setTimeout(() => {
        input.focus({ preventScroll: true });
      }, 0);
      
      // Debug log (temporary - remove after confirming)
      console.log('[smoothie] cleared search UI');
    }

    if (smoothieIngredientSearchEl && smoothieIngredientSuggestionsEl) {
      smoothieIngredientSearchEl.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (smoothieSearchTimeout) clearTimeout(smoothieSearchTimeout);
        
        if (query.length < 2) {
          smoothieIngredientSuggestionsEl.innerHTML = '';
          smoothieIngredientSuggestionsEl.style.display = 'none';
          return;
        }

        smoothieSearchTimeout = setTimeout(async () => {
          try {
            const res = await fetch(`/api/ingredient-search?q=${encodeURIComponent(query)}`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            let suggestions = await res.json();
            const rawSuggestions = suggestions;
            if (location.hostname === "localhost" || location.search.includes("debug=1")) {
              window.__lastSmoothieSuggestionsRaw = rawSuggestions;
            }
            window.__smoothieSearchHit = (window.__smoothieSearchHit || 0) + 1;
            console.log("[smoothie-search hit]", window.__smoothieSearchHit, "len=", Array.isArray(suggestions) ? suggestions.length : suggestions);
            
            // Filter out inappropriate ingredients for smoothies
            function smoothieName(x) {
              if (typeof x === "string") return x;
              if (!x || typeof x !== "object") return "";
              return String(x.name || x.label || x.title || x.food || x.text || "").trim();
            }

            // Meat blocking regex (pork, beef, lamb, poultry, etc.)
            const MEAT_RE = /\b(pork|bacon|ham|prosciutto|salami|pepperoni|pancetta|sausage|chorizo|lard|beef|lamb|chicken|turkey|liver)\b/;
            
            // Seafood blocking regex (fish, shellfish, general seafood terms)
            const SEAFOOD_RE = /\b(clam|clams|oyster|oysters|mussel|mussels|scallop|scallops|shrimp|prawn|crab|lobster|octopus|squid|seafood|fish|shellfish|anchov|anchovy|haddock|halibut|herring|mackerel|salmon|sardine|sardines|trout|tuna)\b/;

            function isSmoothieAllowed(name) {
              const n = (name || "").toLowerCase().trim();
              if (!n) return false;

              // Explicitly ALLOW yogurt, greek yogurt, kefir, and cottage cheese (including low-fat variants)
              if (/\byogurt\b/.test(n) || /\bkefir\b/.test(n) || /\bcottage\s+cheese\b/.test(n) || /low[\s-]?fat.*(cottage|yogurt)/.test(n)) return true;

              // Block ALL oils generically (must be near top)
              if (/\boil\b/.test(n)) return false;

              // kill category/taxonomy labels
              const bannedLabels = new Set([
                "fresh fruits","fresh vegetables","whole grains","legumes",
                "herbs","spices","nuts","raw nuts","unsalted nuts"
              ]);
              if (bannedLabels.has(n)) return false;

              // hard bans: meat/seafood (using word-boundary regex)
              if (MEAT_RE.test(n) || SEAFOOD_RE.test(n)) return false;

              // hard bans: savory ferments/condiments
              if (/(kimchi|sauerkraut|pickles?|miso|natto|vinegar)/.test(n)) return false;

              // hard bans: hard cheeses (yogurt/kefir/cottage already allowed above)
              if (/(blue cheese|cheddar|mozzarella|monterey jack|\bage[d]?\s*cheddar\b|\bcheese\b)/.test(n)) return false;

              // grains/legumes: allow only oats/oatmeal/wheat germ
              if (/(barley|bulgur|buckwheat|amaranth|millet|rice|quinoa|whole wheat|whole wheat bread|beans|lentils|peas|soybeans|edamame)/.test(n)) {
                return /(oats|oatmeal|wheat germ)/.test(n);
              }

              return true;
            }

            // Audit helper for testing filter behavior
            window.auditSmoothieFilter = async function (query) {
              const raw = await fetch(`/api/ingredient-search?q=${encodeURIComponent(query)}`).then(r => r.json());
              const removed = raw.filter(x => !isSmoothieAllowed(smoothieName(x))).map(x => smoothieName(x));
              const filtered = raw.filter(x => isSmoothieAllowed(smoothieName(x)));
              const leaks = filtered.filter(x => !isSmoothieAllowed(smoothieName(x))).map(x => smoothieName(x));

              console.log("REMOVED:", removed);
              console.log("LEAKS (should be empty):", leaks);
              console.log({ rawLen: raw.length, filteredLen: filtered.length });
              console.table(filtered.slice(0, 20));
              return { raw, filtered, removed, leaks };
            };

            // Self-test function (debug only)
            if (location.hostname === "localhost" || location.search.includes("debug=1")) {
              window.smoothieFilterSelfTest = async function() {
                const queries = ["oil","butter","mayo","beef","fish","chicken","pork","bacon","ham","clam","clams","shrimp","salmon","rice","quinoa","barley","beans","lentils","kimchi","sauerkraut","vinegar","miso","cheese"];
                for (const q of queries) {
                  const result = await window.auditSmoothieFilter(q);
                  const leaksLen = result.leaks.length;
                  console.log(`${q}, rawLen=${result.raw.length}, keptLen=${result.filtered.length}, leaksLen=${leaksLen}`);
                  if (leaksLen > 0) {
                    console.log(`LEAKS (should be empty) for "${q}":`);
                    console.table(result.leaks);
                  }
                }
              };
            }

            const filteredSuggestions = rawSuggestions.filter(item => isSmoothieAllowed(smoothieName(item)));
            if (location.hostname === "localhost" || location.search.includes("debug=1")) {
              window.__lastSmoothieSuggestionsFiltered = filteredSuggestions;
            }
            
            // Ensure coconut sugar and date syrup appear in search results if query matches
            // These are important sweeteners that should be easily findable
            const queryLower = query.toLowerCase();
            const prioritySweeteners = [];
            
            // Check if query matches "coconut" or "coco" - add coconut sugar if not already present
            if ((queryLower.includes('coco') || queryLower.includes('sugar')) && 
                !filteredSuggestions.some(s => s.name.toLowerCase() === 'coconut sugar')) {
              prioritySweeteners.push({
                name: 'coconut sugar',
                category: 'Energy Boost',
                subcategory: 'Natural Energy Foods'
              });
            }
            
            // Check if query matches "date" or "syrup" - add date syrup if not already present
            if ((queryLower.includes('date') || queryLower.includes('syrup')) && 
                !filteredSuggestions.some(s => s.name.toLowerCase() === 'date syrup')) {
              prioritySweeteners.push({
                name: 'date syrup',
                category: 'Energy Boost',
                subcategory: 'Natural Energy Foods'
              });
            }
            
            // Prepend priority sweeteners to filteredSuggestions (they appear first)
            let finalSuggestions = filteredSuggestions;
            finalSuggestions = [...prioritySweeteners, ...finalSuggestions];
            if (location.hostname === "localhost" || location.search.includes("debug=1")) {
              window.__lastSmoothieSuggestionsFinal = finalSuggestions;
            }
            
            if (finalSuggestions.length === 0) {
              smoothieIngredientSuggestionsEl.innerHTML = '';
              smoothieIngredientSuggestionsEl.style.display = 'none';
              return;
            }

            // Build suggestion items using DOM APIs and textContent to avoid XSS
            smoothieIngredientSuggestionsEl.innerHTML = '';
            const frag = document.createDocumentFragment();
            const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
            
            finalSuggestions.forEach(sug => {
              const item = document.createElement('div');
              item.className = 'suggestion-item';
              item.dataset.ingredient = sug.name;

              const inner = document.createElement('div');
              const nameDiv = document.createElement('div');
              nameDiv.className = 'suggestion-name';
              nameDiv.textContent = sug.name;

              // Check if ingredient has valid age-based portion
              const isValid = selectedAudience && hasValidAgePortion(sug.name, selectedAudience);
              if (!isValid && selectedAudience) {
                item.classList.add('suggestion-item-disabled');
                item.style.opacity = '0.5';
                item.style.cursor = 'not-allowed';
                const unavailableNote = document.createElement('div');
                unavailableNote.className = 'suggestion-unavailable';
                unavailableNote.style.cssText = 'font-size: 0.75rem; color: #64748b; margin-top: 2px; font-style: italic;';
                unavailableNote.textContent = 'Unavailable for this age group';
                inner.appendChild(unavailableNote);
              }

              inner.appendChild(nameDiv);
              item.appendChild(inner);
              frag.appendChild(item);
            });

            smoothieIngredientSuggestionsEl.appendChild(frag);
            smoothieIngredientSuggestionsEl.style.display = 'block';

            smoothieIngredientSuggestionsEl.querySelectorAll('.suggestion-item').forEach(item => {
              // Use a unique function name to avoid conflicts with other select handlers
              const selectSmoothieIngredient = () => {
                // Disable click handlers for invalid ingredients
                if (item.classList.contains('suggestion-item-disabled')) {
                  return false;
                }
                // Safety check: ensure we're in smoothie mode
                if (!smoothieIngredientSearchEl || !smoothieIngredientSuggestionsEl) {
                  return false;
                }
                
                const ingredient = item.dataset.ingredient;
                
                // Check if ingredient already added
                if (ingredientExists(ingredient)) {
                  setSmoothieStatus(`"${ingredient}" is already added`, true);
                  showToast(
                    `"${ingredient}" is already in your smoothie. You can adjust its quantity using the controls.`,
                    'warning',
                    4000
                  );
                  return false;
                }
                
                // Get current counts
                const { freshFruitCount, driedFruitCount } = countFruitTypes();
                
                // Validate age-based portion availability
                const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
                if (!selectedAudience) {
                  setSmoothieStatus('Please select a target audience first', true);
                  return false;
                }
                
                if (!hasValidAgePortion(ingredient, selectedAudience)) {
                  setSmoothieStatus('This ingredient isn\'t available for the selected age group yet.', true);
                  return false;
                }
                
                // Validate limits before adding
                if (isDriedFruit(ingredient)) {
                  if (driedFruitCount >= MAX_DRIED_FRUITS) {
                    setSmoothieStatus(`Maximum ${MAX_DRIED_FRUITS} dried fruit allowed. Please remove a dried fruit first.`, true);
                    showToast(
                      `You've reached the maximum limit of ${MAX_DRIED_FRUITS} dried fruit. Please remove a dried fruit before adding another one.`,
                      'error',
                      6000
                    );
                    return false;
                  }
                } else if (isFreshFruit(ingredient)) {
                  if (freshFruitCount >= MAX_FRESH_FRUITS) {
                    setSmoothieStatus(`Maximum ${MAX_FRESH_FRUITS} fresh fruits allowed. Please remove a fresh fruit first.`, true);
                    showToast(
                      `You've reached the maximum limit of ${MAX_FRESH_FRUITS} fresh fruits. Please remove a fresh fruit before adding another one.`,
                      'error',
                      6000
                    );
                    return false;
                  }
                }
                
                // Add ingredient with default quantity
                // All ingredients now use ml as the default unit
                const ageGroupKey = normalizeAgeGroupKey(selectedAudience);
                let defaultQuantity = 1;
                let defaultUnit = 'ml'; // Default to ml for all ingredients
                
                // Check if this is a sweetener first (before other classifications)
                if (isSweetener(ingredient)) {
                  // For sweeteners, use grams and calculate age-specific portion
                  defaultQuantity = 1;
                  defaultUnit = 'g';
                } else if (isDriedFruit(ingredient)) {
                  // Check if this is a dried fruit - use grams instead of ml
                  // For dried fruits, use grams
                  // Use age-specific serving if available, otherwise use a reasonable default
                  // Note: normalizeAgeGroupKey maps "girl-9-13" and "boy-9-13" to "child_9_13", "girl-14-18" to "teen_14_18", but we use specific keys for dried fruits
                  let targetKey = ageGroupKey;
                  if (selectedAudience === 'girl-9-13' && DRIED_FRUIT_SERVINGS.girl_9_13) {
                    targetKey = 'girl_9_13';
                  } else if (selectedAudience === 'boy-9-13' && DRIED_FRUIT_SERVINGS.boy_9_13) {
                    targetKey = 'boy_9_13';
                  } else if (selectedAudience === 'girl-14-18' && DRIED_FRUIT_SERVINGS.girl_14_18) {
                    targetKey = 'girl_14_18';
                  } else if (selectedAudience === 'boy-14-18' && DRIED_FRUIT_SERVINGS.boy_14_18) {
                    targetKey = 'boy_14_18';
                  } else if (selectedAudience === 'woman-19-30' && DRIED_FRUIT_SERVINGS.woman_19_30) {
                    targetKey = 'woman_19_30';
                  } else if (selectedAudience === 'man-19-30' && DRIED_FRUIT_SERVINGS.man_19_30) {
                    targetKey = 'man_19_30';
                  }
                  // For dried fruits, quantity should always be 1 (1 serving)
                  // The grams per serving will be calculated based on age group
                  defaultQuantity = 1;
                  defaultUnit = 'g';
                } else if (isPlantBasedMilk(ingredient)) {
                  // For vegan milks, set quantity to the actual ml value from getIngredientPortion
                  // This allows users to directly edit the ml amount in the quantity input
                  const portion = getIngredientPortion(ingredient, selectedAudience);
                  if (portion && portion.unit === 'ml' && portion.amount > 0) {
                    defaultQuantity = portion.amount;
                  } else {
                    // Fallback based on age group
                    defaultQuantity = (selectedAudience === 'child-4-6' || selectedAudience === 'child-7-8' || selectedAudience === 'child-4-8') ? 120 : 150;
                  }
                  defaultUnit = 'ml';
                } else if (isFreshFruit(ingredient)) {
                  // For fresh fruits, use grams
                  // The portion size (g) is determined by getIngredientPortion based on age group
                  defaultQuantity = 1;
                  defaultUnit = 'g';
                } else if (isVegetable(ingredient)) {
                  // For vegetables, use grams and calculate age-specific portion
                  defaultQuantity = 1;
                  defaultUnit = 'g';
                } else {
                  // For other ingredients, use grams as default
                  defaultQuantity = 1;
                  defaultUnit = 'g';
                }
                
                // Create ingredient object
                const ingredientObj = {
                  name: ingredient,
                  quantity: defaultQuantity,
                  unit: defaultUnit
                };
                
                // For vegetables, calculate and store age-specific portion grams
                if (isVegetable(ingredient)) {
                  const vegKey = normalizeVegetableKey(ingredient);
                  const defaultAdultGrams = 0; // Vegetables don't have adult defaults in our system
                  const portionGrams = getVegPortionGrams(selectedAudience, vegKey, defaultAdultGrams);
                  
                  if (portionGrams > 0) {
                    ingredientObj.portionGrams = portionGrams;
                    ingredientObj.gramsUsed = portionGrams; // Also store as gramsUsed for consistency
                    ingredientObj.portionSource = 'veg-age-specific';
                    
                    // Debug logging
                    console.log('[smoothie-add-veg] Storing portionGrams for ingredient:', {
                      ingredientName: ingredient,
                      normalizedKey: vegKey,
                      ageGroup: selectedAudience,
                      portionGrams: portionGrams
                    });
                  }
                }
                
                // For sweeteners, calculate and store age-specific portion grams
                if (isSweetener(ingredient)) {
                  const sweetenerGrams = getSweetenerPortionGrams(ingredient, selectedAudience);
                  
                  if (sweetenerGrams != null && sweetenerGrams > 0) {
                    ingredientObj.portionGrams = sweetenerGrams;
                    ingredientObj.gramsUsed = sweetenerGrams; // Also store as gramsUsed for consistency
                    ingredientObj.portionSource = 'sweetener-age-specific';
                    defaultUnit = 'g'; // Sweeteners use grams
                    
                    // Debug logging
                    console.log('[smoothie-add-sweetener] Storing portionGrams for ingredient:', {
                      ingredientName: ingredient,
                      normalizedKey: normalizeSweetenerKey(ingredient),
                      ageGroup: selectedAudience,
                      portionGrams: sweetenerGrams
                    });
                  }
                }
                
                smoothieIngredients.push(ingredientObj);
                // Clear search UI immediately after successful add
                clearSmoothieIngredientSearchUI();
                
                renderSmoothieIngredients();
                updateSmoothieRecipe();
                checkAndShowVeganMilkRecommendation();
                setSmoothieStatus(`Added "${ingredient}"`);
                
                // Show dried fruit tip if this is a dried fruit (only once per session)
                maybeShowDriedFruitTip(ingredient);
                
                // Return true to indicate successful add
                return true;
              };
              
              // Click handler: clearing happens automatically after push in selectSmoothieIngredient
              item.addEventListener('click', (e) => {
                e.stopPropagation();
                selectSmoothieIngredient();
              });
              
              // Double-click handler: clearing happens automatically after push in selectSmoothieIngredient
              item.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                selectSmoothieIngredient();
              });
              
              // Keyboard handler: clearing happens automatically after push in selectSmoothieIngredient
              item.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  e.stopPropagation();
                  selectSmoothieIngredient();
                }
              });
            });
          } catch (err) {
            console.error('Smoothie search error:', err);
          }
        }, 300);
      });
    }

    // Build smoothie
    if (buildSmoothieBtn) {
      buildSmoothieBtn.addEventListener('click', async () => {
        if (smoothieIngredients.length === 0) return;
        
        // Safety guard: Filter out ingredients with missing/zero portions
        const selectedAgeGroup = smoothieForEl ? smoothieForEl.value : '';
        if (!selectedAgeGroup) {
          setSmoothieStatus('Please select a target audience first', true);
          return;
        }
        
        const originalCount = smoothieIngredients.length;
        const validIngredients = [];
        const removedIngredients = [];
        
        smoothieIngredients.forEach(ing => {
          const ingredientName = typeof ing === 'string' ? ing : (ing && ing.name ? ing.name : '');
          if (!ingredientName) return;
          
          if (hasValidAgePortion(ingredientName, selectedAgeGroup)) {
            validIngredients.push(ing);
          } else {
            removedIngredients.push(ingredientName);
          }
        });
        
        // Update smoothieIngredients array if any were removed
        if (removedIngredients.length > 0) {
          smoothieIngredients.length = 0;
          smoothieIngredients.push(...validIngredients);
          renderSmoothieIngredients();
          
          if (validIngredients.length === 0) {
            setSmoothieStatus('No valid ingredients available for this age group. Please add ingredients.', true);
            return;
          } else {
            setSmoothieStatus(`Removed ${removedIngredients.length} ingredient${removedIngredients.length > 1 ? 's' : ''} unavailable for this age group.`, true);
          }
        }
        
        // Immediately show card and open modal on mobile
        const smoothieResultsCard = document.getElementById('smoothie-results-card');
        if (smoothieResultsCard) {
          smoothieResultsCard.classList.remove('pf-smoothie-hidden');
          
          // Show "Building smoothie..." message while waiting
          const smoothieResultsBody = document.getElementById('smoothie-results-body');
          if (smoothieResultsBody) {
            smoothieResultsBody.innerHTML = `
              <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 15px;">🥤</div>
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">Building smoothie...</div>
                <div style="font-size: 0.9rem;">Please wait while we calculate nutrition information</div>
              </div>
            `;
          }
          
          // Open modal on mobile/tablet
          if (pfIsMobileSmoothieMode()) {
            pfOpenSmoothieModal();
          }
        }
        
        setSmoothieStatus('Building smoothie...');
        try {
          // Helper function to extract ingredient name from "quantity unit name" format
          // The API database has ingredient names like "dried banana", not "18 g dried banana"
          function extractIngredientNameForAPI(ing) {
            if (typeof ing === 'string') {
              // Try to extract name from "quantity unit name" format
              const match = ing.match(/^\d+(?:\.\d+)?\s+(?:g|ml|cup|cups|oz|ounce|ounces|tbsp|tsp)\s+(.+)$/i);
              if (match) {
                return match[1].trim();
              }
              return ing.trim();
            }
            // For object format, just return the name
            return ing.name || '';
          }
          
          // Map ingredient names to database keys (for ingredients that might not match exactly)
          // IMPORTANT: Do NOT map fresh fruits to dried fruits - preserve fresh vs dried distinction
          function normalizeIngredientNameForAPI(ingredientName) {
            if (!ingredientName) return '';
            
            const name = ingredientName.toLowerCase().trim();
            
            // Check if this is a fresh fruit (doesn't contain "dried")
            const isFreshFruitName = !name.includes('dried');
            
            // Direct mappings for common variations
            // Note: Database has "raisins" (not "dried raisins"), but "dried cranberries", "dried strawberries", "dried mulberries"
            const nameMap = {
              'dried banana': 'dried banana',
              'dried_banana': 'dried banana',
              'dried bananas': 'dried banana',
              'dried apricot': 'dried apricots',
              'dried_apricot': 'dried apricots',
              'dried apricots': 'dried apricots',
              'dried fig': 'dried figs',
              'dried_fig': 'dried figs',
              'dried figs': 'dried figs',
              'dried date': 'dried dates',
              'dried_date': 'dried dates',
              'dried dates': 'dried dates',
              'dried raisin': 'raisins',
              'dried_raisin': 'raisins',
              'dried raisins': 'raisins',
              'dried prune': 'prunes',
              'dried_prune': 'prunes',
              'dried prunes': 'prunes',
              'prune': 'prunes',
              'raisin': 'raisins',
              'raisins': 'raisins',
              // Dried cranberries, strawberries, mulberries - ONLY map if name explicitly contains "dried"
              'dried cranberry': 'dried cranberries',
              'dried_cranberry': 'dried cranberries',
              'dried cranberries': 'dried cranberries',
              'dried strawberry': 'dried strawberries',
              'dried_strawberry': 'dried strawberries',
              'dried strawberries': 'dried strawberries',
              'dried mulberry': 'dried mulberries',
              'dried_mulberry': 'dried mulberries',
              'dried mulberries': 'dried mulberries'
            };
            
            // Check direct mapping first (only for explicitly dried fruits)
            if (nameMap[name]) {
              return nameMap[name];
            }
            
            // IMPORTANT: Do NOT map fresh fruits to dried fruits
            // If the name doesn't contain "dried", it's a fresh fruit - keep it as is
            // Only normalize plural/singular forms for fresh fruits
            if (isFreshFruitName) {
              // Normalize fresh fruit names (plural/singular) to match database keys
              // Database has: "strawberries", "blueberries", "blackberries" (and singular forms)
              const freshFruitMap = {
                // Berries - normalize to plural to match database
                'strawberry': 'strawberries',
                'strawberries': 'strawberries',
                'blueberry': 'blueberries',
                'blueberries': 'blueberries',
                'blackberry': 'blackberries',
                'blackberries': 'blackberries',
                'raspberry': 'raspberries',
                'raspberries': 'raspberries',
                'cranberry': 'cranberries',
                'cranberries': 'cranberries',
                'mulberry': 'mulberries',
                'mulberries': 'mulberries',
                'cherry': 'cherries',
                'cherries': 'cherries'
              };
              
              if (freshFruitMap[name]) {
                return freshFruitMap[name];
              }
              
              // For other fresh fruits, return as-is (normalized spaces/underscores)
              return name.replace(/_/g, ' ').replace(/\s+/g, ' ').trim();
            }
            
            // For dried fruits not in the map, normalize spaces/underscores
            return name.replace(/_/g, ' ').replace(/\s+/g, ' ').trim();
          }
          
          // Helper function to map display names to nutrition database lookup keys
          // This is ONLY for the nutrition API lookup, not for serving calculations or display
          function getNutritionLookupName(displayName) {
            if (!displayName) return '';
            
            const key = displayName.toLowerCase().trim();
            
            // Map plural berry names to singular for nutrition database lookup
            // Database has: "strawberry", "blueberry", "blackberry" (singular)
            // But we display/serve as: "strawberries", "blueberries", "blackberries" (plural)
            const NUTRITION_NAME_MAP = {
              // Berries: plural → singular (for nutrition lookup only)
              'strawberries': 'strawberry',
              'blueberries': 'blueberry',
              'blackberries': 'blackberry',
              'raspberries': 'raspberry',
              'cranberries': 'cranberry',
              'mulberries': 'mulberry',
              'cherries': 'cherry',
              
              // Keep singular as-is (already correct)
              'strawberry': 'strawberry',
              'blueberry': 'blueberry',
              'blackberry': 'blackberry',
              'raspberry': 'raspberry',
              'cranberry': 'cranberry',
              'mulberry': 'mulberry',
              'cherry': 'cherry',
              
              // Other fruits that might have plural/singular variations
              // Keep as-is if not in map (database likely has both forms)
            };
            
            // Return mapped name if exists, otherwise return original
            return NUTRITION_NAME_MAP[key] || key;
          }
          
          // Get current age group for portion calculations
          const selectedAgeGroup = smoothieForEl ? smoothieForEl.value : '';
          
          // Create smoothie ingredient objects using getIngredientPortion for all ingredients
          // This ensures vegetables use age-specific grams dynamically (not stored values)
          const smoothieIngredientData = smoothieIngredients.map(ing => {
            const ingredientName = extractIngredientNameForAPI(ing);
            const normalizedName = normalizeIngredientNameForAPI(ingredientName);
            const quantity = typeof ing === 'object' && ing.quantity ? ing.quantity : 1;
            
            // Use getIngredientPortion for ALL ingredients (vegetables, fruits, milks, etc.)
            // This is the single source of truth that respects age group
            const portion = getIngredientPortion(ingredientName, selectedAgeGroup);
            const portionAmount = portion.amount || 0;
            const portionUnit = portion.unit || 'g';
            
            // Calculate total grams: portionAmount * quantity
            // For liquids (ml), quantity is already the ml amount, not a multiplier
            const totalGrams = (portionUnit === 'ml') ? portionAmount : (portionAmount * quantity);
            
            // Map to nutrition database lookup key (plural → singular for berries)
            const nutritionLookupName = getNutritionLookupName(normalizedName);
            
            // Log for debugging - especially important for vegetables
            if (nutritionLookupName) {
              console.log('[smoothie-nutrition] Payload ingredient:', {
                name: ing.name || ingredientName,
                ageGroup: selectedAgeGroup,
                gramsUsed: portionAmount,
                quantity: quantity,
                totalGrams: totalGrams,
                unit: portionUnit
              });
            }
            
            return {
              name: ing.name || ingredientName,
              nutritionLookupName: nutritionLookupName,
              portionGrams: portionAmount,
              totalGrams: totalGrams,
              quantity: quantity,
              unit: portionUnit
            };
          });
          
          // Convert to format expected by API (just ingredient names)
          const formattedIngredients = smoothieIngredientData
            .map(item => item.nutritionLookupName)
            .filter(name => name); // Remove empty names
          
          const response = await apiFetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ingredients: formattedIngredients })
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          
          // Store the built smoothie data with portionGrams for display
          // Use smoothieIngredientData which has portionGrams already calculated
          currentSmoothie = {
            ingredients: JSON.parse(JSON.stringify(smoothieIngredientData)), // Deep copy with portionGrams
            nutritionData: data,
            ageGroup: selectedAgeGroup
          };
          hasBuiltSmoothie = true; // Mark that user has built a smoothie
          
          // Compute sweetener warning
          console.log("[sweetener-debug] ===== STARTING SWEETENER CHECK =====");
          const uiAgeGroup = smoothieForEl ? smoothieForEl.value : '';
          console.log("[sweetener-debug] uiAgeGroup from dropdown:", uiAgeGroup);
          console.log("[smoothieIngredientData sample]:", smoothieIngredientData && smoothieIngredientData.length > 0 ? smoothieIngredientData[0] : "empty");
          const totalSweetenerGrams = computeTotalSweetenerGrams(smoothieIngredientData);
          const maxTotalSweetenerGrams = getMaxTotalSweetenerGrams(uiAgeGroup);
          
          let sweetenerWarning = null;
          
          console.log("[sweetener-debug] comparison:", {
            uiAgeGroup: uiAgeGroup,
            totalSweetenerGrams: totalSweetenerGrams,
            maxTotalSweetenerGrams: maxTotalSweetenerGrams,
            exceedsLimit: maxTotalSweetenerGrams != null && totalSweetenerGrams > maxTotalSweetenerGrams,
            smoothieIngredientDataLength: smoothieIngredientData ? smoothieIngredientData.length : 0
          });
          
          if (maxTotalSweetenerGrams != null && totalSweetenerGrams > maxTotalSweetenerGrams) {
            if (uiAgeGroup === "child-4-8" ||
                uiAgeGroup === "girl-9-13" ||
                uiAgeGroup === "boy-9-13") {
              
              sweetenerWarning =
                "This smoothie uses more added sweeteners (honey, maple, date syrup, etc.) " +
                "than recommended for this age. For children, it's better to keep most " +
                "sweetness coming from fruit.";
              
            } else if (uiAgeGroup === "girl-14-18" || uiAgeGroup === "boy-14-18") {
              
              sweetenerWarning =
                "This smoothie has a high amount of added sweeteners. For teens, " +
                "prioritize fruit-based sweetness and keep honey/maple/date syrup additions small.";
              
            } else {
              // adults
              sweetenerWarning =
                "This smoothie contains a high amount of added sweeteners. " +
                "Consider reducing honey/maple/coconut sugar or date syrup, especially " +
                "for blood sugar or weight-related goals.";
            }
            
            // Optional: strengthen message for blood sugar/weight goals
            if (smoothieHealthGoalsEl && smoothieHealthGoalsEl.value) {
              const currentHealthGoal = smoothieHealthGoalsEl.value;
              if (isBloodSugarOrWeightGoal(currentHealthGoal)) {
                sweetenerWarning += " Because of your selected health goal, reducing added " +
                                    "sweeteners is especially important.";
              }
            }
          }
          
          // Store warning in currentSmoothie for display
          currentSmoothie.sweetenerWarning = sweetenerWarning;
          
          console.log("[sweetener-debug] stored warning in currentSmoothie:", {
            sweetenerWarning: sweetenerWarning,
            currentSmoothie: currentSmoothie
          });
          
          // Compute blood sugar goal tip for adults with Diabetes–Blood Sugar goal
          const selectedHealthGoal = smoothieHealthGoalsEl ? smoothieHealthGoalsEl.value : '';
          let bloodSugarGoalTip = '';
          if (isAdultAgeGroup(uiAgeGroup) && isDiabetesBloodSugarGoal(selectedHealthGoal)) {
            bloodSugarGoalTip = "We're here to help you manage your blood sugar with confidence.<br><br>" +
                               "You've chosen <strong>Diabetes–Blood Sugar</strong> management, and we take that seriously. " +
                               "Every ingredient we recommend will help keep your glucose levels steady.<br><br>" +
                               "<strong>Here's what we'll help you avoid:</strong><br>" +
                               "❌ Added sweeteners (honey, maple syrup, date syrup—they spike blood sugar)<br>" +
                               "❌ Large fruit portions (even natural sugar affects glucose)<br>" +
                               "❌ High-sugar fruits (tropical fruits like mango, pineapple)<br>" +
                               "❌ Dried fruits (concentrated sugar bombs)<br><br>" +
                               "<strong>What actually helps stabilize blood sugar:</strong><br><br>" +
                               "🎯 Berries (lowest glycemic impact)<br>" +
                               "🎯 Protein (Greek yogurt, unsweetened soy milk)<br>" +
                               "🎯 Healthy fats (avocado, chia seeds)<br>" +
                               "🎯 Leafy greens (spinach, kale—fiber is your friend)<br>" +
                               "🎯 Small portions (½ cup fruit max)<br><br>" +
                               "We'll guide every choice to support stable glucose levels. You're in good hands. 💚";
          }
          currentSmoothie.bloodSugarGoalTip = bloodSugarGoalTip;
          
          // Compute weight management tip for all age groups with Weight Management goal
          const weightManagementTip = getWeightManagementTip(uiAgeGroup, selectedHealthGoal);
          currentSmoothie.weightManagementTip = weightManagementTip;
          
          // Compute blood pressure tip for all age groups with Blood Pressure goal
          const bloodPressureTip = getBloodPressureTip(selectedHealthGoal);
          currentSmoothie.bloodPressureTip = bloodPressureTip;
          
          // Display smoothie nutrition using the same display function
          displaySmoothieResults(data);
          setSmoothieStatus('Smoothie built successfully');

          // Clear ingredient selection after building (restore original behavior)
          smoothieIngredients = [];
          renderSmoothieIngredients();
          updateSmoothieRecipe();
          updateSmoothieRecipe();
          smoothieIngredientSearchEl.value = '';
          smoothieIngredientSuggestionsEl.innerHTML = '';
          smoothieIngredientSuggestionsEl.style.display = 'none';
          
          // Store the smoothie name, audience, and timing before clearing fields
          const currentSmoothieName = smoothieNameEl ? smoothieNameEl.value : '';
          
          // Get audience display text before clearing
          let audienceDisplayText = '';
          if (smoothieForEl && smoothieForEl.value) {
            const audienceOption = smoothieForEl.options[smoothieForEl.selectedIndex];
            audienceDisplayText = audienceOption ? audienceOption.textContent : smoothieForEl.value;
          }
          
          // Get timing display text before clearing
          let timingDisplayText = '';
          if (smoothieTimingEl && smoothieTimingEl.value) {
            const timingOption = smoothieTimingEl.options[smoothieTimingEl.selectedIndex];
            timingDisplayText = timingOption ? timingOption.textContent : smoothieTimingEl.value;
          }
          
          // Clear all dropdowns including health goal
          if (smoothieForEl) smoothieForEl.value = '';
          if (smoothieTimingEl) smoothieTimingEl.value = '';
          if (smoothieHealthGoalsEl) smoothieHealthGoalsEl.value = '';
          
          // Keep the smoothie name bar visible with the name that was just built
          // The name is already stored in smoothieNameEl, so we keep it displayed
          if (smoothieNameBarEl && currentSmoothieName) {
            smoothieNameBarEl.style.display = 'block';
            // Ensure the display shows the current name
            if (smoothieNameDisplayEl) {
              smoothieNameDisplayEl.textContent = currentSmoothieName;
            }
            
            // Update audience and timing displays with stored text
            const audienceDisplayEl = document.getElementById('smoothie-audience-display');
            const audienceValueEl = document.getElementById('smoothie-audience-value');
            if (audienceDisplayText && audienceDisplayEl && audienceValueEl) {
              audienceValueEl.textContent = audienceDisplayText;
              audienceDisplayEl.style.display = 'flex';
            } else {
              hideSmoothieAudienceDisplay();
            }
            
            const timingDisplayEl = document.getElementById('smoothie-timing-display');
            const timingValueEl = document.getElementById('smoothie-timing-value');
            if (timingDisplayText && timingDisplayEl && timingValueEl) {
              timingValueEl.textContent = timingDisplayText;
              timingDisplayEl.style.display = 'flex';
            } else {
              hideSmoothieTimingDisplay();
            }
          }
          
          // Reset previous health goal tracking for next change
          previousHealthGoal = null;
          
        
        } catch (err) {
          console.error('Build smoothie error:', err);
          setSmoothieStatus('Failed to build smoothie', true);
          
          // Keep modal open on mobile and show error message
          const smoothieResultsBody = document.getElementById('smoothie-results-body');
          if (smoothieResultsBody) {
            smoothieResultsBody.innerHTML = `
              <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 15px;">⚠️</div>
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--danger);">Error Building Smoothie</div>
                <div style="font-size: 0.9rem;">${err.message || 'Failed to build smoothie. Please try again.'}</div>
              </div>
            `;
          }
        }
      });
    }

    // Function to divide nutrients by servings
    function divideNutrients(nutrients, servings) {
      if (!servings || servings <= 0) servings = 1;
      return {
        calories: (nutrients.calories || 0) / servings,
        protein: (nutrients.protein || 0) / servings,
        carbs: (nutrients.carbs || 0) / servings,
        fat: (nutrients.fat || 0) / servings,
        fiber: (nutrients.fiber || 0) / servings,
        sugar: (nutrients.sugar || 0) / servings,
        sodium: (nutrients.sodium || 0) / servings
      };
    }
    
    // Function to render smoothie nutrition metrics
    // Returns a DOM node (no HTML string) to avoid HTML injection sinks
    function renderSmoothieNutritionMetrics(nutritionData, isPerServing = false) {
      const grid = document.createElement('div');
      grid.className = 'nutrition-grid';
      grid.style.gap = '8px';
      grid.style.margin = '0';
      grid.style.padding = '0';
      grid.style.display = 'flex';
      grid.style.flexDirection = 'column';
      grid.style.flexWrap = 'nowrap';
      grid.style.overflowY = 'auto';
      grid.style.width = '100%';

      function addTile({ className, borderColor, icon, label, value, unit }) {
        const tile = document.createElement('div');
        tile.className = `nutrition-tile ${className} smoothie-metrics-row`;
        tile.style.background = 'white';
        tile.style.borderLeft = `2px solid ${borderColor}`;
        tile.style.boxShadow = '0 1px 1px rgba(0, 0, 0, 0.05)';
        tile.style.padding = '8px 12px';
        tile.style.display = 'flex';
        tile.style.flexDirection = 'row';
        tile.style.alignItems = 'center';
        tile.style.justifyContent = 'space-between';
        tile.style.gap = '12px';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.flexDirection = 'row';
        left.style.alignItems = 'center';
        left.style.gap = '10px';
        left.style.flex = '1';

        const iconSpan = document.createElement('span');
        iconSpan.className = 'icon';
        iconSpan.style.fontSize = '1rem';
        iconSpan.style.lineHeight = '1.2';
        iconSpan.style.margin = '0';
        iconSpan.textContent = icon;

        const labelDiv = document.createElement('div');
        labelDiv.className = 'label';
        labelDiv.style.fontSize = '0.7rem';
        labelDiv.style.fontWeight = '600';
        labelDiv.style.color = '#64748b';
        labelDiv.style.textTransform = 'uppercase';
        labelDiv.style.letterSpacing = '0.05em';
        labelDiv.style.margin = '0';
        labelDiv.style.lineHeight = '1.2';
        labelDiv.textContent = label;

        left.appendChild(iconSpan);
        left.appendChild(labelDiv);

        const valueDiv = document.createElement('div');
        valueDiv.className = 'value';
        valueDiv.style.fontSize = '0.95rem';
        valueDiv.style.fontWeight = '700';
        valueDiv.style.lineHeight = '1.2';
        valueDiv.style.color = borderColor;

        const valueText = document.createTextNode(typeof value === 'number' ? value.toFixed(1) : String(value));
        valueDiv.appendChild(valueText);

        const unitSpan = document.createElement('span');
        unitSpan.className = 'unit';
        unitSpan.style.fontSize = '0.6rem';
        unitSpan.style.color = '#94a3b8';
        unitSpan.style.fontWeight = '500';
        unitSpan.style.marginLeft = '3px';
        unitSpan.textContent = unit;

        valueDiv.appendChild(unitSpan);

        tile.appendChild(left);
        tile.appendChild(valueDiv);

        grid.appendChild(tile);
      }

      addTile({
        className: 'calories',
        borderColor: '#3b82f6',
        icon: '🔥',
        label: 'CALORIES',
        value: Number(nutritionData.calories || 0),
        unit: 'kcal',
      });

      addTile({
        className: 'protein',
        borderColor: '#10b981',
        icon: '💪',
        label: 'PROTEIN',
        value: Number(nutritionData.protein || 0),
        unit: 'g',
      });

      addTile({
        className: 'carbs',
        borderColor: '#f59e0b',
        icon: '🌾',
        label: 'CARBS',
        value: Number(nutritionData.carbs || 0),
        unit: 'g',
      });

      addTile({
        className: 'fat',
        borderColor: '#ef4444',
        icon: '🥑',
        label: 'FAT',
        value: Number(nutritionData.fat || 0),
        unit: 'g',
      });

      addTile({
        className: 'fiber',
        borderColor: '#0EA5A4',
        icon: '🌿',
        label: 'FIBER',
        value: Number(nutritionData.fiber || 0),
        unit: 'g',
      });

      addTile({
        className: 'sugar',
        borderColor: '#ec4899',
        icon: '🍬',
        label: 'SUGAR',
        value: Number(nutritionData.sugar || 0),
        unit: 'g',
      });

      addTile({
        className: 'sodium',
        borderColor: '#06b6d4',
        icon: '🧂',
        label: 'SODIUM',
        value: Number(nutritionData.sodium || 0),
        unit: 'mg',
      });

      return grid;
    }

    function displaySmoothieResults(data) {
      // Only display if user has explicitly built a smoothie
      if (!hasBuiltSmoothie || !currentSmoothie) {
        // Show placeholder if no smoothie has been built
        if (smoothieResultsBodyEl) {
          smoothieResultsBodyEl.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
              <div style="font-size: 3rem; margin-bottom: 15px;">🥤</div>
              <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No Smoothie Built Yet</div>
              <div style="font-size: 0.9rem;">Add ingredients and click "Build Smoothie" to see nutrition information</div>
            </div>
          `;
        }
        return;
      }
      
      // Store current smoothie data for recalculation (for servings tab)
      currentSmoothieData = data;
      
      // Use the same nutrition display logic but render to smoothie results
      const ingredients = data.ingredients || [];
      const totalNutrition = data.total_nutrition || {};
      
      if (!ingredients || ingredients.length === 0) {
        smoothieResultsBodyEl.innerHTML = '<div class="empty-state">No nutrition data available</div>';
        return;
      }
      
      // Check for ingredients with missing nutrition data and log warnings
      // Special handling for berries: treat all-zero responses as "not found"
      ingredients.forEach(ing => {
        const ingredientName = ing.ingredient || ing.name || 'Unknown';
        const ingredientNameLower = ingredientName.toLowerCase();
        
        // Check if nutrition data is valid (not all zeros)
        const hasNutrition = (ing.calories !== undefined && ing.calories !== null && ing.calories > 0) ||
                           (ing.protein !== undefined && ing.protein !== null && ing.protein > 0) ||
                           (ing.carbs !== undefined && ing.carbs !== null && ing.carbs > 0) ||
                           (ing.fat !== undefined && ing.fat !== null && ing.fat > 0);
        
        // Special handling for berries: if all values are 0, treat as "not found"
        const isBerry = ['strawberries', 'blueberries', 'blackberries', 'raspberries', 'cranberries', 
                        'strawberry', 'blueberry', 'blackberry', 'raspberry', 'cranberry'].includes(ingredientNameLower);
        const allZeros = (ing.calories === 0 || ing.calories === null || ing.calories === undefined) &&
                        (ing.protein === 0 || ing.protein === null || ing.protein === undefined) &&
                        (ing.carbs === 0 || ing.carbs === null || ing.carbs === undefined) &&
                        (ing.fat === 0 || ing.fat === null || ing.fat === undefined);
        
        if (!hasNutrition || (isBerry && allZeros)) {
          console.warn('[smoothie-nutrition] No nutrition profile found for ingredient:', ingredientName, 'API returned:', ing);
        }
      });

      // Calculate total smoothie weight from all ingredients (sum of all ingredient gram amounts)
      // This represents the total recipe yield, not a serving size
      totalSmoothieWeightGrams = 0;
      
      // Get selected age group for child serving size logic
      const selectedAgeGroup = smoothieForEl ? smoothieForEl.value : '';
      
      // Get original ingredient quantities from currentSmoothie (if available)
      // This allows us to multiply child serving grams by quantity
      const originalIngredients = currentSmoothie && currentSmoothie.ingredients ? currentSmoothie.ingredients : [];
      
      ingredients.forEach(ing => {
        const ingredientNameFromAPI = ing.ingredient || ing.name || '';
        
        // Get quantity and unit from original ingredients array (match by name)
        // IMPORTANT: Use the ORIGINAL ingredient name to preserve fresh vs dried distinction
        // The API might return a different name (e.g., "dried strawberries" instead of "strawberry")
        // but we need to use the original name to get the correct portion size
        let quantity = 1; // Default quantity
        let unit = 'cup'; // Default unit
        let originalIngredientName = ingredientNameFromAPI; // Default to API name if no match
        
        if (originalIngredients && originalIngredients.length > 0) {
          // Try to find the original ingredient by matching the API name
          // But also try fuzzy matching for cases where API normalized the name
          const originalIng = originalIngredients.find(orig => {
            const origName = typeof orig === 'string' ? orig : orig.name;
            const origNameLower = origName.toLowerCase().trim();
            const apiNameLower = ingredientNameFromAPI.toLowerCase().trim();
            
            // Exact match
            if (origNameLower === apiNameLower) {
              return true;
            }
            
            // Fuzzy match: check if one contains the other (for plural/singular variations)
            // But preserve fresh vs dried distinction
            const origIsDried = origNameLower.includes('dried');
            const apiIsDried = apiNameLower.includes('dried');
            
            // Only match if both are fresh or both are dried
            if (origIsDried === apiIsDried) {
              // Remove "dried" prefix for comparison
              const origBase = origNameLower.replace(/^dried[\s_]+/, '');
              const apiBase = apiNameLower.replace(/^dried[\s_]+/, '');
              
              // Check if base names match (handles plural/singular)
              if (origBase === apiBase || 
                  origBase + 's' === apiBase || 
                  origBase === apiBase + 's' ||
                  origBase + 'ies' === apiBase ||
                  origBase === apiBase + 'ies') {
                return true;
              }
            }
            
            return false;
          });
          
          if (originalIng) {
            originalIngredientName = typeof originalIng === 'string' ? originalIng : originalIng.name;
            if (typeof originalIng === 'object') {
              if (originalIng.quantity) {
                quantity = originalIng.quantity;
              }
              if (originalIng.unit) {
                unit = originalIng.unit;
              }
            }
          }
        }
        
        // Get API serving grams (adult/base value) - this is what the API used to calculate nutrition
        let apiServingGrams = null;
        if (ing.serving_size_g !== undefined && ing.serving_size_g !== null) {
          apiServingGrams = parseFloat(ing.serving_size_g);
        } else if (ing.serving_size) {
          // Fallback: Try to extract numeric value from serving_size string
          const servingStr = String(ing.serving_size).toLowerCase();
          const gramMatch = servingStr.match(/(\d+(?:\.\d+)?)\s*g(?:rams?)?/);
          const mlMatch = servingStr.match(/(\d+(?:\.\d+)?)\s*ml/);
          
          if (gramMatch) {
            apiServingGrams = parseFloat(gramMatch[1]);
          } else if (mlMatch) {
            // Approximate: 1ml ≈ 1g for liquids
            apiServingGrams = parseFloat(mlMatch[1]);
          } else {
            // Try to extract any number and assume grams
            const numMatch = servingStr.match(/(\d+(?:\.\d+)?)/);
            if (numMatch) {
              apiServingGrams = parseFloat(numMatch[1]);
            }
          }
        }
        
        // Use getPortionGrams to get the ACTUAL portion size we're using
        // IMPORTANT: Use the ORIGINAL ingredient name (not API response name) to preserve fresh vs dried
        // The original name has the correct fresh/dried distinction from when the user added it
        const ingredientNameForPortion = originalIngredientName;
        const isVeganMilk = isPlantBasedMilk(ingredientNameForPortion);
        const isDried = isDriedFruit(ingredientNameForPortion);
        const isFresh = isFreshFruit(ingredientNameForPortion);
        const isVeg = isVegetable(ingredientNameForPortion);
        let actualPortionAmount;
        let actualPortionUnit;
        
        // For vegetables, use getIngredientPortion to get age-specific grams dynamically
        if (isVeg) {
          const portion = getIngredientPortion(ingredientNameForPortion, selectedAgeGroup);
          actualPortionAmount = portion.amount || 0;
          actualPortionUnit = 'g';
        } else if (isVeganMilk) {
          // For vegan milks, use getIngredientPortion (handles ml)
          const portion = getIngredientPortion(ingredientNameForPortion, selectedAgeGroup);
          actualPortionAmount = portion.amount || 0;
          actualPortionUnit = 'ml';
        } else if (isDried || isFresh) {
          // For fruits (fresh or dried), use getPortionGrams
          // Use the ORIGINAL ingredient name to preserve fresh vs dried distinction
          let fruitKey = ingredientNameForPortion.toLowerCase().trim();
          if (fruitKey.startsWith('dried_')) {
            fruitKey = fruitKey.replace(/^dried_/, '');
          } else if (fruitKey.startsWith('dried ')) {
            fruitKey = fruitKey.replace(/^dried /, '');
          }
          
          // Get default adult grams as fallback
          let defaultAdultGrams = isDried ? 30 : 150;
          if (isFresh) {
            const normalizedKey = normalizeIngredientNameForServing(fruitKey);
            if (normalizedKey && recommendedServingGrams.adult_19_30 && recommendedServingGrams.adult_19_30[normalizedKey]) {
              defaultAdultGrams = recommendedServingGrams.adult_19_30[normalizedKey];
            }
          }
          
          // Normalize the fruit key to match the structure (e.g., "strawberry" → "strawberries")
          const normalizedFruitKey = normalizeIngredientNameForServing(fruitKey) || fruitKey;
          
          actualPortionAmount = getPortionGrams({
            ageGroup: selectedAgeGroup,
            ingredientKey: normalizedFruitKey,
            isDried: isDried,
            defaultAdultGrams: defaultAdultGrams
          });
          actualPortionUnit = 'g';
        } else {
          // Unknown ingredient type - use getIngredientPortion as fallback
          const portion = getIngredientPortion(ingredientNameForPortion, selectedAgeGroup);
          actualPortionAmount = portion.amount || 0;
          actualPortionUnit = portion.unit || 'g';
        }
        
        // Calculate actual serving grams based on quantity and portion
        // Formula: totalGrams = baseServingGrams * quantity
        // Do NOT multiply grams by ml or by any UI constant
        let actualServingGrams;
        if (actualPortionUnit === 'ml' || isVeganMilk) {
          // For liquids (vegan milks), the quantity IS the ml amount (not a multiplier)
          // So we use quantity directly, not multiplied by portion amount
          if (unit === 'ml' && quantity > 0) {
            // Quantity is already in ml, use it directly
            actualServingGrams = quantity; // 1ml ≈ 1g for liquids
          } else {
            // Fallback: use portion amount if quantity is not in ml
            actualServingGrams = actualPortionAmount;
          }
        } else {
          // For solids (grams), quantity is a multiplier
          // Formula: totalGrams = baseServingGrams * quantity
          actualServingGrams = actualPortionAmount * quantity;
        }
        
        // Scale nutrition values from API based on ratio of actual portion to API serving size
        if (apiServingGrams && apiServingGrams > 0 && actualServingGrams > 0) {
          const scaleFactor = actualServingGrams / apiServingGrams;
          
          // Scale all nutrition values
          ing.calories = (ing.calories || 0) * scaleFactor;
          ing.protein = (ing.protein || 0) * scaleFactor;
          ing.carbs = (ing.carbs || 0) * scaleFactor;
          ing.fat = (ing.fat || 0) * scaleFactor;
          ing.fiber = (ing.fiber || 0) * scaleFactor;
          ing.sugar = (ing.sugar || 0) * scaleFactor;
          ing.sodium = (ing.sodium || 0) * scaleFactor;
          
          // Update serving size display
          ing.serving_size_g = actualServingGrams;
          if (actualPortionUnit === 'ml') {
            ing.serving_size = `${Math.round(actualServingGrams)}ml`;
          } else {
            ing.serving_size = `${Math.round(actualServingGrams)}g`;
          }
        }
        
        // Use actual serving grams for total weight calculation
        totalSmoothieWeightGrams += actualServingGrams;
      });

      // Recalculate total nutrition from scaled ingredient values
      // (since we scaled individual ingredients, we need to sum them up)
      const totalNutrients = {
        calories: 0,
        protein: 0,
        carbs: 0,
        fat: 0,
        fiber: 0,
        sugar: 0,
        sodium: 0
      };
      
      // Sum up all scaled ingredient nutrition values
      ingredients.forEach(ing => {
        totalNutrients.calories += ing.calories || 0;
        totalNutrients.protein += ing.protein || 0;
        totalNutrients.carbs += ing.carbs || 0;
        totalNutrients.fat += ing.fat || 0;
        totalNutrients.fiber += ing.fiber || 0;
        totalNutrients.sugar += ing.sugar || 0;
        totalNutrients.sodium += ing.sodium || 0;
      });

      // ✅ Single source of truth for BOTH Whole + Per-serving
      lastSmoothieTotals = {
        totalNutrients: { ...totalNutrients },
        totalWeightG: totalSmoothieWeightGrams
      };

      // Also sync currentSmoothieData so any other code stays consistent
      currentSmoothieData = currentSmoothieData || {};
      currentSmoothieData.total_nutrition = { ...totalNutrients };
      currentSmoothieData.total_smoothie_weight_grams = totalSmoothieWeightGrams;

      const sumIngredientCalories = ingredients.reduce((a, ing) => a + (ing.calories || 0), 0);

      console.log('[A] displaySmoothieResults totalNutrients', {
        totalCalories: totalNutrients.calories,
        sumIngredientCalories,
        totalSmoothieWeightGrams
      });

      console.log('[B-before-sync] currentSmoothieData.total_nutrition', {
        totalCalories: currentSmoothieData?.total_nutrition?.calories,
        totalSmoothieWeightGrams: currentSmoothieData?.total_smoothie_weight_grams
      });

      smoothieComputedTotals = totalNutrients;

      // Helper function to format weight in grams and ounces
      // Returns { gramsDisplay, ouncesDisplay }
      function formatWeight(grams) {
        if (!grams || grams <= 0) {
          return { gramsDisplay: '0g', ouncesDisplay: '0 oz' };
        }
        
        // Convert grams to ounces (1 oz = 28.3495 grams)
        const ounces = grams / 28.3495;
        
        // Format grams
        let gramsDisplay = '';
        if (grams >= 1000) {
          gramsDisplay = `${(grams / 1000).toFixed(2)} kg`;
        } else if (grams >= 100) {
          gramsDisplay = `${Math.round(grams)}g`;
        } else {
          gramsDisplay = `${grams.toFixed(1)}g`;
        }
        
        // Format ounces
        let ouncesDisplay = '';
        if (ounces >= 16) {
          // Show in pounds and ounces if >= 16 oz
          const pounds = Math.floor(ounces / 16);
          const remainingOz = ounces % 16;
          if (remainingOz > 0) {
            ouncesDisplay = `${pounds} lb ${remainingOz.toFixed(1)} oz`;
          } else {
            ouncesDisplay = `${pounds} lb`;
          }
        } else if (ounces >= 1) {
          ouncesDisplay = `${ounces.toFixed(1)} oz`;
        } else {
          ouncesDisplay = `${ounces.toFixed(2)} oz`;
        }
        
        return { gramsDisplay, ouncesDisplay };
      }
      
      // Format total smoothie yield (total weight)
      const totalWeightFormatted = formatWeight(totalSmoothieWeightGrams);
      
      // ============================================
      // RECOMMENDED SERVING ENGINE INTEGRATION
      // ============================================
      // After total smoothie weight is calculated, compute recommended serving
      // based on target audience and health goal
      const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
      const selectedHealthGoal = smoothieHealthGoalsEl ? smoothieHealthGoalsEl.value : '';
      
      // Get the health goal name from the dropdown value
      // The dropdown value is a slug (e.g., "weight-loss"), we need the category label
      let healthGoalName = '';
      if (selectedHealthGoal && categories) {
        const categoryObj = categories.find(cat => {
          const catValue = typeof cat === 'object' && 'value' in cat ? cat.value : cat;
          return catValue.toLowerCase().replace(/\s+/g, '-') === selectedHealthGoal;
        });
        if (categoryObj) {
          // Use label if available, otherwise use value
          healthGoalName = typeof categoryObj === 'object' && 'label' in categoryObj ? categoryObj.label : categoryObj;
        } else {
          // Fallback: reconstruct name from normalized value
          healthGoalName = selectedHealthGoal.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
      }
      
      // Compute recommended serving if we have audience (health goal optional)
      if (selectedAudience && totalSmoothieWeightGrams > 0) {
        const recommended = computeRecommendedServing(
          selectedAudience,
          healthGoalName || null,
          totalSmoothieWeightGrams
        );

        recommendedPerServingG = recommended.perServingG;
        recommendedServings = recommended.servings;
        
        smoothieWeightServings = recommendedServings;

        smoothieServingMode = 'recommended';
        smoothieServings = Math.max(1, Math.floor(totalSmoothieWeightGrams / recommendedPerServingG));
      } else {
        // Fallback only when NO audience is selected
        recommendedPerServingG = totalSmoothieWeightGrams / smoothieWeightServings;
        recommendedServings = smoothieWeightServings;
        smoothieServingMode = 'recommended';
        smoothieServings = Math.max(1, Math.floor(totalSmoothieWeightGrams / recommendedPerServingG));
      }
      
      // Calculate per serving nutrients using recommended serving ratio
      // This ensures all per-serving nutrient cards use the recommended serving size
      // Formula: perServingNutrients = totalNutrients * (recommendedPerServingG / totalWeightGrams)
      let perServingNutrients;
      if (!manualServingsOverride && recommendedPerServingG > 0 && totalSmoothieWeightGrams > 0) {
        const servingRatio = recommendedPerServingG / totalSmoothieWeightGrams;
        perServingNutrients = {
          calories: (totalNutrients.calories || 0) * servingRatio,
          protein: (totalNutrients.protein || 0) * servingRatio,
          carbs: (totalNutrients.carbs || 0) * servingRatio,
          fat: (totalNutrients.fat || 0) * servingRatio,
          fiber: (totalNutrients.fiber || 0) * servingRatio,
          sugar: (totalNutrients.sugar || 0) * servingRatio,
          sodium: (totalNutrients.sodium || 0) * servingRatio
        };
      } else {
        perServingNutrients = divideNutrients(totalNutrients, smoothieServings);
      }

      
      // Calculate per serving weight using recommended per-serving grams
      // This ensures the per-serving display uses the recommended serving size
      const perServingWeightGrams = recommendedPerServingG;
      const perServingWeightFormatted = formatWeight(perServingWeightGrams);

      const hasUSDA = ingredients.some(ing => ing.is_usda);
      
      // Build ingredients list for display
      // IMPORTANT: Use age-specific serving grams for all age groups
      // Reuse selectedAgeGroup that was already declared above
      const ingredientsList = ingredients.map(ing => {
        const name = ing.ingredient || 'Unknown';
        
        // Get base serving grams from API response
        let baseGrams = null;
        if (ing.serving_size_g !== undefined && ing.serving_size_g !== null) {
          baseGrams = parseFloat(ing.serving_size_g);
        } else if (ing.serving_size) {
          // Parse from serving_size string (e.g., "182g (1 medium)")
          const servingStr = String(ing.serving_size).toLowerCase();
          const gramMatch = servingStr.match(/(\d+(?:\.\d+)?)\s*g(?:rams?)?/);
          if (gramMatch) {
            baseGrams = parseFloat(gramMatch[1]);
          }
        }
        
        // Get quantity from original ingredients array (match by name)
        let quantity = 1; // Default quantity
        if (originalIngredients && originalIngredients.length > 0) {
          const originalIng = originalIngredients.find(orig => {
            const origName = typeof orig === 'string' ? orig : orig.name;
            return origName && origName.toLowerCase().trim() === name.toLowerCase().trim();
          });
          if (originalIng && typeof originalIng === 'object' && originalIng.quantity) {
            quantity = originalIng.quantity;
          }
        }
        
        // Get effective serving grams using the unified getPortionGrams function
        // IMPORTANT: Check vegetables FIRST before fruits, since avocado is both
        // Vegetables must use getVegPortionGrams, not getPortionGrams (fruit logic)
        const isVeg = isVegetable(name);
        const isDried = isDriedFruit(name);
        const isFresh = isFreshFruit(name);
        const isVegan = isPlantBasedMilk(name);
        let effectiveGrams = 0;
        
        // SINGLE SOURCE OF TRUTH: Use getSmoothiePortion() for all ingredients
        const portion = getSmoothiePortion(name, selectedAgeGroup);
          effectiveGrams = portion.amount || 0;
        const isMissing = portion.isMissing;
        const portionUnit = portion.unit || 'g';
        
        // SINGLE SOURCE OF TRUTH: For liquids, quantity IS the total amount (ml)
        // For solids, quantity is a multiplier (portion × quantity = total)
        const isLiquid = isVegan && portionUnit === 'ml';
        const totalGrams = isLiquid ? quantity : (effectiveGrams * quantity);
        
        // Debug safeguard: prevent multiplication for liquids
        if (isLiquid && totalGrams !== quantity) {
          console.warn('[displaySmoothieResults] Liquid totalGrams bug detected!', {
            ingredient: name,
            quantity,
            effectiveGrams,
            calculated: effectiveGrams * quantity,
            corrected: quantity
          });
        }
        
        // Format serving display string
        let serving = '';
        if (isMissing || effectiveGrams <= 0) {
          // If portion is missing, show only 0g missing message (no API fallback)
          const ageGroupOption = smoothieForEl ? smoothieForEl.options[smoothieForEl.selectedIndex] : null;
          const ageGroupLabel = ageGroupOption ? ageGroupOption.textContent : selectedAgeGroup;
          serving = `0g — missing portion for ${ageGroupLabel}`;
        } else if (effectiveGrams > 0 || isLiquid) {
          // Use the portion from getSmoothiePortion() - this is the single source of truth
          // Do NOT use API serving_size when we have a valid age-based portion
          
          if (isLiquid) {
            // For liquids: quantity IS the total amount (ml), not a multiplier
            // Show: "160ml" or "160ml (default: 150ml for <ageGroup>)" format
            const displayMl = quantity;
            const defaultMl = effectiveGrams > 0 ? effectiveGrams : (selectedAgeGroup === 'child-4-8' ? 120 : 150);
            const ageGroupOption = smoothieForEl ? smoothieForEl.options[smoothieForEl.selectedIndex] : null;
            const ageGroupLabel = ageGroupOption ? ageGroupOption.textContent : selectedAgeGroup;
            
            if (displayMl === defaultMl) {
              serving = `${Math.round(displayMl)}ml`;
            } else {
              serving = `${Math.round(displayMl)}ml (default: ${Math.round(defaultMl)}ml for ${ageGroupLabel})`;
            }
          } else {
            // For solids: quantity is a multiplier
            if (quantity > 1) {
              serving = `${effectiveGrams}g × ${quantity} = ${totalGrams}g`;
            } else {
              serving = `${totalGrams}g`;
            }
            
            // Add source indicator for micro-dose ingredients (optional, for clarity)
            if (portion.source === 'microDoseDefault') {
              serving += ' (micro-dose)';
            }
          }
        } else {
          serving = ing.serving_size || 'N/A';
          if (serving && typeof serving === 'string') {
            serving = serving.replace(/\s*\(?USDA\s+standard\)?/gi, '').trim();
            serving = serving.replace(/\s*\(\s*\)/g, '').trim();
          }
        }
        
        const calories = ing.calories ? ing.calories.toFixed(1) : '0';
        
        // Check if this is soy milk and mark as fortified
        let displayName = name;
        if (isPlantBasedMilk(name)) {
          const nameLower = name.toLowerCase();
          if (nameLower.includes('soy milk') || nameLower.includes('soymilk')) {
            displayName = 'Soy Milk (Fortified)';
          }
        }
        
        return { name: displayName, serving, calories, originalName: name };
      });
      
      // ============================================
      // CHILD 4-8 FRUIT PORTION CHECK
      // ============================================
      // Check if target audience is "child-4-8" and show warning if fruit portions exceed limit
      // Note: selectedAudience is already declared above in the recommended serving section
      let childFruitWarningHtml = '';
      
      // Get selected audience for fruit portion check (reuse logic from above)
      const audienceForFruitCheck = smoothieForEl ? smoothieForEl.value : '';
      
      if (audienceForFruitCheck === 'child-4-6' || audienceForFruitCheck === 'child-7-8' || audienceForFruitCheck === 'child-4-8') {
        const { totalFruitGrams, totalPortions } = computeChild48FruitPortions(ingredients);
        
        if (totalPortions > CHILD_4_8_MAX_FRUIT_PORTIONS_PER_SMOOTHIE) {
          childFruitWarningHtml = `
            <div class="child-fruit-warning">
              <span class="child-fruit-warning-icon">⚠️</span>
              <div class="child-fruit-warning-content">
                <div class="child-fruit-warning-title">Fruit Portion Notice for Children 4–8 Years</div>
                <div class="child-fruit-warning-message">
                  For children 4–8 years, this smoothie has more fruit than a typical portion (approximately ${totalPortions.toFixed(1)} child servings, which exceeds the recommended ~1–1.5 servings). Consider reducing fruit or splitting into two smaller servings.
                </div>
              </div>
            </div>
          `;
        }
      }

      // Get sweetener warning from currentSmoothie
      const sweetenerWarning = currentSmoothie && currentSmoothie.sweetenerWarning ? currentSmoothie.sweetenerWarning : null;
      
      console.log("[sweetener-debug] displaySmoothieResults warning:", {
        hasCurrentSmoothie: !!currentSmoothie,
        sweetenerWarning: sweetenerWarning,
        currentSmoothieKeys: currentSmoothie ? Object.keys(currentSmoothie) : []
      });
      
      const sweetenerWarningHtml = sweetenerWarning ? `
        <div id="sweetener-warning" class="info-warning" style="display: block; padding: 12px 16px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: var(--radius); margin-bottom: 16px; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);">
          <div style="display: flex; align-items: flex-start; gap: 10px;">
            <span style="font-size: 1.2rem; flex-shrink: 0; margin-top: 2px;">⚠️</span>
            <div style="flex: 1;">
              <div style="font-size: 0.85rem; font-weight: 600; color: #92400e; margin-bottom: 4px;">Added Sweetener Notice</div>
              <div style="font-size: 0.8rem; color: #78350f; line-height: 1.5;">${sweetenerWarning}</div>
            </div>
          </div>
        </div>
      ` : '';
      
      // Get goal tips from currentSmoothie - show small links instead of full cards
      // Full cards are shown in warning containers above the build button
      const bloodSugarGoalTip = currentSmoothie && currentSmoothie.bloodSugarGoalTip ? currentSmoothie.bloodSugarGoalTip : null;
      const weightManagementTip = currentSmoothie && currentSmoothie.weightManagementTip ? currentSmoothie.weightManagementTip : null;
      const bloodPressureTip = currentSmoothie && currentSmoothie.bloodPressureTip ? currentSmoothie.bloodPressureTip : null;
      
      // Helper to check if container has content and is visible
      const hasContent = (id) => {
        const el = document.getElementById(id);
        return el && el.style.display !== 'none' && (el.textContent || '').trim().length > 0;
      };
      
      // Build small links to scroll to goal guidance cards (only if containers have content)
      const goalLinks = [];
      if (bloodSugarGoalTip && hasContent('blood-sugar-goal-warning-container')) {
        goalLinks.push('<a href="#blood-sugar-goal-warning-container" style="font-size: 0.75rem; color: #0284c7; text-decoration: underline; cursor: pointer;" onclick="document.getElementById(\'blood-sugar-goal-warning-container\')?.scrollIntoView({behavior:\'smooth\',block:\'center\'}); return false;">View Blood Sugar guidance</a>');
      }
      if (weightManagementTip && hasContent('weight-management-goal-warning-container')) {
        goalLinks.push('<a href="#weight-management-goal-warning-container" style="font-size: 0.75rem; color: #0284c7; text-decoration: underline; cursor: pointer;" onclick="document.getElementById(\'weight-management-goal-warning-container\')?.scrollIntoView({behavior:\'smooth\',block:\'center\'}); return false;">View Weight Management guidance</a>');
      }
      if (bloodPressureTip && hasContent('blood-pressure-goal-warning-container')) {
        goalLinks.push('<a href="#blood-pressure-goal-warning-container" style="font-size: 0.75rem; color: #0284c7; text-decoration: underline; cursor: pointer;" onclick="document.getElementById(\'blood-pressure-goal-warning-container\')?.scrollIntoView({behavior:\'smooth\',block:\'center\'}); return false;">View Blood Pressure guidance</a>');
      }
      
      const goalGuidanceLinksHtml = goalLinks.length > 0 ? `
        <div style="margin-bottom: 12px; padding: 8px 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; font-size: 0.8rem; color: #075985;">
          <strong>Goal guidance:</strong> ${goalLinks.join(' • ')}
        </div>
      ` : '';
      
      // Build ingredients HTML for panel
      // Helper to escape HTML
      const escapeHTML = (s) => {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, c => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[c]));
      };
      
      const ingredientsHtml = `
            <div class="sn-ing-grid" style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${ingredientsList.map(ing => `
                <span class="sn-ing-pill" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid #fbbf24; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                  <span class="sn-ing-pill__name" style="font-size: 0.9rem; font-weight: 600; color: #78350f;">${escapeHTML(ing.name)}</span>
                  <span class="sn-ing-pill__badges" style="display: inline-flex; align-items: center; gap: 4px;">
                    ${isPlantBasedMilk(ing.originalName || ing.name) ? '<span style="font-size: 0.7rem; color: #059669; background: #d1fae5; padding: 2px 6px; border-radius: 3px;">🌱 Vegan</span>' : ''}
                    ${isUnsweetenedMilk(ing.originalName || ing.name) && isPlantBasedMilk(ing.originalName || ing.name) ? '<span style="font-size: 0.7rem; color: #0EA5A4; background: rgba(14, 165, 164, 0.10); padding: 2px 6px; border-radius: 3px; margin-left: 4px;">Unsweetened</span>' : ''}
                  </span>
                  <span class="sn-ing-pill__sep" style="font-size: 0.75rem; color: #92400e; opacity: 0.7;">•</span>
                  <span class="sn-ing-pill__amt" style="font-size: 0.75rem; color: #92400e; font-weight: 500;">${escapeHTML(ing.serving)}</span>
                </span>
              `).join('')}
            </div>
      `;

      // Build yield HTML for panel
      const yieldHtml = `
                  <div style="display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap;">
                    <div style="font-size: 1.1rem; font-weight: 800; color: #0c4a6e; line-height: 1.1;">${totalWeightFormatted.gramsDisplay}</div>
                    <div style="font-size: 0.85rem; font-weight: 600; color: #0369a1; line-height: 1.1; opacity: 0.85;">
                      (${totalWeightFormatted.ouncesDisplay})
                    </div>
                  </div>
      `;

      // Build calories meta for nutrition accordion
      const caloriesMeta = totalNutrients.calories ? `${Math.round(totalNutrients.calories)} cal` : '—';

      let html = `
        <div class="sn-wrap">
          ${childFruitWarningHtml}
          ${sweetenerWarningHtml}
          ${goalGuidanceLinksHtml}
          
          <div class="sn-grid">
            <!-- Ingredients -->
            <section class="sn-card sn-card--warm">
              <div class="sn-head">
                <div class="sn-title">🥗 Smoothie Ingredients</div>
                <div class="sn-meta" id="sn-ingredient-count">${ingredients.length} ingredient${ingredients.length > 1 ? 's' : ''}</div>
                </div>
              <div class="sn-body">
                <div id="smoothie-ingredients-panel">${ingredientsHtml}</div>
              </div>
            </section>

            <!-- Yield -->
            <section class="sn-card sn-card--cool">
              <div class="sn-head">
                <div class="sn-title">🥤 Total Smoothie Yield</div>
                <div class="sn-meta" id="sn-yield-meta">${ingredients.length} ingredient${ingredients.length > 1 ? 's' : ''}</div>
              </div>
              <div class="sn-body">
                <div id="smoothie-yield-panel">${yieldHtml}</div>
            </div>
            </section>
          </div>
          
          <!-- Nutrition (collapsible) -->
          <details class="sn-card sn-card--neutral sn-details" open>
            <summary class="sn-summary">
              <span class="sn-title">📊 Nutrition Breakdown</span>
              <span class="sn-meta" id="sn-calories-meta">${caloriesMeta}</span>
            </summary>

            <div class="sn-body">
          <!-- Per Serving Card -->
          <div style="padding: 8px 12px; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.12); position: relative; overflow: hidden;">
            <!-- Decorative accent -->
            <div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(180deg, #10b981 0%, #059669 100%);"></div>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; padding-left: 8px;">
              <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2); flex-shrink: 0;">
                  <span style="font-size: 1rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));">🍽️</span>
                </div>
                <div style="flex: 1; min-width: 0;">
                  <div style="font-size: 0.7rem; color: #047857; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 2px; font-weight: 700;">Per Serving</div>
                  <div style="display: flex; align-items: baseline; gap: 6px; flex-wrap: nowrap;">
                    <div style="font-size: 1rem; font-weight: 800; color: #065f46; line-height: 1;">${perServingWeightFormatted.gramsDisplay}</div>
                    <div style="font-size: 0.7rem; font-weight: 600; color: #047857; line-height: 1; opacity: 0.8;">
                      (${perServingWeightFormatted.ouncesDisplay})
                    </div>
                  </div>
                </div>
              </div>
              <!-- Servings Selector - Compact inline -->
              <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
                <label style="font-size: 0.65rem; color: #047857; font-weight: 600; white-space: nowrap;">Servings:</label>
                <div class="quantity-control" style="border: 1.5px solid #10b981; border-radius: 6px; overflow: hidden; background: white; box-shadow: 0 1px 3px rgba(16, 185, 129, 0.15);">
                  <button class="quantity-btn decrement" id="smoothie-weight-servings-decrement" type="button" style="border-right: 1.5px solid #10b981; width: 24px; height: 24px; font-size: 0.85rem; background: #f0fdf4; color: #047857; font-weight: 700; transition: all 0.2s;">−</button>
                  <input 
                    type="number" 
                    id="smoothie-weight-servings-input" 
                    value="${smoothieWeightServings}" 
                    min="1" 
                    max="10" 
                    step="1"
                    style="width: 38px; padding: 2px 4px; border: none; outline: none; text-align: center; font-size: 0.75rem; font-weight: 700; color: #065f46; background: white;"
                  />
                  <button class="quantity-btn increment" id="smoothie-weight-servings-increment" type="button" style="border-left: 1.5px solid #10b981; width: 24px; height: 24px; font-size: 0.85rem; background: #f0fdf4; color: #047857; font-weight: 700; transition: all 0.2s;">+</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Servings Control and Tabs -->
          <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
                <!-- Servings Input (ONLY for Per Serving tab) -->
                <div id="smoothie-servings-control" style="display:none; margin-bottom: 16px;">
                  <!-- Batch size selector (ml) -->
                  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 12px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                      <span style="font-size:1.1rem;">🧪</span>
                      <label style="font-size:0.9rem; font-weight:600; color: var(--text-primary);">
                        Batch size (ml):
                      </label>
                    </div>

                    <select id="smoothie-batch-ml" style="padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; font-weight:700;">
                      <option value="auto" selected>Auto (from ingredients)</option>
                      <option value="500">500 ml</option>
                      <option value="750">750 ml</option>
                      <option value="1000">1000 ml</option>
                      <option value="1250">1250 ml</option>
                    </select>
                  </div>

                  <div id="smoothie-serving-message" style="margin-bottom: 10px; font-size: 0.85rem; color: var(--text-secondary);"></div>

                  <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">🍽️</span>
                      <label style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary);">
                        Servings (for per-serving values):
                      </label>
              </div>

              <div style="display: flex; align-items: center; gap: 8px;">
                      <div class="quantity-control sn-qty">
                        <button class="quantity-btn sn-qty-btn decrement" id="smoothie-servings-decrement" type="button">−</button>

                  <input 
                    type="number" 
                    id="smoothie-servings-input" 
                          class="sn-qty-input"
                    value="${smoothieServings}" 
                    min="1" 
                    max="10" 
                    step="1"
                  />

                        <button class="quantity-btn sn-qty-btn increment" id="smoothie-servings-increment" type="button">+</button>
                      </div>
                </div>
              </div>
            </div>
            
            <!-- Tabs -->
                <div class="sn-tabs">
                  <button id="smoothie-tab-whole" class="sn-tab active" data-tab="whole" type="button">
                Whole Smoothie
              </button>
                  <button id="smoothie-tab-serving" class="sn-tab" data-tab="serving" type="button">
                Per Serving
              </button>
            </div>
          </div>
          
          <!-- Tab Content -->
          <div id="smoothie-nutrition-whole" class="smoothie-nutrition-tab-content" style="display: block;">
            <!-- Header with USDA badge -->
                <div class="sn-nutrition-head">
                  <div class="sn-nutrition-title">
                    <span class="sn-emoji">🥤</span>
                <div>
                      <div class="sn-title">Smoothie Nutrition</div>
                      <div class="sn-subtitle">Whole smoothie • complete recipe</div>
                </div>
              </div>

              ${hasUSDA ? `
                    <div class="sn-usda-pill">
                      <span>✓</span>
                  <span>USDA verified ingredients</span>
                </div>
              ` : ''}
            </div>
            <div id="smoothie-metrics-whole"></div>
          </div>
          
          <div id="smoothie-nutrition-serving" class="smoothie-nutrition-tab-content" style="display: none;">
            <!-- Header with USDA badge -->
                <div class="sn-nutrition-head">
                  <div class="sn-nutrition-title">
                    <span class="sn-emoji">🥤</span>
                <div>
                      <div class="sn-title">Smoothie Nutrition</div>
                      <div class="sn-subtitle">Per serving • ${smoothieServings} serving${smoothieServings > 1 ? 's' : ''}</div>
                </div>
              </div>

              ${hasUSDA ? `
                    <div class="sn-usda-pill">
                      <span>✓</span>
                  <span>USDA verified ingredients</span>
                </div>
              ` : ''}
            </div>
            <div id="smoothie-metrics-serving"></div>
          </div>
            </div>
          </details>
        </div>
      `;
      smoothieBatchMlOverride = null;

      smoothieResultsBodyEl.innerHTML = html;
      const batchSel = document.getElementById('smoothie-batch-ml');
if (batchSel) batchSel.value = 'auto';


      // Ensure the servings input shows the current smoothieServings value
      const servingsInputEl = document.getElementById('smoothie-servings-input');
      if (servingsInputEl) {
        servingsInputEl.value = smoothieServings;
      }

      // Render nutrition metrics into their containers using DOM nodes
      const wholeMetricsContainer = document.getElementById('smoothie-metrics-whole');
      if (wholeMetricsContainer) {
        wholeMetricsContainer.innerHTML = '';
        wholeMetricsContainer.appendChild(renderSmoothieNutritionMetrics(totalNutrients, false));
      }

      // Don't render serving metrics here - let updatePerServingDisplay() handle it
      // This prevents double rendering and ensures correct calculation
      
      // Set up tab switching
      setupSmoothieNutritionTabs();
      
      // Set up servings control (for nutrition tabs)
      setupSmoothieServingsControl();
      
      // ✅ NEW: Set up batch size selector (ml)
      setupSmoothieBatchSizeControl();
      
      // Set up weight servings control (for per-serving weight display)
      setupSmoothieWeightServingsControl();
      
      // Initialize per-serving display (only if serving tab is active)
      const servingTab = document.getElementById('smoothie-tab-serving');
      if (servingTab && servingTab.classList.contains('active')) {
        updatePerServingDisplay();
      }
    }
    
    function setupSmoothieNutritionTabs() {
      const wholeTab = document.getElementById('smoothie-tab-whole');
      const servingTab = document.getElementById('smoothie-tab-serving');
      const wholeContent = document.getElementById('smoothie-nutrition-whole');
      const servingContent = document.getElementById('smoothie-nutrition-serving');
      const servingsBox = document.getElementById('smoothie-servings-control');
      
      if (!wholeTab || !servingTab || !wholeContent || !servingContent) return;
      
      wholeTab.addEventListener('click', () => {
        wholeTab.classList.add('active');
        servingTab.classList.remove('active');
        wholeContent.style.display = 'block';
        servingContent.style.display = 'none';
        if (servingsBox) servingsBox.style.display = 'none';
      });
      
      servingTab.addEventListener('click', () => {
        servingTab.classList.add('active');
        wholeTab.classList.remove('active');
        wholeContent.style.display = 'none';
        servingContent.style.display = 'block';
        if (servingsBox) servingsBox.style.display = 'block';
        updatePerServingDisplay();
      });
    }
    
    // Function to setup servings control
    function setupSmoothieServingsControl() {
      const servingsInput = document.getElementById('smoothie-servings-input');
      const decrementBtn = document.getElementById('smoothie-servings-decrement');
      const incrementBtn = document.getElementById('smoothie-servings-increment');
      
      if (!servingsInput || !decrementBtn || !incrementBtn) return;
      
      // Handle input change
      servingsInput.addEventListener('change', (e) => {
        const newServings = parseInt(e.target.value) || 1;
        if (newServings >= 1 && newServings <= 10) {
          smoothieServingMode = 'manual';
          manualServingsOverride = true;
          smoothieServings = newServings;
          updatePerServingDisplay();
        } else {
          e.target.value = smoothieServings;
        }
      });
      
      // Handle decrement button
      decrementBtn.addEventListener('click', () => {
        if (smoothieServings > 1) {
          smoothieServingMode = 'manual';
          manualServingsOverride = true;
          smoothieServings--;
          servingsInput.value = smoothieServings;
          updatePerServingDisplay();
        }
      });
      
      // Handle increment button
      incrementBtn.addEventListener('click', () => {
        if (smoothieServings < 10) {
          smoothieServingMode = 'manual';
          manualServingsOverride = true;
          smoothieServings++;
          servingsInput.value = smoothieServings;
          updatePerServingDisplay();
        }
      });
    }
    
    function setupSmoothieBatchSizeControl() {
      const sel = document.getElementById('smoothie-batch-ml');
      if (!sel) return;

      // IMPORTANT: sync the JS variable to what the dropdown currently shows
      // Otherwise the UI can show "Auto" while smoothieBatchMlOverride still holds an old number.
      const apply = () => {
        const v = sel.value;
        smoothieBatchMlOverride = (v === 'auto') ? null : (parseInt(v, 10) || null);
      };

      apply(); // <-- THIS LINE is the fix

      sel.addEventListener('change', () => {
        apply();
        // user is choosing batch sizing, keep recommended mode unless they manually edit servings
        smoothieServingMode = 'recommended';
        updatePerServingDisplay();
      });
    }
    
    // Function to update per serving display
    function updatePerServingDisplay() {
      if (!currentSmoothieData) return;
      
      console.log('[SERVING DEBUG]', {
        totalSmoothieWeightGrams,
        smoothieBatchMlOverride,
        batchG: (smoothieBatchMlOverride != null) ? smoothieBatchMlOverride : totalSmoothieWeightGrams,
        recommendedPerServingG,
        smoothieServings,
        smoothieServingMode
      });
      
      // Always sync batch override with the dropdown UI.
      // If UI says "auto", override must be null.
      const batchSel = document.getElementById('smoothie-batch-ml');
      if (batchSel && batchSel.value === 'auto') {
        smoothieBatchMlOverride = null;
        smoothieServingMode = 'recommended';
      }

      
      const totalNutrition =
        (lastSmoothieTotals && lastSmoothieTotals.totalNutrients)
          ? lastSmoothieTotals.totalNutrients
          : (currentSmoothieData.total_nutrition || {});
      const totalNutrients = {
        calories: totalNutrition.calories || 0,
        protein: totalNutrition.protein || 0,
        carbs: totalNutrition.carbs || 0,
        fat: totalNutrition.fat || 0,
        fiber: totalNutrition.fiber || 0,
        sugar: totalNutrition.sugar || 0,
        sodium: totalNutrition.sodium || 0
      };
      
      console.log('[PER-SERVING TOTALS]', totalNutrients);
      
      const autoBatchG = (lastSmoothieTotals && lastSmoothieTotals.totalWeightG)
  ? lastSmoothieTotals.totalWeightG
  : (totalSmoothieWeightGrams || 0);

const batchG = (smoothieBatchMlOverride != null)
  ? smoothieBatchMlOverride
  : autoBatchG;


      // Use recommended ratio ONLY if mode is 'recommended' AND we have the required values
      let perServingNutrients;
      if (smoothieServingMode === 'recommended' && recommendedPerServingG > 0 && batchG > 0) {
        const servingG = recommendedPerServingG;
        // ratio for one recommended serving (cap at 1 so we never exceed whole batch)
        const ratio = (batchG > 0 && servingG > 0) ? Math.min(1, servingG / batchG) : 1;
        
        console.log('[PER SERVING CALC]', {
          mode: 'recommended',
          totalCalories: totalNutrients.calories,
          ratio: ratio,
          servingG: servingG,
          batchG: batchG,
          calculatedCalories: (totalNutrients.calories || 0) * ratio
        });
        
        perServingNutrients = {
          calories: (totalNutrients.calories || 0) * ratio,
          protein: (totalNutrients.protein || 0) * ratio,
          carbs:   (totalNutrients.carbs   || 0) * ratio,
          fat:     (totalNutrients.fat     || 0) * ratio,
          fiber:   (totalNutrients.fiber   || 0) * ratio,
          sugar:   (totalNutrients.sugar   || 0) * ratio,
          sodium:  (totalNutrients.sodium  || 0) * ratio
        };
      } else {
        // Manual mode: compute per-serving by dividing by servings count
        console.log('[PER SERVING CALC]', {
          mode: 'manual',
          totalCalories: totalNutrients.calories,
          servings: smoothieServings,
          calculatedCalories: (totalNutrients.calories || 0) / smoothieServings
        });
        perServingNutrients = divideNutrients(totalNutrients, smoothieServings);
      }
      
      const servingContent = document.getElementById('smoothie-nutrition-serving');
      
      if (servingContent) {
        const subtitleDiv = servingContent.querySelector('.sn-subtitle');
          if (subtitleDiv) {
          if (smoothieServingMode === 'recommended' && recommendedPerServingG > 0) {
            subtitleDiv.textContent = `Per serving • ${Math.round(recommendedPerServingG)}g recommended`;
          } else {
            subtitleDiv.textContent = `Per serving • ${smoothieServings} manual serving${smoothieServings > 1 ? 's' : ''}`;
          }
        }

        const msg = document.getElementById('smoothie-serving-message');
        if (msg && batchG > 0) {
          if (smoothieServingMode === 'recommended' && recommendedPerServingG > 0) {
            const servingG = recommendedPerServingG;
            const full = Math.floor(batchG / servingG);
            const extra = Math.max(0, Math.round(batchG - full * servingG));

            if (full >= 1) {
              msg.textContent = `This batch is ~${Math.round(batchG)}g → ${full} full serving${full>1?'s':''} (${Math.round(servingG)}g each)` +
                (extra > 0 ? ` + ${extra}g extra.` : '.');
            } else {
              msg.textContent = `This batch is ~${Math.round(batchG)}g which is smaller than the recommended ${Math.round(servingG)}g serving. Per-serving equals the whole batch.`;
            }
          } else {
            // Manual mode: show simple message
            msg.textContent = `Per-serving values are based on splitting the batch into ${smoothieServings} serving${smoothieServings > 1 ? 's' : ''}.`;
          }
        }

        const servingMetricsContainer = document.getElementById('smoothie-metrics-serving');
        if (servingMetricsContainer) {
          servingMetricsContainer.innerHTML = '';
          servingMetricsContainer.appendChild(renderSmoothieNutritionMetrics(perServingNutrients, true));
        }
      }
    }
    
    // Helper function to format weight in grams and ounces (global version for use outside displaySmoothieResults)
    // Returns { gramsDisplay, ouncesDisplay }
    function formatWeightGlobal(grams) {
      if (!grams || grams <= 0) {
        return { gramsDisplay: '0g', ouncesDisplay: '0 oz' };
      }
      
      // Convert grams to ounces (1 oz = 28.3495 grams)
      const ounces = grams / 28.3495;
      
      // Format grams
      let gramsDisplay = '';
      if (grams >= 1000) {
        gramsDisplay = `${(grams / 1000).toFixed(2)} kg`;
      } else if (grams >= 100) {
        gramsDisplay = `${Math.round(grams)}g`;
      } else {
        gramsDisplay = `${grams.toFixed(1)}g`;
      }
      
      // Format ounces
      let ouncesDisplay = '';
      if (ounces >= 16) {
        // Show in pounds and ounces if >= 16 oz
        const pounds = Math.floor(ounces / 16);
        const remainingOz = ounces % 16;
        if (remainingOz > 0) {
          ouncesDisplay = `${pounds} lb ${remainingOz.toFixed(1)} oz`;
        } else {
          ouncesDisplay = `${pounds} lb`;
        }
      } else if (ounces >= 1) {
        ouncesDisplay = `${ounces.toFixed(1)} oz`;
      } else {
        ouncesDisplay = `${ounces.toFixed(2)} oz`;
      }
      
      return { gramsDisplay, ouncesDisplay };
    }
    
    // Function to update per-serving weight display
    // This recalculates per-serving weight based on current servings count
    // Note: This does not change ingredient quantities, only the displayed per-serving weight
    // Uses recommended serving calculation if available, otherwise manual servings
    function updatePerServingWeightDisplay() {
      if (totalSmoothieWeightGrams <= 0) return;
      
      // Recalculate recommended serving if audience and health goal are selected
      const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
      const selectedHealthGoal = smoothieHealthGoalsEl ? smoothieHealthGoalsEl.value : '';
      let healthGoalName = '';
      
      if (selectedHealthGoal && categories) {
        const categoryObj = categories.find(cat => {
          const catValue = typeof cat === 'object' && 'value' in cat ? cat.value : cat;
          return catValue.toLowerCase().replace(/\s+/g, '-') === selectedHealthGoal;
        });
        if (categoryObj) {
          // Use label if available, otherwise use value
          healthGoalName = typeof categoryObj === 'object' && 'label' in categoryObj ? categoryObj.label : categoryObj;
        } else {
          // Fallback: reconstruct name from normalized value
          healthGoalName = selectedHealthGoal.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
      }
      
      // Use recommended serving if available, otherwise use manual calculation
      let perServingWeightGrams;
      if (selectedAudience && healthGoalName && totalSmoothieWeightGrams > 0) {
        const recommended = computeRecommendedServing(selectedAudience, healthGoalName, totalSmoothieWeightGrams);
        recommendedPerServingG = recommended.perServingG;
        recommendedServings = recommended.servings;
        smoothieWeightServings = recommendedServings;
        perServingWeightGrams = recommendedPerServingG;
      } else {
        // Fallback: use manual servings calculation
        perServingWeightGrams = totalSmoothieWeightGrams / smoothieWeightServings;
      }
      
      const perServingWeightFormatted = formatWeightGlobal(perServingWeightGrams);
      
      // Find the per-serving card and update the weight display
      const perServingCard = document.getElementById('smoothie-weight-servings-input')?.closest('div[style*="background: linear-gradient(135deg, #ecfdf5"]');
      if (perServingCard) {
        // Update the weight display (find the div with the large weight number)
        const weightDisplayDiv = perServingCard.querySelector('div[style*="font-size: 1.1rem; font-weight: 800"]');
        const ouncesDisplayDiv = perServingCard.querySelector('div[style*="font-size: 0.85rem; font-weight: 600"][style*="color: #047857"]');
        
        if (weightDisplayDiv) {
          weightDisplayDiv.textContent = perServingWeightFormatted.gramsDisplay;
        }
        if (ouncesDisplayDiv) {
          ouncesDisplayDiv.textContent = `(${perServingWeightFormatted.ouncesDisplay})`;
        }
        
        // Update servings input to reflect recommended servings
        const servingsInput = document.getElementById('smoothie-weight-servings-input');
        if (servingsInput && recommendedServings > 0) {
          servingsInput.value = recommendedServings;
        }
      }
    }
    
    // Function to setup weight servings control (for per-serving weight display)
    // This is separate from nutrition servings and can be hooked to age/target audience later
    function setupSmoothieWeightServingsControl() {
      const servingsInput = document.getElementById('smoothie-weight-servings-input');
      const decrementBtn = document.getElementById('smoothie-weight-servings-decrement');
      const incrementBtn = document.getElementById('smoothie-weight-servings-increment');
      
      if (!servingsInput || !decrementBtn || !incrementBtn) return;
      
      // Handle input change
      servingsInput.addEventListener('change', (e) => {
        const newServings = parseInt(e.target.value) || 1;
        if (newServings >= 1 && newServings <= 10) {
          smoothieWeightServings = newServings;
          updatePerServingWeightDisplay();
        } else {
          e.target.value = smoothieWeightServings;
        }
      });
      
      // Handle decrement button
      decrementBtn.addEventListener('click', () => {
        if (smoothieWeightServings > 1) {
          smoothieWeightServings--;
          servingsInput.value = smoothieWeightServings;
          updatePerServingWeightDisplay();
        }
      });
      
      // Handle increment button
      incrementBtn.addEventListener('click', () => {
        if (smoothieWeightServings < 10) {
          smoothieWeightServings++;
          servingsInput.value = smoothieWeightServings;
          updatePerServingWeightDisplay();
        }
      });
    }

    // Clear smoothie - Clear ALL fields including dropdowns and ingredients
    if (clearSmoothieBtn) {
      clearSmoothieBtn.addEventListener('click', () => {
        // Clear all ingredients
        smoothieIngredients = [];
        
        // Clear smoothie state
        clearSmoothieState();
        
        // Clear all form fields
        if (smoothieNameEl) smoothieNameEl.value = '';
        if (smoothieNameBarEl) smoothieNameBarEl.style.display = 'none';
        if (smoothieNameDisplayEl) smoothieNameDisplayEl.textContent = 'My Smoothie';
        if (smoothieForEl) smoothieForEl.value = '';
        if (smoothieTimingEl) smoothieTimingEl.value = '';
        if (smoothieHealthGoalsEl) smoothieHealthGoalsEl.value = '';
        
        // Reset previous health goal tracking
        previousHealthGoal = null;
        
        // Clear search input and suggestions
        if (smoothieIngredientSearchEl) smoothieIngredientSearchEl.value = '';
        if (smoothieIngredientSuggestionsEl) {
          smoothieIngredientSuggestionsEl.innerHTML = '';
          smoothieIngredientSuggestionsEl.style.display = 'none';
        }
        
        // Update UI to reflect cleared state
        renderSmoothieIngredients();
        updateSmoothieRecipe();
        
        // Clear results
        if (smoothieResultsBodyEl) {
          smoothieResultsBodyEl.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
              <div style="font-size: 3rem; margin-bottom: 15px;">🥤</div>
              <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No Smoothie Built Yet</div>
              <div style="font-size: 0.9rem;">Add ingredients and click "Build Smoothie" to see nutrition information</div>
            </div>
          `;
        }
        
        setSmoothieStatus('Ready to build');
      });
    }

    // Load smoothie presets
    function loadSmoothiePresets() {
      smoothiePresetsEl.innerHTML = smoothiePresets.map(preset => `
        <div style="background: white; border-radius: var(--radius); padding: 20px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s ease; hover:border-color: var(--primary);" 
             onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 4px 12px rgba(14, 165, 164, 0.15)'"
             onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'"
             onclick="loadSmoothiePreset('${preset.name}')">
          <div style="font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: 8px;">${preset.name}</div>
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">${preset.description}</div>
          <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
            ${preset.ingredients.slice(0, 3).map(ing => `
              <span style="padding: 4px 8px; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem; color: var(--text-primary);">
                ${ing}
              </span>
            `).join('')}
            ${preset.ingredients.length > 3 ? `<span style="font-size: 0.75rem; color: var(--text-secondary);">+${preset.ingredients.length - 3} more</span>` : ''}
          </div>
          <div style="font-size: 0.75rem; color: var(--success); font-weight: 600;">${preset.healthGoal}</div>
        </div>
      `).join('');
    }

    window.loadSmoothiePreset = function(presetName) {
      const preset = smoothiePresets.find(p => p.name === presetName);
      if (!preset) return;
      
      const selectedAudience = smoothieForEl ? smoothieForEl.value : '';
      if (!selectedAudience) {
        setSmoothieStatus('Please select a target audience first', true);
        return;
      }
      
      // Filter preset ingredients to only include those with valid age-based portions
      const validPresetIngredients = preset.ingredients.filter(ing => {
        const ingredientName = typeof ing === 'string' ? ing : (ing && ing.name ? ing.name : '');
        if (!ingredientName) return false;
        return hasValidAgePortion(ingredientName, selectedAudience);
      });
      
      if (validPresetIngredients.length === 0) {
        setSmoothieStatus('No valid ingredients in this preset for the selected age group.', true);
        return;
      }
      
      if (validPresetIngredients.length < preset.ingredients.length) {
        const removedCount = preset.ingredients.length - validPresetIngredients.length;
        setSmoothieStatus(`Loaded preset (${removedCount} ingredient${removedCount > 1 ? 's' : ''} unavailable for this age group removed).`, true);
      }
      
      smoothieNameEl.value = preset.name;
      smoothieIngredients = validPresetIngredients;
      renderSmoothieIngredients();
      updateSmoothieRecipe();
      setSmoothieStatus(`Loaded "${preset.name}"`);
    };

    // Main tab switching
    const mainTabs = document.querySelectorAll('.main-tab');
    const mainTabContents = document.querySelectorAll('.main-tab-content');

    mainTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.mainTab;
        
        // Clear Ingredient tab fields when switching away
        if (targetTab === 'smoothie') {
          // Clear ingredient input
          if (ingredientsInputEl) {
            ingredientsInputEl.value = '';
          }
          // Clear selected ingredients
          selectedIngredients = [];
          if (selectedIngredientsEl) {
            selectedIngredientsEl.innerHTML = '';
            selectedIngredientsEl.style.display = 'none';
          }
          // Clear results
          if (resultsBodyEl) {
            resultsBodyEl.innerHTML = '';
          }
          // Reset analyze button
          if (analyzeBtn) {
            analyzeBtn.disabled = true;
          }
          
          // Cancel any pending "scroll back to search" timer (from Add button UX)
          if (scrollToSearchTimer) {
            clearTimeout(scrollToSearchTimer);
            scrollToSearchTimer = null;
          }

          // Fully reset Goal/Subcategory/Selected summary + chips/lists
          resetBrowseAfterAnalyze();

          // Hide step sections again (they'll re-appear after user clicks goal/subcategory)
          const subSec = document.getElementById('subcategories-section');
          if (subSec) subSec.style.display = 'none';

          const ingSec = document.getElementById('ingredients-section');
          if (ingSec) ingSec.style.display = 'none';
        }
        
        // Clear Smoothie tab fields when switching away from smoothie
        if (targetTab === 'ingredient') {
          // Clear smoothie state when switching tabs
          clearSmoothieState();
          
          // Clear smoothie search and input
          if (smoothieIngredientSearchEl) {
            smoothieIngredientSearchEl.value = '';
          }
          if (smoothieIngredientSuggestionsEl) {
            smoothieIngredientSuggestionsEl.innerHTML = '';
            smoothieIngredientSuggestionsEl.style.display = 'none';
          }
          // Clear smoothie ingredients array
          smoothieIngredients = [];
          if (smoothieSelectedIngredientsEl) {
            smoothieSelectedIngredientsEl.innerHTML = '';
            smoothieSelectedIngredientsEl.style.display = 'none';
          }
          // Clear smoothie recipe preview
          if (smoothieRecipeEl) {
            smoothieRecipeEl.innerHTML = `
              <div style="font-size: 0.9rem; color: var(--text-secondary); text-align: center; padding: 20px;">
                Add ingredients to build your smoothie recipe
              </div>
            `;
          }
          // Clear smoothie name bar
          if (smoothieNameBarEl) {
            smoothieNameBarEl.style.display = 'none';
          }
          if (smoothieNameEl) {
            smoothieNameEl.value = '';
          }
          if (smoothieNameDisplayEl) {
            smoothieNameDisplayEl.textContent = 'My Smoothie';
          }
          // Clear dropdowns
          if (smoothieForEl) smoothieForEl.value = '';
          if (smoothieTimingEl) smoothieTimingEl.value = '';
          if (smoothieHealthGoalsEl) smoothieHealthGoalsEl.value = '';
          // Clear smoothie results
          if (smoothieResultsBodyEl) {
            smoothieResultsBodyEl.innerHTML = `
              <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 15px;">🥤</div>
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No Smoothie Built Yet</div>
                <div style="font-size: 0.9rem;">Add ingredients and click "Build Smoothie" to see nutrition information</div>
              </div>
            `;
          }
          // Reset build button
          if (buildSmoothieBtn) {
            buildSmoothieBtn.disabled = true;
          }
          // Reset status
          setSmoothieStatus('Ready to build');
        }
        
        // Update active states
        mainTabs.forEach(t => t.classList.remove('active'));
        mainTabContents.forEach(c => {
          c.classList.remove('active');
          c.style.display = 'none';
        });
        
        tab.classList.add('active');
        const targetContent = document.getElementById(`${targetTab}-tab-content`);
        if (targetContent) {
          targetContent.classList.add('active');
          targetContent.style.display = 'block';
        }
      });
    });

    // ============================================
    // END SMOOTHIE BUILDER
    // ============================================

    // Function to reset page to initial state
    function resetToInitialState() {
      // Clear analysis results
      lastAnalysisResult = null;
      
      // Reset results body to initial message
      if (resultsBodyEl) {
        resultsBodyEl.innerHTML = 'When you analyze ingredients, the results will appear here. Select ingredients from the panels below and click "Analyze Ingredients" to get started.';
      }
      
      // Reset tabs to Nutrition (first tab)
      if (tabs && tabs.length > 0) {
        tabs.forEach(t => t.classList.remove('active'));
        tabs[0].classList.add('active');
      }
      
      // Reset scroll positions
      tabScrollPositions = {
        'nutrition': 0,
        'allergens': 0,
        'health-benefits': 0
      };
      
      // Reset scroll positions for all tab panes
      if (nutritionResultsBodyEl) nutritionResultsBodyEl.scrollTop = 0;
      if (allergensResultsBodyEl) allergensResultsBodyEl.scrollTop = 0;
      if (healthBenefitsResultsBodyEl) healthBenefitsResultsBodyEl.scrollTop = 0;
      
      // Reset tab panes visibility
      if (tabPanes) {
        tabPanes.forEach(pane => {
          pane.classList.remove('active');
          pane.style.display = 'none';
        });
        const nutritionPane = document.querySelector('.tab-pane[data-tab="nutrition"]');
        if (nutritionPane) {
          nutritionPane.classList.add('active');
          nutritionPane.style.display = 'block';
        }
      }
      
      // Clear ingredient inputs
      if (ingredientsInputEl) ingredientsInputEl.value = '';
      selectedIngredients = [];
      if (selectedIngredientsEl) {
        selectedIngredientsEl.innerHTML = '';
        selectedIngredientsEl.style.display = 'none';
      }
      
      // Reset analyze button
      if (analyzeBtn) analyzeBtn.disabled = true;
      
      // Reset status
      setStatus('Ready. Enter ingredients in the textarea or use search to add them.');
      
      // Reset category selections
      selectedCategory = null;
      selectedSubcategory = null;
      currentIngredients = [];
      if (categoryListEl) {
        categoryListEl.querySelectorAll('.panel-item').forEach(item => {
          item.classList.remove('active');
        });
      }
      if (subcatListEl) {
        subcatListEl.innerHTML = '<div class="empty-state">Select a category first</div>';
      }
      if (ingredientListEl) {
        ingredientListEl.innerHTML = '<div class="empty-state">Select a sub-category to see ingredients</div>';
      }
      
      // Reset smoothie builder
      smoothieIngredients = [];
      lastBuiltSmoothieData = null;
      previousHealthGoal = null;
      if (smoothieIngredientSearchEl) smoothieIngredientSearchEl.value = '';
      if (smoothieIngredientSuggestionsEl) {
        smoothieIngredientSuggestionsEl.innerHTML = '';
        smoothieIngredientSuggestionsEl.style.display = 'none';
      }
      if (smoothieSelectedIngredientsEl) {
        smoothieSelectedIngredientsEl.innerHTML = '';
        smoothieSelectedIngredientsEl.style.display = 'none';
      }
      if (smoothieRecipeEl) {
        smoothieRecipeEl.innerHTML = `
          <div style="font-size: 0.9rem; color: var(--text-secondary); text-align: center; padding: 20px;">
            Add ingredients to build your smoothie recipe
          </div>
        `;
      }
      if (smoothieNameEl) smoothieNameEl.value = '';
      if (smoothieNameBarEl) smoothieNameBarEl.style.display = 'none';
      if (smoothieNameDisplayEl) smoothieNameDisplayEl.textContent = 'My Smoothie';
      if (smoothieForEl) smoothieForEl.value = '';
      if (smoothieTimingEl) smoothieTimingEl.value = '';
      if (smoothieHealthGoalsEl) smoothieHealthGoalsEl.value = '';
      if (smoothieResultsBodyEl) {
        smoothieResultsBodyEl.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <div style="font-size: 3rem; margin-bottom: 15px;">🥤</div>
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No Smoothie Built Yet</div>
            <div style="font-size: 0.9rem;">Add ingredients and click "Build Smoothie" to see nutrition information</div>
          </div>
        `;
      }
      if (buildSmoothieBtn) buildSmoothieBtn.disabled = true;
      if (smoothieStatusTextEl) smoothieStatusTextEl.textContent = 'Ready to build';
      if (smoothieStatusDotEl) smoothieStatusDotEl.classList.remove('error');
    }

    // Prevent browser from restoring scroll position on reload
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }

    // Force page to top on every load and remove any hash
    function forceScrollToTop() {
      // Remove any hash so the browser doesn't jump to an anchor
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      }
      
      // Force scroll to very top
      window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
      
      // Also set scrollTop directly as a fallback
      if (document.documentElement) {
        document.documentElement.scrollTop = 0;
      }
      if (document.body) {
        document.body.scrollTop = 0;
      }
    }

    // Run immediately on script load (before DOM is ready)
    forceScrollToTop();

    // Also run on DOMContentLoaded (early DOM ready)
    document.addEventListener('DOMContentLoaded', () => {
      forceScrollToTop();
    });

    // Also run on window load (after all resources loaded)
    window.addEventListener('load', () => {
      forceScrollToTop();
    });

    (async function init() {
      // Reset to initial state on page load
      resetToInitialState();
      
      // Ensure we're at the top after reset
      forceScrollToTop();
      
      await loadHierarchy();
      await loadCategories();
      renderSelectedIngredients();
      loadSmoothiePresets();
      
      // Initialize search and toggle functionality
      initializeBrowseIngredientsFeatures();
      
      // Check initial state of textarea
      const hasText = ingredientsInputEl.value.trim().length > 0;
      analyzeBtn.disabled = !hasText && selectedIngredients.length === 0;
      
      setStatus('Ready. Enter ingredients in the textarea or use search to add them.');
      
      // Final scroll to top after everything is initialized
      setTimeout(() => {
        forceScrollToTop();
      }, 100);
    })();

    // Check session validity on page load (detect if session was invalidated) - backup check
    // This runs after DOM loads as a backup to the early check in <head>

    document.addEventListener('DOMContentLoaded', function() {
      console.log('[SESSION CHECK] DOMContentLoaded - running backup session check...');
      (async function checkSession() {
        try {
          console.log('[SESSION CHECK] Fetching /api/session-check (backup)...');
          const response = await fetch('/api/session-check', {
            credentials: 'same-origin',
            method: 'GET'
          });
          
          console.log('[SESSION CHECK] Backup check - Response status:', response.status, 'ok:', response.ok);
          
          if (response.status === 401) {
            try {
              const data = await response.json();
              console.log('[SESSION CHECK] Backup check - 401 response data:', data);
              if (data.error === 'session_invalidated') {
                // Session was invalidated (e.g., logged in from another device)
                console.log('[SESSION CHECK] Backup check - Session invalidated! Redirecting to login...');
                const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
                window.location.href = `/login?next=${nextUrl}`;
                return;
              }
              // If error === 'auth_required', do nothing (free mode - allow access)
              console.log('[SESSION CHECK] Backup check - auth_required (free mode, ignoring)');
            } catch (parseError) {
              // If JSON parsing fails, still treat 401 as potential invalidation
              console.warn('[SESSION CHECK] Backup check - Could not parse 401 response:', parseError);
            }
          } else if (response.ok) {
            const data = await response.json();
            console.log('[SESSION CHECK] Backup check - Valid session:', data);
          } else {
            console.log('[SESSION CHECK] Backup check - Unexpected status:', response.status);
          }
        } catch (error) {
          // Network errors are logged but don't block page load
          console.error('[SESSION CHECK] Backup check - Network error:', error);
        }
      })();
    });
  </script>
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    <button id="feedback-open" class="feedback-fab feedback-open" data-feedback-open type="button">
      Feedback
    </button>
  </body>
</html>

